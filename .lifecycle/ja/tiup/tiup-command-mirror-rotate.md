---
title: tiup ミラーの切り替え
---

# tiup ミラーの切り替え

`root.json` は TiUP ミラーにおける重要なファイルです。このファイルにはシステム全体で必要となる公開鍵が格納され、TiUP の信頼チェーンの基盤となります。このファイルには主に次の部分が含まれます:

- ミラー管理者の署名。公式のミラーでは5つの署名があります。初期化されたミラーの場合、デフォルトで3つの署名があります。
- 次のファイルの検証に使用される公開鍵:
    - root.json
    - index.json
    - snapshot.json
    - timestamp.json
- `root.json` の有効期限。公式のミラーの場合、有効期限は `root.json` の作成日から1年後になります。

TiUP ミラーの詳細な説明については、[TiUP ミラーリファレンス](/tiup/tiup-mirror-reference.md) を参照してください。

次の場合に `root.json` を更新する必要があります:

- ミラーの鍵を置き換える場合。
- 証明書ファイルの有効期限を更新する場合。

`root.json` の内容を更新した後は、ファイルはすべての管理者によって再署名する必要があります。それ以外の場合、クライアントはファイルを拒否します。更新プロセスは以下の通りです:

1. ユーザー（クライアント）が `root.json` の内容を更新します。
2. すべての管理者が新しい `root.json` ファイルに署名します。
3. tiup-server が `snapshot.json` を更新し、新しい `root.json` ファイルのバージョンを記録します。
4. tiup-server が新しい `snapshot.json` ファイルに署名します。
5. tiup-server が `timestamp.json` を更新し、新しい `snapshot.json` ファイルのハッシュ値を記録します。
6. tiup-server が新しい `timestamp.json` ファイルに署名します。

TiUP は `tiup mirror rotate` コマンドを使用して上記のプロセスを自動化します。

> **注意:**
>
> + v1.5.0 より前の TiUP バージョンでは、このコマンドを実行しても正しい新しい `root.json` ファイルが返されません。[#983](https://github.com/pingcap/tiup/issues/983) を参照してください。
> + このコマンドを使用する前に、すべての TiUP クライアントが v1.5.0 またはそれ以降のバージョンにアップグレードされていることを確認してください。

## 構文

```shell
tiup mirror rotate [flags]
```

このコマンドを実行すると、TiUP はユーザーがファイルの内容を目標値に変更するためのエディタを起動します。例えば、`expires` フィールドの値を後の日付に変更します。その後、TiUP は `version` フィールドを `N` から `N+1` に変更し、ファイルを保存します。ファイルを保存した後、TiUP は一時的な HTTP サーバーを起動し、すべてのミラー管理者がファイルに署名するのを待ちます。

ミラー管理者がファイルに署名する方法については、[`sign` コマンド](/tiup/tiup-command-mirror-sign.md) を参照してください。

## オプション

### --addr

- 一時サーバーのリスニング アドレスを指定します。このアドレスが他のミラー管理者からアクセス可能であることを確認する必要があります。こうすることで、他の管理者が [`sign` コマンド](/tiup/tiup-command-mirror-sign.md) を使用してファイルに署名できます。
- データ型: `STRING`
- コマンドでこのオプションが指定されていない場合、TiUP はデフォルトで `0.0.0.0:8080` でリスンします。

## 出力

各ミラー管理者の現在の署名状況。

[<< 前のページに戻る - TiUP ミラーコマンド一覧](/tiup/tiup-command-mirror.md#command-list)