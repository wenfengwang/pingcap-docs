---
title: tiup クラスターチェック
---

# tiup クラスターチェック

正式なプロダクション環境では、環境が本番稼働する前にクラスターが最高のパフォーマンスを発揮するために一連のチェックを実行する必要があります。手動のチェック手順を簡略化するために、TiUP クラスターは、指定したクラスターの対象マシンのハードウェアとソフトウェア環境が要件を満たして正常に動作するかどうかをチェックする `check` コマンドを提供しています。

## チェック項目のリスト

### オペレーティングシステムバージョン

展開されたマシンのオペレーティングシステムのディストリビューションとバージョンをチェックします。現在は、デプロイには CentOS 7 のみがサポートされています。後のリリースで互換性向上のため、さらに多くのシステムバージョンがサポートされる可能性があります。

### CPU EPOLLEXCLUSIVE

対象マシンのCPUが EPOLLEXCLUSIVE をサポートしているかどうかをチェックします。

### numactl

対象マシンに numactl がインストールされているかどうかをチェックします。対象マシンでタイドコアが構成されている場合は、numactl をインストールする必要があります。

### システム時刻

対象マシンのシステム時刻が同期されているかどうかをチェックします。対象マシンのシステム時刻を中央制御マシンのシステム時刻と比較し、偏差が一定のしきい値（500ミリ秒）を超える場合はエラーを報告します。

### システムタイムゾーン

対象マシンのシステムタイムゾーンが同期されているかどうかをチェックします。これらのマシンのタイムゾーンの構成を比較し、タイムゾーンが不一致の場合はエラーを報告します。

### タイム同期サービス

対象マシンでタイム同期サービスが構成されているかどうかをチェックします。つまり、ntpd が実行されているかどうかをチェックします。

### スワップ領域

対象マシンでスワップ領域が有効になっているかどうかをチェックします。スワップ領域は無効にすることを推奨します。

### カーネルパラメータ

次のカーネルパラメータの値をチェックします。

- `net.ipv4.tcp_tw_recycle`: 0
- `net.ipv4.tcp_syncookies`: 0
- `net.core.somaxconn`: 32768
- `vm.swappiness`: 0
- `vm.overcommit_memory`: 0 または 1
- `fs.file-max`: 1000000

### 透過的な巨大ページ（THP）

対象マシンで THP が有効になっているかどうかをチェックします。THP を無効にすることを推奨します。

### システム制限

`/etc/security/limits.conf` ファイルの制限値をチェックします。

```
<deploy-user> soft nofile 1000000
<deploy-user> hard nofile 1000000
<deploy-user> soft stack 10240
```

`<deploy-user>` は TiDB クラスターを展開および実行するユーザーであり、最後の列はシステムで必要な最小値です。

### SELinux

SELinux が有効になっているかどうかをチェックします。SELinux を無効にすることを推奨します。

### ファイアウォール

FirewallD サービスが有効になっているかどうかをチェックします。FirewallD サービスを無効にするか、TiDB クラスターの各サービスに対して許可ルールを追加することを推奨します。

### irqbalance

irqbalance サービスが有効になっているかどうかをチェックします。irqbalance サービスを有効にすることを推奨します。

### ディスクマウントオプション

ext4 パーティションのマウントオプションをチェックします。nodelalloc オプションおよび noatime オプションがマウントオプションに含まれていることを確認してください。

### ポート使用

トポロジで定義されたポート（自動補完のデフォルトポートを含む）が対象マシンのプロセスによって既に使用されているかどうかをチェックします。

> **注意:**
>
> ポート使用のチェックは、クラスターがまだ開始されていないことを前提としています。クラスターが既に展開および開始されている場合、クラスター上のポート使用のチェックは失敗します。この場合、ポートは使用されている必要があります。

### CPUコア数

対象マシンのCPU情報をチェックします。プロダクションクラスターの場合、CPUの論理コア数が16以上であることを推奨します。

> **注意:**
>
> CPUコア数はデフォルトではチェックされません。チェックを有効にするには、コマンドに `-enable-cpu` オプションを追加する必要があります。

### メモリサイズ

対象マシンのメモリサイズをチェックします。プロダクションクラスターの場合、合計メモリ容量が32GB以上であることを推奨します。

> **注意:**
>
> メモリサイズはデフォルトではチェックされません。チェックを有効にするには、コマンドに `-enable-mem` オプションを追加する必要があります。

### Fioディスクパフォーマンステスト

柔軟なI/Oテスター（fio）を使用して、`data_dir` があるディスクのパフォーマンスをテストします。次の3つのテスト項目が含まれます。

- fio_randread_write_latency
- fio_randread_write
- fio_randread

> **注意:**
>
> fioディスクパフォーマンステストはデフォルトでは実行されません。テストを実行するには、コマンドに `-enable-disk` オプションを追加する必要があります。

## 構文

```shell
tiup cluster check <topology.yml | cluster-name> [flags]
```

- クラスターがまだ展開されていない場合は、クラスターを展開するために使用される [topology.yml](/tiup/tiup-cluster-topology-reference.md) ファイルを渡す必要があります。このファイルの内容に従って、tiup-cluster は対応するマシンに接続してチェックを実行します。
- クラスターが既に展開されている場合は、`<cluster-name>` をチェックオブジェクトとして使用できます。
- 既存のクラスターに対してスケールアウトYAMLファイルをチェックする場合は、`<scale-out.yml>` および `<cluster-name>` の両方をチェックオブジェクトとして使用できます。

> **注意:**
>
> `<cluster-name>` をチェックする場合、コマンドに `--cluster` オプションを追加する必要があります。

## オプション

### --apply

- 失敗したチェック項目を自動修復しようとします。現在、tiup-cluster は次のチェック項目のみを自動修復しようとします。
    - SELinux
    - ファイアウォール
    - irqbalance
    - カーネルパラメータ
    - システム制限
    - THP（透過的な巨大ページ）
- データタイプ: `BOOLEAN`
- このオプションはデフォルトで無効になっており、`false` 値です。このオプションを有効にするには、このオプションをコマンドに追加し、`true` 値を渡すか、値を渡さないでください。

> **注意:**
>
> `tiup cluster check` は、次のコマンド形式で既存のクラスターの `scale-out.yml` ファイルを修復することもサポートしています:
>
>```shell
> tiup cluster check <cluster-name> scale-out.yml --cluster --apply --user root [-p] [-i /home/root/.ssh/gcp_rsa]
>```

### --cluster

- 展開されているクラスター用のチェックであることを示します。
- データタイプ: `BOOLEAN`
- このオプションはデフォルトで無効になっており、`false` 値です。このオプションを有効にするには、このオプションをコマンドに追加し、`true` 値を渡すか、値を渡さないでください。
- コマンド形式:

    ```shell
    tiup cluster check <topology.yml | cluster-name> --cluster [flags]
    ```

> **注意:**
>
> - `tiup cluster check <cluster-name>` コマンドを使用する場合は、`--cluster` オプションを追加する必要があります: `tiup cluster check <cluster-name> --cluster`。
> - `tiup cluster check` は、次のコマンド形式で既存のクラスターの `scale-out.yml` ファイルをチェックすることもサポートしています:
>
>   ```shell
>   tiup cluster check <cluster-name> scale-out.yml --cluster --user root [-p] [-i /home/root/.ssh/gcp_rsa]
>   ```

### -N, --node

- チェックするノードを指定します。このオプションの値は、ノードIDのカンマ区切りリストです。ノードIDは、[`tiup cluster display`](/tiup/tiup-component-cluster-display.md) コマンドによって返されるクラスターステータステーブルの最初の列から取得できます。
- データタイプ: `STRINGS`
- このオプションがコマンドで指定されていない場合、デフォルトで全てのノードがチェックされます。

> **注意:**
>
> 同時に `-R, --role` オプションが指定されている場合、`-N, --node` オプションと `-R, --role` オプションの両方に一致するサービスノードだけがチェックされます。

### -R, --role

- チェックする役割を指定します。このオプションの値は、ノードの役割のカンマ区切りリストです。ノードの役割は、[`tiup cluster display`](/tiup/tiup-component-cluster-display.md) コマンドによって返されるクラスターステータステーブルの2番目の列から取得できます。
- データタイプ: `STRINGS`
- このオプションがコマンドで指定されていない場合、デフォルトで全てのロールがチェックされます。

> **注意:**
>
> 同時に `-N, --node` オプションが指定されている場合、`-N, --node` オプションと `-R, --role` オプションの両方に一致するサービスノードだけがチェックされます。

### --enable-cpu

- CPUコア数のチェックを有効にします。
- データタイプ: `BOOLEAN`
- このオプションはデフォルトで無効になっており、`false` 値です。このオプションを有効にするには、このオプションをコマンドに追加し、`true` 値を渡すか、値を渡さないでください。

### --enable-disk

- fioディスクパフォーマンステストを有効にします。
- データタイプ: `BOOLEAN`
- このオプションはデフォルトで無効になっており、`false` 値です。このオプションを有効にするには、このオプションをコマンドに追加し、`true` 値を渡すか、値を渡さないでください。

### --enable-mem

- メモリサイズのチェックを有効にします。
- データタイプ: `BOOLEAN`
- このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、コマンドにこのオプションを追加し、`true`の値を渡すか、値を渡さないようにします。

### --u, --user

- ターゲットマシンに接続するユーザー名を指定します。指定されたユーザーは、ターゲットマシンでパスワードフリーのsudoルート権限を持っている必要があります。
- データタイプ：`STRING`
- このオプションがコマンドで指定されていない場合、コマンドを実行するユーザーがデフォルト値として使用されます。

> **注：**
>
> このオプションは、`-cluster`オプションが`false`の場合のみ有効です。それ以外の場合、このオプションの値は、クラスタ展開のトポロジファイルで指定されたユーザー名に固定されます。

### -i, --identity_file

- ターゲットマシンに接続する鍵ファイルを指定します。
- データタイプ：`STRING`
- このオプションは、デフォルトで`~/.ssh/id_rsa`（デフォルト値）を渡すことで有効になっています。

> **注：**
>
> このオプションは、`--cluster`オプションが`false`の場合のみ有効です。それ以外の場合、このオプションの値は`${TIUP_HOME}/storage/cluster/clusters/<cluster-name>/ssh/id_rsa`に固定されます。

### -p, --password

- ターゲットマシンに接続する際にパスワードを使用します。
    - クラスタで`--cluster`オプションが追加された場合、パスワードはクラスタが展開されたときにトポロジファイルで指定されたユーザーのパスワードです。
    - クラスタに`--cluster`オプションが追加されていない場合、パスワードは`-u/--user`オプションで指定されたユーザーのパスワードです。
- データタイプ：`BOOLEAN`
- このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、コマンドにこのオプションを追加し、`true`の値を渡すか、値を渡さないようにします。

### -h, --help

- 関連するコマンドのヘルプ情報を表示します。
- データタイプ：`BOOLEAN`
- このオプションは、デフォルトで`false`の値で無効になっています。このオプションを有効にするには、コマンドにこのオプションを追加し、`true`の値を渡すか、値を渡さないようにします。

## 出力

次のフィールドを含むテーブル：

- `Node`：対象ノード
- `Check`：チェック項目
- `Result`：チェック結果（Pass、Warn、またはFail）
- `Message`：結果の説明

[<< 前のページに戻る - TiUPクラスタコマンドリスト](/tiup/tiup-component-cluster.md#command-list)