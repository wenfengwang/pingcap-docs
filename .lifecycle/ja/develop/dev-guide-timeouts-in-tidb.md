---
title: TiDB のタイムアウト
summary: TiDB におけるタイムアウトと、エラーのトラブルシューティングの解決策について学びます。

# TiDB のタイムアウト

このドキュメントでは、TiDB におけるさまざまなタイムアウトについて説明し、エラーのトラブルシューティングを支援します。

## GC のタイムアウト

TiDB のトランザクション実装では MVCC (Multiple Version Concurrency Control) メカニズムが使用されます。新しく書き込まれたデータが古いデータを上書きする際、古いデータは置き換えられず、新しく書き込まれたデータと一緒に保持されます。これらのバージョンはタイムスタンプによって区別されます。TiDB では、不要になった古いデータを定期的にガベージコレクション (GC) メカニズムを使用してクリーンアップします。

デフォルトでは、各 MVCC バージョン (一貫性のスナップショット) は 10 分間保持されます。10 分よりも長い読み取りに時間を要するトランザクションは `GC life time is shorter than transaction duration` のエラーを受け取ります。

たとえば、**Dumpling** を使用して完全バックアップを行う場合（**Dumpling** は一貫性のスナップショットをバックアップします）、より長い読み取り時間が必要な場合は、TiDB の `mysql.tidb` テーブル内の `tikv_gc_life_time` の値を調整して MVCC バージョンの保持時間を延長できます。なお、`tikv_gc_life_time` はグローバルかつ即座に有効になります。値を増やすとすべての既存のスナップショットの life time が増加し、減らすとすべてのスナップショットの life time が即座に短くなります。多くの MVCC バージョンは TiKV の処理効率に影響を与えます。ですので、**Dumpling** で完全バックアップを行った後は適切なタイミングで `tikv_gc_life_time` を以前の設定に戻す必要があります。

GC に関する詳細は[GC の概要](/garbage-collection-overview.md)を参照してください。

## トランザクションのタイムアウト

GC は進行中のトランザクションに影響を与えません。ただし、実行される悲観的なトランザクションの数には上限があり、トランザクションのタイムアウトやトランザクションに使用されるメモリの上限があります。デフォルトでは TiDB プロファイルの `[performance]` カテゴリ内の `max-txn-ttl` を修正してトランザクションのタイムアウトを行うことができます。デフォルトでは 60 分です。

`INSERT INTO t10 SELECT * FROM t1` などの SQL ステートメントは GC の影響を受けませんが、`max-txn-ttl` を超えるとタイムアウトによってロールバックされます。

## SQL 実行のタイムアウト

TiDB は単一の SQL ステートメントの実行時間を制限するためにシステム変数 (`max_execution_time`) を提供します。デフォルトでは `0` であり、制限がありません。現在、このシステム変数は読み取り専用の SQL ステートメントにのみ効果があります。`max_execution_time` の単位は `ms` ですが、実際の精度はミリ秒ではなく `100ms` レベルです。

## JDBC クエリのタイムアウト

TiDB に対する MySQL JDBC の `setQueryTimeout()` で設定されたクエリのタイムアウトは効果がありません。これは、クライアントがタイムアウトを検出するとデータベースに `KILL` コマンドを送信します。ただし、tidb-server はロードバランスが行われており、間違った tidb-server で接続を切断するのを避けるため、この `KILL` コマンドを実行しません。クエリのタイムアウトの効果を確認するには `MAX_EXECUTION_TIME` を使用する必要があります。

TiDB は以下の MySQL 互換のタイムアウト制御パラメータを提供します。

- **wait_timeout**: Java アプリケーションへの非インタラクティブアイドル時間のタイムアウトを制御します。TiDB v5.4 以降、`wait_timeout` のデフォルト値は `28800` 秒（8 時間）です。v5.4 以前の TiDB バージョンのデフォルト値は `0` であり、タイムアウトが無制限であることを意味します。
- **interactive_timeout**: Java アプリケーションへのインタラクティブなアイドル時間のタイムアウトを制御します。デフォルト値は `8 時間` です。
- **max_execution_time**: 接続での SQL 実行のタイムアウトを制御します。これは読み取り専用の SQL ステートメントにのみ有効です。デフォルト値は `0` であり、接続が無期限にビジーであることを可能にします。つまり、SQL ステートメントが無制限の時間実行されます。

しかし、実際のプロダクション環境ではアイドル接続と無期限に実行される SQL ステートメントはデータベースとアプリケーションの両方に悪影響を与えます。これらの2つのセッションレベルの変数をアプリケーションの接続文字列で設定することによってアイドル接続と無期限に実行される SQL ステートメントを回避することができます。たとえば、以下を設定します:

- `sessionVariables=wait_timeout=3600` (1 時間)
- `sessionVariables=max_execution_time=300000` (5 分)