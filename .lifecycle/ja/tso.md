---
title: TiDBのTimeStamp Oracle（TSO）
summary: TiDBのTimeStamp Oracle（TSO）について学びます。

# TiDBのTimeStamp Oracle（TSO）

TiDBでは、配置ドライバ（Placement Driver、PD）がクラスタ内のさまざまなコンポーネントにタイムスタンプを割り当てるのに重要な役割を果たします。これらのタイムスタンプは、トランザクションやデータに一時的なマーカーを割り当て、TiDB内で[Percolator](https://research.google.com/pubs/pub36726.html)モデルを有効にするために極めて重要です。Percolatorモデルは、Multi-Version Concurrency Control（MVCC）および[トランザクション管理](/transaction-overview.md)をサポートするために使用されています。

次の例は、TiDBで現在のTSOを取得する方法を示しています。

```sql
BEGIN; SET @ts := @@tidb_current_ts; ROLLBACK;
Query OK, 0 rows affected (0.0007 sec)
Query OK, 0 rows affected (0.0002 sec)
Query OK, 0 rows affected (0.0001 sec)

SELECT @ts;
+--------------------+
| @ts                |
+--------------------+
| 443852055297916932 |
+--------------------+
1 行のインデックスが返されました（0.00 sec）
```

前述の例では、TSOタイムスタンプは10進数で取得されます。このタイムスタンプを解析するために、次のSQL関数を使用できます。

- [`TIDB_PARSE_TSO()`](/functions-and-operators/tidb-functions.md#tidb_parse_tso)
- [`TIDB_PARSE_TSO_LOGICAL()`](/functions-and-operators/tidb-functions.md)

```sql
SELECT TIDB_PARSE_TSO(443852055297916932);
+------------------------------------+
| TIDB_PARSE_TSO(443852055297916932) |
+------------------------------------+
| 2023-08-27 20:33:41.687000         |
+------------------------------------+
1 行のインデックスが返されました（0.00 sec）
```

```sql
SELECT TIDB_PARSE_TSO_LOGICAL(443852055297916932);
+--------------------------------------------+
| TIDB_PARSE_TSO_LOGICAL(443852055297916932) |
+--------------------------------------------+
|                                          4 |
+--------------------------------------------+
1 行のインデックスが返されました（0.00 sec）
```

次の例は、TSOタイムスタンプがバイナリ形式でどのように見えるかを示しています。

```shell
0000011000101000111000010001011110111000110111000000000000000100  ← これが443852055297916932のバイナリ形式です
0000011000101000111000010001011110111000110117                    ← 最初の46ビットは物理タイムスタンプです
                                              000000000000000100  ← 最後の18ビットは論理タイムスタンプです
```

TSOタイムスタンプには2つの部分があります。

- 物理タイムスタンプ: 1970年1月1日以来のミリ秒単位のUNIXタイムスタンプです。
- 論理タイムスタンプ: 同じミリ秒内で複数のタイムスタンプが必要なシナリオや、特定のイベントがクロックの進行を逆転させる可能性がある場合に使用される増加カウンターです。このような場合、物理タイムスタンプは変化せず、論理タイムスタンプが着実に進行します。このメカニズムにより、TSOタイムスタンプは常に前進し、後退することはありません。

これらの知識を持っていると、SQLでTSOタイムスタンプをさらに調査できます。

```sql
SELECT @ts, UNIX_TIMESTAMP(NOW(6)), (@ts >> 18)/1000, FROM_UNIXTIME((@ts >> 18)/1000), NOW(6), @ts & 0x3FFFF\G
*************************** 1 行目 ***************************
                            @ts: 443852055297916932
         UNIX_TIMESTAMP(NOW(6)): 1693161835.502954
               (@ts >> 18)/1000: 1693161221.6870
FROM_UNIXTIME((@ts >> 18)/1000): 2023-08-27 20:33:41.6870
                         NOW(6): 2023-08-27 20:43:55.502954
                  @ts & 0x3FFFF: 4
1 行のインデックスが返されました（0.00 sec）
```

`>> 18` 操作は、18ビット右シフト（bitwise right shift）を示し、これは物理タイムスタンプを抽出するために使用されます。物理タイムスタンプはミリ秒単位で表現されているため、より一般的な秒単位で測定されるUNIXタイムスタンプ形式から外れています。そのため、これを 1000 で除算して[`FROM_UNIXTIME()`](/functions-and-operators/date-and-time-functions.md)と互換性のある形式に変換する必要があります。このプロセスは、`TIDB_PARSE_TSO()`の機能と一致しています。

また、論理タイムスタンプ `000000000000000100` をバイナリ形式で抽出することもできます。これは10進数では `4` に相当します。

また、次のようにCLIツールを使用してタイムスタンプを解析することもできます。

```shell
$ tiup ctl:v7.1.0 pd tso 443852055297916932
```

```
system:  2023-08-27 20:33:41.687 +0200 CEST
logic:   4
```

ここでは、行の最初に `system:` が付いた行に物理タイムスタンプ、`logic:` が付いた行に論理タイムスタンプが表示されています。