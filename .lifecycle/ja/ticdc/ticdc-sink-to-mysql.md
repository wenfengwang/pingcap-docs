---
title: MySQL 互換データベースへのデータレプリケーション
summary: TiCDCを使用してTiDBまたはMySQLへのデータレプリケーションの方法について学びます。

# MySQL 互換データベースへのデータレプリケーション

このドキュメントでは、TiCDCを使用してインクリメンタルデータを下流のTiDBデータベースまたは他のMySQL互換データベースにレプリケートする方法について説明します。また、災害シナリオ時のイベントualy consistent replication機能の使用方法についても紹介します。

## レプリケーションタスクの作成

以下のコマンドを実行してレプリケーションタスクを作成します。

```shell
cdc cli changefeed create \
    --server=http://10.0.10.25:8300 \
    --sink-uri="mysql://root:123456@127.0.0.1:3306/" \
    --changefeed-id="simple-replication-task"
```

```shell
変更フィードは正常に作成されました！
ID: simple-replication-task
情報: {"sink-uri":"mysql://root:123456@127.0.0.1:3306/","opts":{},"create-time":"2023-11-28T22:04:08.103600025+08:00","start-ts":415241823337054209,"target-ts":0,"admin-job-type":0,"sort-engine":"unified","sort-dir":".","config":{"case-sensitive":false,"filter":{"rules":["*.*"],"ignore-txn-start-ts":null,"ddl-allow-list":null},"mounter":{"worker-num":16},"sink":{"dispatchers":null},"scheduler":{"type":"table-number","polling-time":-1}},"state":"normal","history":null,"error":null}
```

- `--server`: TiCDCクラスタ内の任意のTiCDCサーバーのアドレス。
- `--changefeed-id`: レプリケーションタスクのID。形式は`^[a-zA-Z0-9]+(\-[a-zA-Z0-9]+)*$`正規表現と一致する必要があります。このIDが指定されていない場合、TiCDCは自動的にUUID（バージョン4形式）をIDとして生成します。
- `--sink-uri`: レプリケーションタスクの下流アドレス。詳細については[Configure sink URI with `mysql`/`tidb`](#configure-sink-uri-for-mysql-or-tidb)を参照してください。
- `--start-ts`: 変更フィードの開始TSOを指定します。このTSOからTiCDCクラスタはデータを取得し始めます。デフォルト値は現在時刻です。
- `--target-ts`: 変更フィードの終了TSOを指定します。TiCDCクラスタはこのTSOまでデータを取得を停止します。デフォルト値は空であり、TiCDCは自動的にデータの取得を停止しません。

## MySQLまたはTiDBのためのシンクURIを構成する

シンクURIは、TiCDCのターゲットシステムの接続情報を指定するために使用されます。フォーマットは次のとおりです。

```
[scheme]://[userinfo@][host]:[port][/path]?[query_parameters]
```

> **注意:**
>
> MySQLシンクでは `/path` は使用されません。

MySQLのためのサンプル構成:

```shell
--sink-uri="mysql://root:123456@127.0.0.1:3306"
```

以下は、MySQLまたはTiDBに構成できるシンクURIパラメータおよびパラメータ値の説明です:

| パラメータ/パラメータ値    | 説明                                             |
| :------------ | :------------------------------------------------ |
| `root`        | 下流データベースのユーザー名。                              |
| `123456`       | 下流データベースのパスワード（Base64でエンコードしても構いません）。                                      |
| `127.0.0.1`    | 下流データベースのIPアドレス。                               |
| `3306`         | 下流データのポート番号。                                 |
| `worker-count` | 下流で並行して実行できるSQLステートメントの数（オプション設定、デフォルトは `16`）。       |
| `cache-prep-stmts` | 下流でSQLを実行する際にプリペアドステートメントを使用し、クライアント側でプリペアドステートメントキャッシュを有効にするかどうかを制御します（オプション設定、デフォルトは `true`）。 |
| `max-txn-row`  | 下流で実行できるトランザクションのバッチサイズ（オプション設定、デフォルトは `256`）。 |
| `ssl-ca` | 下流MySQLインスタンスに接続するために必要なCA証明書ファイルのパス（オプション設定）。  |
| `ssl-cert` | 下流MySQLインスタンスに接続するために必要な証明書ファイルのパス（オプション設定）。|
| `ssl-key` | 下流MySQLインスタンスに接続するために必要な証明書キーファイルのパス（オプション設定）。|
| `time-zone` | 下流MySQLインスタンスへの接続時に使用されるタイムゾーン。v4.0.8以降有効です。これはオプションパラメータです。このパラメータが指定されていない場合、TiCDCサービスプロセスのタイムゾーンが使用されます。このパラメータを空の値に設定する（`time-zone=""`）と、TiCDCは下流MySQLインスタンスに接続する際にタイムゾーンを指定せず、下流のデフォルトのタイムゾーンが使用されます。
| `transaction-atomicity`  |  トランザクションのアトミシティレベル。これはオプションパラメータで、デフォルト値は `none` です。値が `table` の場合、TiCDCは単一テーブルトランザクションのアトミシティを保証します。`none` の場合、TiCDCは単一テーブルトランザクションを分割します。  |

データベースのパスワードをBase64でエンコードするために次のコマンドを使用します:

```shell
echo -n '123456' | base64   # '123456' はエンコードするパスワードです。
```

エンコードされたパスワードは `MTIzNDU2` です:

```shell
MTIzNDU2
```

> **注意:**
>
> シンクURIに `! * ' ( ) ; : @ & = + $ , / ? % # [ ]` などの特殊文字が含まれる場合は、特殊文字をエスケープする必要があります。例えば、[URI Encoder](https://www.urlencoder.org/) を使用します。

## 災害シナリオ時のイベントually consistent replicationの活用

v6.1.1から、この機能はGAとなりました。v5.3.0から、TiCDCは上流のTiDBクラスタから下流クラスタのオブジェクトストレージまたはNFSにインクリメンタルデータをバックアップする機能をサポートしています。上流クラスタが災害に遭遇し利用できなくなった場合、TiCDCは下流クラスタのデータを最新のイベントュアルリコンシリエーション状態に復元することができます。これがTiCDCが提供するイベントualy consistent replication機能です。この機能を使用すると、アプリケーションを迅速に下流クラスタに切り替えることができ、長時間の停止時間を回避しサービスの連続性を向上させることができます。

現在、TiCDCはTiDBクラスタから別のTiDBクラスタまたはMySQL互換データベースシステム（Aurora、MySQL、MariaDBを含む）へのインクリメンタルデータのレプリケーションをサポートしています。上流クラスタで、TiCDCがクラッシュ前にデータを正常にレプリケートし、レプリケーション遅延が小さい場合、TiCDCは下流クラスタのデータを5分以内に復元することができます。最大で10秒のデータ損失が許容され、つまり、RTO <= 5分、P95 RPO <= 10秒です。

以下のシナリオでTiCDCのレプリケーション遅延が増加します:

- 短時間でTPSが大幅に増加する。
- 上流で大規模または長いトランザクションが発生する。
- TiKVまたは上流のTiCDCクラスタが再読み込みまたはアップグレードされている。
- `add index`などの時間のかかるDDLステートメントが上流で実行されます。
- PDが頻繁なリージョンリーダーの転送やリージョンのマージ、またはリージョンの分割を起こすように設定されています。

> **注意:**
>
> v6.1.1から、TiCDCのイベントually consistent replication機能はAmazon S3互換のオブジェクトストレージをサポートしています。v6.1.4からは、この機能はGCSおよびAzure互換のオブジェクトストレージをサポートしています。

### 前提条件

- TiCDCのリアルタイムインクリメンタルデータのバックアップファイルを保存するための高可用性オブジェクトストレージまたはNFSを準備してください。上流で災害が発生した場合にこれらのファイルにアクセスできるようになります。
- 災害シナリオでイベントUAL consistencyを持つ変更フィードにこの機能を有効にする。有効にするには、次の設定を変更フィードの構成ファイルに追加します。

```toml
[consistent]
# 一貫性レベル。以下のオプションがあります:
# - none: デフォルト値。災害シナリオでのイベントUA aminoal consistencyは、finished-tsが指定されている場合のみ保証されます。
# - 結局: リドロログを使用してイベントUA consalk logical consistencyを保証します。
レベル = "結局"

# 個々のリドロログファイルのサイズ、MiB単位。デフォルトでは、64 です。128を超えないようにすることをお勧めします。
max-log-size = 64

# リドロログをAmazon S3にフラッシュしたりアップロードしたりする間隔、ミリ秒単位。この構成は2000と等しいかそれ以上であることがお勧めされます。
flush-interval = 2000

# リドロログバックアップが格納されるパス。スキームは、nfs（NFSディレクトリ）またはAmazon S3、GCS、およびAzure（オブジェクトストレージにアップロード）があります。
storage = "$SCHEME://logbucket/test-changefeed?endpoint=http://$ENDPOINT/"
```

### 災害復旧

プライマリクラスタで災害が発生した場合、`cdc redo`コマンドを実行してセカンダリクラスタで手動でリカバリします。リカバリプロセスは次のとおりです。

1. TiCDCプロセスがすべて終了していることを確認します。これは、データリカバリ中にプライマリクラスタがサービスを再開し、TiCDCがデータ同期を再開するのを防ぐためです。
```shell
cdcのデータ復旧のためにcdcバイナリを使用します。次のコマンドを実行してください：

```shell
cdc redo apply --tmp-dir="/tmp/cdc/redo/apply" \
    --storage="s3://logbucket/test-changefeed?endpoint=http://10.0.10.25:24927/" \
    --sink-uri="mysql://normal:123456@10.0.10.55:3306/"
```

このコマンドについて：

- `tmp-dir`: TiCDCの差分データバックアップファイルの一時ディレクトリを指定します。
- `storage`: TiCDCの差分データバックアップファイルを保存するアドレスを指定します。オブジェクトストレージまたはNFSディレクトリのURIです。
- `sink-uri`: データを復元するための二次クラスタのアドレスを指定します。スキームは`mysql`のみです。
```