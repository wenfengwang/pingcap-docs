---
title: TiCDCの概要
summary: TiCDCが何であるか、TiCDCが提供する機能、TiCDCのインストールと展開方法を学びます。
aliases: ['/docs/dev/ticdc/ticdc-overview/','/docs/dev/reference/tools/ticdc/overview/']
---

# TiCDCの概要

[TiCDC](https://github.com/pingcap/tiflow/tree/master/cdc) は、TiDBからの増分データを複製するためのツールです。具体的には、TiCDCはTiKVの変更ログを取得し、取得したデータを並べ替え、ローベースの増分データを下流のデータベースにエクスポートします。

## 使用シナリオ

TiCDCには複数の使用シナリオがあります。具体的には、以下が含まれます。

- 複数のTiDBクラスターの高可用性および災害復旧ソリューションを提供します。災害が発生した場合、TiCDCはプライマリとセカンダリクラスター間の最終的なデータ整合性を確保します。
- リアルタイムのデータ変更を同質のシステムにレプリケートします。これにより、監視、キャッシング、グローバルインデックス作成、データ解析、異種データベース間のプライマリ・セカンダリレプリケーションなど、さまざまなシナリオにデータソースを提供します。

## 主な機能

### 主要な機能

TiCDCには、以下の主要な機能があります。

- TiDBクラスター間の増分データを、秒単位のRPOと分単位のRTOで複製します。
- TiDBクラスター間の双方向レプリケーションを行い、TiCDCを使用してマルチアクティブなTiDBソリューションを作成できます。
- TiDBクラスターからMySQLデータベースやその他のMySQL互換データベースに低遅延で増分データを複製します。
- TiDBクラスターからKafkaクラスターに増分データを複製します。推奨されるデータ形式には、[Canal-JSON](/ticdc/ticdc-canal-json.md) と [Avro](/ticdc/ticdc-avro-protocol.md) が含まれます。
- TiDBクラスターからAmazon S3、GCS、Azure Blob Storage、およびNFSなどのストレージサービスに増分データを複製します。
- データベース、テーブル、DML、およびDDLをフィルタリングする能力を持つテーブルの複製を行います。
- いかなる単一障害点も持たず、TiCDCノードの動的な追加と削除をサポートする高可用性を提供します。
- [オープンAPI](/ticdc/ticdc-open-api-v2.md) を通じてクラスター管理を行い、タスクのステータスのクエリ、タスク構成の動的な変更、タスクの作成や削除を行えます。

### レプリケーション順序

- すべてのDDLまたはDMLステートメントについて、TiCDCはそれらを**少なくとも一度**出力します。
- TiKVまたはTiCDCクラスターが障害に遭遇した場合、TiCDCは同じDDL/DMLステートメントを繰り返し送信する場合があります。重複したDDL/DMLステートメントについては、以下が適用されます。

    - MySQLシンクはDDLステートメントを繰り返し実行できます。例えば、`TRUNCATE TABLE`など、下流で繰り返し実行できるDDLステートメントは成功します。しかし、`CREATE TABLE`など、繰り返し実行できないDDLステートメントは失敗し、TiCDCはエラーを無視して複製プロセスを継続します。
    - Kafkaシンクはデータ配信に異なる戦略を提供します。
        - テーブル、プライマリキー、またはタイムスタンプに基づいてデータを異なるKafkaパーティションに配信できます。これにより、行の更新データが順番に同じパーティションに送信されます。
        - これらの配信戦略はすべて、定期的に全てのトピックとパーティションに `Resolved TS` メッセージを送信します。これにより、 `Resolved TS` より前の全てのメッセージがすでにトピックとパーティションに送信されたことを示します。Kafkaコンシュマーは `Resolved TS` を使用して受信したメッセージを並べ替えることができます。
        - Kafkaシンクは、時々重複したメッセージを送信することがありますが、これらの重複メッセージは `Resolved Ts` の制約に影響を与えません。例えば、changefeedが一時停止され再開された場合、Kafkaシンクは `msg1`、`msg2`、`msg3`、`msg2`、`msg3` の順に送信することがあります。コンシュマーはKafkaから重複したメッセージをフィルタリングできます。

### レプリケーションの整合性

- MySQLシンク

    - TiCDCは、再実行ログを有効にしてデータレプリケーションの最終的な整合性を確保します。
    - TiCDCは、単一行の更新の順序が上流と一致することを保証します。
    - TiCDCは、下流トランザクションが上流トランザクションと同じ順序で実行されることは保証しません。

    > **注意:**
    >
    > v6.2以降では、sink URIパラメータ [`transaction-atomicity`](/ticdc/ticdc-sink-to-mysql.md#configure-sink-uri-for-mysql-or-tidb) を使用して、単一のテーブルトランザクションを分割するかどうかを制御できます。単一のテーブルトランザクションを分割することで、大規模なトランザクションの複製時のレイテンシとメモリ消費を大幅に削減できます。

## TiCDCのアーキテクチャ

TiCDCは、TiDBのための増分データレプリケーションツールであり、PDのetcdを介して高可用性を持っています。レプリケーションプロセスは以下のステップで構成されています。

1. 複数のTiCDCプロセスがデータ変更をTiKVノードから取得します。
2. TiCDCがデータ変更をソートしマージします。
3. TiCDCが複数のレプリケーションタスク（changefeed）を介してデータ変更を複数の下流システムにレプリケーションします。

TiCDCのアーキテクチャは、以下の図に示されています。

![TiCDCアーキテクチャ](/media/ticdc/cdc-architecture.png)

アーキテクチャ図のコンポーネントは以下のように説明されます。

- TiKVサーバー: TiDBクラスター内のTiKVノード。データ変更が発生すると、TiKVノードは変更ログ（KV変更ログ）をTiCDCノードに送信します。TiCDCノードは変更ログが連続していないことを検出すると、TiKVノードに変更ログを提供するようにアクティブに要求します。
- TiCDC: TiCDCプロセスが実行されるTiCDCノード。各ノードでTiCDCプロセスが実行されます。各プロセスは、TiKVノードの1つ以上のテーブルからデータ変更を取得し、シンクコンポーネントを介して変更を下流システムにレプリケーションします。
- PD: TiDBクラスター内のスケジューリングモジュール。このモジュールは、クラスターデータのスケジューリングを担当し、通常は3つのPDノードで構成されます。PDはetcdクラスターを介して高可用性を提供します。TiCDCは、ノードの状態情報やchangefeedの設定などのメタデータをetcdクラスターに保存します。

アーキテクチャ図に示されているように、TiCDCはTiDB、MySQL、Kafka、およびストレージサービスにデータをレプリケートすることをサポートしています。

## ベストプラクティス

- 2つのTiDBクラスター間でデータを複製するためにTiCDCを使用する場合、2つのクラスター間のネットワークレイテンシが100msを超える場合は、以下の推奨事項が適用されます。

    - TiCDC v6.5.2より前のバージョンでは、下流のTiDBクラスターがある地域（IDC）にTiCDCを展開することを推奨します。
    - TiCDC v6.5.2から導入された一連の改良により、上流のTiDBクラスターがある地域（IDC）にTiCDCを展開することを推奨します。

- TiCDCは、少なくとも1つの有効なインデックスを持つテーブルのみをレプリケートします。有効なインデックスは以下の条件を満たします。

    - プライマリキー (`PRIMARY KEY`) は有効なインデックスです。
    - ユニークインデックス (`UNIQUE INDEX`) は、インデックスの各列が明示的に `NOT NULL` と定義されており、かつインデックスに仮想生成列 (`VIRTUAL GENERATED COLUMNS`) がない場合、有効です。

- TiCDCを使用して災害復旧にデータをレプリケートする場合、最終的な整合性を確保するために、[redo log](/ticdc/ticdc-sink-to-mysql.md#eventually-consistent-replication-in-disaster-scenarios) を構成し、上流で災害が発生した場合でも、redo logが正常に読み取ることができるストレージシステムを確保する必要があります。

## サポートされていないシナリオ

現時点では、以下のシナリオはサポートされていません。

- RawKVのみを使用するTiKVクラスター。
- [`CREATE SEQUENCE` DDL操作](/sql-statements/sql-statement-create-sequence.md) および [`SEQUENCE` 関数](/sql-statements/sql-statement-create-sequence.md#sequence-function) をTiDBで使用する場合、TiCDCは `SEQUENCE` DDL操作/関数を無視します。ただし、`SEQUENCE` 関数を使用するDML操作は正しく複製されます。

TiCDCは、上流で大規模なトランザクションを含むシナリオを一部サポートしています。詳細については、[TiCDC FAQ](/ticdc/ticdc-faq.md#does-ticdc-support-replicating-large-transactions-is-there-any-risk) を参照してください。そこでは、TiCDCが大規模なトランザクションを複製することをサポートしているか、およびそれに関連するリスクについて詳細が記載されています。