---
title: TiCDC Open Protocol
summary: TiCDCオープンプロトコルの概念と使用方法について学ぶことができます。
aliases: ['/docs/dev/ticdc/ticdc-open-protocol/','/docs/dev/reference/tools/ticdc/open-protocol/','/docs/dev/ticdc/column-ddl-type-codes/']
---

# TiCDCオープンプロトコル

TiCDCオープンプロトコルは、モニタリング、キャッシング、フルテキストインデックス作成エンジン、および異なるデータベース間のプライマリセカンダリレプリケーションのためのデータソースを提供する行レベルのデータ変更通知プロトコルです。TiCDCはTiCDCオープンプロトコルに準拠しており、TiDBのデータ変更をメッセージキュー（MQ）などのサードパーティ製のデータ媒体にレプリケートします。

TiCDCオープンプロトコルは、イベントを基本単位として、データ変更イベントをダウンストリームにレプリケートします。イベントは3つのカテゴリに分かれます。

* 行変更イベント：行のデータ変更を表します。行が変更されると、このイベントが送信され、変更された行の情報が含まれます。
* DDLイベント：DDLの変更を表します。このイベントは、上流でDDLステートメントが正常に実行された後に送信されます。このDDLイベントは、各MQパーティションにブロードキャストされます。
* 解決済みイベント：受信したイベントが完了した特別な時間点を表します。

## 制限事項

* ほとんどの場合、特定のバージョンの行変更イベントは1回だけ送信されますが、ノードの障害やネットワークの分断などの特殊な状況では、同じバージョンの行変更イベントが複数回送信される場合があります。
* 同じテーブル上で、最初に送信された各バージョンの行変更イベントは、イベントストリーム内のタイムスタンプ（TS）の順に増分されます。
* 解決済みイベントは、各MQパーティションに定期的にブロードキャストされます。解決済みイベントは、そのTSよりも早いTSを持つ任意のイベントがダウンストリームに送信されたことを意味します。
* DDLイベントは、各MQパーティションにブロードキャストされます。
* 同じ行の複数の行変更イベントは、同じMQパーティションに送信されます。

## メッセージ形式

メッセージには、以下の形式で1つまたは複数のイベントが含まれています。

キー:

| オフセット（バイト） | 0~7     | 8~15 | 16~(15+length1) | ... | ... |
| :----------- | :------ | :--- | :----------- | :--- | :----------- |
| パラメータ         | プロトコルバージョン | Length1 | イベントキー1         | LengthN | イベントキーN         |

値:

| オフセット（バイト） | 0~7 | 8~(7+length1) | ... | ... |
| :----------- | :--- | :-------- | :--- | :------ |
| パラメータ         | Length1 | イベント値1     | LengthN | イベント値N |

* `LengthN` は、`N` 番目のキー/値の長さを表します。
* 長さとプロトコルバージョンは、big-endianの `int64` 型です。
* 現行プロトコルのバージョンは `1` です。

## イベント形式

このセクションでは、行変更イベント、DDLイベント、および解決済みイベントの形式について説明します。

### 行変更イベント

+ **キー:**

    ```
    {
        "ts":<TS>,
        "scm":<スキーマ名>,
        "tbl":<テーブル名>,
        "t":1
    }
    ```

    | パラメータ         | タイプ   | 説明                    |
    | :---------- | :----- | :--------------------- |
    | TS          | 数値 |  行の変更を引き起こすトランザクションのタイムスタンプ。  |
    | スキーマ名 | 文字列 |  行が含まれるスキーマの名前。 |
    | テーブル名  | 文字列 |  行が含まれるテーブルの名前。 |

+ **値:**

    `Insert` イベント。新しく追加された行データが出力されます。

    ```
    {
        "u":{
            <カラム名>:{
                "t":<カラムタイプ>,
                "h":<Whereハンドル>,
                "f":<フラグ>,
                "v":<カラム値>
            },
            <カラム名>:{
                "t":<カラムタイプ>,
                "h":<Whereハンドル>,
                "f":<フラグ>,
                "v":<カラム値>
            }
        }
    }
    ```

    `Update` イベント。新しく追加された行データ（"u"）と更新前の行データ（"p"）が出力されます。

    ```
    {
        "u":{
            <カラム名>:{
                "t":<カラムタイプ>,
                "h":<Whereハンドル>,
                "f":<フラグ>,
                "v":<カラム値>
            },
            <カラム名>:{
                "t":<カラムタイプ>,
                "h":<Whereハンドル>,
                "f":<フラグ>,
                "v":<カラム値>
            }
        },
        "p":{
            <カラム名>:{
                "t":<カラムタイプ>,
                "h":<Whereハンドル>,
                "f":<フラグ>,
                "v":<カラム値>
            },
            <カラム名>:{
                "t":<カラムタイプ>,
                "h":<Whereハンドル>,
                "f":<フラグ>,
                "v":<カラム値>
            }
        }
    }
    ```

    `Delete` イベント。削除された行のデータが出力されます。

    ```
    {
        "d":{
            <カラム名>:{
                "t":<カラムタイプ>,
                "h":<Whereハンドル>,
                "f":<フラグ>,
                "v":<カラム値>
            },
            <カラム名>:{
                "t":<カラムタイプ>,
                "h":<Whereハンドル>,
                "f":<フラグ>,
                "v":<カラム値>
            }
        }
    }
    ```

    | パラメータ         | タイプ   | 説明                    |
    | :---------- | :----- | :--------------------- |
    | カラム名    | 文字列 |  カラム名。  |
    | カラムタイプ    | 数値 |  カラムタイプ。詳細は[Column Type Code](#column-type-code)を参照してください。  |
    | Whereハンドル  | ブール値   |  この列が`Where`句のフィルタ条件となるかどうかを決定します。この列がテーブル上で一意である場合、`Whereハンドル`は`true`です。 |
    | フラグ       | 数値   |  カラムのビットフラグ。詳細は[Bit flags of columns](#bit-flags-of-columns)を参照してください。 |
    | カラム値   | 任意    | カラムの値。   |

### DDLイベント

+ **キー:**

    ```
    {
        "ts":<TS>,
        "scm":<スキーマ名>,
        "tbl":<テーブル名>,
        "t":2
    }
    ```

    | パラメータ         | タイプ   | 説明                    |
    | :---------- | :----- | :--------------------- |
    | TS          | 数値 |  DDL変更を実行するトランザクションのタイムスタンプ。    |
    | スキーマ名 | 文字列 |  DDL変更のスキーマ名。空の文字列である可能性があります。  |
    | テーブル名  | 文字列 |  DDL変更のテーブル名。空の文字列である可能性があります。 |

+ **値:**

    ```
    {
        "q":<DDLクエリ>,
        "t":<DDLタイプ>
    }
    ```

    | パラメータ       | タイプ   | 説明           |
    | :-------- | :----- | :------------ |
    | DDLクエリ | 文字列 | DDLクエリSQL |
    | DDLタイプ  | 文字列 | DDLタイプ。詳細は[DDL Type Code](#ddl-type-code)を参照してください。    |

### 解決済みイベント

+ **キー:**

    ```
    {
        "ts":<TS>,
        "t":3
    }
    ```

    | パラメータ         | タイプ   | 説明                                         |
    | :---------- | :----- | :------------------------------------------ |
    | TS          | 数値 | 解決済みのタイムスタンプ。このイベントよりも早いTSのイベントが送信されました。 |

+ **値:** なし

## イベントストリーム出力の例

このセクションでは、イベントストリームの出力ログを示して表示します。

上流で以下のSQLステートメントを実行し、MQパーティションの数が2であると仮定します。

{{< copyable "sql" >}}

```sql
CREATE TABLE test.t1(id int primary key, val varchar(16));
```

以下のLog 1とLog 3から、DDLイベントはすべてのMQパーティションにブロードキャストされ、解決済みイベントは各MQパーティションに定期的にブロードキャストされていることがわかります。

```
1. [partition=0] [key="{\"ts\":415508856908021766,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":2}"] [value="{\"q\":\"CREATE TABLE test.t1(id int primary key, val varchar(16))\",\"t\":3}"]
2. [partition=0] [key="{\"ts\":415508856908021766,\"t\":3}"] [value=]
3. [partition=1] [key="{\"ts\":415508856908021766,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":2}"] [value="{\"q\":\"CREATE TABLE test.t1(id int primary key, val varchar(16))\",\"t\":3}"]
4. [partition=1] [key="{\"ts\":415508856908021766,\"t\":3}"] [value=]
```

上流で以下のSQLステートメントを実行します:

{{< copyable "sql" >}}

```sql
BEGIN;
INSERT INTO test.t1(id, val) VALUES (1, 'aa');
```
```sql
INSERT INTO test.t1(id, val) VALUES (2, 'aa');
UPDATE test.t1 SET val = 'bb' WHERE id = 2;
INSERT INTO test.t1(id, val) VALUES (3, 'cc');
COMMIT;
```

+ 以下のログ5とログ6から、同じテーブルに対するRow Changedイベントが、プライマリキーに基づいて異なるパーティションに送信されることがわかります。ただし、同じ行の変更は同じパーティションに送信されるため、ダウンストリームがイベントを簡単に並行して処理できます。
+ ログ6から、トランザクション内で同じ行に対する複数の変更は、1つのRow Changedイベントのみで送信されます。
+ ログ8はログ7の繰り返しイベントです。Row Changedイベントは繰り返されることがありますが、各バージョンの最初のイベントが順番に送信されます。

```
5. [partition=0] [key="{\"ts\":415508878783938562,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":1},\"val\":{\"t\":15,\"v\":\"YWE=\"}}}]
6. [partition=1] [key="{\"ts\":415508878783938562,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":2},\"val\":{\"t\":15,\"v\":\"YmI=\"}}}]
7. [partition=0] [key="{\"ts\":415508878783938562,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":3},\"val\":{\"t\":15,\"v\":\"Y2M=\"}}}]
8. [partition=0] [key="{\"ts\":415508878783938562,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":3},\"val\":{\"t\":15,\"v\":\"Y2M=\"}}}]
```

アップストリームで以下のSQL文を実行します：

{{< copyable "sql" >}}

```sql
BEGIN;
DELETE FROM test.t1 WHERE id = 1;
UPDATE test.t1 SET val = 'dd' WHERE id = 3;
UPDATE test.t1 SET id = 4, val = 'ee' WHERE id = 2;
COMMIT;
```

+ ログ9は`Delete`タイプのRow Changedイベントです。このタイプのイベントには、プライマリキー列またはユニークインデックス列のみが含まれます。
+ ログ13とログ14はResolvedイベントです。Resolvedイベントは、このパーティション内で、Resolved TS（Row ChangedイベントおよびDDLイベントを含む）よりも小さいイベントがすべて送信されたことを意味します。

```
9. [partition=0] [key="{\"ts\":415508881418485761,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"d\":{\"id\":{\"t\":3,\"h\":true,\"v\":1}}}"]
10. [partition=1] [key="{\"ts\":415508881418485761,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"d\":{\"id\":{\"t\":3,\"h\":true,\"v\":2}}}"]
11. [partition=0] [key="{\"ts\":415508881418485761,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":3},\"val\":{\"t\":15,\"v\":\"ZGQ=\"}}}]
12. [partition=0] [key="{\"ts\":415508881418485761,\"scm\":\"test\",\"tbl\":\"t1\",\"t\":1}"] [value="{\"u\":{\"id\":{\"t\":3,\"h\":true,\"v\":4},\"val\":{\"t\":15,\"v\":\"ZWU=\"}}}]
13. [partition=0] [key="{\"ts\":415508881038376963,\"t\":3}"] [value=]
14. [partition=1] [key="{\"ts\":415508881038376963,\"t\":3}"] [value=]
```

## コンシューマー用のプロトコル解析

現在、TiCDCはTiCDCオープンプロトコルの標準解析ライブラリを提供していませんが、TiCDCのGolangバージョンおよびJavaバージョンの解析例が提供されています。本ドキュメントで提供されているデータ形式と、以下の例を参照して、コンシューマー向けのプロトコル解析を実装できます。

- [Golangの例](https://github.com/pingcap/tiflow/tree/master/cmd/kafka-consumer)
- [Javaの例](https://github.com/pingcap/tiflow/tree/master/examples/java)

## カラムタイプコード

`カラムタイプコード`は、Row Changedイベントの列データ型を表します。

| タイプ                   | コード | 出力例 | 説明 |
| :-------------------- | :--- | :------ | :-- |
| TINYINT/BOOLEAN          | 1    | {"t":1,"v":1} | |
| SMALLINT              | 2    | {"t":2,"v":1} | |
| INT                   | 3    | {"t":3,"v":123} | |
| FLOAT                 | 4    | {"t":4,"v":153.123} | |
| DOUBLE                | 5    | {"t":5,"v":153.123} | |
| NULL                  | 6    | {"t":6,"v":null} | |
| TIMESTAMP             | 7    | {"t":7,"v":"1973-12-30 15:30:00"} | |
| BIGINT                | 8    | {"t":8,"v":123} | |
| MEDIUMINT             | 9    | {"t":9,"v":123} | |
| DATE                  | 10/14   | {"t":10,"v":"2000-01-01"} | |
| TIME                  | 11   | {"t":11,"v":"23:59:59"} | |
| DATETIME              | 12   | {"t":12,"v":"2015-12-20 23:58:58"} | |
| YEAR                  | 13   | {"t":13,"v":1970} | |
| VARCHAR/VARBINARY     | 15/253   | {"t":15,"v":"test"} / {"t":15,"v":"\\\\x89PNG\\\\r\\\\n\\\\x1a\\\\n"} |  この値はUTF-8でエンコードされます。アップストリームのタイプがVARBINARYの場合、不可視文字がエスケープされます。 |
| BIT                   | 16   | {"t":16,"v":81} | |
| JSON                  | 245  | {"t":245,"v":"{\\"key1\\": \\"value1\\"}"} | |
| DECIMAL               | 246  | {"t":246,"v":"129012.1230000"} | |
| ENUM                  | 247  | {"t":247,"v":1} | |
| SET                   | 248  | {"t":248,"v":3} | |
| TINYTEXT/TINYBLOB     | 249  | {"t":249,"v":"5rWL6K+VdGV4dA=="} |  この値はBase64でエンコードされます。 |
| MEDIUMTEXT/MEDIUMBLOB | 250  | {"t":250,"v":"5rWL6K+VdGV4dA=="} |  この値はBase64でエンコードされます。 |
| LONGTEXT/LONGBLOB     | 251  | {"t":251,"v":"5rWL6K+VdGV4dA=="} |  この値はBase64でエンコードされます。 |
| TEXT/BLOB             | 252  | {"t":252,"v":"5rWL6K+VdGV4dA=="} |  この値はBase64でエンコードされます。 |
| CHAR/BINARY           | 254  | {"t":254,"v":"test"} / {"t":254,"v":"\\\\x89PNG\\\\r\\\\n\\\\x1a\\\\n"} |  この値はUTF-8でエンコードされます。アップストリームのタイプがBINARYの場合、不可視文字がエスケープされます。 |
| GEOMETRY              | 255  |  | サポートされていません。 |

## DDLタイプコード

`DDLタイプコード`は、DDLイベントのDDLステートメントタイプを表します。

| タイプ                              | コード |
| :-------------------------------- | :- |
| Create Schema                     | 1  |
| Drop Schema                       | 2  |
| Create Table                      | 3  |
| Drop Table                        | 4  |
| Add Column                        | 5  |
| Drop Column                       | 6  |
| Add Index                         | 7  |
| Drop Index                        | 8  |
| Add Foreign Key                   | 9  |
| Drop Foreign Key                  | 10 |
| Truncate Table                    | 11 |
| Modify Column                     | 12 |
| Rebase Auto ID                    | 13 |
| Rename Table                      | 14 |
| Set Default Value                 | 15 |
| Shard RowID                       | 16 |
| Modify Table Comment              | 17 |
| Rename Index                      | 18 |
| Add Table Partition               | 19 |
| Drop Table Partition              | 20 |
| Create View                       | 21 |
| Modify Table Charset And Collate  | 22 |
| テーブルパーティションの切り捨て | 23 |
| ビューの削除                   | 24 |
| テーブルの復旧                 | 25 |
| スキーマの文字セットと照合順序を変更 | 26 |
| テーブルのロック               | 27 |
| テーブルのアンロック           | 28 |
| テーブルの修復                 | 29 |
| TiFlash レプリカの設定         | 30 |
| TiFlash レプリカのステータスを更新 | 31 |
| プライマリキーの追加           | 32 |
| プライマリキーの削除           | 33 |
| シーケンスの作成               | 34 |
| シーケンスの変更               | 35 |
| シーケンスの削除               | 36 |

## カラムのビットフラグ

ビットフラグは、カラムの特定の属性を表します。

| ビット | 値 | 名前 | 説明 |
| :-- | :- | :- | :- |
| 1   | 0x01 | BinaryFlag          | カラムがバイナリエンコードされているかどうか。 |
| 2   | 0x02 | HandleKeyFlag       | カラムがハンドルインデックスカラムかどうか。 |
| 3   | 0x04 | GeneratedColumnFlag | カラムが生成されたカラムかどうか。     |
| 4   | 0x08 | PrimaryKeyFlag      | カラムがプライマリキーカラムかどうか。      |
| 5   | 0x10 | UniqueKeyFlag       | カラムがユニークインデックスカラムかどうか。  |
| 6   | 0x20 | MultipleKeyFlag     | カラムが複合インデックスカラムかどうか。   |
| 7   | 0x40 | NullableFlag        | カラムがNULL可能なカラムかどうか。       |
| 8   | 0x80 | UnsignedFlag        | カラムが符号なしカラムかどうか。     |

例：

カラムフラグの値が `85` の場合、そのカラムはNULL可能なカラムであるため、ユニークインデックスカラムであり、生成されたカラムであり、バイナリエンコードされたカラムです。

```
85 == 0b_101_0101
   == NullableFlag | UniqueKeyFlag | GeneratedColumnFlag | BinaryFlag
```

カラムの値が `46` の場合、そのカラムは複合インデックスカラムであり、プライマリキーカラムであり、生成されたカラムであり、ハンドルキーカラムです。

```
46 == 0b_010_1110
   == MultipleKeyFlag | PrimaryKeyFlag | GeneratedColumnFlag | HandleKeyFlag
```

> **注意:**
>
> + `BinaryFlag` は、カラムの型が BLOB/TEXT（TINYBLOB/TINYTEXT および BINARY/CHAR を含む）の場合のみ意味があります。上流カラムが BLOB 型の場合、`BinaryFlag` の値は `1` に設定されます。上流カラムが TEXT 型の場合、`BinaryFlag` の値は `0` に設定されます。
> + 上流からのテーブルのレプリケーションの際、TiCDC はハンドルインデックスとして[有効なインデックス](/ticdc/ticdc-overview.md#best-practices)を選択します。ハンドルインデックスカラムの `HandleKeyFlag` の値は `1` に設定されます。