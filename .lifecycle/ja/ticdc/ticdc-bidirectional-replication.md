---
title: バイダイレクショナルレプリケーション
summary: TiCDCのバイダイレクショナルレプリケーションの使用方法を学びます。

# バイダイレクショナルレプリケーション

v6.5.0からTiCDCは、2つのTiDBクラスタ間での双方向レプリケーションをサポートしています。この機能を使用すると、TiCDCを使用してマルチアクティブなTiDBソリューションを作成できます。

このセクションでは、2つのTiDBクラスタを使用した双方向レプリケーションの使用方法について説明します。

## バイダイレクショナルレプリケーションのデプロイ

TiCDCは、指定されたタイムスタンプ以降に発生した増分データ変更のみをダウンストリームクラスタにレプリケートします。バイダイレクショナルレプリケーションを開始する前に、次の手順を実行する必要があります。

1. （オプション）必要に応じて、データエクスポートツール[Dumpling](/dumpling-overview.md)およびデータインポートツール[TiDB Lightning](/tidb-lightning/tidb-lightning-overview.md)を使用して、2つのTiDBクラスタのデータを互いにインポートします。

2. 2つのTiDBクラスタ間に2つのTiCDCクラスタをデプロイします。クラスタのトポロジは次のとおりです。ダイアグラム内の矢印はデータフローの方向を示します。

    ![TiCDCのバイダイレクショナルレプリケーション](/media/ticdc/ticdc-bidirectional-replication.png)

3. アップストリームおよびダウンストリームクラスタのデータレプリケーションの開始時点を指定します。

    1. アップストリームおよびダウンストリームクラスタの時刻を確認します。2つのTiDBクラスタの場合、2つのクラスタのデータが特定の時点で一致していることを確認します。例えば、TiDB Aのデータの`ts=1`とTiDB Bのデータの`ts=2`が一致していることを確認します。

    2. チェンジフィードを作成する際に、アップストリームクラスタのチェンジフィードの`--start-ts`を対応する`tso`に設定します。つまり、アップストリームクラスタがTiDB Aの場合は`--start-ts=1`、TiDB Bの場合は`--start-ts=2`とします。

4. `--config`パラメータで指定された構成ファイルに、次の構成を追加します。 

    ```toml
    # バイダイレクショナルレプリケーションモードを有効にするかどうか
    bdr-mode = true
    ```

構成が有効になると、クラスタはバイダイレクショナルレプリケーションを実行できます。

## DDLの実行

バイダイレクショナルレプリケーションが有効になると、TiCDCはDDLステートメントをレプリケートしません。したがって、アップストリームとダウンストリームクラスタでそれぞれDDLステートメントを実行する必要があります。

一部のDDLステートメントは、テーブル構造の変更やデータ変更の時間順序の問題を引き起こす可能性があるため、レプリケーション後にデータの不整合を引き起こす可能性があります。したがって、バイダイレクショナルレプリケーションを有効にした後は、次の表に示すDDLステートメントのみを、アプリケーションの書き込み操作を停止することなく実行できます。

| イベント | changefeedエラーを引き起こすか | メモ |
|---|---|---|
| データベースを作成 | はい | アップストリームおよびダウンストリームクラスタでDDLステートメントを手動で実行した後、エラーは自動的に回復します。 |
| データベースを削除 | はい | changefeedを手動で再開し、DDLステートメントの`commitTs`を`--overwrite-checkpoint-ts`として指定して、エラーを回復する必要があります。 |
| テーブルを作成 | はい | アップストリームおよびダウンストリームクラスタでDDLステートメントを手動で実行した後、エラーは自動的に回復します。 |
| テーブルを削除 | はい | changefeedを手動で再開し、DDLステートメントの`commitTs`を`--overwrite-checkpoint-ts`として指定して、エラーを回復する必要があります。 |
| テーブルコメントを変更 | いいえ |  |
| インデックス名を変更 | いいえ |  |
| テーブルのインデックス可視性を変更 | いいえ |  |
| パーティションを追加 | はい | アップストリームおよびダウンストリームクラスタでDDLステートメントを手動で実行した後、エラーは自動的に回復します。 |
| パーティションを削除 | いいえ |  |
| ビューを作成 | いいえ |  |
| ビューを削除 | いいえ |  |
| 列のデフォルト値を変更 | いいえ |  |
| パーティションを再構成 | はい | アップストリームおよびダウンストリームクラスタでDDLステートメントを手動で実行した後、エラーは自動的に回復します。 |
| テーブルTTLを変更 | いいえ |  |
| テーブルからTTLを削除 | いいえ |  |
| **一意でない**インデックスを追加 | いいえ |  |
| **一意でない**インデックスを削除 | いいえ |  |

前述の表にないDDLステートメントを実行する必要がある場合は、次の手順を実行します。

1. すべてのクラスタのDDLを実行する必要があるテーブルで書き込み操作を一時停止します。
2. 対応するテーブルの書き込み操作が他のすべてのクラスタにレプリケートされた後、各TiDBクラスタですべてのDDLステートメントを手動で実行します。
3. DDLステートメントが実行されたら、書き込み操作を再開します。

## バイダイレクショナルレプリケーションの停止

アプリケーションがデータ書き込みを停止した後、それぞれのクラスタに特別なレコードを挿入できます。2つの特別なレコードを確認することで、2つのクラスタのデータが一致していることを確認できます。

確認が完了したら、バイダイレクショナルレプリケーションを停止するためにchangefeedを停止できます。

## 制限事項

- DDLの制限事項については、[DDLの実行](#DDLの実行)を参照してください。

- バイダイレクショナルレプリケーションクラスタは、書き込み競合を検出することができません。これにより、未定義の動作が発生する可能性があります。そのため、アプリケーション側で書き込み競合が発生しないようにする必要があります。

- バイダイレクショナルレプリケーションは2つ以上のクラスタをサポートしていますが、TiDB A -> TiDB B -> TiDB C -> TiDB Aのような循環レプリケーションのような複数のクラスタをサポートしていません。このようなトポロジでは、1つのクラスタが失敗すると、全体のデータレプリケーションに影響を与えます。そのため、複数のクラスタ間でバイダイレクショナルレプリケーションを有効にするには、各クラスタを他のすべてのクラスタと接続する必要があります。例えば、`TiDB A <-> TiDB B`、`TiDB B <-> TiDB C`、`TiDB C <-> TiDB A`。