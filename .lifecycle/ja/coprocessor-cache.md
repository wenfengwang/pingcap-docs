---
title: Coprocessor Cache
summary: Coprocessor Cacheの機能を学ぶ。
aliases: ['/docs/dev/coprocessor-cache/']
---

# Coprocessor Cache

TiDBインスタンスは、v4.0からTiKVへプッシュダウンされる計算結果をキャッシュすることができるようになり、これにより特定のシナリオで計算処理を高速化することが可能になりました。

## 設定

<CustomContent platform="tidb">

TiDBの設定ファイル内の`tikv-client.copr-cache`構成項目を介してCoprocessor Cacheを設定できます。Coprocessor Cacheの有効化と設定の詳細については、[TiDB Configuration File](/tidb-configuration-file.md#tikv-clientcopr-cache-new-in-v400)を参照してください。

</CustomContent>

<CustomContent platform="tidb-cloud">

Coprocessor Cache機能はデフォルトで有効化されています。キャッシュされるデータの最大サイズは1000 MBです。

</CustomContent>

## 機能の説明

+ SQL文が初めて実行された場合、実行結果はキャッシュされません。
+ 計算結果はTiDBのメモリにキャッシュされます。TiDBインスタンスが再起動されると、キャッシュは無効になります。
+ キャッシュはTiDBインスタンス間で共有されません。
+ プッシュダウンされた計算結果のみがキャッシュされます。キャッシュがヒットした場合でも、TiDBは後続の計算を実行する必要があります。
+ キャッシュの単位はリージョンです。リージョンにデータを書き込むことで、リージョンのキャッシュが無効になります。そのため、Coprocessor Cache機能は主にデータがあまり変更されないデータに影響します。
+ プッシュダウンされた計算リクエストが同じ場合、キャッシュがヒットします。通常は以下のシナリオでプッシュダウンされた計算リクエストが同じか部分的に同じです：
    - SQL文が同じ場合。たとえば、同じSQL文が繰り返し実行される場合。

        このシナリオでは、すべてのプッシュダウンされた計算リクエストは一貫しており、すべてのリクエストがプッシュダウンされた計算のキャッシュを使用できます。

    - SQL文に変化する条件が含まれており、他の部分が一貫している場合。変化する条件はテーブルまたはパーティションの主キーです。

        このシナリオでは、一部のプッシュダウンされた計算リクエストが以前のリクエストと同じであり、これらの計算リクエストはキャッシュされた（以前の）プッシュダウンされた計算結果を使用できます。

    - SQL文に複数の変化する条件が含まれており、他の部分が一貫している場合。変化する条件は複合インデックス列と完全に一致します。

        このシナリオでは、一部のプッシュダウンされた計算リクエストが以前のリクエストと同じであり、これらの計算リクエストはキャッシュされた（以前の）プッシュダウンされた計算結果を使用できます。

+ この機能はユーザーには透過的です。この機能の有効化または無効化は計算結果に影響を与えず、SQLの実行時間のみに影響を与えます。

## キャッシュの効果を確認する

Coprocessorのキャッシュ効果は、`EXPLAIN ANALYZE`を実行したり、Grafanaモニタリングパネルを表示することで確認できます。

### `EXPLAIN ANALYZE`を使用する

[`EXPLAIN ANALYZE`ステートメント](/sql-statements/sql-statement-explain-analyze.md)を使用して、[Operators for accessing tables](/choose-index.md#operators-for-accessing-tables)でキャッシュヒット率を表示できます。次の例を参照してください：

```sql
EXPLAIN ANALYZE SELECT * FROM t USE INDEX(a);
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| id                            | estRows   | actRows | task      | access object          | execution info                                                                                                                                                                                                                                           | operator info                  | memory                | disk |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
| IndexLookUp_6                 | 262400.00 | 262400  | root      |                        | time:620.513742ms, loops:258, cop_task: {num: 4, max: 5.530817ms, min: 1.51829ms, avg: 2.70883ms, p95: 5.530817ms, max_proc_keys: 2480, p95_proc_keys: 2480, tot_proc: 1ms, tot_wait: 1ms, rpc_num: 4, rpc_time: 10.816328ms, copr_cache_hit_rate: 0.75} |                                | 6.685169219970703 MB  | N/A  |
| ├─IndexFullScan_4(Build)      | 262400.00 | 262400  | cop[tikv] | table:t, index:a(a, c) | proc max:93ms, min:1ms, p80:93ms, p95:93ms, iters:275, tasks:4                                                                                                                                                                                           | keep order:false, stats:pseudo | 1.7549400329589844 MB | N/A  |
| └─TableRowIDScan_5(Probe)     | 262400.00 | 0       | cop[tikv] | table:t                | time:0ns, loops:0                                                                                                                                                                                                                                        | keep order:false, stats:pseudo | N/A                   | N/A  |
+-------------------------------+-----------+---------+-----------+------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------+-----------------------+------+
3 rows in set (0.62 sec)
```

実行結果の`execution info`列には、Coprocessor Cacheのヒット率を示す`copr_cache_hit_ratio`情報が表示されます。上記の例の`0.75`は、ヒット率が約75%であることを意味します。

### Grafanaモニタリングパネルを表示する

Grafanaでは、`tidb`ネームスペースの`distsql`サブシステム内の**copr-cache**パネルが表示されます。このパネルでは、Coprocessor Cacheのクラスタ全体でのヒット数、ミス数、およびキャッシュ破棄数が監視されます。