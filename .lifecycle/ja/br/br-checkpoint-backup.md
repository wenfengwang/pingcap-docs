---
title: チェックポイント バックアップ
summary: チェックポイントバックアップ機能について、その適用シナリオ、実装の詳細、使用法について学びます。
aliases: ["/tidb/dev/br-checkpoint"]
---

# チェックポイント バックアップ

スナップショットバックアップは、ディスクの枯渇やノードのクラッシュなどの復旧可能なエラーによって中断されることがあります。TiDB v6.5.0より前では、中断前にバックアップされたデータはエラーが解消された後も無効になり、バックアップを最初からやり直す必要がありました。大規模なクラスターの場合、これにはかなりの追加コストがかかります。

TiDB v6.5.0では、バックアップ＆リストア（BR）にチェックポイント バックアップ機能が導入され、中断されたバックアップを続行できるようになりました。この機能により、中断されたバックアップのほとんどのデータを保持できます。

## 適用シナリオ

TiDBクラスターが大規模で、障害後に再度バックアップする余裕がない場合は、チェックポイントバックアップ機能を使用できます。brコマンドラインツール（以下、「br」とします）は、バックアップされたシャードを定期的に記録します。これにより、次のバックアップ再試行では、異常な終了に近いバックアップ進捗を使用できます。

## 実装の詳細

スナップショットバックアップ中、`br`はテーブルを対応するキースペースにエンコードし、バックアップRPCリクエストを生成し、それをTiKVノードに送信します。バックアップリクエストを受け取った後、TiKVノードは要求された範囲内のデータをバックアップします。TiKVノードがあるRegionのデータのバックアップを完了するたびに、その範囲のバックアップ情報を`br`に返します。

`br`はTiKVノードによって返された情報を記録し、それが`br`がバックアップされたキーレンジを取得するのに役立ちます。チェックポイント バックアップ機能は、バックアップされたキーレンジを外部ストレージに定期的にアップロードし、バックアップされたキーレンジを永続化します。

`br`がバックアップを再試行する際、外部ストレージからバックアップされたキーレンジを読み取り、それをバックアップタスクのキーレンジと比較します。差分データによって、チェックポイントバックアップでまだバックアップする必要があるキーレンジを`br`が特定できます。

## 使用上の制限

チェックポイントバックアップはGCメカニズムに依存し、バックアップされたすべてのデータを回復することができません。以下のセクションでは詳細を説明します。

### GCよりも前のバックアップ再試行が必要

バックアップ中、`br`はバックアップスナップショットの`gc-safepoint`を定期的にPDに更新して、データがGarbage Collectionされるのを防ぎます。`br`が終了すると、`gc-safepoint`をタイムリーに更新できなくなります。その結果、次のバックアップ再試行の前に、データがGarbage Collectionされてしまう可能性があります。

この状況を避けるために、`br`はデフォルトで`gcttl`が指定されていない場合、`gcttl`パラメータを使用して`gc-safepoint`を約1時間保持します。必要に応じて、保持期間を延長するために`gcttl`パラメータを設定できます。

次の例では、`gcttl`を15時間（54000秒）に設定して、`gc-safepoint`の保持期間を延長しています。

```shell
br backup full \
--storage local:///br_data/ --pd "${PD_IP}:2379" \
--gcttl 54000
```

> **注記:**
>
> バックアップ前に作成された`gc-safepoint`は、スナップショットバックアップが完了した後に削除されます。手動で削除する必要はありません。

### 一部のデータを再度バックアップする必要がある

`br`がバックアップを再試行する際、バックアップされた一部のデータは再度バックアップする必要があります。これには、チェックポイントに記録されていないバックアップ中のデータや、バックアップが必要なデータが含まれます。

- エラーによって中断が発生した場合、`br`は終了前にバックアップされたデータのメタ情報を保持します。この場合、次回の再試行では、バックアップが必要なのはバックアップ中のデータだけです。

- システムによって`br`プロセスが中断された場合、`br`はバックアップされたデータのメタ情報を外部ストレージに保持できません。`br`は30秒ごとにメタ情報を永続化するため、中断される30秒前にバックアップされたデータは永続化されず、次回の再試行で再度バックアップする必要があります。