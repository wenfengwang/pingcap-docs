---
title: TiDBのスナップショットバックアップとリストアのアーキテクチャ
summary: TiDBのスナップショットバックアップとリストアのアーキテクチャについて学びます。

# TiDBのスナップショットバックアップとリストアのアーキテクチャ

この文書では、バックアップ＆リストア（BR）ツールを使用したTiDBのスナップショットバックアップとリストアのアーキテクチャおよびプロセスについて紹介します。

## アーキテクチャ

TiDBのスナップショットバックアップとリストアのアーキテクチャは次のとおりです：

![BRスナップショットバックアップとリストアアーキテクチャ](/media/br/br-snapshot-arch.png)

## バックアップのプロセス

クラスターのスナップショットバックアップのプロセスは以下のようになります：

![スナップショットバックアッププロセスの設計](/media/br/br-snapshot-backup-ts.png)

完全なバックアッププロセスは次のとおりです：

1. BRは`br backup full`コマンドを受け取ります。

    * バックアップの時点とストレージパスを取得します。

2. BRはバックアップデータをスケジュールします。

    * **GCを一時停止**: BRはTiDB GCの時間を構成し、[TiDB GCメカニズム](/garbage-collection-overview.md)によるバックアップデータのクリーンアップを防ぎます。
    * **TiKVおよびリージョン情報を取得**: BRは、すべてのTiKVノードのアドレスとデータの[リージョン](/tidb-storage.md#region)分布を取得するため、PDにアクセスします。
    * **TiKVにデータバックアップを要求**: BRはバックアップリクエストを作成し、すべてのTiKVノードに送信します。バックアップリクエストにはバックアップ時点、バックアップされるリージョン、およびストレージパスが含まれます。

3. TiKVはバックアップリクエストを受け付け、バックアップワーカーを開始します。

4. TiKVはデータをバックアップします。

    * **KVsをスキャン**: バックアップワーカーは、リーダーが存在するリージョンからバックアップ時点に対応するデータを読み取ります。
    * **SSTを生成**: バックアップワーカーは、データをメモリに保存されているSSTファイルに保存します。
    * **SSTをアップロード**: バックアップワーカーはSSTファイルをストレージパスにアップロードします。

5. BRは各TiKVノードからのバックアップ結果を受け取ります。

    * リージョンの変更によるバックアップデータのバックアップに失敗した場合（たとえば、TiKVノードがダウンしている場合）は、BRはバックアップを再試行します。
    * バックアップされなかったデータがあり、再試行できない場合、バックアップタスクは失敗します。
    * すべてのデータがバックアップされた後、BRはメタデータをバックアップします。

6. BRはメタデータをバックアップします。

    * **スキーマをバックアップ**: BRはテーブルのスキーマをバックアップし、テーブルデータのチェックサムを計算します。
    * **メタデータをアップロード**: BRはバックアップメタデータを生成し、それをストレージパスにアップロードします。バックアップメタデータにはバックアップのタイムスタンプ、テーブルおよび対応するバックアップファイル、データのチェックサム、ファイルチェックサムが含まれます。

## リストアのプロセス

クラスターのスナップショットリストアのプロセスは以下のようになります：

![スナップショットリストアプロセスの設計](/media/br/br-snapshot-restore-ts.png)

完全なリストアプロセスは次のとおりです：

1. BRは`br restore`コマンドを受け取ります。

    * データのストレージパスとリストアするデータベースまたはテーブルを取得します。
    * リストアするテーブルが存在し、リストアの要件を満たしているかどうかをチェックします。

2. BRはリストアデータをスケジュールします。

    * **リージョンのスケジュールを一時停止**: BRはリストア中の自動リージョンのスケジューリングを一時停止するようにPDにリクエストします。
    * **スキーマをリストア**: BRはバックアップデータのスキーマとリストアするデータベースおよびテーブルを取得します。新しく作成されたテーブルのIDはバックアップデータとは異なる場合があることに注意してください。
    * **リージョンの分割と分散**: BRは、バックアップデータに基づいてリージョンを割り当てるようPDにリクエストし（リージョンの分割）、リージョンをストレージノードに均等に分散するようスケジュールします（リージョンの分散）。各リージョンには指定されたデータ範囲 `[start key, end key)`があります。
    * **TiKVにデータリストアを要求**: BRはリージョン分割の結果に基づいて対応するTiKVノードにリストアリクエストを作成し送信します。リストアリクエストにはリストアするデータと書き換え規則が含まれます。

3. TiKVはリストアリクエストを受け付け、リストアワーカーを開始します。

    * リストアワーカーはリストアに必要なバックアップデータを計算します。

4. TiKVはデータをリストアします。

    * **SSTのダウンロード**: リストアワーカーはストレージパスから対応するSSTファイルをローカルディレクトリにダウンロードします。
    * **KVsの書き換え**: リストアワーカーは、新しいテーブルIDに応じてKVデータを書き換えます。つまり、[Key-Value](/tidb-computing.md#mapping-table-data-to-key-value)内の元のテーブルIDを新しいテーブルIDで置き換えます。リストアワーカーはインデックスIDも同じように書き換えます。
    * **SSTのインジェスト**: リストアワーカーは処理済みのSSTファイルをRocksDBに取り込みます。
    * **リストア結果の報告**: リストアワーカーはリストア結果をBRに報告します。

5. BRは各TiKVノードからのリストア結果を受け取ります。

    * `RegionNotFound`または`EpochNotMatch`によりリストアに失敗したデータがある場合（たとえば、TiKVノードがダウンしている場合）、BRはリストアを再試行します。
    * リストアされなかったデータがあり、再試行できない場合、リストアタスクは失敗します。
    * すべてのデータがリストアされた後、リストアタスクは成功します。

## バックアップファイル

### バックアップファイルの種類

スナップショットバックアップは、次の種類のファイルを生成します：

- `SST`ファイル：TiKVノードがバックアップしたデータを保存します。`SST`ファイルのサイズはリージョンのサイズと同等です。
- `backupmeta`ファイル：バックアップタスクのメタデータを保存し、すべてのバックアップファイルの数、各バックアップファイルのキー範囲、サイズ、およびハッシュ（sha256）値を含みます。
- `backup.lock`ファイル：同じディレクトリにデータを保存する複数のバックアップの競合を防ぎます。

### SSTファイルの命名形式

データをGoogle Cloud Storage（GCS）またはAzure Blob Storageにバックアップする場合、SSTファイルは`storeID_regionID_regionEpoch_keyHash_timestamp_cf`の形式で命名されます。名前のフィールドは以下のように説明されます：

- `storeID`はTiKVノードのIDです。
- `regionID`はリージョンのIDです。
- `regionEpoch`はリージョンのバージョン番号です。
- `keyHash`は範囲のstartKeyのハッシュ（sha256）値で、ファイルの一意性を保証します。
- `timestamp`はTiKVによって生成されたSSTファイルのUnixタイムスタンプです。
- `cf`はRocksDBのコラムファミリを示します（`cf`が`default`または`write`であるデータのみをリストアします）。

データをAmazon S3またはネットワークディスクにバックアップする場合、SSTファイルは`regionID_regionEpoch_keyHash_timestamp_cf`の形式で命名されます。名前のフィールドは以下のように説明されます：

- `regionID`はリージョンのIDです。
- `regionEpoch`はリージョンのバージョン番号です。
- `keyHash`は範囲のstartKeyのハッシュ（sha256）値で、ファイルの一意性を保証します。
- `timestamp`はTiKVによって生成されたSSTファイルのUnixタイムスタンプです。
- `cf`はRocksDBのコラムファミリを示します（`cf`が`default`または`write`であるデータのみをリストアします）。

### SSTファイルの保存形式

- SSTファイルの保存形式の詳細については、[RocksDB BlockBasedTable format](https://github.com/facebook/rocksdb/wiki/Rocksdb-BlockBasedTable-Format)を参照してください。
- SSTファイル内のバックアップデータのエンコーディング形式の詳細については、[テーブルデータをKey-Valueにマッピング](/tidb-computing.md#mapping-table-data-to-key-value)を参照してください。

### バックアップファイルの構造

GCSまたはAzure Blob Storageにデータをバックアップする場合、SSTファイル、`backupmeta`ファイル、`backup.lock`ファイルは次のような構造の同じディレクトリに保存されます：

```
.
└── 20220621
    ├── backupmeta
    |—— backup.lock
    ├── {storeID}-{regionID}-{regionEpoch}-{keyHash}-{timestamp}-{cf}.sst
    ├── {storeID}-{regionID}-{regionEpoch}-{keyHash}-{timestamp}-{cf}.sst
    └── {storeID}-{regionID}-{regionEpoch}-{keyHash}-{timestamp}-{cf}.sst
```

Amazon S3またはネットワークディスクにデータをバックアップする場合、SSTファイルは`storeID`に基づいてサブディレクトリに保存されます。構造は次のようになります：

```
.
└── 20220621
    ├── backupmeta
    |—— backup.lock
    ├── store1
    │   └── {regionID}-{regionEpoch}-{keyHash}-{timestamp}-{cf}.sst
    ├── store100
    │   └── {regionID}-{regionEpoch}-{keyHash}-{timestamp}-{cf}.sst
    ├── store2
    │   └── {regionID}-{regionEpoch}-{keyHash}-{timestamp}-{cf}.sst
    ├── store3
    ├── store4
    └── store5
```

## 関連項目

- [TiDBスナップショットバックアップとリストアガイド](/br/br-snapshot-guide.md)