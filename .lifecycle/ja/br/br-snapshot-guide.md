---
title: スナップショットバックアップおよび復元ガイド
summary: brコマンドラインツールを使用してTiDBのスナップショットをバックアップおよび復元する方法について学びます。
aliases: ['/tidb/dev/br-usage-backup/','/tidb/dev/br-usage-restore/','/tidb/dev/br-usage-restore-for-maintain/', '/tidb/dev/br-usage-backup-for-maintain/']
---

# スナップショットバックアップおよび復元ガイド

本書は、brコマンドラインツール（以下「br」とします）を使用してTiDBのスナップショットをバックアップおよび復元する方法について説明します。データのバックアップおよび復元を行う前には、まず[brコマンドラインツールをインストール](/br/br-use-overview.md#deploy-and-use-br)する必要があります。

スナップショットバックアップは、クラスタ全体のバックアップを実行するものです。これは[多重バージョン同時実行制御（MVCC）](/tidb-storage.md#mvcc)に基づいており、指定されたスナップショットのすべてのデータをターゲットストレージにバックアップします。バックアップデータのサイズは、クラスタ内の圧縮されたシングルレプリカのサイズとほぼ同じです。バックアップが完了すると、バックアップデータを空のクラスタまたは競合データを含まないクラスタ（同じスキーマまたは同じテーブルを含む）に復元したり、スナップショットバックアップの時点にクラスタを復元したり、クラスタレプリカの設定に従って複数のレプリカを復元できます。

基本的なバックアップと復元に加えて、スナップショットバックアップおよび復元は以下の機能も提供します。

* [指定した時点のデータをバックアップ](#back-up-cluster-snapshots)
* [指定したデータベースまたはテーブルを復元](#restore-a-database-or-a-table)

## クラスタスナップショットをバックアップする

> **注意:**
>
> - 以下の例は、Amazon S3のアクセスキーおよびシークレットキーが使用されてアクセス許可が付与されていることを想定しています。IAMロールを使用してアクセス許可を付与している場合は、`--send-credentials-to-tikv`を`false`に設定する必要があります。
> - 他のストレージシステムや認証方法を使用してアクセス許可を付与している場合は、[バックアップストレージ](/br/backup-and-restore-storages.md)に従ってパラメータ設定を調整してください。

TiDBクラスタのスナップショットをバックアップするには、`br backup full`コマンドを実行します。`br backup full --help`を実行してヘルプ情報を確認できます:

```shell
tiup br backup full --pd "${PD_IP}:2379" \
    --backupts '2022-09-08 13:30:00' \
    --storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}" \
    --ratelimit 128 \
```

上記のコマンドでは、

- `--backupts`: スナップショットの時点です。フォーマットは[TSO](/glossary.md#tso)またはタイムスタンプで、`400036290571534337`または`2018-05-11 01:42:23`などです。このスナップショットのデータがガベージコレクトされると、`br backup`コマンドはエラーを返し、`br`が終了します。このパラメータを指定しない場合、`br`はバックアップ開始時点に対応するスナップショットを選択します。
- `--storage`: バックアップデータの保存先アドレスです。スナップショットバックアップは、Amazon S3、Google Cloud Storage、およびAzure Blob Storageをバックアップストレージとしてサポートしています。上記のコマンドはAmazon S3を例にしています。詳細については、[外部ストレージサービスのURIフォーマット](/external-storage-uri.md)をご覧ください。
- `--ratelimit`: バックアップタスクを実行する **TiKVごとの** 最大速度です。単位はMiB/sです。

バックアップ中には、以下のようにターミナルに進捗バーが表示されます。進捗バーが100%に達すると、バックアップタスクが完了し、総バックアップ時間、平均バックアップ速度、バックアップデータのサイズなどの統計情報が表示されます。

```shell
フルバックアップ <-------------------------------------------------------------------------------> 100.00%
チェックサム <----------------------------------------------------------------------------------> 100.00%
*** ["フルバックアップ成功の概要"] *** [backup-checksum=3.597416ms] [backup-fast-checksum=2.36975ms] *** [total-take=4.715509333s] [BackupTS=435844546560000000] [total-kv=1131] [total-kv-size=250kB] [average-speed=53.02kB/s] [backup-data-size(after-compressed)=71.33kB] [Size=71330]
```

## スナップショットバックアップのバックアップ時点を取得する

多くのバックアップを管理するために、スナップショットバックアップの物理的な時刻を取得する必要がある場合は、次のコマンドを実行できます:

```shell
tiup br validate decode --field="end-version" \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}" | tail -n1
```

出力は次のようになり、物理的な時刻 `2022-09-08 13:30:00 +0800 CST` に対応します:

```
435844546560000000
```

## クラスタのスナップショットを復元する

スナップショットバックアップを復元するには、`br restore full`コマンドを実行します。`br restore full --help`を実行してヘルプ情報を確認できます:

次の例は、[前のバックアップスナップショット](#back-up-cluster-snapshots)をターゲットクラスタに復元します:

```shell
tiup br restore full --pd "${PD_IP}:2379" \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}"
```

復元中には、以下のようにターミナルに進捗バーが表示されます。進捗バーが100%に達すると、復元タスクが完了し、総復元時間、平均復元速度、総データサイズなどの統計情報が表示されます。

```shell
フル復元 <------------------------------------------------------------------------------> 100.00%
*** ["フル復元成功の概要"] *** [total-take=4.344617542s] [total-kv=5] [total-kv-size=327B] [average-speed=75.27B/s] [restore-data-size(after-compressed)=4.813kB] [Size=4813] [BackupTS=435844901803917314]
```

### データベースまたはテーブルを復元する

BRは、バックアップデータから指定したデータベースまたはテーブルの部分データを復元することをサポートしています。この機能を使用すると、不要なデータをフィルタリングして特定のデータベースまたはテーブルのみをバックアップできます。

**データベースを復元する**

特定のデータベースをクラスタに復元するには、`br restore db`コマンドを実行します。次の例は、バックアップデータから`test`データベースをターゲットクラスタに復元します:

```shell
tiup br restore db \
--pd "${PD_IP}:2379" \
--db "test" \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}"
```

このコマンドでは、`--db`で復元するデータベースの名前を指定します。

**テーブルを復元する**

単一のテーブルをクラスタに復元するには、`br restore table`コマンドを実行します。次の例は、バックアップデータから`test.usertable`テーブルをターゲットクラスタに復元します:

```shell
tiup br restore table --pd "${PD_IP}:2379" \
--db "test" \
--table "usertable" \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}"
```

このコマンドでは、`--db`で復元するデータベースの名前、`--table`で復元するテーブルの名前を指定します。

**テーブルフィルターを使用して複数のテーブルを復元する**

より複雑なフィルタルールで複数のテーブルを復元するには、`br restore full`コマンドを実行し、`--filter`または`-f`で[テーブルフィルター](/table-filter.md)を指定します。次の例は、`db*.tbl*`フィルタルールに一致するテーブルをバックアップデータからターゲットクラスタに復元します:

```shell
tiup br restore full \
--pd "${PD_IP}:2379" \
--filter 'db*.tbl*' \
--storage "s3://backup-101/snapshot-202209081330?access-key=${access-key}&secret-access-key=${secret-access-key}"
```

### `mysql`スキーマ内のテーブルを復元する

BR v5.1.0以降、スナップショットをバックアップする際、BRは`mysql`スキーマ内の**システムテーブル**をバックアップし、デフォルトではそれらを復元しません。BR v6.2.0以降、`--with-sys-table`を構成すると、**一部のシステムテーブル**のデータを復元します。

**BRでデータを復元できるシステムテーブル:**

```
+----------------------------------+
| mysql.columns_priv               |
| mysql.db                         |
| mysql.default_roles              |
| mysql.global_grants              |
| mysql.global_priv                |
| mysql.role_edges                 |
| mysql.tables_priv                |
| mysql.user                       |
| mysql.bind_info                  |
+----------------------------------+
```

**BRでデータを復元できないシステムテーブル:**

- 統計テーブル（`mysql.stat_*`）。ただし、統計は復元できます。[統計をバックアップする](/br/br-snapshot-manual.md#back-up-statistics)を参照してください。
- システム変数テーブル（`mysql.tidb`および`mysql.global_variables`）
- [その他のシステムテーブル](https://github.com/pingcap/tidb/blob/master/br/pkg/restore/systable_restore.go#L31)

```
+-----------------------------------------------------+
| capture_plan_baselines_blacklist                    |
| 列の統計情報の使用法 |
| gc_delete_range |
| gc_delete_range_done |
| global_variables |
| schema_index_usage |
| stats_buckets |
| stats_extended |
| stats_feedback |
| stats_fm_sketch |
| stats_histograms |
| stats_history |
| stats_meta |
| stats_meta_history |
| stats_table_locked |
| stats_top_n |
| tidb |
+-------------------------------------------------- ------------------- +

システム権限に関連するデータを復元する際は、次の点に注意してください。

- BRは、`user`を`cloud_admin`、`host`を`'％'`としてユーザデータを復元しません。このユーザはTiDB Cloud用に予約されています。クラスタ内に`cloud_admin`というユーザまたはロールを作成しないでください。なぜなら、`cloud_admin`に関連するユーザ権限を正しく復元できないからです。
- データの復元前に、BRは対象クラスタのシステムテーブルがバックアップデータと互換性があるかどうかをチェックします。ここでの「互換性」とは、次の条件すべてが満たされていることを指します。

    - 対象クラスタにはバックアップデータと同じシステムテーブルがあること。
    - 対象クラスタのシステム権限テーブルの**列の数**がバックアップデータと同じであること。列の順序は重要ではありません。
    - 対象クラスタのシステム権限テーブルの列がバックアップデータと互換性があること。列のデータ型が長さ付きの型（整数や文字列など）の場合、対象クラスタの長さはバックアップデータの長さ以上である必要があります。列のデータ型が`ENUM`型の場合、対象クラスタの`ENUM`値の数はバックアップデータのそれを含んでいる必要があります。

## パフォーマンスと影響

### スナップショットバックアップのパフォーマンスと影響

バックアップ機能はクラスタのパフォーマンス（トランザクションのレイテンシとQPS）にある影響を与えます。ただし、バックアップスレッドの数[`backup.num-threads`](/tikv-configuration-file.md#num-threads-1)を調整したり、クラスタを追加することで、その影響を緩和できます。

バックアップの影響を示すために、このドキュメントでは、いくつかのスナップショットバックアップのテストの結論をリストします。

-（5.3.0およびそれ以前）BRのバックアップスレッドがTiKVノードの合計CPUの75%を占めると、QPSは元のQPSの35%減少します。
-（5.4.0以降）TiKVノードにBRのスレッドが`8`個以下あり、クラスタの合計CPU使用率が80％以下である場合、クラスタへのBRタスクの影響（書き込みと読み取り）は最大でも20％です。
-（5.4.0以降）TiKVノードにBRのスレッドが`8`個以下あり、クラスタの合計CPU使用率が75％以下である場合、クラスタへのBRタスクの影響（書き込みと読み取り）は最大でも10％です。
-（5.4.0以降）TiKVノードにBRのスレッドが`8`個以下あり、クラスタの合計CPU使用率が60％以下である場合、BRタスクはクラスタにほとんど影響を与えません（書き込みと読み取り）。

バックアップタスクの影響を手動で制御するために、以下の方法を使用できます。ただし、これらの方法はバックアップタスクの速度を低下させつつ、クラスタへの影響も制限します。

- `--ratelimit`パラメータを使用してバックアップタスクの速度を制限します。このパラメータは**外部ストレージへのバックアップファイルの保存速度**を制限します。バックアップファイルの総サイズを計算する際には、`圧縮後のバックアップデータサイズ`をベンチマークとして使用してください。
- バックアップタスクで使用するスレッドの数を制限するために、TiKV構成項目[`backup.num-threads`](/tikv-configuration-file.md#num-threads-1)を調整します。内部テストによると、BRがバックアップタスクに対して`8`個以上のスレッドを使用しない場合、かつクラスタの合計CPU使用率が60％以下である場合、読み書きのワークロードに関係なく、バックアップタスクはクラスタにほとんど影響を与えません。

バックアップがクラスタのパフォーマンスに与える影響は、バックアップスレッドの数を制限することで軽減できますが、これはバックアップのパフォーマンスに影響を与えます。前述のテストから、バックアップ速度はバックアップスレッドの数に比例することがわかります。スレッド数が少ない場合、バックアップ速度は約20 MiB/スレッドです。たとえば、単一のTiKVノードで5つのバックアップスレッドを使用すると、バックアップ速度は100 MiB/sになります。

### スナップショットリストアのパフォーマンスと影響

- データのリストア中、TiDBはTiKVのCPU、ディスクIO、およびネットワーク帯域リソースを最大限に利用しようとします。したがって、実行中のアプリケーションに影響を与えないように、バックアップデータを空のクラスタにリストアすることを推奨します。
- バックアップデータのリストア速度は、クラスタ構成、展開状況、および実行中のアプリケーションに密接に関連しています。内部テストでは、単一のTiKVノードのリストア速度は100 MiB/sに達することがあります。スナップショットリストアのパフォーマンスと影響は、異なるユーザシナリオで異なり、実際の環境でテストする必要があります。

## 関連項目

* [TiDB バックアップおよびリストアのユースケース](/br/backup-and-restore-use-cases.md)
* [br コマンドラインマニュアル](/br/use-br-command-line-tool.md)
* [TiDB スナップショットバックアップおよびリストアアーキテクチャ](/br/br-snapshot-architecture.md)