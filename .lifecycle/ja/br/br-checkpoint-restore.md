---
title: チェックポイントのリストア
summary: チェックポイントのリストア機能について、適用シナリオや実装の詳細、使用方法などの情報をご覧ください。
---

# チェックポイントのリストア

スナップショットのリストアやログのリストアは、ディスクの枯渇やノードクラッシュなどの回復可能なエラーによって中断されることがあります。以前のTiDB v7.1.0までは、エラーを解消した後でも中断前のリストア進捗は無効となり、リストアを最初からやり直さなければなりませんでした。大規模なクラスターの場合、これにはかなりの追加コストがかかります。

TiDB v7.1.0からは、バックアップ＆リストア（BR）には、中断したリストアを継続するチェックポイントリストア機能が導入され、中断したリストアの進捗の大部分を保持できるようになります。

## 適用シナリオ

TiDBクラスターが大規模であり、障害後にリストアをやり直す余裕がない場合は、チェックポイントのリストア機能を使用できます。`br`コマンドラインツール（以下、`br`と呼びます）は、定期的にリストアされたシャードを記録します。これにより、次回のリストア再試行では、異常終了に近いリカバリ進行ポイントを使用できます。

## 実装の詳細

チェックポイントのリストアの実装は、スナップショットリストアとログのリストアの2つの部分に分かれています。

### スナップショットリストア

スナップショットのリストアの実装は、[スナップショットバックアップ](/br/br-checkpoint-backup.md#implementation-details)に類似しています。`br`は、キー範囲（リージョン）内のすべてのSSTファイルをバッチでリストアします。リストアが完了すると、`br`はこの範囲と復元されたクラスターテーブルのテーブルIDを記録します。チェックポイントのリストア機能は、定期的に新しいリストア情報を外部ストレージにアップロードするため、復元されたキー範囲を永続化できます。

`br`がリストアを再試行する際、チェックポイントのリストアから復元されたキー範囲を外部ストレージから読み取り、それに対応するテーブルIDと一致させます。リストア中、`br`はチェックポイントのリストアで記録されたオーバーラップするキー範囲と同じテーブルIDをスキップします。

`br`がリストアを再試行する前にテーブルを削除した場合、再試行中に新しく作成されたテーブルのテーブルIDは、チェックポイントのリストアで以前に記録されたテーブルIDと異なります。この場合、`br`は以前のチェックポイントのリストア情報をバイパスし、テーブルを再度リストアします。これにより、新しいIDを持つ同じテーブルは、古いIDのチェックポイントのリストア情報を無視し、新しいIDに対応する新しいチェックポイントのリストア情報を記録します。

指定されたタイムスタンプのデータはMVCC（多重バージョン同時実行制御）メカニズムを使用して無順序で書き込むことができます。

スナップショットリストアを使用してデータベースまたはテーブルのDDLをリストアする場合、`ifExists`パラメータが追加されます。既に作成された既存のデータベースやテーブルについては、`br`は自動的にリストアをスキップします。

### ログのリストア

ログのリストアは、TiKVノードでバックアップされたデータメタデータ（メタKV）をタイムスタンプの順に復元するプロセスです。チェックポイントのリストアはまず、メタKVデータを基にバックアップクラスターと復元クラスターの1対1のIDマッピング関係を確立します。これにより、異なるリストア再試行間でもメタKVのIDが一貫しているため、メタKVを再度リストアできます。

スナップショットバックアップファイルとは異なり、ログバックアップファイルの範囲は重複する場合があります。そのため、キー範囲を直接リカバリ進行のメタデータとして使用することはできません。さらに、大量のログバックアップファイルがあるかもしれません。ただし、各ログバックアップファイルはログバックアップのメタデータ内で固定された位置を持っています。つまり、ログバックアップのメタデータ内で一意の位置を割り当てることができます。

ログバックアップのメタデータにはファイルメタデータの配列が含まれています。配列内の各ファイルメタデータは、複数のログバックアップファイルで構成されるファイルを表します。ファイルメタデータには、連結ファイル内のログバックアップファイルのオフセットとサイズが記録されています。そのため、`br`はトリプル`(ログバックアップメタデータ名、ファイルメタデータの配列オフセット、ログバックアップファイルの配列オフセット)`を使用して、ログバックアップファイルを一意に識別できます。

## 使用上の制限事項

チェックポイントのリストアにはGCメカニズムが依存しており、復元されたすべてのデータを記録することはできません。以下ではその詳細について説明します。

### GCが一時停止します

ログのリストア中は、復元されたデータの順序が無順序であるため、キーの削除レコードがその書き込みレコードよりも前に復元される可能性があります。このタイミングでGCがトリガーされると、そのキーのすべてのデータが削除され、その後の書き込みレコードのGCができなくなります。この状況を避けるため、`br`はログのリストア中にGCを一時停止します。`br`が途中で終了した場合でも、GCは一時停止したままとなります。

ログのリストアが完了すると、GCは手動で起動することなく自動的に再開されます。しかし、リストアを続行することを決定しない場合は、以下の方法で手動でGCを有効にできます。

`br`がGCを一時停止する原則は、`SET config tikv gc.ratio-threshold = -1.0`を実行して`gc.ratio-threshold`を負の数に設定することで、GCを一時停止することです。[`gc.ratio-threshold`](/tikv-configuration-file.md#ratio-threshold)の値を変更することで、手動でGCを有効にできます。たとえば、その値をデフォルト値にリセットするには、`SET config tikv gc.ratio-threshold = 1.1`を実行します。

### 一部のデータを再度リストアする必要があります

`br`がリストアを再試行する際、中断前に復元された一部のデータを再度リストアする必要があります。これには、リストアされているデータとチェックポイントで記録されていないデータが含まれます。

- エラーによって中断された場合、`br`は終了前に復元されたデータのメタ情報を保持します。この場合、次回の再試行では、再度リストアする必要があるのは復元中のデータのみです。

- システムによって`br`プロセスが中断された場合、`br`は復元されたデータのメタ情報を外部ストレージに保存できません。`br`は30秒ごとにメタ情報を保持するため、終了直前の30秒以内に復元されたデータは保存されず、次回の再試行でもう一度リストアする必要があります。

### リストア中にクラスターデータを変更しないでください

リストアが失敗した後、クラスターに書き込み、削除、またはテーブルを作成しないでください。なぜなら、バックアップデータにはテーブルの名前の変更に関するDDL操作が含まれる可能性があるからです。クラスターデータを変更すると、チェックポイントのリストアは外部操作によって削除または存在するテーブルが生じたかどうかを判断できず、次回のリストア再試行の正確性に影響を与えます。