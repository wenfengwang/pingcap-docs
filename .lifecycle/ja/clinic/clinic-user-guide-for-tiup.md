---
title: PingCAP Clinicを使用したクラスタのトラブルシューティング
summary: PingCAP Clinicドキュメント診断サービスを使用してクラスタの問題をリモートでトラブルシューティングし、TiUPを使用してデプロイされたTiDBクラスタまたはDMクラスタのクラスタ状態を素早くチェックする方法を学びます。

# PingCAP Clinicを使用したクラスタのトラブルシューティング

TiUPを使用してデプロイされたTiDBクラスタとDMクラスタでは、PingCAP Clinic診断サービス（PingCAP Clinic）を使用して、リモートでクラスタの問題をトラブルシューティングし、[Diagクライアント（Diag）](https://github.com/pingcap/diag)とClinicサーバーを使用してクラスタ状態をローカルで素早くチェックすることができます。

> **注：**
>
> - このドキュメントは、TiUPを使用して自己ホスト環境にデプロイされたクラスタにのみ適用されます。Kubernetes上でTiDB Operatorを使用してデプロイされたクラスタについては、[TiDB Operator環境用のPingCAP Clinic](https://docs.pingcap.com/tidb-in-kubernetes/stable/clinic-user-guide)を参照してください。
>
> - PingCAP Clinicは、TiDB Ansibleを使用してデプロイされたクラスタからのデータ収集をサポートしていません。

## ユーザシナリオ

- [リモートでクラスタの問題をトラブルシューティングする](#troubleshoot-cluster-problems-remotely)

    - クラスタに問題が発生した場合、PingCAPから[サポートを受ける](/support.md)必要がある場合、Diagを使用して診断データを収集し、収集したデータをClinicサーバーにアップロードし、データアクセスリンクをテクニカルサポートスタッフに提供できます。
    - クラスタに問題が発生した場合、問題を直ちに解析できない場合、Diagを使用してデータを収集して後で解析することができます。

- [クラスタの状態をローカルで素早くチェックする](#perform-a-quick-check-on-the-cluster-status-locally)

    現時点でクラスタが安定して稼働している場合でも、潜在的な安定リスクを検出するために、クラスタを定期的にチェックする必要があります。PingCAP Clinicが提供するローカルクイックチェック機能を使用して、クラスタの潜在的な健康リスクを特定できます。ローカルチェックは構成のみをチェックします。メトリックスやログなどをチェックするには、診断データをClinicサーバーにアップロードし、ヘルスレポート機能を使用することをお勧めします。

## 前提条件

PingCAP Clinicを使用する前に、PingCAP Clinicで提供されたデータを収集するためのコンポーネントであるDiagをインストールし、データをアップロードするための環境を準備する必要があります。

1. Diagをインストールします。

   - コントロールマシンにTiUPをインストール済みの場合、次のコマンドを実行してDiagをインストールします。

        ```bash
        tiup install diag
        ```

    - Diagをインストール済みの場合、次のコマンドを使用してDiagを最新バージョンにアップグレードできます。

        ```bash
        tiup update diag
        ```

    > **注：**
    >
    > - インターネット接続がないクラスタの場合、Diagを展開する必要があります。詳細については、[TiUPを使用したオフライン展開：方法2](/production-deployment-using-tiup.md#deploy-tiup-offline)を参照してください。
    > - Diagは、v5.4.0以降のTiDB Serverオフラインミラーパッケージでのみ提供されています。

2. アクセストークン（トークン）を取得して設定します。

    Diagを介して収集したデータをアップロードする際に、ユーザ認証にトークンが必要です。既にトークンを設定した場合は、そのトークンを再利用してこの手順をスキップできます。

    トークンを取得するには、次の手順を実行します。

    - Clinicサーバーにログインします。

        <SimpleTab groupId="clinicServer">
        <div label="国際ユーザー向けClinicサーバー" value="clinic-us">

        [国際ユーザー向けClinicサーバー](https://clinic.pingcap.com): データは米国のAWSに保存されています。

        </div>
        <div label="中国本土のユーザー向けClinicサーバー" value="clinic-cn">

        [中国本土のユーザー向けClinicサーバー](https://clinic.pingcap.com.cn): データは中国（北京）地域のAWSに保存されています。

        </div>

        </SimpleTab>

    - クラスタページの右下隅にあるアイコンをクリックし、**Diagツールのアクセストークンを取得**を選択し、ポップアップウィンドウの中の**+**をクリックします。表示されるトークンをコピーして保存してください。

        ![トークンを取得](/media/clinic-get-token.png)

    > **注：**
    >
    > - Clinicサーバーに初めてアクセスする場合は、トークンを取得する前に、[PingCAP Clinicのクイックスタート](/clinic/quick-start-with-clinic.md#prerequisites)を参照して環境を準備する必要があります。
    > - データのセキュリティ保護のため、TiDBではトークンが作成された際にのみトークンが表示されます。トークンを失った場合は、古いトークンを削除して新しいトークンを作成してください。
    > - トークンはデータのアップロードにのみ使用されます。

    - 次に、Diagでトークンを設定します。たとえば：

        ```bash
        tiup diag config clinic.token ${token-value}
        ```

3. Diagで`region`を設定します。

    `region`は、データのパッキングに使用される暗号化証明書とデータのアップロード先のサービスを決定します。たとえば：

    > **注：**
    >
    > - Diag v0.9.0およびそれ以降のバージョンでは、`region`の設定がサポートされています。
    > - Diag v0.9.0より前のバージョンでは、デフォルトでデータが中国地域のClinicサーバーにアップロードされます。これらのバージョンでは、`region`を設定するには、`tiup update diag`コマンドを実行してDiagを最新バージョンにアップグレードし、その後、Diagで`region`を設定してください。

    <SimpleTab groupId="clinicServer">
    <div label="国際ユーザー向けClinicサーバー" value="clinic-us">

    国際ユーザー向けClinicサーバーを使用する場合、次のコマンドを使用して`region`を`US`に設定します：

    ```bash
    tiup diag config clinic.region US
    ```

    </div>
    <div label="中国本土のユーザー向けClinicサーバー" value="clinic-cn">

    中国本土のユーザー向けClinicサーバーを使用する場合、次のコマンドを使用して`region`を`CN`に設定します：

    ```bash
    tiup diag config clinic.region CN
    ```

    </div>

    </SimpleTab>

4. （オプション）ログのマスキングを有効にします。

    TiDBは詳細なログ情報を提供する場合、ログに機密情報（例：ユーザデータ）が出力される可能性があります。ローカルログとClinicサーバーで機密情報の漏洩を避けたい場合は、TiDB側でログのマスキングを有効にすることができます。詳細については、[log redaction](/log-redaction.md#log-redaction-in-tidb-side)を参照してください。

## リモートでクラスタの問題をトラブルシューティング

Diagを使用して、TiDBクラスタとDMクラスタから監視データや構成情報を含む診断データを素早く収集できます。

### ステップ 1. 収集するデータをチェックします

Diagで収集できるデータの全リストについては、[PingCAP Clinic Diagnostic Data](/clinic/clinic-data-instruction-for-tiup.md)を参照してください。

後続の診断の効率を高めるために、監視データや構成情報を含む完全な診断データを収集することをお勧めします。詳細については、[クラスタからデータを収集する](#step-2-collect-data)を参照してください。

### ステップ 2. データを収集します

Diagを使用して、TiUPを使用してデプロイされたTiDBクラスタとDMクラスタからデータを収集できます。

1. Diagのデータ収集コマンドを実行します。

    たとえば、現在の時刻を基準にして4時間前から2時間前までの診断データを収集する場合は、次のコマンドを実行します：

    <SimpleTab>
    <div label="TiDBクラスタ">

    ```bash
    tiup diag collect ${cluster-name} -f="-4h" -t="-2h"
    ```

    </div>
    <div label="DMクラスタ">

    ```bash
    tiup diag collectdm ${dm-cluster-name} -f="-4h" -t="-2h"
    ```

    </div>
    </SimpleTab>

    データ収集のためのパラメータの説明：

    - `-f/--from`：データ収集の開始時刻を指定します。このパラメータを指定しない場合、デフォルトの開始時刻は現在時刻の2時間前です。タイムゾーンを変更するには、`-f="12:30 +0800"`の構文を使用します。このパラメータでタイムゾーン情報を指定しない場合、`+0800`などのタイムゾーン情報がない場合、デフォルトでUTCタイムゾーンが使用されます。
    - `-t/--to`：データ収集の終了時刻を指定します。このパラメータを指定しない場合、デフォルトの終了時刻は現時刻です。タイムゾーンを変更するには、`-f="12:30 +0800"`の構文を使用します。このパラメータでタイムゾーン情報を指定しない場合、`+0800`などのタイムゾーン情報がない場合、デフォルトでUTCタイムゾーンが使用されます。

    パラメータの使用に関するヒント：

    データ収集時に、その他のパラメータを指定することができます。すべてのパラメータについては、`tiup diag collect -h`または`tiup diag collectdm -h`コマンドを実行してください。

    > **注：**
    >
    > - Diagはデフォルトでシステム変数データ（db_vars）を収集しません。このデータを収集するには、データベースにアクセス可能なユーザ名とパスワードを追加で提供する必要があります。なお、このデータベースではシステム変数への読み取りアクセスが有効にされている必要があります。
    > - Diagはデフォルトでパフォーマンスデータ（`perf`）とデバッグデータ（`debug`）を収集しません。
    > - すべての診断データ（システム変数を含む）を収集するには、次のコマンドを使用してください。`tiup diag collect <cluster-name> --include="system,monitor,log,config,db_vars,perf,debug"`。

    - `-l`: ファイル転送の帯域制限で、単位はKbit/sで、デフォルト値は `100000` です（scpの `-l` パラメータ）。
    - `-N/--node`: 指定したノードからのみデータを収集します。形式は `ip:port` です。
    - `--include`: 特定の種類のデータのみを収集します。オプションの値は `system`, `monitor`, `log`, `config`, `db_vars` です。2種類以上を含めるには、各種類の間に `,` を使用します。
    - `--exclude`: 特定の種類のデータを収集しません。オプションの値は `system`, `monitor`, `log`, `config`, `db_vars` です。2種類以上を除外するには、各種類の間に `,` を使用します。

    コマンドを実行すると、Diag はすぐにデータの収集を開始しません。代わりに、Diag は推定データサイズとターゲットのデータ保存パスを出力して、続行するかどうかを確認するための情報を提供します。例:

    ```bash
    収集するデータの推定サイズ:
    ホスト               サイズ       ターゲット
    ----               ----       ------
    172.16.7.129:9090  43.57 MB   1775 metrics, 圧縮済み
    172.16.7.87        0 B        /tidb-deploy/tidb-4000/log/tidb_stderr.log
    ... ...
    172.16.7.179       325 B      /tidb-deploy/tikv-20160/conf/tikv.toml
    合計              2.01 GB    (不正確)
    これらのデータは /home/user/diag-fNTnz5MGhr6 に保存されます
    続行しますか？ [y/N]: (デフォルト=N)
    ```

2. `Y` を入力してデータの収集を開始することを確認します。

   データの収集には時間がかかります。収集するデータの容量によって時間が異なります。例えば、テスト環境では、1 GBのデータを収集するのに約10分かかります。

   収集が完了すると、Diag は収集されたデータが存在するフォルダのパスを提供します。例:

    ```bash
    収集されたデータは /home/user/diag-fNTnz5MGhr6 に保存されます
    ```

### Step 3. ローカルでデータを表示（オプション）

収集されたデータはデータソースに基づいて個々のサブディレクトリに保存されます。これらのサブディレクトリはそれぞれのマシン名とポート番号に基づいて命名されます。各ノードの設定、ログその他のファイルの保存場所は、TiDB クラスターの実際のサーバー上の相対的な保存パスと同じです。

- システムおよびハードウェアの基本情報：`insight.json`
- システムの `/etc/security/limits.conf` 内容：`limits.conf`
- カーネルパラメータリスト：`sysctl.conf`
- カーネルログ：`dmesg.log`
- データ収集中のネットワーク接続：`ss.txt`
- 構成データ：各ノードの `config.json` ディレクトリ
- クラスター自体のメタ情報：`meta.yaml`（このファイルは収集されたデータを保存するディレクトリの最上位に存在します）
- 監視データ：`/monitor` ファイルディレクトリ。監視データはデフォルトで圧縮されており、直接表示することはできません。監視データの JSON ファイルを直接表示するには、データの収集時に `--compress-metrics=false` パラメータを使用して圧縮を無効にしてください。

### Step 4. データのアップロード

PingCAP 技術サポートスタッフにクラスターの診断データを提供するためには、まずデータを Clinic サーバーにアップロードし、その後取得したデータアクセスリンクをスタッフに送信する必要があります。Clinic サーバーは、診断データを安全に保存および共有するクラウドサービスです。

クラスターのネットワーク接続に応じて、データをアップロードするための次の方法のいずれかを選択できます：

- 方法 1: クラスターが存在するネットワークがインターネットにアクセスできる場合、[アップロードコマンドを使用してデータを直接アップロード](#method-1-upload-directly) できます。
- 方法 2: クラスターが存在するネットワークがインターネットにアクセスできない場合は、[データをまとめてからアップロード](#method-2-pack-and-upload-data)する必要があります。

> **注意:**
>
> アップロード前に Diag でトークンまたは `region` を設定していない場合、Diag はアップロードの失敗を報告し、トークンまたは `region` の設定を促します。トークンを設定するには、[前提条件の第二ステップ](#prerequisites)を参照してください。

#### 方法 1. 直接アップロード

クラスターが存在するネットワークがインターネットにアクセスできる場合、[Step 2: Collect data](#step-2-collect-data) で収集したデータの存在するフォルダを使用して次のコマンドを実行して、データを直接アップロードできます:

{{< copyable "shell-regular" >}}

```bash
tiup diag upload
```

アップロードが完了すると、出力に `Download URL` が表示されます。`Download URL` のリンクを開いてアップロードされたデータを表示するか、リンクを以前に連絡した PingCAP 技術サポートスタッフに送信できます。

#### 方法 2. データのまとめてからアップロード

クラスターが存在するネットワークがインターネットにアクセスできない場合、イントラネットでデータをまとめてから、データパッケージをインターネットにアクセスできるデバイスを使用して Clinic サーバーにアップロードする必要があります。詳細な操作手順は次のとおりです:

1. [Step 2. Collect data](#step-2-collect-data) で取得した収集されたデータを次のコマンドを実行してまとめます:

    ```bash
    tiup diag package ${filepath}
    ```

    パッケージング中、Diag はデータを同時に暗号化および圧縮します。テスト環境では、800 MBのデータが57 MBに圧縮されました。以下は出力の例です:

    ```bash
    コンポーネント `diag` の開始: /root/.tiup/components/diag/v0.7.0/diag package diag-fNTnz5MGhr6
    パッケージされたデータセットが /home/user/diag-fNTnz5MGhr6.diag に保存されました
    ```

    パッケージングが完了すると、データは `.diag` フォーマットにパッケージ化されます。`.diag` ファイルは Clinic サーバーにアップロードされた後にのみ解読および表示できます。Clinic サーバーに直接収集されたデータを転送する場合は、別の方法でデータを圧縮して転送できます。

2. インターネットにアクセスできるデバイスから、圧縮されたデータパッケージをアップロードします:

    ```bash
    tiup diag upload ${filepath}
    ```

    以下は出力の例です:

    ```bash
    [root@Copy-of-VM-EE-CentOS76-v1 user]# tiup diag upload /home/user/diag-fNTnz5MGhr6
    コンポーネント `diag` の開始: /root/.tiup/components/diag/v0.7.0/diag upload /home/user/diag-fNTnz5MGhr6
    >>>>>>>>>>>>>>>>>>>>>>>>>>>>>><>>>>>>>>>
    完了！
    Download URL: "https://clinic.pingcap.com.cn/portal/#/orgs/4/clusters/XXXX"
    ```

3. アップロードが完了すると、`Download URL` のリンクを開いてアップロードされたデータを表示するか、リンクを以前に連絡した PingCAP 技術サポートスタッフに送信できます。

## クラスターの状態をローカルで簡易的にチェック

Diag を使用して、クラスターの状態をローカルで簡易的にチェックすることができます。クラスターが現在安定して稼働している場合でも、定期的にクラスターをチェックし、潜在的な安定リスクを検出することは重要です。PingCAP Clinic が提供するローカル簡易チェック機能を使用して、クラスターの潜在的な健康リスクを特定できます。ローカルチェックは構成のみをチェックします。メトリクスおよびログなどの他の項目をチェックするには、診断データを Clinic サーバーにアップロードし、ヘルスレポート機能を使用することが推奨されます。

1. 構成データを収集:

    ```bash
    tiup diag collect ${cluster-name} --include="config"
    ```

    構成ファイルのデータは比較的小さいです。収集後、デフォルトで現在のパスに収集されたデータが保存されます。テスト環境では、18ノードのクラスターの構成ファイルのデータサイズは10 KB未満です。

2. 構成データの診断:

    ```bash
    tiup diag check ${subdir-in-output-data}
    ```

    上記のコマンドの `${subdir-in-output-data}` は収集されたデータを保存するパスであり、このパスに `meta.yaml` ファイルが存在します。

3. 診断結果の表示:

    診断結果はコマンドラインで返されます。例:

    ```bash
    コンポーネント `diag` の開始: /root/.tiup/components/diag/v0.7.0/diag check diag-fNTnz5MGhr6

    # 診断結果
    lili 2022-01-24T09:33:57+08:00

    ## 1. クラスター基本情報
    - クラスターID: 7047403704292855808
    - クラスター名: lili
    - クラスターバージョン: v5.3.0

    ## 2. サンプリング情報
    - サンプルID: fNTnz5MGhr6
    - サンプリング日付: 2022-01-24T09:33:57+08:00
    - サンプル内容:: [system monitor log config]
## 3. 診断結果、潜在的な構成問題を含む
この検査で、22のルールが実行されました。

**1**つのルールの結果が異常であり、サポートチームとさらに議論する必要がありました。

以下は、異常の詳細です。

### 診断結果の要約
構成ルールはすべてPingCAPのOnCall Serviceから派生しています。

構成ルールの結果が異常である場合、クラスタが障害を引き起こす可能性があります。

**1**つの異常な結果がありました。

#### 診断結果ファイルを保存するパス

ルール名: tidb-max-days
- RuleID: 100
- Variation: TidbConfig.log.file.max-days
- 詳細はこちらをご覧ください: https://s.tidb.io/msmo6awg
- チェック結果:
  TidbConfig_172.16.7.87:4000   TidbConfig.log.file.max-days:0   警告
  TidbConfig_172.16.7.86:4000   TidbConfig.log.file.max-days:0   警告
  TidbConfig_172.16.7.179:4000   TidbConfig.log.file.max-days:0   警告

結果レポートおよび記録は、diag-fNTnz5MGhr6/report-220125153215に保存されています。

## FAQ

1. データのアップロードに失敗した場合、再度アップロードできますか？

    はい。データのアップロードはブレークポイントアップロードをサポートしています。アップロードに失敗した場合、直接再度アップロードできます。

2. データをアップロードした後、返されたデータアクセスリンクを開けません。どうすればよいですか？

    まずClinic Serverにログインしてください。ログイン成功後もリンクを開けない場合は、データへのアクセス権を持っているかどうかを確認してください。持っていない場合は、データの所有者にアクセス権を取得してください。権限を取得した後、Clinic Serverにログインしてリンクを再度開いてください。

3. Clinic Serverにアップロードしたデータはどのくらい保管されますか？

    最長で180日です。180日後でもClinic Serverページでアップロードしたデータをいつでも削除できます。