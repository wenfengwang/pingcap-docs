---
title: PingCAP Clinicクイックスタートガイド
summary: PingCAP Clinicを使用してクラスタ診断データを素早く収集、アップロード、表示する方法を学びます。
---

# PingCAP Clinicクイックスタートガイド

このドキュメントでは、PingCAP Clinic診断サービス（PingCAP Clinic）を使用して、クラスタの診断データを素早く収集、アップロード、表示する方法について説明します。

PingCAP Clinicには、2つのコンポーネントが含まれています：[Diagクライアント](https://github.com/pingcap/diag)（Diagと略します）、およびクリニックサーバークラウドサービス（クリニックサーバーと略します）。これら2つのコンポーネントの詳細については、[PingCAP Clinic概要](/clinic/clinic-introduction.md)を参照してください。

## ユーザシナリオ

- PingCAPの技術サポートからリモートで助けを求めてクラスタの問題を正確に特定し、迅速に解決するために、Diagで診断データを収集し、収集したデータをクリニックサーバーにアップロードし、そのデータのアクセスリンクを技術サポートに提供することができます。
- クラスタが正常に動作しており、クラスタの状態を確認する必要がある場合には、Diagを使用して診断データを収集し、そのデータをクリニックサーバーにアップロードし、ヘルスレポートの結果を表示することができます。

> **注記:**
>
> - データを収集しアップロードするための以下の方法は、[TiUPを使用して展開されたクラスタ](/production-deployment-using-tiup.md)にのみ適用されます。Kubernetes上でTiDB Operatorを使用して展開されたクラスタに関しては、[TiDB Operator環境用のPingCAP Clinic](https://docs.pingcap.com/tidb-in-kubernetes/stable/clinic-user-guide)を参照してください。
> - PingCAP Clinicによって収集された診断データは、クラスタ問題のトラブルシューティングにのみ使用されます。

## 必要条件

PingCAP Clinicを使用する前に、Diagをインストールしアップロード用の環境を準備する必要があります。

1. TiUPがインストールされたコントロールマシンで、次のコマンドを実行してDiagをインストールします：

    ```bash
    tiup install diag
    ```

2. クリニックサーバーにログインします。

    <SimpleTab groupId="clinicServer">
    <div label="国際ユーザー用クリニックサーバー" value="clinic-us">

    [国際ユーザー用クリニックサーバー](https://clinic.pingcap.com)にアクセスし、「TiDBアカウントでサインイン」を選択してTiDB Cloudログインページにアクセスします。TiDB Cloudアカウントを持っていない場合は、そのページで作成してください。

    > **注記:**
    >
    > TiDB Cloudアカウントは、SSOモードでクリニックサーバーにログインするためにのみ使用され、TiDB Cloudサービスにアクセスするために必須ではありません。

    </div>

    <div label="中国本土ユーザー用クリニックサーバー" value="clinic-cn">

    [中国本土ユーザー用クリニックサーバー](https://clinic.pingcap.com.cn)にアクセスし、「AskTUGでサインイン」を選択してAskTUGコミュニティログインページにアクセスします。AskTUGアカウントを持っていない場合は、そのページで作成してください。

    </div>
    </SimpleTab>

3. クリニックサーバーで組織を作成します。組織はTiDBクラスタのコレクションです。作成した組織に診断データをアップロードできます。

4. データをアップロードするためのアクセストークンを取得します。Diagを使用して収集したデータをアップロードする際には、データを安全に分離するためのユーザ認証用のトークンが必要です。既にクリニックサーバーからトークンを取得している場合は、そのトークンを再利用できます。

    トークンを取得するには、クラスターページの右下にあるアイコンをクリックし、「Diagツール用のアクセストークンを取得」を選択し、ポップアップウィンドウで「+」をクリックします。表示されるトークンをコピーして保存してください。

    ![トークンの例](/media/clinic-get-token.png)

    > **注記:**
    >
    > - データセキュリティのため、TiDBはトークン情報を作成した場合にのみ表示します。情報を失った場合は、古いトークンを削除し、新しいトークンを作成できます。
    > - トークンはデータのアップロードにのみ使用されます。

5. Diagでトークンと`region`を設定します。

    - `clinic.token`を設定するには、次のコマンドを実行します：

        ```bash
        tiup diag config clinic.token ${token-value}
        ```

    - `clinic.region`を設定するには、次のコマンドを実行します：

    `region`は、データをパッキングするために使用する暗号化証明書と、データをアップロードするターゲットサービスを決定します。例：

    > **注記:**
    >
    > - Diag v0.9.0以降のバージョンでは`region`の設定がサポートされています。
    > - Diag v0.9.0より前のバージョンでは、デフォルトでデータが中国リージョンのクリニックサーバーにアップロードされます。これらのバージョンで`region`を設定するには、`tiup update diag`コマンドを実行してDiagを最新バージョンにアップグレードし、その後にDiagで`region`を設定してください。

    <SimpleTab groupId="clinicServer">
    <div label="国際ユーザー用クリニックサーバー" value="clinic-us">

    国際ユーザー用クリニックサーバーを使用する場合は、次のコマンドを実行して`region`を`US`に設定します：

    ```bash
    tiup diag config clinic.region US
    ```

    </div>
    <div label="中国本土ユーザー用クリニックサーバー" value="clinic-cn">

    中国本土ユーザー用クリニックサーバーを使用する場合は、次のコマンドを実行して`region`を`CN`に設定します：

    ```bash
    tiup diag config clinic.region CN
    ```

    </div>
    </SimpleTab>

6. (オプション)ログの非表示を有効にします。

    TiDBが詳細なログ情報を提供する場合、ログには機密情報（例：ユーザデータ）が含まれることがあります。ローカルログとクリニックサーバーで機密情報が漏洩するのを防ぐために、TiDB側でログの非表示を有効にすることができます。詳細については、[ログの非表示](/log-redaction.md#log-redaction-in-tidb-side)を参照してください。

## 手順

1. Diagを実行して診断データを収集します。

    たとえば、現在時刻を基準に4時間前から2時間前までの診断データを収集する場合、次のコマンドを実行してください：

    ```bash
    tiup diag collect ${cluster-name} -f="-4h" -t="-2h"
    ```

    コマンドを実行した後、Diagはすぐにデータの収集を開始しません。代わりに、出力での予想データサイズと対象データの格納パスを提供し、続行するかどうかを確認します。データの収集を開始することを確認するには、「Y」を入力してください。

    収集が完了すると、Diagは収集されたデータが配置されているフォルダのパスを提供します。

2. 収集されたデータをクリニックサーバーにアップロードします。

    > **注記:**
    >
    > アップロードするデータ（収集されたデータを含む圧縮ファイル）のサイズは、**3 GBを超えてはなりません**。それ以外の場合、データのアップロードに失敗します。

    - クラスタが所在するネットワークがインターネットにアクセスできる場合は、次のコマンドを使用して収集したデータのあるフォルダを直接アップロードできます：

        {{< copyable "shell-regular" >}}

        ```bash
        tiup diag upload ${filepath}
        ```

        アップロードが完了すると、出力に`Download URL`が表示されます。

        > **注記:**
        >
        > この方法でデータをアップロードする際には、Diag v0.9.0以降のバージョンが必要です。Diagのバージョンは、実行した際に確認できます。Diagのバージョンが0.9.0より前の場合は、`tiup update diag`コマンドを使用してDiagを最新バージョンにアップグレードできます。

    - クラスタが所在するネットワークがインターネットにアクセスできない場合は、収集したデータをパッケージ化してアップロードする必要があります。詳細については、[方法2.データのパックとアップロード](/clinic/clinic-user-guide-for-tiup.md#method-2-pack-and-upload-data)を参照してください。

3. アップロードが完了したら、コマンドの出力から`Download URL`を取得します。

    デフォルトでは、診断データにはクラスタ名、クラスタのトポロジ情報、収集された診断データ内のログコンテンツ、および収集したデータ内のメトリクスに基づいて再構築されたGrafanaダッシュボード情報が含まれています。

    このデータを使用してクラスタ問題のトラブルシューティングを行うこともできますし、データのアクセスリンクをPingCAPの技術サポートスタッフに提供してリモートトラブルシューティングを支援することもできます。

4. ヘルスレポートの結果を表示する

    データがアップロードされると、クリニックサーバーはデータを自動的にバックグラウンドで処理します。ヘルスレポートは約5〜15分で生成されます。診断データのリンクを開いて「ヘルスレポート」をクリックすると、レポートを表示できます。

## 次の手順

- [PingCAP Clinic概要](/clinic/clinic-introduction.md)
- [PingCAP Clinicを使用したクラスタのトラブルシューティング](/clinic/clinic-user-guide-for-tiup.md)
- [PingCAP Clinic診断データ](/clinic/clinic-data-instruction-for-tiup.md)