---
title: シャードされたテーブルからのデータのマージと移行
summary: DM がシャードされたテーブルからのデータのマージと移行を行う方法を学ぶ。
aliases: ['/docs/tidb-data-migration/dev/feature-shard-merge/']
---

# シャードされたテーブルからのデータのマージと移行

このドキュメントでは、Data Migration（DM）によって提供されるシャーディングサポート機能について紹介します。この機能により、上流の MySQL または MariaDB インスタンスの同じまたは異なるテーブルスキーマのテーブルのデータを、下流の TiDB の同じテーブルにマージおよび移行することができます。これにより、上流の DML ステートメントの移行だけでなく、複数の上流シャードテーブルにおける DDL ステートメントによるテーブルスキーマ変更の移行も調整することができます。

## 概要

DM は、複数の上流シャードテーブルのデータを TiDB の1つのテーブルにマージおよび移行する機能をサポートしています。マイグレーション中、各シャードテーブルの DDL および DDL の前後の DML を調整する必要があります。使用シナリオについて、DM は2つの異なるモードをサポートしています：悲観モードと楽観モード。

> **注意：**
>
> - シャードされたテーブルからのデータのマージおよび移行を行うには、タスク構成ファイルで `shard-mode` を設定する必要があります。
> - マージには DM がデフォルトで悲観モードを使用します。（文書に特別な記述がない場合、悲観モードをデフォルトで使用してください。）
> - 楽観モードの原則と制限を理解していない場合は、このモードの使用をお勧めしません。それ以外の場合は、移行の中断やデータの整合性の失敗などの深刻な結果を引き起こす可能性があります。

### 悲観モード

上流のシャードテーブルが DDL ステートメントを実行すると、このシャードテーブルのマイグレーションは中断されます。その後、他のすべてのシャードテーブルが同じ DDL を実行した後、DDL は下流で実行され、データ移行タスクが再開されます。このモードの利点は、下流に移行されたデータに何も問題がないことを確実にすることができます。詳細については、[悲観モードにおけるシャードマージ](/dm/feature-shard-merge-pessimistic.md) を参照してください。

### 楽観モード

DM は、上流のシャードテーブルで実行される DDL を自動的に他のシャードテーブルと互換性のあるステートメントに変更し、それを下流に移行します。これにより、どのシャードテーブルの DML 移行もブロックすることはありません。このモードの利点は、DDL の処理中にデータ移行をブロックしない点です。ただし、不適切な使用は、移行の中断やデータの整合性の失敗などの問題を引き起こす可能性があります。詳細については、[楽観モードにおけるシャードマージ](/dm/feature-shard-merge-optimistic.md) を参照してください。

### 対比

| 悲観モード   | 楽観モード   |
| :----------- | :----------- |
| DDL を実行するシャードテーブルは DML の移行が中断される | DDL を実行するシャードテーブルは DML の移行が継続される |
| 各シャードテーブルの DDL 実行順およびステートメントは同じである必要がある | 各シャードテーブルは互いにテーブルスキーマを互換性のある状態に保つだけで良い |
| シャードグループ全体が一貫した後に DDL が下流に移行する | 各シャードテーブルの DDL はすぐに下流に影響を及ぼす |
| 誤った DDL 操作は検知後に遮断することができる | 誤った DDL 操作は下流に移行され、検知前に上流と下流のデータの不整合を引き起こす可能性があります |