---
title: ペシミスティックモードでのシャーディングテーブルからのデータマージとマイグレーション
summary: DM がペシミスティックモード（デフォルトモード）で提供するシャーディングサポートによる、データマージとマイグレーションについて学びます。
---

# ペシミスティックモードでのシャーディングテーブルからのデータマージとマイグレーション

このドキュメントでは、Data Migration（DM）が提供するペシミスティックモード（デフォルトモード）でのシャーディングサポート機能について紹介します。この機能を使用すると、上流の MySQL や MariaDB インスタンスの同じテーブルスキーマを持つテーブルのデータを、下流の TiDB の同じテーブルにマージおよびマイグレーションできます。

## 制限

DM は、ペシミスティックモードでの以下のシャーディング DDL 使用制限を持ちます：

- 論理的な**シャーディンググループ**（1 つの下流テーブルにマージおよびマイグレーションする必要のあるすべてのシャーディングテーブルから構成される）において、1 つのタスクを使用してシャーディングテーブルのソースを正確に使用するように、マイグレーションを実行することが制限されています。
- 論理的な**シャーディンググループ**において、同じ DDL ステートメントはすべての上流シャーディングテーブルで同じ順序で実行される必要があります（スキーマ名とテーブル名は異なっていても構いません）、現在の DDL 操作が完全に終了しない限り、次の DDL ステートメントは実行できません。
    - たとえば、`table_1` に `column A` を追加する前に` column B` を追加する場合、`table_2` に` column B` を追加する前に `column A` を追加することはできません。異なる順序で DDL ステートメントを実行することはサポートされていません。
- シャーディンググループにおいて、対応する DDL ステートメントは、すべての上流シャーディングテーブルで実行される必要があります。
    - たとえば、`DM-worker-2` に対応する 1 つまたは複数の上流シャーディングテーブルに DDL ステートメントが実行されていない場合、DDL ステートメントを実行した他の DM-worker は、上流の DDL ステートメントを受信するためにマイグレーションタスクを一時停止します。
- シャーディンググループのマイグレーションタスクは、`DROP DATABASE`/`DROP TABLE` をサポートしていません。
    - DM-worker の同期ユニットは、上流シャーディングテーブルの` DROP DATABASE`/`DROP TABLE` ステートメントを自動的に無視します。
- シャーディンググループのマイグレーションタスクは、`TRUNCATE TABLE` をサポートしていません。
    - DM-worker の同期ユニットは、上流シャーディングテーブルの` TRUNCATE TABLE` ステートメントを自動的に無視します。
- シャーディンググループのマイグレーションタスクは、`RENAME TABLE` をサポートしますが、以下の制限があります（オンライン DDL は他のソリューションでサポートしています）：
    - 1 つのテーブルは他のテーブルで使用されていない新しい名前にのみ変更できます。
    - 1 つの`RENAME TABLE` ステートメントには 1 つの`RENAME` 操作のみを含めることができます。
- シャーディンググループのマイグレーションタスクでは、各 DDL ステートメントが 1 つのテーブルにのみ関連する操作である必要があります。
- 増分レプリケーションタスクの開始時に各シャーディングテーブルのテーブルスキーマが同じである必要があります。これにより、異なるシャーディングテーブルの DML ステートメントが確定したテーブルスキーマを持つ下流にマイグレートし、その後のシャーディング DDL ステートメントを正しくマッチおよびマイグレートできるようにします。
- [テーブル経路](/dm/dm-table-routing.md) ルールを変更する必要がある場合、すべてのシャーディング DDL ステートメントのマイグレーションが完了するのを待たなければなりません。
    - シャーディング DDL ステートメントのマイグレーション中に、`dmctl` を使用して`router-rules` を変更した場合、エラーが報告されます。
- DDL ステートメントの実行中に新しいテーブルを作成する必要がある場合、新しく作成したテーブルのスキーマが新しく変更されたテーブルスキーマと同じであることを確認する必要があります。
    - たとえば、最初に`table_1` と `table_2` が初めは 2 つの列（a、b）を持ち、シャーディング DDL 操作後に 3 つの列（a、b、c）を持つ場合、新たに作成されたテーブルも 3 つの列（a、b、c）を持っている必要があります。
- DDL ステートメントを受信した DM-worker がタスクを一時停止して他の DM-worker が自身の DDL ステートメントを受信するのを待つため、データマイグレーションの遅延が増加します。

## 背景

現在、DM は`ROW`フォーマットのバイナリログを使用してマイグレーションタスクを実行しています。バイナリログにはテーブルスキーマ情報が含まれません。`ROW`バイナリログを使用してデータをマイグレートするとき、上流のテーブルを複数下流のテーブルにマイグレートしていない場合、下流テーブルのテーブルスキーマを更新できる上流テーブルの DDL 操作しか存在しません。`ROW`バイナリログは自己記述の性質を持っていると考えられます。マイグレーションプロセス中、DML ステートメントはカラム値と下流テーブルのテーブルスキーマに従って適切に構築できます。

しかし、シャーディングテーブルのマージおよびマイグレーションのプロセスでは、上流のテーブルで DDL ステートメントが実行されてテーブルスキーマが変更された場合、カラム値によって生成される DML ステートメントと実際の下流テーブルのテーブルスキーマとの不整合を避けるために、追加の操作が必要です。

以下は簡単な例です：

![shard-ddl-example-1](/media/dm/shard-ddl-example-1.png)

上記の例では、マージプロセスが単純化されており、上流に 2 つの MySQL インスタンスが存在し、それぞれ 1 つのテーブルが存在すると仮定します。マイグレーションが開始されると、2 つのシャーディングテーブルのテーブルスキーマバージョンは`スキーマ V1`としてマークされ、DDL ステートメントの実行後のテーブルスキーマバージョンは`スキーマ V2`としてマークされます。

マイグレーションプロセス中、上流の 2 つのシャーディングテーブルから受信したバイナリログデータが以下の時間順序を持つと仮定します：

1. マイグレーションが開始されると、DM-worker の同期ユニットは 2 つのシャーディングテーブルから`スキーマ V1`の DML イベントを受信します。
2. `t1` で、インスタンス 1 からのシャーディング DDL イベントが受信されます。
3. `t2` から、同期ユニットはインスタンス 1 から`スキーマ V2`の DML イベントを受信します。しかし、インスタンス 2 からは、今でも`スキーマ V1`の DML イベントが受信されます。
4. `t3` で、インスタンス 2 からのシャーディング DDL イベントが受信されます。
5. `t4` から、同期ユニットはインスタンス 2 からも`スキーマ V2`の DML イベントを受信します。

シャーディングテーブルの DDL ステートメントがマイグレーションプロセス中に処理されないと仮定します。インスタンス 1 の DDL ステートメントが下流にマイグレートされた後、下流のテーブルスキーマは`スキーマ V2`に変更されます。しかし、インスタンス 2 については、DM-worker の同期ユニットは` t2` から` t3` の間、`スキーマ V1`の DML イベントを受信しています。したがって、`スキーマ V1`の DML ステートメントが下流にマイグレートされると、DML ステートメントとテーブルスキーマの不整合がエラーを引き起こし、データは正常にマイグレートできません。

## 原則

このセクションでは、ペシミスティックモードでのマージシャーディングテーブルのプロセスで DM が DDL ステートメントをどのようにマイグレートするかについて、上記の例に基づいて説明します。

![shard-ddl-flow](/media/dm/shard-ddl-flow.png)

この例では、`DM-worker-1` は MySQL インスタンス 1 からデータをマイグレートし、`DM-worker-2` は MySQL インスタンス 2 からデータをマイグレートします。`DM-master` は複数の DM-worker 間での DDL マイグレーションを調整します。`DM-worker-1` が DDL ステートメントを受信する場合、DDL マイグレーションプロセスは次のように単純化されます：

1. `DM-worker-1` は`t1` で MySQL インスタンス 1 から DDL ステートメントを受信し、対応する DDL および DML ステートメントのデータマイグレーションを一時停止し、DDL 情報を`DM-master` に送信します。
2. `DM-master` は受信した DDL 情報に基づいて、この DDL ステートメントのマイグレーションを調整する必要があると判断し、この DDL ステートメント用のロックを作成し、この DDL ステートメントの所有者として同時に`DM-worker-1` をマークします。
3. `DM-worker-2` は`t3` で MySQL インスタンス 2 から DDL ステートメントを受信し、この DDL ステートメントのデータマイグレーションを一時停止し、DDL 情報を`DM-master` に送信します。
4. `DM-master` は受信した DDL 情報に基づいて、この DDL ステートメントのロックが既に存在すると判断し、直接的にロック情報を`DM-worker-2` に送信します。
5. マイグレーションタスクが開始されると、上流 MySQL インスタンス内のシャーディングテーブルの情報およびデプロイメントトポロジ情報に基づいて、`DM-master` はこの DDL ステートメントをすべての上流シャーディングテーブルが受信したと判断し、DDL ロックの所有者（`DM-worker-1`）にこの DDL ステートメントを下流にマイグレートするよう要求します。
6. `DM-worker-1` は、Step #2 で受信した DDL ロック情報に基づいて DDL ステートメント実行要求を検証し、この DDL ステートメントを下流にマイグレートし、結果を`DM-master` に送信します。もしこの操作が成功した場合、`DM-worker-1` は` t2` から開始される次の DML ステートメントをマイグレートし続けます。
7. `DM-master` は、DDL が正常に実行されたことをロックの所有者から受信し、DDL ステートメントを待っている他のすべての DM-worker（`DM-worker-2`）にこの DDL ステートメントを無視するように要求し、`t4` から開始される次の DML ステートメントをマイグレートし続けます。

DM が複数の DM-worker 間でのシャーディング DDL マイグレーションを処理する特性は、以下のようにまとめることができます：

- タスクの設定とDMクラスターの展開トポロジ情報に基づいて、`DM-master`にロジカルなシャーディンググループを構築し、DDL マイグレーションを調整します。グループメンバーは、マイグレーションタスクから分割された各サブタスクを処理する DM-worker です）。
- 各 DM-worker は、バイナリログイベントから DDL ステートメントを受信すると、それを `DM-master` に送信します。
- `DM-master` は、各 DM-worker から受信した DDL 情報とシャーディンググループ情報に基づいて、DDL ロックを作成または更新します。
- シャーディンググループのすべてのメンバーが同じ特定の DDL ステートメントを受信した場合、これは上流のシャードテーブルのDDL 実行前のすべての DML ステートメントが完全にマイグレーションされたことを示し、この DDL ステートメントを実行できます。その後、 DM は後続の DML ステートメントのマイグレーションを継続できます。
- [テーブルルーター](/dm/dm-table-routing.md) によって変換された上流のシャードされたテーブルのDDL ステートメントは、ダウンストリームで実行されるDDL ステートメントと一致している必要があります。したがって、このDDL ステートメントは DDL オーナーによって1回だけ実行すればよく、他のすべての DM-worker はこのDDL ステートメントを無視できます。

上記の例では、各 DM-worker に対応する上流の MySQL インスタンスに統合する必要があるシャードテーブルが1つだけです。しかし、実際のシナリオでは、1つの MySQL インスタンスで複数のシャードスキーマ内の複数のシャードテーブルを統合する必要がある可能性があります。そして、これが発生すると、シャーディング DDL マイグレーションの調整がより複雑になります。

1. 各 DM-worker は、独立して上流の MySQL インスタンス内の複数のシャードテーブルから構成される対応するシャーディンググループのDDL ステートメントのマイグレーションを調整します。
2. DM-worker がすべてのシャードテーブルのDDL ステートメントを受信した後、DDL 情報を `DM-master` に送信します。
3. `DM-master` は、受信したDDL 情報を基に、DM-workers から構成されるシャーディンググループのDDL マイグレーションを調整します。
4. すべての DM-workers からDDL 情報を受信した後、`DM-master` はDDL ロックオーナー（特定の DM-worker）にDDL ステートメントの実行を要求します。
5. DDL ロックオーナーはDDL ステートメントを実行し、結果を `DM-master` に返します。その後、オーナーはDDL マイグレーションの内部調整中に以前に無視された DML ステートメントのマイグレーションを再開します。
6. `DM-master` がオーナーがDDL ステートメントを正常に実行したことを確認した後、すべての他の DM-worker にマイグレーションを継続するよう要求します。
7. すべての他の DM-workers は、DDL マイグレーションの内部調整中に以前に無視された DML ステートメントのマイグレーションをそれぞれ再開します。
8. 再度無視された DML ステートメントのマイグレーションが完了した後、すべての DM-workers は通常のマイグレーションプロセスを再開します。