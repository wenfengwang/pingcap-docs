---
title: DMセーフモード
summary: DMセーフモードの目的、動作原理、使用方法を紹介します。

# DMセーフモード

セーフモードは、DMが増分レプリケーションを実行するための特別な動作モードです。セーフモードでは、DM増分レプリケーションコンポーネントがバイナリログイベントをレプリケートする際に、ダウンストリームで実行する前にすべての `INSERT` および `UPDATE` ステートメントを強制的に書き換えます。

セーフモードでは、1つのバイナリログイベントが再度ダウンストリームに安全にレプリケートされ、冪等性が保証されます。そのため、増分レプリケーションが *セーフ* になります。

データレプリケーションタスクをチェックポイントから再開した後、DMは一部のバイナリログイベントを繰り返しレプリケートすることがあります。これにより以下の問題が発生します:

- 増分レプリケーション中に DML の実行とチェックポイントの書き込みが同時に行われません。チェックポイントの書き込みとダウンストリームデータベースへのデータ書き込みの操作はアトミックではありません。したがって、**DMが異常終了すると、チェックポイントは終了ポイントの前の復元ポイントのみを記録する可能性があります**。
- DMがレプリケーションタスクを再起動し、チェックポイントから増分レプリケーションを再開する際、チェックポイントと終了ポイントの間の一部のデータは異常終了前にすでに処理されている可能性があります。これにより、**一部のSQLステートメントが繰り返し実行**されます。
- `INSERT` ステートメントが繰り返し実行されると、プライマリキーまたはユニークインデックスに競合が発生し、レプリケーションの失敗を引き起こす可能性があります。 `UPDATE` ステートメントが繰り返し実行されると、フィルタ条件が以前に更新されたレコードを見つけることができなくなる可能性があります。

セーフモードでは、DMはSQLステートメントを書き換えてこれらの問題を解決できます。

## 動作原理

セーフモードでは、DMはSQLステートメントを書き換えることで、バイナリログイベントの冪等性を保証します。具体的には、次のSQLステートメントが書き換えられます:

* `INSERT` ステートメントは `REPLACE` ステートメントに書き換えられます。
* `UPDATE` ステートメントは、更新された行のプライマリキーまたはユニークインデックスの値を取得してから、次の2段階に分けて `DELETE` + `REPLACE` ステートメントに書き換えられます: DMはプライマリキーまたはユニークインデックスを使用して古いレコードを削除し、`REPLACE` ステートメントを使用して新しいレコードを挿入します。

`REPLACE` はデータを挿入するためのMySQL固有の文法です。`REPLACE` を使用してデータを挿入し、新しいデータと既存のデータがプライマリキーまたはユニーク制約で競合する場合、MySQLは競合するすべてのレコードを削除し、挿入操作を実行します。これは "強制挿入" と等価です。詳細については、MySQLドキュメントの [`REPLACE` ステートメント](https://dev.mysql.com/doc/refman/8.0/en/replace.html) を参照してください。

`dummydb.dummytbl` テーブルに `id` というプライマリキーがあるとします。次のSQLステートメントをこのテーブルで繰り返し実行します:

```sql
INSERT INTO dummydb.dummytbl (id, int_value, str_value) VALUES (123, 999, 'abc');
UPDATE dummydb.dummytbl SET int_value = 888999 WHERE int_value = 999;   -- int_value = 999の他のレコードが存在しないと仮定する
UPDATE dummydb.dummytbl SET id = 999 WHERE id = 888;    -- プライマリキーを更新
```

セーフモードが有効な場合、前述のSQLステートメントがダウンストリームで再度実行されたとき、次のように書き換えられます:

```sql
REPLACE INTO dummydb.dummytbl (id, int_value, str_value) VALUES (123, 999, 'abc');
DELETE FROM dummydb.dummytbl WHERE id = 123;
REPLACE INTO dummydb.dummytbl (id, int_value, str_value) VALUES (123, 888999, 'abc');
DELETE FROM dummydb.dummytbl WHERE id = 888;
REPLACE INTO dummydb.dummytbl (id, int_value, str_value) VALUES (999, 888888, 'abc888');
```

上記のステートメントでは、`UPDATE` が `DELETE` + `REPLACE` に書き換えられています。ここで `INSERT` を使用すると、`id = 999`の重複レコードを挿入すると、データベースがプライマリキーの競合を報告します。これが `REPLACE` が使用される理由です。新しいレコードは既存のレコードを置き換えます。

SQLステートメントを書き換えることにより、DMは重複した挿入または更新操作を実行する場合に、新しい行データを使用して既存の行データを上書きします。これにより、挿入および更新操作が繰り返し実行されることが保証されます。

## セーフモードを有効にする

セーフモードを自動的または手動で有効にすることができます。このセクションでは、詳細な手順について説明します。

### 自動的に有効にする

DMがチェックポイントから増分レプリケーションタスクを再開する際（たとえば、DMワーカーの再起動またはネットワーク再接続）、DMはデフォルトで一定期間（デフォルトでは60秒）セーフモードを自動的に有効にします。

セーフモードを有効にするかどうかは、チェックポイント内の `safemode_exit_point` と関連があります。増分レプリケーションタスクが異常に一時停止された場合、DMはメモリ内にすべてのDMLステートメントをダウンストリームにレプリケートし、そのDMLステートメントの中での最新のバイナリログ位置を `safemode_exit_point` として記録し、最後のチェックポイントに保存します。

詳細なロジックは次のとおりです:

- チェックポイントに `safemode_exit_point` が含まれている場合、増分レプリケーションタスクは異常終了しました。DMがタスクを再開する際、チェックポイントから再開するバイナリログ位置(**開始位置**)は`safemode_exit_point`を上回るため、開始位置と`safemode_exit_point`の間のバイナリログイベントが既にダウンストリームで処理された可能性があります。したがって、セーフモードを有効にすることでこれらのバイナリログ位置を**セーフ**にすることができます。バイナリログの位置が`safemode_exit_point`を超えると、DMは自動的にセーフモードを無効にします（セーフモードが手動で有効にされていない限り）。

- チェックポイントに `safemode_exit_point` が含まれない場合は、次の2つのケースが考えられます:

    1. これは新しいタスクであるか、予期された通りにタスクが一時停止されたものです。
    2. タスクが異常に一時停止されたが、DMが `safemode_exit_point` を記録できず、またはDMプロセスが異常終了した場合。

    第2の場合は、DMはチェックポイント間の最初の2つのインターバル中に、ダウンストリームで実行されたバイナリログイベントがわからないため、繰り返し実行されたバイナリログイベントが問題を引き起こさないようにするため、自動的にセーフモードを有効にします。二つのチェックポイント間のデフォルトのインターバルは30秒であり、つまり通常の増分レプリケーションタスクが開始する際に、最初の60秒間（2 * 30秒）セーフモードが強制されます。

    通常、セーフモードの期間を増分レプリケーションタスクの開始時に調整するためにチェックポイント間隔を変更することは推奨されません。ただし、変更が必要な場合は、[手動でセーフモードを有効に](#manually-enable)する（推奨）か、syncer構成の`checkpoint-flush-interval`項目を変更することができます。

### 手動で有効にする

セーフモードを全体のレプリケーションプロセス中に有効にするために、syncer構成の`safe-mode`項目を設定することができます。`safe-mode`はbool型のパラメータであり、デフォルトでは`false`です。`true`に設定すると、DMは全体の増分レプリケーションプロセス中でセーフモードを有効にします。

以下は、セーフモードが有効になっているタスク構成の例です:

```
syncers:                              # sync処理ユニットの実行構成。
  global:                            # 構成名。
    # この例では他の構成項目は提供されていません。
    safe-mode: true                  # 全体の増分レプリケーションプロセスのためにセーフモードを有効にします。
    # この例では他の構成項目は提供されていません。
# ----------- インスタンス構成 -----------
mysql-instances:
  -
    source-id: "mysql-replica-01"
    # この例では他の構成項目は提供されていません。
    syncer-config-name: "global"            # syncers構成の名前。
```

## セーフモードの注意事項

安全性のために全体のレプリケーションプロセス中でセーフモードを有効にする場合は、以下に注意してください:

- **セーフモードでの増分レプリケーションには追加のオーバーヘッドがかかります。** 頻繁な `DELETE` + `REPLACE` 操作によってプライマリキーやユニークインデックスへの変更が頻繁に行われ、`UPDATE` ステートメントの実行のみよりもパフォーマンスのオーバーヘッドが大きくなります。
- **セーフモードは同じプライマリキーを持つレコードを強制的に置き換えるため、ダウンストリームでデータの損失が発生する可能性があります。** シャードをマージしてアップストリームからダウンストリームに移行する際、設定が誤っていると大量のプライマリキーやユニークキーの競合が発生する可能性があります。この状況でセーフモードが有効になっていると、ダウンストリームで多くのデータが失われる可能性があり、例外が表示されないため、重大なデータの不整合が発生します。
- **セーフモードは、競合を検出するためにプライマリキーやユニークインデックスに依存しています。** ダウンストリームテーブルにプライマリキーまたはユニークインデックスがない場合、DMは`REPLACE`を使用してレコードを置き換えることができません。この場合、セーフモードが有効になっていても、DMが`INSERT`を`REPLACE`ステートメントに書き換えても、重複したレコードがダウンストリームに挿入されます。

要約すると、アップストリームデータベースに重複したプライマリキーを持つデータがある場合、そしてアプリケーションが重複レコードの損失とパフォーマンスのオーバーヘッドを許容する場合は、セーフモードを有効にしても構いません。