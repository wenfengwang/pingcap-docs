---
title: TiDBデータマイグレーションのパフォーマンス問題の対処方法
summary: DMに存在するかもしれない一般的なパフォーマンス問題とそれらの対処方法について学びます。
---

# TiDBデータマイグレーションのパフォーマンス問題の対処方法

このドキュメントでは、DMに存在するかもしれない一般的なパフォーマンス問題とそれらの対処方法について説明します。

問題の診断を行う前に、[DMベンチマークレポート](https://github.com/pingcap/docs-dm/blob/release-5.3/ja/dm-benchmark-v5.3.0.md)を参照してください。

パフォーマンスの問題を診断し、対処する際には、次の点に注意してください。

- DMのモニタリングコンポーネントが正しく設定され、インストールされていること。
- Grafanaのモニタリングダッシュボードで[モニタリングメトリクス](/dm/ja/dm-cluster-monitoring.md#task)を表示できること。
- 診断するコンポーネントが正常に動作していること。さもないと、パフォーマンスの問題の診断に影響を与える可能性のあるモニタリングメトリクスの例外が発生する可能性があります。

データマイグレーションにおける応答遅延が大きい場合、DMコンポーネント内のボトルネックが原因なのか、TiDBクラスタ内のボトルネックが原因なのかをすばやく特定するために、まず[下流にSQLステートメントを書き込む](#write-sql-statements-to-downstream)で`DMLキューの残り長さ`をチェックしてください。

## リレーログユニット

リレーログユニットのパフォーマンス問題を診断するには、`masterとrelayのbinlogファイルのギャップ`のモニタリングメトリクスをチェックしてください。このメトリクスの詳細については、[リレーログのモニタリングメトリクス](/dm/ja/dm-cluster-monitoring.md#relay-log)を参照してください。もし、このメトリクスが長い間1よりも大きい値を示す場合、通常はパフォーマンスの問題があることを示し、このメトリクスが0の場合は通常パフォーマンスの問題がないことを意味します。

`masterとrelayのbinlogファイルのギャップ`の値が0である場合、しかしパフォーマンスの問題があると疑われる場合、`binlog pos`をチェックしてください。このメトリクスの`master`が`relay`よりもはるかに大きい場合、パフォーマンスの問題が存在する可能性があります。この場合は、関連する問題を診断し、対処してください。

### binlogデータの読み取り

`binlogイベントの読み取り時間`は、リレーログが上流のデータベース（MySQL/MariaDB）からbinlogを読み取る時間を指します。理想的には、このメトリクスはDM-workerとMySQL/MariaDBインスタンス間のネットワークの遅延に近い値であるべきです。

- データセンター内でのデータマイグレーションでは、binlogデータの読み取りはパフォーマンスのボトルネックにはなりません。`binlogイベントの読み取り時間`の値が大きすぎる場合、DM-workerとMySQL/MariaDB間のネットワーク接続を確認してください。

- ジオ・ディストリビューション環境でのデータマイグレーションでは、DM-workerとMySQL/MariaDBを同じデータセンターに配置し、TiDBクラスターをターゲットデータセンターに配置するようにしてください。

上流のデータベースからのbinlogデータの読み取りプロセスには、次のサブプロセスが含まれます。

- 上流のMySQL/MariaDBがローカルのbinlogデータを読み取り、ネットワークを介して送信します。MySQL/MariaDBの負荷に例外が発生しない場合、このサブプロセスは通常ボトルネックにはなりません。
- binlogデータは、MySQL/MariaDBが配置されているマシンからDM-workerが配置されているマシンにネットワークを介して転送されます。このサブプロセスがボトルネックになるかどうかは、DM-workerと上流のMySQL/MariaDB間のネットワーク接続に主に依存します。
- DM-workerは、ネットワークデータストリームからbinlogデータを読み取り、binlogイベントとして構築します。DM-workerの負荷に例外が発生しない場合、このサブプロセスは通常ボトルネックにはなりません。

> **注意:**
>
> `binlogイベントの読み取り時間`の値が大きい場合、もう1つの可能性として、上流のMySQL/MariaDBに負荷が低いことが考えられます。これは、一定の時間内にDMに送信する binlogイベントが必要ないことを意味し、リレーログユニットが待機状態になるため、この値には追加の待機時間が含まれます。

### binlogデータのデコードと検証

リレーログイベントをDMのメモリに読み込んだ後、DMのリレープロセスユニットはデータをデコードして検証します。これは通常パフォーマンスのボトルネックにはならないため、デフォルトではモニタリングダッシュボードに関連するパフォーマンスメトリクスはありません。このメトリクスを表示する必要がある場合は、Grafanaでモニタリングアイテムを手動で追加できます。このモニタリングアイテムは、Prometheusの`dm_relay_read_transform_duration`というメトリクスに対応しています。

### リレーログファイルへの書き込み

binlogイベントをリレーログファイルに書き込む際の関連するパフォーマンスメトリクスは`リレーログの書き込み時間`です。この値は、`binlogイベントのサイズ`があまり大きくない場合、マイクロ秒であるべきです。`リレーログの書き込み時間`が大きすぎる場合は、ディスクの書き込み性能を確認してください。書き込みパフォーマンスの低下を防ぐために、DM-workerにローカルSSDを使用してください。

## ロードユニット

ロードユニットの主な操作は、ローカルからSQLファイルデータを読み取り、ダウンストリームに書き込むことです。関連するパフォーマンスメトリクスは`トランザクションの実行レイテンシ`です。この値が大きすぎる場合は、ダウンストリームデータベースのモニタリングをチェックしてダウンストリームのパフォーマンスを確認してください。また、DMとダウンストリームデータベース間のネットワーク遅延が大きい場合も確認してください。

## Binlogレプリケーションユニット

Binlogレプリケーションユニットのパフォーマンス問題を診断するには、`マスターと同期者のbinlogファイルのギャップ`のモニタリングメトリクスをチェックしてください。このメトリクスの詳細については、[Binlogレプリケーションのモニタリングメトリクス](/dm/ja/dm-cluster-monitoring.md#binlog-replication)を参照してください。

- もし、このメトリクスが長い間1よりも大きい値を示す場合、通常はパフォーマンスの問題があることを示し、このメトリクスが0の場合は通常パフォーマンスの問題がないことを意味します。

`マスターと同期者のbinlogファイルのギャップ`が長い間1よりも大きい場合は、`リレーと同期者のbinlogファイルのギャップ`をチェックして、遅延の主な原因がどのユニットに存在するかを特定してください。この値が通常0の場合、遅延はリレーログユニットに存在する可能性があります。その場合は、[リレーログユニット](#relay-log-unit)を参照してこの問題を解決してください。そうでなければ、Binlogレプリケーションユニットのチェックを続けてください。

### binlogデータの読み取り

Binlogレプリケーションユニットは、ユーザーの設定に応じて上流のMySQL/MariaDBからbinlogイベントを読み取るか、リレーログファイルからbinlogイベントを読み取るかを判断します。関連するパフォーマンスメトリクスは`binlogイベントの読み取り時間`で、通常はいくつかのマイクロ秒から数十のマイクロ秒の範囲です。

- もし、DMのBinlogレプリケーション処理ユニットが上流のMySQL/MariaDBからbinlogイベントを読み取る場合は、問題を特定し解決するには、「[read binlog data](#read-binlog-data)」を「relay log unit」のセクションで参照してください。

- もし、DMのBinlogレプリケーション処理ユニットがbinlogイベントをリレーログファイルから読み取る場合、`binlogイベントのサイズ`があまり大きくない場合は、`binlogイベントの読み取り時間`の値はマイクロ秒であるべきです。`binlogイベントの読み取り時間`が大きすぎる場合は、ディスクの読み取り性能を確認してください。書き込みパフォーマンスの低下を防ぐために、DM-workerにローカルSSDを使用してください。

### binlogイベントの変換

Binlogレプリケーションユニットは、DMLを構築し、DDLを解析し、binlogイベントデータから[table router](/dm/ja/dm-table-routing.md)への変換を行います。関連するメトリクスは`binlogイベントの変換時間`です。

この時間は、上流の書き込み操作に影響を受けます。例えば、「INSERT INTO」ステートメントの場合、単一の「VALUES」を変換するために消費される時間は、「VALUES」を多数変換するために消費される時間と大きく異なる場合があります。消費される時間は、数十マイクロ秒から数百マイクロ秒の範囲となる場合があります。しかし、通常、これはシステムのボトルネックにはなりません。

### 下流にSQLステートメントを書き込む

Binlogレプリケーションユニットが変換されたSQLステートメントを下流に書き込む際、関連するパフォーマンスメトリクスは`DMLキューの残り長さ`と`トランザクションの実行レイテンシ`です。

binlogイベントからSQLステートメントを構築した後、DMは`worker-count`のキューを使用してこれらのステートメントを下流に並行して書き込みます。しかし、監視エントリが多すぎるのを避けるために、DMは同時キューのIDに対してモジュロ8の演算を実行します。これはすべての並行キューが`q_0`から`q_7`の1つのアイテムに対応することを意味します。

`DMLキューの残り長さ`は、並行処理キュー内の、まだ消費されず、下流への書き込みが開始されていないDMLステートメントの数を示します。理想的には、各`q_*`に対応するカーブはほぼ同じであるべきです。そうでない場合、並行ロードが非常に不均衡であることを示しています。

ロードが均衡していない場合は、マイグレーションするテーブルに主キーまたは一意キーが必要かどうか確認してください。これらのキーが存在しない場合は、主キーまたは一意キーを追加してください。これらのキーが存在する場合でもロードが均衡していない場合は、DMをv1.0.5以降のバージョンにアップグレードしてください。

- データマイグレーションリンク全体に明らかな待機時間がない場合、`DMLキューの残り長さ`に対応するカーブはほぼ常に0であり、最大値はタスクの設定ファイルの`batch`の値を超えません。

- データマイグレーションリンクに明らかな待機時間がある場合、各`q_*`に対応する`DMLキューの残り長さ`のカーブはほぼ同じで、ほぼ常に0である場合、DMは上流のデータを読み取り、変換したり、並行して下流に書き込むことができません（ボトルネックはリレーユニットに存在する可能性があります）。トラブルシューティングについては、このドキュメントの前のセクションを参照してください。

`DMLキューの残り長さ`に対応するカーブが0でない場合（通常、最大値は1024を超えません）、下流へのSQLステートメントの書き込み時にボトルネックがあることを意味します。単一のトランザクションの実行にかかる時間を表示するために、`トランザクションの実行レイテンシ`を使用できます。
```
`トランザクションの実行レイテンシ`は通常数十ミリ秒です。この値が大きすぎる場合は、下流のデータベースのモニタリングに基づいて、下流のパフォーマンスを確認してください。また、DMと下流のデータベース間に大きなネットワークレイテンシがあるかどうかも確認できます。

`BEGIN`、`INSERT`、`UPDATE`、`DELETE`、または`COMMIT`などの単一のステートメントを下流に書き込むのにかかる時間を表示するには、`ステートメントの実行レイテンシ`もチェックできます。
```