---
title: アップストリームMySQLインスタンス間でDM-worker接続を切り替える方法
summary: DM-workerのアップストリームMySQLインスタンス間の接続を切り替える方法について学びます。

# アップストリームMySQLインスタンス間でDM-worker接続を切り替える

DM-workerが接続しているアップストリームMySQLインスタンスがダウンタイムのメンテナンスが必要な場合やインスタンスが予期せずクラッシュした場合、同じ移行グループ内の別のMySQLインスタンスにDM-workerの接続を切り替える必要があります。

> **注意:**
>
> - DM-workerの接続を切り替えることができるのは、同じプライマリ-セカンダリ移行クラスタ内のインスタンスのみです。
> - 新たに接続するMySQLインスタンスは、DM-workerが必要とするバイナリログを持っている必要があります。
> - DM-workerはGTIDセットモードで動作する必要があります。つまり、対応するソース設定ファイルで `enable-gtid: true` を指定する必要があります。
> - 接続切り替えは以下の2つのシナリオのみサポートしています。各シナリオの手順に厳密に従ってください。そうでない場合、新たに接続するMySQLインスタンスに応じてDMクラスタを再デプロイし、データ移行タスクをやり直す必要が生じる可能性があります。

GTIDセットの詳細については、[MySQL documentation](https://dev.mysql.com/doc/refman/8.0/en/replication-gtids-concepts.html#replication-gtids-concepts-gtid-sets) を参照してください。

## 仮想IP経由でのDM-worker接続の切り替え

DM-workerが仮想IP（VIP）経由でアップストリームMySQLインスタンスに接続している場合、VIP接続を別のMySQLインスタンスに切り替えるということは、DM-workerに接続されているMySQLインスタンスを切り替えることを意味しますが、アップストリーム接続アドレスは変更されません。

> **注意:**
>
> このシナリオではDMに必要な変更を行ってください。そうしないと、VIP接続を別のMySQLインスタンスに切り替える際に、DMは異なる接続で新しいMySQLインスタンスと古いMySQLインスタンスの両方に同時に接続する可能性があります。この状況では、DMにレプリケートされるバイナリログが、DMが受信する他のアップストリームの状態と一貫性が取れず、予測不可能な異常およびデータ損傷が発生する可能性があります。

DM-workerが仮想IPを介してアップストリームMySQLインスタンスを切り替える場合、以下の手順を実行してください。

1. `query-status` コマンドを使用して、バイナリログレプリケーションの現在の処理ユニットがダウンストリームにレプリケートしたGTIDセット (`syncerBinlogGtid`) を取得します。これらのセットを `gtid-S` としてマークします。
2. 新しいMySQLインスタンスで `SELECT @@GLOBAL.gtid_purged;` コマンドを使用して、削除されたバイナリログに対応するGTIDセットを取得します。これらのセットを `gtid-P` としてマークします。
3. 新しいMySQLインスタンスで `SELECT @@GLOBAL.gtid_executed;` コマンドを使用して、すべての正常に実行されたトランザクションに対応するGTIDセットを取得します。これらのセットを `gtid-E` としてマークします。
4. 以下の条件を満たしていることを確認してください。そうでない場合、DM-workの接続を新しいMySQLインスタンスに切り替えることができません:
    - `gtid-S` が `gtid-P` を含んでいること。 `gtid-P` は空であっても構いません。
    - `gtid-E` が `gtid-S` を含んでいること。
5. `pause-task` を使用して、データ移行のすべての実行中のタスクを一時停止します。
6. 新しいMySQLインスタンスにVIPを変更します。
7. `resume-task` を使用して、以前の移行タスクを再開します。

## DM-workerが接続するアップストリームMySQLインスタンスのアドレスを変更

DM-workerが接続しているアップストリームのアドレスを変更して新しいMySQLインスタンスに接続するには、DM-workerの設定を変更するために以下の手順を実行してください。

1. `query-status` コマンドを使用して、バイナリログレプリケーションの現在の処理ユニットがダウンストリームにレプリケートしたGTIDセット (`syncerBinlogGtid`) を取得します。このセットを `gtid-S` としてマークします。
2. 新しいMySQLインスタンスで `SELECT @@GLOBAL.gtid_purged;` コマンドを使用して、削除されたバイナリログに対忲するGTIDセットを取得します。このセットを `gtid-P` としてマークします。
3. 新しいMySQLインスタンスで `SELECT @@GLOBAL.gtid_executed;` コマンドを使用して、すべての正常に実行されたトランザクションに対応するGTIDセットを取得します。このセットを `gtid-E` としてマークします。
4. 以下の条件を満たしていることを確認してください。そうでない場合、DM-workの接続を新しいMySQLインスタンスに切り替えることができません:
    - `gtid-S` が `gtid-P` を含んでいること。 `gtid-P` は空であっても構いません。
    - `gtid-E` が `gtid-S` を含んでいること。
5. `stop-task` を使用して、データ移行のすべての実行中のタスクを停止します。
6. `operator-source stop` コマンドを使用して、古いMySQLインスタンスのアドレスに対応するソース設定をDMクラスタから削除します。
7. ソース設定ファイル内のMySQLインスタンスのアドレスを更新し、`operate-source create` コマンドを使用してDMクラスタに新しいソース設定を再読み込みします。
8. `start-task` を使用して、移行タスクを再開します。
