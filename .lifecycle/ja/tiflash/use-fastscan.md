---
title: ファストスキャンの使用
summary: ファストスキャンを使用してOLAPシナリオでのクエリ処理を高速化する方法を紹介します。
aliases: ['/tidb/dev/sql-statement-set-tiflash-mode/','/tidb/dev/dev-guide-use-fastscan/']
---

# ファストスキャンの使用

このドキュメントでは、OLAP（Online Analytical Processing）シナリオでクエリ処理を高速化するためにファストスキャンを使用する方法について説明します。

デフォルトでは、TiFlashはクエリ結果とデータの整合性を保証します。ファストスキャン機能を使用すると、TiFlashはより効率的なクエリ処理を提供しますが、クエリ結果とデータの整合性を保証しません。

一部のOLAPシナリオでは、クエリ結果の精度にある程度の許容があります。これらのケースでは、より高速なクエリ処理が必要な場合、セッションレベルまたはグローバルレベルでファストスキャン機能を有効にできます。変数 `tiflash_fastscan` を構成することで、ファストスキャン機能を有効にするかどうかを選択できます。

## 制限

ファストスキャン機能を有効にすると、クエリ結果にはテーブルの古いデータが含まれる可能性があります。つまり、同じ主キーを持つ複数の過去のデータバージョンまたは削除されたデータを取得することがあります。

例：

```sql
CREATE TABLE t1 (a INT PRIMARY KEY, b INT);
ALTER TABLE t1 SET TIFLASH REPLICA 1;
INSERT INTO t1 VALUES(1,2);
INSERT INTO t1 VALUES(10,20);
UPDATE t1 SET b = 4 WHERE a = 1;
DELETE FROM t1 WHERE a = 10;
SET SESSION tidb_isolation_read_engines='tiflash';

SELECT * FROM t1;
+------+------+
| a    | b    |
+------+------+
|    1 |    4 |
+------+------+

SET SESSION tiflash_fastscan=ON;
SELECT * FROM t1;
+------+------+
| a    | b    |
+------+------+
|    1 |    2 |
|    1 |    4 |
|   10 |   20 |
+------+------+
```

TiFlashは古いデータの自動コンパクションをバックグラウンドで開始できますが、古いデータはコンパクションされ、そのデータバージョンがGCセーフポイントよりも古い場合に物理的にクリーンアップされます。物理的なクリーニング後、クリーンアップされた古いデータはファストスキャンモードで返されなくなります。データのコンパクションのタイミングはさまざまな要因によって自動的にトリガーされます。また、[`ALTER TABLE ... COMPACT`](/sql-statements/sql-statement-alter-table-compact.md) ステートメントを使用してデータのコンパクションを手動でトリガーすることもできます。

## ファストスキャンの有効化と無効化

デフォルトでは、セッションレベルおよびグローバルレベルで変数は `tiflash_fastscan=OFF` であり、つまり、ファストスキャン機能は無効になっています。次のステートメントを使用することで、変数情報を確認できます。

```
show variables like 'tiflash_fastscan';

+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| tiflash_fastscan | OFF   |
+------------------+-------+
```

```
show global variables like 'tiflash_fastscan';

+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| tiflash_fastscan | OFF   |
+------------------+-------+
```

セッションレベルおよびグローバルレベルで変数 `tiflash_fastscan` を構成できます。現在のセッションでファストスキャンを有効にする必要がある場合は、次のステートメントを使用します。

```
set session tiflash_fastscan=ON;
```

グローバルレベルで `tiflash_fastscan` を設定することもできます。新しい設定は新しいセッションで有効になりますが、現在のセッションおよび以前のセッションで有効になることはありません。さらに、新しいセッションでは、セッションレベルおよびグローバルレベルの `tiflash_fastscan` はどちらも新しい値を取ることになります。

```
set global tiflash_fastscan=ON;
```

以下のステートメントを使用してファストスキャンを無効にできます。

```
set session tiflash_fastscan=OFF;
set global tiflash_fastscan=OFF;
```

## ファストスキャンの仕組み

TiFlashのストレージレイヤーのデータはデルタレイヤーとステーブルレイヤーの2つのレイヤーに保存されます。

デフォルトでは、ファストスキャンは無効になっており、TableScan演算子は以下の手順でデータを処理します。

1. データの読み取り: デルタレイヤーとステーブルレイヤーの別々のデータストリームを作成して、それぞれのデータを読み取ります。
2. ソートマージ: ステップ1で作成したデータストリームをマージします。その後、(主キーカラム、タイムスタンプカラム)の順でソートされたデータを返します。
3. 範囲フィルタ: ユーザの指定したデータ範囲に基づいて、ステップ2で生成されたデータをフィルタリングして、そのデータを返します。
4. MVCC + カラムフィルタ: ステップ3で生成されたデータをMVCCを介してフィルタリングします（つまり、主キーカラムとタイムスタンプカラムに基づいてデータバージョンをフィルタリングする）およびカラムを介してフィルタリングします（つまり、不要なカラムをフィルタリングして、そのデータを返します）。

ファストスキャンは、一部のデータ整合性を犠牲にしてより高速なクエリ処理を実現します。通常のスキャンプロセスのステップ2とステップ4のMVCC部分はファストスキャンでは省略されるため、クエリ処理が向上します。