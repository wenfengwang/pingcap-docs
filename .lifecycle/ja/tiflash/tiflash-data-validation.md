---
title: TiFlash データ検証
summary: TiFlash のデータ検証メカニズムとツールについて理解する。

# TiFlash データ検証

このドキュメントでは、TiFlash のデータ検証メカニズムとツールについて紹介します。

データの破損は通常、深刻なハードウェアの故障が原因です。このような場合、データの手動による復旧を試みても、データは信頼性を失います。

データの整合性を確保するために、デフォルトで TiFlash はデータファイルに基本的なデータ検証を `City128` アルゴリズムを使用して実行します。データ検証に失敗した場合、TiFlash はすぐにエラーを報告して終了し、整合性のないデータによる二次的な災害を避けます。この時点で、手動で介入してデータを再複製し、TiFlash ノードを復元する必要があります。

v5.4.0 から、TiFlash はより高度なデータ検証機能を導入します。TiFlash はデフォルトで `XXH3` アルゴリズムを使用し、検証フレームとアルゴリズムをカスタマイズすることができます。

## 検証メカニズム

検証メカニズムは DeltaTree ファイル（DTFile）に基づいています。DTFile は TiFlash のデータを永続化するストレージファイルです。DTFile には次の3つの形式があります。

| バージョン | 状態 | 検証メカニズム | メモ |
| :-- | :-- | :-- |:-- |
| V1 | 廃止予定 | ハッシュがデータファイルに埋め込まれています。 | |
| V2 | v6.0.0 未満のデフォルト | ハッシュがデータファイルに埋め込まれています。 | V1 に比べ、V2 は列データの統計情報を追加しています。 |
| V3 | v6.0.0 以上のデフォルト | V3 にはメタデータとトークンデータのチェックサムが含まれ、複数のハッシュアルゴリズムをサポートしています。 | v5.4.0 で新規追加されました。 |

DTFile はデータファイルディレクトリ内の `stable` フォルダに保存されています。現在有効なフォーマットはすべてフォルダフォーマットであり、データは `dmf_<file id>` のような名前のフォルダの下に複数のファイルに保存されています。

### データ検証の使用

TiFlash は自動および手動の両方のデータ検証をサポートしています。

* 自動データ検証:
    * v6.0.0 以降のバージョンではデフォルトで V3 検証メカニズムを使用します。
    * v6.0.0 より前のバージョンではデフォルトで V2 検証メカニズムを使用します。
    * 検証メカニズムを手動で切り替える場合は、[TiFlash 構成ファイル](/tiflash/tiflash-configuration.md#configure-the-tiflashtoml-file)を参照してください。ただし、デフォルトの構成はテストによって検証されており、推奨されています。
* 手動データ検証。[`DTTool inspect`](/tiflash/tiflash-command-line-flags.md#dttool-inspect)を参照してください。

> **警告:**
>
> V3 検証メカニズムを有効にした後、新しく生成された DTFile は、v5.4.0 より前の TiFlash では直接読むことができません。v5.4.0 以降、TiFlash は V2 および V3 の両方をサポートし、バージョンのアップグレードまたはダウングレードを積極的に行いません。既存ファイルのバージョンをアップグレードまたはダウングレードする必要がある場合は、手動で[バージョンを切り替える](/tiflash/tiflash-command-line-flags.md#dttool-migrate)必要があります。

### 検証ツール

TiFlash がデータを読み込む際に自動的にデータ検証を行うだけでなく、v5.4.0 でデータ整合性を手動で確認するためのツールが導入されています。詳細については、[DTTool](/tiflash/tiflash-command-line-flags.md#dttool-inspect)を参照してください。
