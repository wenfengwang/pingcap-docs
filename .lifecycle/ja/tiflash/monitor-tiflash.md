---
title: TiFlashクラスターのモニタリング
summary: TiFlashの監視項目を学ぶ
aliases: ['/docs/dev/tiflash/monitor-tiflash/','/docs/dev/reference/tiflash/monitor/']
---

# TiFlashクラスターのモニタリング

このドキュメントではTiFlashの監視項目について説明します。

TiUPを使用してTiDBクラスターを展開する場合、監視システム（Prometheus＆Grafana）は同時に展開されます。詳細については、[監視フレームワークの概要](/tidb-monitoring-framework.md)を参照してください。

Grafanaのダッシュボードは、概要、PD、TiDB、TiKV、およびNode\_exporterを含む一連のサブダッシュボードに分かれています。診断に役立つ多くのメトリクスがあります。

TiFlashには、**TiFlash-Summary**、**TiFlash-Proxy-Summary**、および**TiFlash-Proxy-Details**の3つのダッシュボードパネルがあります。これらのパネルのメトリクスは、TiFlashの現在の状態を示します。 **TiFlash-Proxy-Summary**および**TiFlash-Proxy-Details**パネルでは、主にRaftレイヤーの情報が表示され、メトリクスの詳細については、[TiKVの主要な監視メトリクス](/grafana-tikv-dashboard.md)を参照してください。

> **注意:**
>
> TiFlashの監視が向上するために、TiDB v4.0.5以降のバージョンを使用することをお勧めします。

次のセクションでは、**TiFlash-Summary**のデフォルトの監視情報を紹介します。

## サーバー

- ストアサイズ：各TiFlashインスタンスが使用するストレージサイズ。
- 利用可能サイズ：各TiFlashインスタンスで利用可能なストレージサイズ。
- 容量サイズ：各TiFlashインスタンスのストレージ容量。
- 稼働時間：前回の再起動以降のTiFlashの稼働時間。
- メモリ：TiFlashインスタンスごとのメモリ使用量。
- CPU使用率：TiFlashインスタンスごとのCPU利用率。
- FSync OPS：各TiFlashインスタンスごとのfsync操作の回数。
- File Open OPS：各TiFlashインスタンスごとの`open`操作の回数。
- 開かれたファイル数：各TiFlashインスタンスで現在開かれているファイル記述子の数。

> **注意:**
>
> ストアサイズ、FSync OPS、File Open OPS、およびOpened File Countは、現在TiFlashストレージレイヤーの監視情報のみをカバーしており、TiFlash-Proxyのものはカバーしていません。

## コプロセッサー

- リクエストQPS：すべてのTiFlashインスタンスが受信したコプロセッサーのリクエスト数。`batch`はバッチリクエストの数です。`batch_cop`はバッチリクエスト内のコプロセッサーリクエストの数です。 `cop`は直接コプロセッサーインターフェースを介して送信されたコプロセッサーリクエストの数です。`cop_dag`はすべてのコプロセッサーリクエスト内のdagリクエストの数です。`super_batch`はスーパーバッチ機能を有効にするためのリクエスト数です。
- エグゼキューターQPS：すべてのTiFlashインスタンスが受信したリクエストの中での各タイプのdagエグゼキューターの数。`table_scan`はテーブルスキャンエグゼキューターです。`selection`はセレクションエグゼキューターです。`aggregation`は集約エグゼキューターです。 `top_n`は`TopN`エグゼキューターです。 `limit`は制限エグゼキューターです。
- リクエストの期間：すべてのTiFlashインスタンスがコプロセッサーリクエストを処理する際の合計期間。合計期間は、コプロセッサーリクエストの受信からその応答が完了するまでの時間です。
- エラーQPS：すべてのTiFlashインスタンスがコプロセッサーリクエストを処理する際のエラーの数。`meet_lock`は読み取りデータがロックされていることを示します。`region_not_found`はRegionが存在しないことを示します。 `epoch_not_match`は、読み取りRegionのエポックがローカルのエポックと一致していないことを示します。 `kv_client_error`は、TiKVとの通信がエラーを返したことを示します。 `internal_error`はTiFlashの内部システムエラーです。 `other`はその他の種類のエラーです。
- リクエスト処理期間：すべてのTiFlashインスタンスがコプロセッサーリクエストを処理する際の期間。処理時間は、コプロセッサーリクエストの実行開始から実行完了までの時間です。
- 応答バイト/秒：すべてのTiFlashインスタンスからの応答の合計バイト数。
- Copタスクメモリ使用量：すべてのTiFlashインスタンスがコプロセッサーリクエストを処理する際の合計メモリ使用量。
- 処理されたリクエスト数：すべてのTiFlashインスタンスが処理するコプロセッサーリクエストの合計数。リクエストの分類は、リクエストQPSと同じです。
- RPCスレッド：各TiFlashインスタンスで使用されているリアルタイムのRPCスレッドの数。
- RPCの最大スレッド：各TiFlashインスタンスで最近使用されたRPCスレッドの最大数。
- スレッド：各TiFlashインスタンスで使用されているリアルタイムのスレッドの数。
- 最大スレッド：各TiFlashインスタンスで最近使用されたスレッドの最大数。

## タスクスケジューラー

- 最小TSO：各TiFlashインスタンスで実行されている全クエリの中での最小TSO。この値により、最小TSOを持つクエリがスケジュールされます。クエリが実行されていない場合、この値は最大の64ビット符号無し整数になります。
- 推定スレッド使用量と制限：各TiFlashインスタンスで実行されている全クエリによって使用されるスレッドの推定量とソフトおよびハードの制限。
- アクティブおよび待機中のクエリ数：各TiFlashインスタンスで実行中のクエリの数と待機中のクエリの数。
- アクティブおよび待機中のタスク数：各TiFlashインスタンスで実行中のタスクの数と待機中のタスクの数。
- ハード制限を超えた回数：各TiFlashインスタンスで実行されているクエリによって使用されるスレッドの推定量がハード制限を超えた回数。
- タスク待機期間：各TiFlashインスタンスでのタスク初期化からタスクスケジューリングまでの期間。

## DDL

- スキーマバージョン：各TiFlashインスタンスで現在キャッシュされているスキーマのバージョン。
- スキーマ適用OPM：すべてのTiFlashインスタンスで1分間にTiDB `schema diff`を`apply`操作で同期化する回数。このアイテムには、`diff apply`、`full apply`、`failed apply`の3種類の`apply`のカウントが含まれます。`diff apply`は単一のapplyの通常のプロセスです。`diff apply`が失敗すると、`failed apply`が`1`増加し、TiFlashは`full apply`に戻り、最新のスキーマ情報を取得してTiFlashのスキーマバージョンを更新します。
- スキーマ内部DDL OPM：すべてのTiFlashインスタンスで1分間に実行される特定のDDL操作の数。
- スキーマ適用期間：すべてのTiFlashインスタンスで単一の`apply schema`操作に使用される時間。

## ストレージ

- 書き込みコマンドOPS：すべてのTiFlashインスタンスのストレージレイヤーが1秒あたりに受信した書き込み要求の数。
- 書き込み増幅：各TiFlashインスタンスの書き込み増幅（物理データの書き込まれたバイト数を論理データの書き込まれたバイト数で割ったもの）。`total`は開始以来の書き込み増幅で、`5分間`は過去5分間の書き込み増幅です。
- 読み込みタスクOPS：各TiFlashインスタンスのストレージレイヤーにおける1秒あたりの読み込みタスクの数。
- Rough Setフィルター率：各TiFlashインスタンスがフィルターされた過去1分間のパケット数の割合。
- 内部タスクOPS：すべてのTiFlashインスタンスが1秒あたりに内部データソーティングタスクを実行する回数。
- 内部タスク期間：全TiFlashインスタンスが内部データソーティングタスクに費やした時間。
- ページGCタスクOPM：すべてのTiFlashインスタンスが1分間にDeltaデータソーティングタスクを実行する回数。
- ページGCタスク期間：全TiFlashインスタンスがDeltaデータソーティングタスクを実行する際に費やした時間の分布。
- ディスク書き込みOPS：すべてのTiFlashインスタンスによる1秒あたりのディスク書き込み数。
- ディスク読み取りOPS：すべてのTiFlashインスタンスによる1秒あたりのディスク読み取り数。
- 書き込みフロー：すべてのTiFlashインスタンスによるディスク書き込みのトラフィック。
- 読み込みフロー：すべてのTiFlashインスタンスによるディスク読み込みのトラフィック。

> **注意:**
>
> これらのメトリクスは、現在TiFlashストレージレイヤーの監視情報のみをカバーしており、TiFlash-Proxyのものはカバーしていません。

## ストレージ書き込みスタール

- 書き込みおよびデルタ管理スループット：すべてのインスタンスによる書き込みとデータコンパクションのスループット。
    - `throughput_write`はRaftを介したデータ同期のスループットです。
    - `throughput_delta-management`はデータコンパクションのスループットです。
    - `total_write`は開始以来書かれた合計バイト数です。
    - `total_delta-management`は開始以来コンパクト化されたデータの合計バイト数です。
- 書き込みスタール期間：インスタンスによる書き込みおよびリージョンデータの削除（範囲の削除）のスタール期間。
- インスタンスごとの書き込みスループット：インスタンスごとの書き込みのスループット。Raft書き込みコマンドとRaftスナップショットを適用することによるスループットが含まれます。
- インスタンスごとの書き込みコマンドOPS：インスタンスが受信した異なる種類のコマンドの合計数。
    - `write block`はRaftを介して同期化されたデータログを意味します。
    - `delete_range`はいくつかのリージョンがこのインスタンスから削除されるか移動されることを意味します。
    - `ingest`はいくつかのリージョンスナップショットがこのインスタンスに適用されることを意味します。

## Raft

- Read Index OPS：各TiFlashインスタンスが1秒あたりに`read_index`リクエストをトリガーする回数。これはトリガーされたリージョンの数に等しいです。
- Read Index Duration：すべてのTiFlashインスタンスが`read_index`に使用する時間。ほとんどの時間はリージョンリーダーおよびリトライとの相互作用に使用されます。
- Wait Index Duration：すべてのTiFlashインスタンスが`read_index`リクエストを受け取った後に、ローカルインデックスがread_index以上になるまで待機する時間、すなわち`wait_index`に使用される時間。