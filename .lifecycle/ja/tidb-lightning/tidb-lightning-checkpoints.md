---
title: TiDBライトニングチェックポイント
summary: ライトニングが以前に完了したタスクをやり直すのを避けるために、チェックポイントを使用します。
aliases: ['/docs/dev/tidb-lightning/tidb-lightning-checkpoints/','/docs/dev/reference/tools/tidb-lightning/checkpoints/']
---

# TiDBライトニングチェックポイント

通常、大規模なデータベースのインポートには数時間または数日かかることがあります。そして、そのような長時間実行されるプロセスが突然クラッシュした場合、以前に完了したタスクをやり直すのは非常に時間の無駄です。これを解決するために、TiDBライトニングはインポートの進捗状況を保存するために*チェックポイント*を使用し、そのために`tidb-lightning`は再起動後に中断した場所からのインポートを継続します。

このドキュメントでは、*チェックポイント*の有効化、設定、保存、および制御方法について説明します。

## チェックポイントの有効化と設定

```toml
[checkpoint]
# チェックポイントを有効にするかどうか。
# データのインポート中、TiDBライトニングはどのテーブルがインポートされたかを記録しています。そのため、TiDBライトニングまたは他のコンポーネントがクラッシュした場合でも、最初からやり直すのではなく、既知の正常な状態から開始することができます。
enable = true

# チェックポイントを保存する場所。
#  - file:  ローカルファイルとして保存（v2.1.1以降が必要）
#  - mysql: リモートのMySQL互換データベースに保存
driver = "file"

# チェックポイントを保存するスキーマ名（データベース名）
# `driver = "mysql"` の場合にのみ有効。
# schema = "tidb_lightning_checkpoint"

# チェックポイント保存場所を示すデータソース名（DSN）。
#
# "file"ドライバの場合、DSNはパスで指定されます。パスが指定されていない場合、Lightningはデフォルトで "/tmp/CHECKPOINT_SCHEMA.pb" になります。
#
# "mysql"ドライバの場合、DSNは "USER:PASS@tcp(HOST:PORT)/" の形式のURLです。
# URLが指定されていない場合、チェックポイントを保存するために [tidb]セクションのTiDBサーバーが使用されます。ターゲットのTiDBクラスターの負荷を軽減するために、異なるMySQL互換のデータベースサーバーを指定する必要があります。
#dsn = "/tmp/tidb_lightning_checkpoint.pb"

# データがすべてインポートされた後、チェックポイントを保持するかどうか。falseの場合、チェックポイントは削除されます。
# チェックポイントを保持すると、デバッグに役立ちますが、データソースに関するメタデータが漏洩する可能性があります。
# keep-after-success = false
```

## チェックポイントの保存

TiDBライトニングは、ローカルファイルまたはリモートのMySQL互換データベースの2種類のチェックポイント保存をサポートしています。

* `driver = "file"` の場合、チェックポイントは`dsn`設定で指定されたパスのローカルファイルに保存されます。チェックポイントは迅速に更新されるため、チェックポイントファイルをRAMディスクなど書き込み耐久性の非常に高いドライブに配置することを強くお勧めします。

* `driver = "mysql"` の場合、チェックポイントはMySQL 5.7以降と互換性のある任意のデータベースに保存できます。これにはMariaDBやTiDBも含まれます。デフォルトでは、チェックポイントはターゲットデータベースに保存されます。

ターゲットデータベースをチェックポイント保存場所として使用する場合、Lightningは同時に大量のデータをインポートしています。これにより、ターゲットデータベースに余分な負荷がかかり、通信がタイムアウトすることがあります。そのため、**これらのチェックポイントを保存する一時的なMySQLサーバーをインストールすることを強くお勧めします**。このサーバーは`tidb-lightning`と同じホストにインストールし、インポーターの進行が完了した後にアンインストールできます。

## チェックポイントの制御

`tidb-lightning`が復旧不能なエラー（たとえば、データの破損）によって異常終了した場合、チェックポイントを再利用することは拒否されます。これは状況を悪化させるのを防ぐためです。チェックポイントのエラーは`tidb-lightning-ctl`プログラムを使用して解決できます。

### `--checkpoint-error-destroy`

```sh
tidb-lightning-ctl --checkpoint-error-destroy='`schema`.`table`'
```

このオプションにより、テーブルのインポートを最初からやり直すことができます。スキーマとテーブル名はバッククォートで囲む必要があり、大文字と小文字が区別されます。

- もし以前にテーブル `` `schema`.`table` `` のインポートに失敗した場合、このオプションは次の操作を実行します：

    1. ターゲットデータベースからテーブル `` `schema`.`table` `` をDROPします。これはインポートされたデータをすべて削除します。
    2. このテーブルのチェックポイントレコードを "まだ開始されていない" にリセットします。

- テーブル `` `schema`.`table` `` に関連するエラーがない場合、この操作は何もしません。

これはすべてのテーブルに適用されたと見なされます。これはチェックポイントエラーの問題を修正する最も便利で安全かつ保守的な解決策です：

```sh
tidb-lightning-ctl --checkpoint-error-destroy=all
```

### `--checkpoint-error-ignore`

```sh
tidb-lightning-ctl --checkpoint-error-ignore='`schema`.`table`'
tidb-lightning-ctl --checkpoint-error-ignore=all
```

もし以前にテーブル `` `schema`.`table` `` のインポートに失敗した場合、このオプションはエラーステータスを消去し、何も起こらなかったかのようにします。`all` バリアントはこの操作をすべてのテーブルに適用します。

> **注意:**
>
> このオプションはエラーを確実に無視できると確信した場合のみ使用してください。そうでない場合、いくつかのインポートされたデータが失われる可能性があります。最後の "checksum" チェックが唯一のセーフティネットであり、したがって `--checkpoint-error-ignore` を使用する際は常に "checksum" オプションを有効にしておく必要があります。

### `--checkpoint-remove`

```sh
tidb-lightning-ctl --checkpoint-remove='`schema`.`table`'
tidb-lightning-ctl --checkpoint-remove=all
```

このオプションは、1つのテーブルまたはすべてのテーブルに関するすべてのチェックポイント情報を単純に削除します。その状態にかかわらずです。

### `--checkpoint-dump`

```sh
tidb-lightning-ctl --checkpoint-dump=output/directory
```

このオプションは、指定したディレクトリにチェックポイントの内容をダンプします。これは主に技術スタッフによるデバッグに使用されます。このオプションは`driver = "mysql"` の場合にのみ有効です。