---
title: 50 TiB データのインポートのベストプラクティス
summary: 大容量のデータをインポートするためのベストプラクティスを学ぶ。
---

# 50 TiB データのインポートのベストプラクティス

このドキュメントでは、TiDB に大容量のデータをインポートするためのベストプラクティスについて、データインポートに影響を与える重要な要素やステップを含めて提供します。私たちは、大きな単一のテーブル内のデータを 50 TiB 以上の内部環境および顧客の環境に正常にインポートし、これらの実際のアプリケーションシナリオに基づいたベストプラクティスを積み重ねてきました。これは、データのスムーズかつ効率的なインポートを支援します。

TiDB Lightning（[物理インポートモード](/tidb-lightning/tidb-lightning-physical-import-mode.md)）は、空のテーブルにデータをインポートし、空のクラスタを初期化するために使用される包括的で効率的なデータインポートツールであり、ファイルがデータソースとなります。TiDB Lightning には、シングルインスタンスと[並列インポート](/tidb-lightning/tidb-lightning-distributed-import.md)の2つの実行モードがあります。さまざまなサイズのソースファイルをインポートできます。

- ソースファイルのデータサイズが 10 TiB 以下の場合、インポートには TiDB Lightning のシングルインスタンスを使用することを推奨します。
- ソースファイルのデータサイズが 10 TiB を超える場合、[並列インポート](/tidb-lightning/tidb-lightning-distributed-import.md)には複数の TiDB Lightning インスタンスを使用することを推奨します。
- ソースファイルデータスケールが非常に大きい場合（50 TiB より大きい）、並列インポートに加えて、ソースデータ、テーブル定義、およびパラメータ構成の特性に基づいて、スムーズで高速な大規模なデータインポートを実現するための準備と最適化を行う必要があります。

次のセクションは、複数のテーブルのインポートと大きな単一のテーブルのインポートの両方に適用されます。

- [主要な要因](#主要な要因)
- [ソースファイルの準備](#ソースファイルの準備)
- [ストレージスペースの推定](#ストレージスペースの推定)
- [構成パラメータの変更](#構成パラメータの変更)
- ["checksum mismatch" エラーの解決](#"checksum mismatch" エラーの解決)
- [チェックポイントの有効化](#チェックポイントの有効化)
- [トラブルシューティング](#トラブルシューティング)

大きな単一のテーブルをインポートするためのベストプラクティスは、その特別な要件のため、別々に記載されています。

- [大きな単一のテーブルをインポートするためのベストプラクティス](#大きな単一のテーブルをインポートするためのベストプラクティス)

## 主要な要因

データをインポートする際、いくつかの主要な要因がインポートのパフォーマンスに影響を与え、場合によってはインポートに失敗する可能性さえあります。一般的な重要な要因には次のようなものがあります：

- ソースファイル

    - 単一のファイル内のデータが主キーでソートされているかどうか。ソートされたデータは最適なインポートパフォーマンスを発揮できます。
    - 複数の TiDB Lightning インスタンスによってインポートされたソースファイル間でオーバーラッピングする主キーまたは非NULLのユニークインデックスが存在するかどうか。重複が少ないほど、インポートパフォーマンスが向上します。

- テーブルの定義

    - テーブルごとのセカンダリインデックスの数とサイズは、インポート速度に影響を与える可能性があります。少ないインデックス数は、高速なインポートと、インポート後のより少ないスペース消費につながります。
    - インデックスデータサイズ = インデックス数 \* インデックスのサイズ \* 行数。

- 圧縮率

    - TiDB クラスタにインポートされるデータは圧縮形式で保存されます。圧縮率は事前に計算することはできません。実際にデータを TiKV クラスタにインポートした後に確定します。
    - ベストプラクティスとして、データの一部（たとえば、10%）を最初にインポートして、クラスタの対応する圧縮率を取得し、それを使用して全体のデータインポートの圧縮率を推定できます。

- 構成パラメータ

    - `region-concurrency`: TiDB Lightning のメイン論理処理の並行性。
    - `send-kv-pairs`: TiDB Lightning が TiKV に送信するキー-値ペアの数。    
    - `disk-quota`: 物理インポートモードを使用する場合の TiDB Lightning のローカル一時ファイルに使用されるディスククォータ。
    - `GOMEMLIMIT`: TiDB Lightning は Go 言語で実装されています。[適切に `GOMEMLIMIT` を設定します。](#構成パラメータの変更)

- データ検証

    データおよびインデックスインポートが完了した後、[`ADMIN CHECKSUM`](/sql-statements/sql-statement-admin-checksum-table.md) 文が各テーブルで実行され、チェックサム値が TiDB Lightning のローカルチェックサム値と比較されます。多数のテーブルが存在する場合、または個々のテーブルに多数の行がある場合、チェックサム段階には時間がかかる可能性があります。

- 解析操作

    チェックサムが正常に完了した後、[`ANALYZE TABLE`](/sql-statements/sql-statement-analyze-table.md) 文が各テーブルで実行され、最適な実行プランが生成されます。大量のテーブルやデータが多い個々のテーブルを処理する場合、解析操作に時間がかかる可能性があります。

- 関連する問題

    実際の 50 TiB のデータをインポートするプロセス中には、多数のソースファイルや大規模なクラスタを扱うときにのみ露出される特定の問題が発生する可能性があります。製品バージョンを選択する際には、対応する問題が修正されているかどうかを確認することをお勧めします。

    次の問題は、v6.5.3、v7.1.0以降で解決されています：

    - [Issue-14745](https://github.com/tikv/tikv/issues/14745): インポートが完了すると、TiKV インポートディレクトリに多数の一時ファイルが残される。
    - [Issue-6426](https://github.com/tikv/pd/issues/6426): PDの[range scheduling](/tidb-lightning/tidb-lightning-physical-import-mode-usage.md#scope-of-pausing-scheduling-during-import)インターフェイスがリージョンを分散させるのに失敗し、タイムアウトの問題を引き起こすことがあります。v6.2.0より前では、グローバルスケジューリングはデフォルトで無効になっており、これによりこの問題がトリガされるのを回避できます。
    - [Issue-43079](https://github.com/pingcap/tidb/pull/43079): TiDB Lightning は NotLeader エラーの再試行中にリージョンピア情報を更新できないことがあります。
    - [Issue-43291](https://github.com/pingcap/tidb/issues/43291): TiDB Lightning は、一時ファイルが見つからない場合に再試行を行わないことがあります（"No such file or directory" エラー）。

## ソースファイルの準備

- ソースファイルを生成する際に、単一ファイル内のデータを主キーでソートすることが望ましいです。テーブル定義に主キーがない場合は、自動増分主キーを追加できます。この場合、ファイルの内容の順序は問題ありません。
- 複数の TiDB Lightning インスタンスにソースファイルを割り当てる場合、複数のソースファイル間にオーバーラッピングする主キーまたは非NULLのユニークインデックスが存在しないようにします。生成されたファイルがグローバルにソートされている場合、異なる TiDB Lightning インスタンスに最適なインポートパフォーマンスを得るために、範囲に基づいて配布されます。
- ファイルが生成される際に、各ファイルのサイズが 96 MiB 未満であるように制御します。
- ファイルが非常に大きく、256 MiB を超える場合は、[`strict-format`](/migrate-from-csv-files-to-tidb.md#step-4-tune-the-import-performance-optional)を有効にします。

## ストレージスペースの推定

データのインポートに必要なストレージスペースを推定するためには、次の2つの方法があります。

- 合計データサイズを **A** 、合計インデックスサイズを **B** 、レプリケーションファクターを **3** 、圧縮率を **α**（通常約2.5）とした場合、全体の使用スペースは次のように計算できます：**(A+B)\*3/α**。この方法は、データのインポートを実行せずに推定するためのクラスタのトポロジを計画するために主に使用されます。
- データの 10% のみをインポートし、実際の使用スペースに 10 をかけることで、そのバッチのデータの最終的なスペース使用量を推定できます。この方法は、特に大量のデータをインポートする場合により正確です。

インポート後もコンパクションやスナップショットレプリケーションなどのバックグラウンドタスクが一部のストレージスペースを消費するため、ストレージスペースの 20% を予約することをお勧めします。

## 構成パラメータの変更

- `region-concurrency`: TiDB Lightning のメイン論理処理の並行性。並列インポート中には、CPUコア数の 75% に設定することを推奨し、リソースの過負荷や潜在的なOOMの問題を防ぐためです。
- `send-kv-pairs`: TiDB Lightning が TiKV に送信するキー-値ペアの数。この値は、send-kv-pairs \* row-size < 1 MiB の計算に基づいて調整することを推奨します。v7.2.0以降、このパラメータは `send-kv-size` に置き換えられ、追加の設定は不要です。
- `disk-quota`: TiDB Lightning のソートディレクトリスペースがデータソースのサイズより大きいことを確認することを推奨します。確認できない場合は、TiDB Lightning のソートディレクトリスペースの80% に `disk-quota` を設定してください。これにより、指定された `disk-quota` に従って data-sort をバッチ処理でソートおよび書き込みすることになりますが、このアプローチは完全なソートプロセスと比較してインポートパフォーマンスが低下する可能性があります。
- `GOMEMLIMIT`: TiDB Lightning は Go 言語で実装されています。GoのGCメカニズムによるOOMの発生確率を減らすために、`GOMEMLIMIT` をインスタンスメモリの80% に設定します。

TiDB Lightning パラメータの詳細については、[TiDB Lightning 構成パラメータ](/tidb-lightning/tidb-lightning-configuration.md)を参照してください。

## "checksum mismatch" エラーの解決

データ検証時に競合が発生する可能性があります。エラーメッセージは "checksum mismatch" です。この問題を解決するためには、必要に応じて以下の手順を実行してください：

1. ソースデータで競合するプライマリキーまたはユニークキーをチェックし、再インポートする前に競合を解消してください。ほとんどの場合、これが最も一般的な原因です。
2. テーブルのプライマリキーまたはユニークキーの定義が適切かどうかを確認してください。適切でない場合は、テーブルの定義を変更し、データを再インポートしてください。
3. 前述の2つの手順に従った後も問題が解消されない場合は、ソースデータに予期しない競合するデータがごく少量（10%未満）含まれているかどうかをさらに調査する必要があります。TiDB Lightningが競合するデータを検出および解消するために、[競合検出](/tidb-lightning/tidb-lightning-physical-import-mode-usage.md#conflict-detection)を有効にしてください。

## チェックポイントを有効にする

大量のデータをインポートする場合、[ライトニングチェックポイント](/tidb-lightning/tidb-lightning-checkpoints.md)を参照して有効にすることが重要です。コンテナ環境で TiDB Lightning が実行されている場合、コンテナが終了してチェックポイント情報が削除される可能性があるため、チェックポイント情報が失われないようにするために、チェックポイント情報を失わないようにするために、MySQLをドライバとして使用することを優先することをお勧めします。

インポート中に下流の TiKV でスペースが不足する問題に遭遇した場合、すべての TiDB Lightning インスタンスで `kill` コマンド（`-9` オプションなし）を手動で実行することができます。キャパシティをスケールアップした後、チェックポイント情報に基づいてインポートを再開することができます。

## 大きな単一テーブルをインポートするためのベストプラクティス

複数のテーブルをインポートすると、チェックサムおよび分析操作に必要な時間が増加することがあり、データのインポートに必要な時間を上回ることがあります。ただし、通常は構成を調整する必要はありません。複数のテーブルの中に1つ以上の大きなテーブルが存在する場合、これらの大きなテーブルのソースファイルを分離して個別にインポートすることをお勧めします。

このセクションでは、大きな単一テーブルをインポートするためのベストプラクティスを提供します。大きな単一テーブルの厳密な定義はありませんが、通常は次の基準のいずれかを満たすものと考えられます。

- テーブルのサイズが 10 TiB を超える。
- 行数が 10億を超えるかつワイドテーブルで列数が50を超える。

### ソースファイルの生成

[ソースファイルの準備](#prepare-source-files)に記載されている手順に従います。

大きな単一テーブルの場合、グローバルなソーティングが実現できない場合でも、各ファイル内でプライマリキーに基づいてソートすることが可能で、ファイルが標準の CSVファイルである場合、各ファイルを約20 GiBごとに大きな単一ファイルを生成することをお勧めします。

その後、`strict-format` を有効にしてください。この手法により、TiDB Lightning インスタンス間でインポートされるファイルのプライマリおよびユニークキーの重複が減少し、 TiDB Lightning インスタンスは大きなファイルをインポートする前にファイルを分割して最適なインポートパフォーマンスを達成できます。

### クラスタのトポロジの計画

各インスタンスが 5 TiB から 10 TiB のソースデータを処理するようにするために TiDB Lightning インスタンスを準備してください。各ノードに1つの TiDB Lightning インスタンスを展開します。ノードの仕様については、TiDB Lightning インスタンスの[環境要件](/tidb-lightning/tidb-lightning-physical-import-mode.md#environment-requirements)を参照してください。

### 構成パラメータの変更

- `region-concurrency` を TiDB Lightning インスタンスのコア数の75%に設定してください。
- `send-kv-pairs` を `3200` に設定します。この方法は TiDB v7.1.0 およびそれ以前のバージョンに適用されます。v7.2.0 以降ではこのパラメータは `send-kv-size` に置き換えられ、追加の設定は不要です。
- `GOMEMLIMIT` をインスタンスがあるノードのメモリの80%に調整してください。

インポートプロセス中にPD Scatter Regionの待ち時間が30分を超える場合は、次の最適化を検討してください。

- TiKV クラスタでI/Oボトルネックが発生していないかどうかを確認してください。
- TiKV `raftstore.apply-pool-size` をデフォルト値の `2` から `4` または `8` に増やしてください。
- TiDB Lightning `region-split-concurrency` を CPU コア数の半分に、最小値を `1` に減らしてください。

### 分析操作の無効化

大きな単一テーブル（たとえば、10億行を超え、50列を超えるテーブル）の場合、インポートプロセス中に `analyze` 操作を無効にすること（`analyze="off"`）をお勧めします。インポートが完了した後に、[`ANALYZE TABLE`](/sql-statements//sql-statement-analyze-table.md) ステートメントを手動で実行してください。

`analyze` の構成についての詳細は、[TiDB Lightning タスク設定](/tidb-lightning/tidb-lightning-configuration.md#tidb-lightning-task)を参照してください。

## トラブルシューティング

TiDB Lightning を使用している際に問題が発生した場合は、[TiDB Lightningのトラブルシューティング](/tidb-lightning/troubleshoot-tidb-lightning.md)を参照してください。