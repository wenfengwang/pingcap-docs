---
title: TiDBビンロッグ中継ログ
summary: エクストリームなケースでデータ整合性を維持するための中継ログの使用方法を学びます。
aliases: ['/docs/dev/tidb-binlog/tidb-binlog-relay-log/','/docs/dev/reference/tidb-binlog/relay-log/']
---

# TiDBビンロッグ中継ログ

ビンロッグを複製する際、Drainerは上流からトランザクションを分割し、分割されたトランザクションを並行して下流に複製します。

上流クラスタが利用できず、Drainerが異常終了したエクストリームなケースでは、下流クラスタ（MySQLまたはTiDB）が不整合な状態になる可能性があります。このような場合、Drainerは中継ログを使用して、下流クラスタが整合した状態になるよう保証します。

## Drainer複製中の整合した状態

下流クラスタが整合した状態になるとは、下流クラスタのデータが上流のスナップショット（`tidb_snapshot = ts`と設定）と同じであることを意味します。

チェックポイントの整合性とは、Drainerのチェックポイントが`consistent`で複製の整合した状態を保存することを意味します。Drainerが実行されると、`consistent`は`false`になります。Drainerが正常に終了すると、`consistent`は`true`に設定されます。

以下のように、下流のチェックポイントテーブルをクエリできます：

{{< copyable "sql" >}}

```sql
select * from tidb_binlog.checkpoint;
```

```
+---------------------+----------------------------------------------------------------+
| clusterID           | checkPoint                                                     |
+---------------------+----------------------------------------------------------------+
| 6791641053252586769 | {"consistent":false,"commitTS":414529105591271429,"ts-map":{}} |
+---------------------+----------------------------------------------------------------+
```

## 実装原則

Drainerが中継ログを有効にすると、まずビンロッグイベントをディスクに書き込み、次にそのイベントを下流クラスタに複製します。

上流クラスタが利用できない場合、Drainerは中継ログを読み取ることで下流クラスタを整合した状態に復元できます。

> **注意：**
>
> 中継ログデータが同時に失われた場合、この方法は機能しませんが、その発生率は非常に低いです。また、中継ログのデータ安全性を確保するために、Network File Systemを使用することができます。

### Drainerが中継ログからビンログを消費するトリガーシナリオ

Drainerが起動した際、上流クラスタのPlacement Driver（PD）に接続に失敗し、かつチェックポイントで`consistent = false`を検出した場合、Drainerは中継ログを読み取り、下流クラスタを整合した状態に復元しようとします。その後、Drainerプロセスはチェックポイントの`consistent`を`true`に設定して終了します。

### 中継ログのGCメカニズム

データが下流に複製される前に、Drainerはデータを中継ログファイルに書き込みます。中継ログファイルのサイズが10MB（デフォルト値）に達し、現在のトランザクションのビンログデータが完全に書き込まれた場合、Drainerはデータを次の中継ログファイルに書き込み始めます。Drainerがデータを下流に正常に複製した後、複製されたデータの中継ログファイルは自動的にクリーンアップされます。データの書き込み中の中継ログはクリーンアップされません。

## 設定

中継ログを有効にするには、Drainerに以下の設定を追加します：

{{< copyable "" >}}

```
[syncer.relay]
# 中継ログのディレクトリを保存します。値が空の場合、中継ログは有効になりません。
# 下流がTiDBまたはMySQLの場合のみ、この構成が有効です。
log-dir = "/dir/to/save/log"
# 単一の中継ログファイルのサイズ制限（単位：バイト）。
# 中継ログファイルのサイズがこの制限に達した場合、データは次の中継ログファイルに書き込まれます。
max-file-size = 10485760
```