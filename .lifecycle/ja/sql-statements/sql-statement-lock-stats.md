---
title: LOCK STATS
summary: LOCK STATSのTiDBデータベースの使用状況についての概要です。

# LOCK STATS

`LOCK STATS` は、テーブルまたはパーティションの統計情報をロックするために使用されます。統計情報がロックされると、TiDBは自動的にテーブルまたはパーティションの統計情報を更新しません。詳細は[統計情報のロックの動作](/statistics.md#behaviors-of-locking-statistics)を参照してください。

> **警告：**
>
> 現在のバージョンでは統計情報のロックは実験的な機能です。本番環境で使用することは推奨されません。

## 概要

```ebnf+diagram
LockStatsStmt ::=
    'LOCK' 'STATS' (TableNameList) | (TableName 'PARTITION' PartitionNameList)

TableNameList ::=
    TableName (',' TableName)*

TableName ::=
    Identifier ( '.' Identifier )?

PartitionNameList ::=
    Identifier ( ',' Identifier )*
```

## 例

テーブル「t」を作成し、データを挿入します。テーブル「t」の統計情報がロックされていない場合、`ANALYZE`ステートメントを正常に実行できます。

```sql
mysql> CREATE TABLE t(a INT, b INT);
Query OK, 0 rows affected (0.03 sec)

mysql> INSERT INTO t VALUES (1,2), (3,4), (5,6), (7,8);
Query OK, 4 rows affected (0.00 sec)
Records: 4  Duplicates: 0  Warnings: 0

mysql> ANALYZE TABLE t;
Query OK, 0 rows affected, 1 warning (0.02 sec)

mysql> SHOW WARNINGS;
+-------+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| レベル | コード | メッセージ                                                                                                                                                                                                               |
+-------+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 注釈  | 1105 | 表test.tの統計メタの行数がPDで取得した行数よりもはるかに小さいため、Analyzeは自動調整されたサンプル率1.000000を使用します。理由は"Row count in stats_meta is much smaller compared with the row count got by PD, use min(1, 15000/4) as the sample-rate=1"です。 |
+-------+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 行出力 (0.00 sec)
```

テーブル「t」の統計情報をロックし、`ANALYZE`を実行します。`SHOW STATS_LOCKED`の出力から、テーブル「t」の統計情報がロックされていることがわかります。警告メッセージによると、`ANALYZE`ステートメントはテーブル「t」をスキップしたことが示されています。

```sql
mysql> LOCK STATS t;
Query OK, 0 rows affected (0.00 sec)

mysql> SHOW STATS_LOCKED;
+---------+------------+----------------+--------+
| Db_name | Table_name | Partition_name | Status |
+---------+------------+----------------+--------+
| test    | t          |                | locked |
+---------+------------+----------------+--------+
1 行出力 (0.01 sec)

mysql> ANALYZE TABLE t;
Query OK, 0 rows affected, 2 warnings (0.00 sec)

mysql> SHOW WARNINGS;
+---------+------+-----------------------------------------------------------------------------------------------------------------------------------------+
| レベル   | コード | メッセージ                                                                                                                                 |
+---------+------+-----------------------------------------------------------------------------------------------------------------------------------------+
| 注釈    | 1105 | 表test.tの統計メタの行数がPDで取得した行数よりもはるかに小さいため、Analyzeは自動調整されたサンプル率1.000000を使用します。理由は"use min(1, 110000/8) as the sample-rate=1"です。 |
| 警告 | 1105 | 統計情報がロックされたテーブルを解析しない: test.t                                                                                                       |
+---------+------+-----------------------------------------------------------------------------------------------------------------------------------------+
2 行出力 (0.00 sec)
```

さらに、`LOCK STATS`を使用して、パーティションの統計情報もロックすることができます。例えば：

パーティションテーブル「t」を作成し、データを挿入します。パーティション「p1」の統計情報がロックされていない場合、`ANALYZE`ステートメントを正常に実行できます。

```sql
mysql> CREATE TABLE t(a INT, b INT) PARTITION BY RANGE (a) (PARTITION p0 VALUES LESS THAN (10), PARTITION p1 VALUES LESS THAN (20), PARTITION p2 VALUES LESS THAN (30));
Query OK, 0 rows affected (0.03 sec)

mysql> INSERT INTO t VALUES (1,2), (3,4), (5,6), (7,8);
Query OK, 4 rows affected (0.00 sec)
Records: 4  Duplicates: 0  Warnings: 0

mysql> ANALYZE TABLE t;
Query OK, 0 rows affected, 6 warning (0.02 sec)

mysql> SHOW WARNINGS;
+---------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| レベル   | コード | メッセージ                                                                                                                                                                                                                              |
+---------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 警告 | 1105 | グローバルな統計情報がtに存在しないため、ダイナミックプルーニングを無効にする                                                                                                    |
| 注釈    | 1105 | 表test.tのパーティションp0の統計メタの行数がPDで取得した行数よりもはるかに小さいため、Analyzeは自動調整されたサンプル率1.000000を使用します。理由は"Row count in stats_meta is much smaller compared with the row count got by PD, use min(1, 15000/4) as the sample-rate=1"です。 |
| 警告 | 1105 | グローバルな統計情報がtに存在しないため、ダイナミックプルーニングを無効にする                                                                                                    |
| 注釈    | 1105 | 表test.tのパーティションp1の統計メタの行数がPDで取得した行数よりもはるかに小さいため、Analyzeは自動調整されたサンプル率1.000000を使用します。理由は"TiDB assumes that the table is empty, use sample-rate=1"です。                                                                 |
| 警告 | 1105 | グローバルな統計情報がtに存在しないため、ダイナミックプルーニングを無効にする                                                                                                    |
| 注釈    | 1105 | 表test.tのパーティションp2の統計メタの行数がPDで取得した行数よりもはるかに小さいため、Analyzeは自動調整されたサンプル率1.000000を使用します。理由は"TiDB assumes that the table is empty, use sample-rate=1"です。 |
+---------+------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
6 行出力 (0.01 sec)
```

パーティション「p1」の統計情報をロックし、`ANALYZE`を実行します。警告メッセージによると、`ANALYZE`ステートメントはパーティション「p1」をスキップしたことが示されています。

```sql
mysql> LOCK STATS t PARTITION p1;
Query OK, 0 rows affected (0.00 sec)

mysql> SHOW STATS_LOCKED;
+---------+------------+----------------+--------+
| Db_name | Table_name | Partition_name | Status |
+---------+------------+----------------+--------+
| test    | t          | p1             | locked |
+---------+------------+----------------+--------+
1 行出力 (0.00 sec)

mysql> ANALYZE TABLE t PARTITION p1;
Query OK, 0 rows affected, 2 warnings (0.01 sec)

mysql> SHOW WARNINGS;
+---------+------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| レベル   | コード | メッセージ                                                                                                                                                              |
+---------+------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 注釈    | 1105 | テーブルtest.tのパーティションp1の統計メタの行数がPDで取得した行数よりもはるかに小さいため、Analyzeは自動調整されたサンプル率1.000000を使用します。理由は"TiDB assumes that the table is empty, use sample-rate=1" |
| 警告 | 1105 | 統計情報がロックされたテーブルを解析しない: test.tのパーティション(p1)                                                                                                                     |
+---------+------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
2 行出力 (0.00 sec)
```

統計情報のロック解除に関する情報については、[UNLOCK STATS](/sql-statements/sql-statement-unlock-stats.md)を参照してください。

## MySQL互換性

このステートメントは、MySQL構文のTiDB拡張です。

## 関連項目

* [統計情報](/statistics.md#lock-statistics)
* [UNLOCK STATS](/sql-statements/sql-statement-unlock-stats.md)
* [SHOW STATS_LOCKED](/sql-statements/sql-statement-show-stats-locked.md)