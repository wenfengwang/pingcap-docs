---
title: LOCK TABLESとUNLOCK TABLES
summary: LOCK TABLESとUNLOCK TABLESのTiDBデータベースでの使用法の概要。

# LOCK TABLESとUNLOCK TABLES

> **警告:**
>
> `LOCK TABLES`および`UNLOCK TABLES`は現在のバージョンの実験的な機能です。本番環境での使用はお勧めしません。

TiDBは、クライアントセッションがテーブルのロックを取得し、他のセッションとの協調アクセスや他のセッションによるテーブルの変更を防止するための機能を提供しています。セッションは自分自身のためだけにロックを取得または解放できます。他のセッションのためにロックを取得したり、他のセッションが保持するロックを解放したりすることはできません。

`LOCK TABLES`は、現在のクライアントセッションのためにテーブルのロックを取得します。`LOCK TABLES`と`SELECT`の権限を持っている場合、共通のテーブルのためにテーブルのロックを取得できます。

`UNLOCK TABLES`は、現在のセッションが保持するテーブルのロックを明示的に解放します。`LOCK TABLES`は、新しいロックを取得する前に、現在のセッションが保持するすべてのテーブルのロックを暗黙的に解放します。

テーブルのロックは、他のセッションによる読み取りまたは書き込みを防ぎます。`WRITE`ロックを保持するセッションは、`DROP TABLE`や`TRUNCATE TABLE`などのテーブルレベルの操作を実行できます。

> **注意：**
>
> テーブルロック機能はデフォルトで無効になっています。
>
> - TiDB自己ホスト型の場合、テーブルロック機能を有効にするには、すべてのTiDBインスタンスの設定ファイルで[`enable-table-lock`](https://docs.pingcap.com/tidb/stable/tidb-configuration-file#enable-table-lock-new-in-v400)を`true`に設定する必要があります。
> - TiDB Cloudの場合、テーブルロック機能を有効にするには、[TiDB Cloudのサポート](https://docs.pingcap.com/tidbcloud/tidb-cloud-support)に連絡して[`enable-table-lock`](https://docs.pingcap.com/tidb/stable/tidb-configuration-file#enable-table-lock-new-in-v400)を`true`に設定する必要があります。

## 概要

```ebnf+diagram
LockTablesDef
         ::= 'LOCK' ( 'TABLES' | 'TABLE' ) TableName LockType ( ',' TableName LockType)*


UnlockTablesDef
         ::= 'UNLOCK' 'TABLES'

LockType
         ::= 'READ' ('LOCAL')?
           | 'WRITE' ('LOCAL')?
```

## テーブルロックの取得

`LOCK TABLES`文を使用して、現在のセッションでテーブルロックを取得できます。次のロックタイプが利用可能です。

`READ`ロック:

- このロックを保持するセッションはテーブルを読み取ることができますが、書き込むことはできません。
- 複数のセッションが同時に同じテーブルから`READ`ロックを取得できます。
- 他のセッションは、明示的に`READ`ロックを取得しなくてもテーブルを読み取ることができます。

`READ LOCAL`ロックは、MySQLとの構文の互換性のためだけであり、サポートされていません。

`WRITE`ロック:

- このロックを保持するセッションはテーブルを読み書きできます。
- このロックを保持しているセッションだけがテーブルにアクセスできます。他のセッションはロックが解除されるまでそのテーブルにアクセスできません。

`WRITE LOCAL`ロック:

- このロックを保持するセッションはテーブルを読み書きできます。
- このロックを保持しているセッションだけがテーブルにアクセスできます。他のセッションはテーブルを読み取ることはできますが、書き込むことはできません。

`LOCK TABLES`文が必要とするロックが他のセッションによって保持されている場合、`LOCK TABLES`文は待機する必要があり、この文の実行時にエラーが返されます。例：

```sql
> LOCK TABLES t1 READ;
ERROR 8020 (HY000): Table 't1' was locked in WRITE by server: f4799bcb-cad7-4285-8a6d-23d3555173f1_session: 2199023255959
```

前述のエラーメッセージは、TiDB `f4799bcb-cad7-4285-8a6d-23d3555173f1`のセッションID`2199023255959`がテーブル`t1`で`WRITE`ロックをすでに保持していることを示しています。したがって、現在のセッションはテーブル`t1`で`READ`ロックを取得できません。

単一の`LOCK TABLES`文内で同じテーブルロックを複数回取得することはできません。

```sql
> LOCK TABLES t WRITE, t READ;
ERROR 1066 (42000): Not unique table/alias: 't'
```

## テーブルロックの解除

セッションが保持するテーブルのロックが解除されると、一度にすべて解放されます。セッションは、明示的にロックを解除したり、暗黙的に解除することができます。

- セッションは`UNLOCK TABLES`を使用して明示的にロックを解除できます。
- セッションが既にロックを保持している場合、`LOCK TABLES`文を使用して新しいロックを取得すると、既存のロックが暗黙的に解除されます。

クライアントセッションの接続が正常または異常に終了すると、TiDBはそのセッションが保持するすべてのテーブルロックを暗黙的に解除します。クライアントが再接続すると、ロックは有効ではありません。このため、クライアントで自動再接続を有効にすることは推奨されません。自動再接続を有効にすると、クライアントが再接続が発生したときに通知されず、すべてのテーブルロックや現在のトランザクションが失われます。それに対して、自動再接続を無効にした場合、接続が切断されると、次の文が実行されるとエラーが発生します。クライアントはエラーを検出し、適切な処置をとることができます。例えば、ロックを再取得したり、トランザクションをやり直したりすることができます。

## テーブルロックの制限と条件

`KILL`を使用してテーブルロックを保持するセッションを終了することができます。

次のデータベースのテーブルに対しては、テーブルロックを取得することはできません:

- `INFORMATION_SCHEMA`
- `PERFORMANCE_SCHEMA`
- `METRICS_SCHEMA`
- `mysql`

## MySQLとの互換性

### テーブルロックの取得

- TiDBでは、セッションAがすでにテーブルロックを保持している場合、セッションBがテーブルに書き込もうとするとエラーが返されます。MySQLでは、セッションBの書き込みリクエストはセッションAがテーブルロックを解除するまでブロックされ、他のセッションからのテーブルのロック要求も現在のセッションが`WRITE`ロックを解除するまでブロックされます。
- TiDBでは、`LOCK TABLES`文が必要とするロックが他のセッションによって保持されている場合、`LOCK TABLES`文は待機する必要があり、この文の実行時にエラーが返されます。MySQLでは、この文はロックが取得されるまでブロックされます。
- TiDBでは、`LOCK TABLES`文はクラスタ全体で有効です。MySQLでは、この文は現在のMySQLサーバーでのみ有効であり、NDBクラスタとの互換性がありません。

### テーブルロックの解除

TiDBのセッションでトランザクションが明示的に開始された場合（たとえば、`BEGIN`文を使用して）、TiDBはセッションが保持するテーブルロックを暗黙に解除しませんが、MySQLでは解除します。