---
title: コストモデル
summary: TiDBが物理的な最適化中に使用するコストモデルの仕組みを学びます。
---

# コストモデル

TiDBは[物理的最適化](/sql-physical-optimization.md)の過程でインデックスとオペレータを選択するためにコストモデルを使用します。このプロセスは次の図で示されています:

![CostModel](/media/cost-model.png)

TiDBは、プラン（HashJoinやIndexJoinなど）内の各インデックスのアクセスコストと各物理オペレータの実行コストを計算し、最小コストのプランを選択します。

以下はコストモデルがどのように機能するかを説明する簡単な例です。テーブル`t`があるとします:

```sql
mysql> SHOW CREATE TABLE t;
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                        |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t     | CREATE TABLE `t` (
  `a` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL,
  `c` int(11) DEFAULT NULL,
  KEY `b` (`b`),
  KEY `c` (`c`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
```

`SELECT * FROM t WHERE b < 100 and c < 100` を実行すると、TiDBは`b < 100`条件を満たす行が20、`c < 100`条件を満たす行が500と推定し、`INT`タイプのインデックスの長さが8であるとします。その後TiDBは2つのインデックスのコストを計算します:

+ インデクス`b`のコスト = `b < 100`を満たす行数 \* インデックス`b`の長さ = 20 * 8 = 160
+ インデクス`c`のコスト = `c < 100`を満たす行数 \* インデックス`c`の長さ = 500 * 8 = 4000

インデクス`b`のコストがより低いため、TiDBはインデクス`b`を選択します。

前述の例は簡略化されたものであり、基本的な原理を説明するために使用されています。実際のSQL実行では、TiDBのコストモデルはより複雑です。

## コストモデルバージョン2

TiDB v6.2.0では、新しいコストモデルであるコストモデルバージョン2が導入されています。

コストモデルバージョン2では、コスト計算式のより正確な回帰補正、いくつかのコスト計算式の調整が行われ、前のバージョンよりも正確です。

コストモデルのバージョンを切り替えるには、[`tidb_cost_model_version`](/system-variables.md#tidb_cost_model_version-new-in-v620)変数を設定します。

> **注意:**
>
> コストモデルのバージョンを切り替えると、クエリプランに変更が生じる可能性があります。