---
title: TiDB TPC-H パフォーマンステストレポート -- v5.4 MPP モード vs. Greenplum 6.15.0 および Apache Spark 3.1.1
---

# TiDB TPC-H パフォーマンステストレポート -- TiDB v5.4 MPP モード vs. Greenplum 6.15.0 および Apache Spark 3.1.1

## テスト概要

このテストは、TiDB v5.4 MPP モードの TPC-H 100 GB のパフォーマンスを、他の2つの主要なアナリティクスエンジンであるGreenplumとApache Sparkの最新バージョンと比較することを目的としています。 テストの結果、TiDB v5.4 MPP モードのパフォーマンスは、TPC-Hのワークロード下で他の2つのソリューションよりも2倍から3倍高速であることが示されています。

v5.0では、[TiFlash](/tiflash/tiflash-overview.md)向けのMPP（Massively Parallel Processing）モードがTiDBに導入され、TiDBのハイブリッドトランザクションおよびアナリティカル処理（HTAP）機能が大幅に向上しています。 このレポートのテストオブジェクトは以下の通りです:

+ TiDB v5.4 MPP モードでの列指向ストレージ
+ Greenplum 6.15.0
+ Apache Spark 3.1.1 + Parquet

## テスト環境

### ハードウェア要件

| インスタンスの種類 | インスタンスの数 |
|:----------|:----------|
| PD        | 1 |
| TiDB     | 1 |
| TiKV     | 3 |
| TiFlash   | 3 |

+ CPU: Intel(R) Xeon(R) CPU E5-2630 v4 @ 2.20GHz, 40 cores
+ メモリ: 189 GB
+ ディスク: NVMe 3TB * 2

### ソフトウェアバージョン

| サービスの種類 | ソフトウェアのバージョン |
|:----------|:-----------|
| TiDB      | 5.4        |
| Greenplum   |  6.15.0  |
| Apache Spark | 3.1.1   |

### パラメータの設定

#### TiDB v5.4

v5.4クラスターでは、TiDBは以下の構成項目以外のデフォルトのパラメータ構成を使用します。

TiFlashの構成ファイル`users.toml`で`max_memory_usage`を以下のように設定します:

```toml
[profiles.default]
max_memory_usage = 10000000000000
```

以下のSQLステートメントでセッション変数を設定します:

```sql
set @@tidb_isolation_read_engines='tiflash';
set @@tidb_allow_mpp=1;
set @@tidb_mem_quota_query = 10 << 30;
```

すべてのTPC-Hテストテーブルは、カラム形式でTiFlashにレプリケートされ、追加のパーティションやインデックスはありません。

#### Greenplum

最初の3つのノードを除いて、Greenplumクラスターは追加のマスターノードを使用して展開されます。 各セグメントサーバーには8つのセグメントが含まれており、つまりNVMe SSDあたり4つのセグメントがあります。 セグメント数は合計で24です。 ストレージ形式は追記専用/列指向ストレージであり、パーティションキーは主キーとして使用されます。

{{< copyable "" >}}

```
log_statement = all
gp_autostats_mode = none
statement_mem = 2048MB
gp_vmem_protect_limit = 16384
```

#### Apache Spark

Apache Sparkのテストでは、Apache Parquetをストレージ形式とし、データをHDFSに格納します。 HDFSシステムは3つのノードで構成されています。 各ノードには、データディスクとして割り当てられたNVMe SSDディスクが2つあります。 Sparkクラスターはスタンドアロンモードで展開され、`spark.local.dir`のローカルディレクトリにNVMe SSDディスクを使用し、追加のパーティションやインデックスはありません。

{{< copyable "" >}}

```
--driver-memory 20G
--total-executor-cores 120
--executor-cores 5
--executor-memory 15G
```

## テスト結果

> **注:**
>
> 以下のテスト結果は3つのテストの平均データです。 すべての数値は秒単位です。

| クエリID |  TiDB v5.4  |  Greenplum 6.15.0 |  Apache Spark 3.1.1 + Parquet |
| :-------- | :----------- | :------------ | :-------------- |
| 1       |    8.08   |      64.1307  |      52.64   |
| 2       |    2.53   |      4.76612  |      11.83   |
| 3       |    4.84   |      15.62898  |      13.39  |
| 4       |    10.94  |  12.88318    |      8.54     |
| 5       |   12.27    | 23.35449    |      25.23    |
| 6       |    1.32    |   6.033     |      2.21     |
| 7       |    5.91    |   12.31266  |      25.45    |
| 8       |    6.71    |   11.82444  |      23.12    |
| 9       |   44.19    |   22.40144  |       35.2    |
| 10      |    7.13    |   12.51071  |      12.18    |
| 11      |    2.18    |  2.6221     |      10.99    |
| 12      |    2.88    |   7.97906   |      6.99     |
| 13      |    6.84    |   10.15873  |      12.26    |
| 14      |    1.69    |   4.79394   |       3.89    |
| 15      |   3.29     |   10.48785  |       9.82    |
| 16      |    5.04    |   4.64262   |       6.76    |
| 17      |   11.7     |   74.65243  |      44.65    |
| 18      |   12.87    |   64.87646  |      30.27    |
| 19      |    4.75    |   8.08625   |        4.7    |
| 20      |    8.89    |   15.47016  |        8.4    |
| 21      |   24.44    |   39.08594  |      34.83    |
| 22      |    1.23    |   7.67476   |       4.59    |

![TPC-H](/media/tidb-v5.4-tpch-100-vs-gp-spark.png)

上記のパフォーマンスダイアグラムでは:

- 青い線はTiDB v5.4を表します;
- 赤い線はGreenplum 6.15.0を表します;
- 黄色い線はApache Spark 3.1.1を表します。
- y軸はクエリの実行時間を表しています。時間が短いほどパフォーマンスが良いです。