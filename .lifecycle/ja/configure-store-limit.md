---
title: ストア制限
summary: ストア制限の機能を学ぶ
aliases: ['/docs/dev/configure-store-limit/']
---

# ストア制限

ストア制限はTiDB 3.0で導入されたPDの機能です。さまざまなシナリオでのパフォーマンスを向上させるために、スケジューリング速度をより細かく制御するために設計されています。

## 実装原則

PDはオペレータの単位でスケジューリングを行います。オペレータには複数のスケジューリング操作が含まれる場合があります。例:

```
"replace-down-replica {mv peer: store [2] to [3]} (kind:region,replica, region:10(4,5), createAt:2020-05-18 06:40:25.775636418 +0000 UTC m=+2168762.679540369, startAt:2020-05-18 06:40:25.775684648 +0000 UTC m=+2168762.679588599, currentStep:0, steps:[add learner peer 20 on store 3, promote learner peer 20 on store 3 to voter, remove peer on store 2])"
```

上記の例では、`replace-down-replica` オペレータには以下の具体的な操作が含まれています:

1. IDが `20` のラーナーピアを `ストア3` に追加します。
2. IDが `20` のラーナーピアを `ストア3` で有権者に昇格させます。
3. `ストア2` のピアを削除します。


ストア制限は、ストアIDからトークンバケットへのマッピングをメモリ内で保持することで、ストアレベルのスピード制限を実現しています。ここでの異なる操作は異なるトークンバケットに対応しています。現在、ストア制限はラーナーピア/ピアの追加とピアの削除のスピードの制限のみをサポートしています。つまり、各ストアには2種類のトークンバケットがあります。

オペレータが生成されるたびに、その操作に必要なトークンがトークンバケットに存在するかどうかをチェックします。トークンがあれば、オペレータはスケジューリングキューに追加され、対応するトークンがトークンバケットから取得されます。そうでなければ、オペレータは破棄されます。トークンバケットは固定速度でトークンを補充するため、スピード制限が実現されます。

ストア制限は、PDの他の制限関連パラメータ（ `region-schedule-limit` および `leader-schedule-limit` など）とは異なり、主にオペレータの消費速度を制限します。他のパラメータはオペレータの生成速度を制限します。ストア制限機能を導入する前は、スケジューリングのスピード制限は主にグローバルスコープで行われていました。そのため、グローバルスピードが制限されていても、スケジューリング操作が特定のストアに集中している可能性があり、クラスタのパフォーマンスに影響を与えることがありました。より細かいレベルで速度を制限することで、ストア制限はスケジューリング動作をよりよく制御することができます。

## 使用法

ストア制限のパラメータは `pd-ctl` を使用して設定できます。

### 現在のストア設定の表示

現在のストアの制限設定を表示するには、次のコマンドを実行します:

{{< copyable "shell-regular" >}}

```bash
store limit                         // すべてのストアでのラーナーピアの追加およびピアの削除のスピード制限を表示します。
store limit add-peer                // すべてのストアでのピアの追加のスピード制限を表示します。
store limit remove-peer             // すべてのストアでのピアの削除のスピード制限を表示します。 
```

### すべてのストアの制限の設定

すべてのストアのスピード制限を設定するには、次のコマンドを実行します:

{{< copyable "shell-regular" >}}

```bash
store limit all 5                   // すべてのストアは1分あたりに最大で5つのピアを追加および削除できます。
store limit all 5 add-peer          // すべてのストアは1分あたりに最大で5つのピアを追加できます。
store limit all 5 remove-peer       // すべてのストアは1分あたりに最大で5つのピアを削除できます。
```

### 個々のストアの制限の設定

単一のストアのスピード制限を設定するには、次のコマンドを実行します:

{{< copyable "shell-regular" >}}

```bash
store limit 1 5                     // ストア1は1分あたりに最大で5つのピアを追加および削除できます。
store limit 1 5 add-peer            // ストア1は1分あたりに最大で5つのピアを追加できます。
store limit 1 5 remove-peer         // ストア1は1分あたりに最大で5つのピアを削除できます。
```

### ストア制限 v2の原則

[`store-limit-version`](/pd-configuration-file.md#store-limit-version-new-in-v710) を `v2` に設定すると、ストア制限 v2が有効になります。v2モードでは、TiKVスナップショットの容量に基づいてオペレータの制限が動的に調整されます。TiKVの保留中のタスクが少ない場合、PDはスケジューリングタスクを増やします。それ以外の場合、PDはノードのスケジューリングタスクを減らします。そのため、スケジューリング処理のスピードアップのために手動で `store limit` を設定する必要はありません。

v2モードでは、TiKVの実行速度が移行中の主要なボトルネックとなります。現在のスケジューリング速度が上限に達しているかどうかは、**TiKVの詳細** > **スナップショット** > **スナップショット速度** パネルで確認できます。ノードのスケジューリング速度を増減させるには、TiKVのスナップショット制限（[`snap-io-max-bytes-per-sec`](/tikv-configuration-file.md#snap-io-max-bytes-per-sec)）を調整できます。