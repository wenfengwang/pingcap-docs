---
title: フォロワーリード
summary: このドキュメントでは、フォロワーリードの使用と実装について説明します。
aliases: ['/docs/dev/follower-read/','/docs/dev/reference/performance/follower-read/']
---

# フォロワーリード

あるリージョンで読み取りホットスポットが発生すると、そのリージョンのリーダーがシステム全体の読み取りボトルネックになることがあります。この状況では、フォロワーリード機能を有効にすることでリーダーの負荷を大幅に減らし、複数のフォロワー間で負荷を分散して全体のスループットを向上させることができます。このドキュメントでは、フォロワーリードの使用と実装メカニズムについて紹介します。

## 概要

フォロワーリード機能は、ストロングリーグによる一貫性のある読み取りを前提として、あるリージョンの任意のフォロワーレプリカを読み取り要求の提供に使用することを指します。この機能により、TiDBクラスタのスループットが向上し、リーダーの負荷が軽減されます。これには、TiKVの読み取り負荷をリージョン内のリーダーレプリカからフォロワーレプリカに移動する一連の負荷分散メカニズムが含まれます。TiKVのフォロワーリード実装は、ユーザーにストロングリーグによる読み取りを提供します。

> **注意:**
>
> ストロングリーグによる読み取りを達成するために、現在フォロワーノードはリーダーノード（つまり`ReadIndex`）から現在の実行進捗を要求する必要があり、これにより追加のネットワーク要求負荷が生じます。したがって、フォロワーリードの主な利点は、クラスタ内の読み取り要求と書き込み要求を分離し、全体の読み取りスループットを増やすことです。

## 使用方法

TiDBのフォロワーリード機能を有効にするには、`tidb_replica_read`変数の値を次のように変更します：

{{< copyable "sql" >}}

```sql
set [session | global] tidb_replica_read = '<target value>';
```

スコープ: SESSION | GLOBAL

デフォルト: leader

この変数は期待されるデータ読み取りモードを設定するために使用されます。

- `tidb_replica_read`の値が`leader`または空の文字列に設定されている場合、TiDBはデフォルトの動作を維持し、すべての読み取り操作をリーダーレプリカに実行させます。
- `tidb_replica_read`の値が`follower`に設定されている場合、TiDBはリージョンのフォロワーレプリカをすべての読み取り操作に使用します。
- `tidb_replica_read`の値が`leader-and-follower`に設定されている場合、TiDBは任意のレプリカを読み取り操作に使用できます。このモードでは、読み取りリクエストがリーダーとフォロワー間で負荷が分散されます。
- `tidb_replica_read`の値が`prefer-leader`に設定されている場合、TiDBはリーダーレプリカを優先して読み取り操作に使用します。ただし、リーダーレプリカが明らかに読み取り操作の処理が遅い場合（ディスクやネットワークの性能の揺らぎなどによる）、TiDBは他の利用可能なフォロワーレプリカを読み取り操作に使用します。
- `tidb_replica_read`の値が`closest-replicas`に設定されている場合、TiDBは同じ利用可能ゾーンのレプリカを読み取り操作に使用することを好みます。同じ利用可能ゾーンにレプリカがない場合、TiDBはリーダーレプリカから読み取ります。
- `tidb_replica_read`の値が`closest-adaptive`に設定されている場合：

    - 読み取り要求の推定結果が[`tidb_adaptive_closest_read_threshold`](/system-variables.md#tidb_adaptive_closest_read_threshold-new-in-v630)の値以上の場合、TiDBは読み取り操作に同じ利用可能ゾーンのレプリカを好みます。利用可能ゾーン間の読み取りトラフィックのバランスを取るために、TiDBは動的にオンラインのすべてのTiDBとTiKVノードによる利用可能ゾーンの分布を検出します。各利用可能ゾーンでは、`closest-adaptive`設定が有効になるTiDBノードの数が制限され、それは常にTiDBノードの中で最も少ない数のTiDBノードが存在する利用可能ゾーンの数と同じであり、その他のTiDBノードは自動的にリーダーレプリカから読み取ります。たとえば、TiDBノードが3つの利用可能ゾーン（A、B、C）に分散している場合（AとBがそれぞれ3つのTiDBノードを含み、Cが2つのTiDBノードのみを含む）、各利用可能ゾーンで`closest-adaptive`設定が有効になるTiDBノードの数は2であり、AとBの各利用可能ゾーンの他のTiDBノードは、リーダーレプリカを自動的に選択して読み取り操作を行います。
    - 読み取り要求の推定結果が[`tidb_adaptive_closest_read_threshold`](/system-variables.md#tidb_adaptive_closest_read_threshold-new-in-v630)の値未満の場合、TiDBはリーダーレプリカのみを読み取り操作に選択することができます。

- `tidb_replica_read`の値が`learner`に設定されている場合、TiDBはリーナーレプリカからデータを読み取ります。リージョンにリーナーレプリカがない場合は、TiDBはエラーを返します。

<CustomContent platform="tidb">

> **注意:**
>
> `tidb_replica_read`の値が`closest-replicas`または`closest-adaptive`に設定されている場合、指定された設定に従ってレプリカが利用可能ゾーンに均等に分布するようにクラスタを構成する必要があります。PDに`location-labels`を構成し、TiDBとTiKVに正しい`labels`を設定するには、[地域ラベルによるレプリカのスケジューリング](/schedule-replicas-by-topology-labels.md)を参照してください。TiDBは`zone`ラベルを使用して同じ利用可能ゾーンにあるTiKVノードを一致させるため、PDの`location-labels`に`zone`ラベルが含まれ、各TiDBおよびTiKVノードの構成に`zone`が含まれることを確認する必要があります。TiDB Operatorを使用してクラスタを展開した場合は、[データの高可用性](https://docs.pingcap.com/tidb-in-kubernetes/v1.4/configure-a-tidb-cluster#high-availability-of-data)を参照してください。

</CustomContent>

## 実装メカニズム

フォロワーリード機能が導入される前、TiDBは強力なリーダー原則を適用し、すべての読み取りおよび書き込み要求をリージョンのリーダーノードに送信しました。TiKVはリージョンを複数の物理ノードに均等に分散することができますが、各リージョンにおいて外部サービスを提供できるのはリーダーのみです。その他のフォロワーは、読み取り要求を処理することはできませんが、常にリーダーから複製されたデータを受け取り、フェイルオーバー時に新しいリーダーを選出するために投票の準備を行います。

TiDBのフォロワーリード機能の実装においては、フォロワーリード単純にリージョンの読み取り要求を負荷分散ポリシーに基づいてフォロワーレプリカに送信するため、フォロワーノードはRaftプロトコルの`ReadIndex`を使用してリーダーの最新のコミットインデックスを取得し、その後そのリーダーの最新のコミットインデックスをフォロワーにローカルに適用してから読み取り要求の処理を開始します。

### ストロングリーグによる読み取り

フォロワーノードが読み取り要求を処理する際、まずそのリージョンのリーダーと`ReadIndex`を使用してやり取りし、現在のRaftグループの最新のコミットインデックスを取得します。リーダーの最新のコミットインデックスがフォロワーにローカルに適用された後、読み取り要求の処理が開始されます。

### フォロワーレプリカの選択戦略

フォロワーリード機能がSnapshot Isolation を繰り返し、影響を与えないため、TiDBはフォロワーレプリカを選択するためにラウンドロビン戦略を採用します。現在、コプロセッサのリクエストに対しては、フォロワーリードの負荷分散ポリシーの粒度は接続レベルです。特定のリージョンに接続されたTiDBクライアントに対して選択されたフォロワーレプリカは固定され、それが失敗した場合やスケジューリングポリシーが調整された場合のみ切り替えられます。

ただし、非コプロセッサのリクエスト（ポイントクエリなど）に対しては、フォロワーリードの負荷分散ポリシーの粒度はトランザクションレベルです。特定のリージョンのTiDBトランザクションにおいて選択されたフォロワーレプリカは固定され、それが失敗した場合やスケジューリングポリシーが調整された場合のみ切り替えられます。