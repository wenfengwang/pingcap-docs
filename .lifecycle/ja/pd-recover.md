---
title: PD Recoverユーザーガイド
summary: PD Recoverを使用して、正常に起動できないまたはサービスを正常に提供できないPDクラスターを復旧します。
aliases: ['/docs/dev/pd-recover/','/docs/dev/reference/tools/pd-recover/']
---

# PD Recoverユーザーガイド

PD Recoverは、正常に起動できないまたはサービスを正常に提供できないPDクラスターを復旧するためのPDの災害復旧ツールです。

## ソースコードからコンパイル

+ Goの[Go modules](https://golang.org/)を使用しているため、Go 1.21以降が必要です。
+ [PDプロジェクト](https://github.com/pingcap/pd)のルートディレクトリで、`make pd-recover`コマンドを使用して`bin/pd-recover`をコンパイルおよび生成します。

> **注:**
>
> 通常、リリースされているバイナリやDockerに既にPD Controlツールが存在しているため、ソースコードをコンパイルする必要はありません。ただし、開発者はソースコードをコンパイルするために上記の手順を参照することができます。

## TiDB Toolkitのダウンロード

PD RecoverのインストールパッケージはTiDB Toolkitに含まれています。TiDB Toolkitをダウンロードするには、[TiDBツールのダウンロード](/download-ecosystem-tools.md)を参照してください。

以下のセクションでは、PDクラスターを復旧する2つの方法を紹介します: 生存しているPDノードからの復旧とPDクラスター全体の再構築。

## 方法1: 生存しているPDノードを使用してPDクラスターを復旧する

クラスターの過半数のPDノードが回復不可能なエラーを経験すると、クラスターはサービスを提供できなくなります。生存しているPDノードがある場合は、生存しているPDノードを選択し、Raftグループのメンバーを強制的に変更してサービスを復旧することができます。手順は次のとおりです。

### ステップ1: すべてのノードを停止

復旧プロセス中にPDパラメータとの相互作用によってデータの破損や回復不能なエラーが発生することを防ぐために、クラスター内のTiDB、TiKV、およびTiFlashプロセスを停止します。

### ステップ2: 生存しているPDノードを起動する

生存しているPDノードを`--force-new-cluster`起動パラメータを使用して起動します。以下は一例です：

```shell
./bin/pd-server --force-new-cluster --name=pd-127.0.0.10-2379 --client-urls=http://0.0.0.0:2379 --advertise-client-urls=http://127.0.0.1:2379 --peer-urls=http://0.0.0.0:2380 --advertise-peer-urls=http://127.0.0.1:2380 --config=conf/pd.toml
```

### ステップ3: `pd-recover`を使用してメタデータを修復する

この方法は少数のPDノードに依存するため、ノードには古いデータが含まれている可能性があります。`alloc_id`と`TSO`データがロールバックされると、クラスターデータが破損したり利用できなくなったりする可能性があります。これを防ぐために、`pd-recover`を使用してメタデータを修正し、ノードが正しい割り当てIDとTSOサービスを提供できることを確認する必要があります。以下は一例です：

```shell
./bin/pd-recover --from-old-member --endpoints=http://127.0.0.1:2379 # 対応するPDアドレスを指定
```

> **注:**
>
> このステップでは、ストレージ内の`alloc_id`が安全な値である`100000000`増加します。その結果、後続のクラスターはより大きなIDを割り当てます。
>
> また、`pd-recover`はTSOを変更しません。したがって、このステップを実行する前に、障害が発生する前の時間よりもローカル時間が後であることを確認し、障害発生前のPDコンポーネント間でNTP時計同期サービスが有効になっていることを確認してください。有効になっていない場合は、TSOがロールバックされないように、ローカルクロックを将来の時間に調整する必要があります。

### ステップ4: PDノードを再起動する

`recovery is successful`というプロンプトメッセージが表示されたら、PDノードを再起動します。

### ステップ5: PDをスケールアウトしてクラスターを起動する

展開ツールを使用してPDクラスターをスケールアウトし、クラスター内の他のコンポーネントを起動します。この時点で、PDサービスは利用可能です。

## 方法2: PDクラスター全体を再構築する

この方法は、すべてのPDデータが失われたが、TiDB、TiKV、およびTiFlashなどの他のコンポーネントのデータがまだ存在するシナリオに適用されます。

### ステップ1: クラスターIDを取得する

クラスターIDは、PD、TiKV、またはTiDBのログから取得できます。クラスターIDを取得するには、サーバー上でログを直接表示できます。

#### PDログからクラスターIDを取得 (推奨)

PDログからクラスターIDを取得するには、次のコマンドを実行します：

{{< copyable "shell-regular" >}}

```bash
cat {{/path/to}}/pd.log | grep "init cluster id"
```

```bash
[2019/10/14 10:35:38.880 +00:00] [INFO] [server.go:212] ["init cluster id"] [cluster-id=6747551640615446306]
...
```

#### TiDBログからクラスターIDを取得

TiDBログからクラスターIDを取得するには、次のコマンドを実行します：

{{< copyable "shell-regular" >}}

```bash
cat {{/path/to}}/tidb.log | grep "init cluster id"
```

```bash
2019/10/14 19:23:04.688 client.go:161: [info] [pd] init cluster id 6747551640615446306
...
```

#### TiKVログからクラスターIDを取得

TiKVログからクラスターIDを取得するには、次のコマンドを実行します：

{{< copyable "shell-regular" >}}

```bash
cat {{/path/to}}/tikv.log | grep "connect to PD cluster"
```

```bash
[2019/10/14 07:06:35.278 +00:00] [INFO] [tikv-server.rs:464] ["connect to PD cluster 6747551640615446306"]
...
```

### ステップ2: 割り当てられたIDを取得する

指定する割り当てIDの値は、現在の最大の割り当てID値よりも大きくする必要があります。割り当てIDを取得するには、モニターから取得するか、サーバー上でログを直接表示できます。

#### モニターから割り当てIDを取得 (推奨)

モニターから割り当てIDを取得するには、表示しているメトリクスが**最後のPDリーダー**のメトリクスであることを確認し、PDダッシュボードの**Current ID allocation**パネルで最大の割り当てIDを取得できます。

#### PDログから割り当てIDを取得

PDログから割り当てIDを取得するには、表示しているログが**最終のPDリーダー**のログであることを確認し、次のコマンドを実行することで、最大の割り当てIDを取得できます：

{{< copyable "shell-regular" >}}

```bash
cat {{/path/to}}/pd*.log | grep "idAllocator allocates a new id" |  awk -F'=' '{print $2}' | awk -F']' '{print $1}' | sort -r -n | head -n 1
```

```bash
4000
...
```

または、以上のコマンドをすべてのPDサーバーで実行して最大の割り当てIDを見つけることができます。

### ステップ3: 新しいPDクラスターをデプロイする

新しいPDクラスターをデプロイする前に、既存のPDクラスターを停止し、前のデータディレクトリを削除するか、`--data-dir`を使用して新しいデータディレクトリを指定する必要があります。

### ステップ4: pd-recoverを使用する

`pd-recover`を1つのPDノードで実行する必要があります。

{{< copyable "shell-regular" >}}

```bash
./pd-recover -endpoints http://10.0.1.13:2379 -cluster-id 6747551640615446306 -alloc-id 10000
```

### ステップ5: クラスター全体を再起動する

回復が成功したと表示されたら、クラスター全体を再起動します。

## よくある質問

### クラスターIDを取得する際に複数のクラスターIDが見つかる

PDクラスターが作成されると、新しいクラスターIDが生成されます。ログを表示することで、古いクラスターのクラスターIDを特定できます。

### `pd-recover`を実行すると`dial tcp 10.0.1.13:2379: connect: connection refused`というエラーが返される

`pd-recover`を実行するにはPDサービスが必要です。PD Recoverを使用する前にPDクラスターをデプロイして起動してください。