---
title: TiDBサイズの決定
summary: TiDBクラウドクラスターのサイズを決定する方法を学びます。

# TiDBサイズの決定

このドキュメントでは、TiDB Dedicatedクラスターのサイズを決定する方法について説明します。

> **注：**
>
> [TiDB Serverless](/tidb-cloud/select-cluster-tier.md#tidb-serverless) クラスターのサイズは変更できません。

## TiDBのサイズ

TiDBは計算専用であり、データを格納しません。水平スケーラブルです。

TiDBのノード数、vCPU、RAMを構成することができます。

異なるクラスタースケールの性能テスト結果については、[TiDBクラウド性能リファレンス](/tidb-cloud/tidb-cloud-performance-reference.md)を参照してください。

### TiDBのvCPUとRAM

サポートされているvCPUとRAMのサイズは次の通りです：

- 2 vCPU、8 GiB（ベータ版）
- 4 vCPU、16 GiB
- 8 vCPU、16 GiB
- 16 vCPU、32 GiB

> **注：**
>
> TiDBのvCPUとRAMサイズが「2 vCPU、8 GiB（ベータ版）」または「4 vCPU、16 GiB」に設定されている場合は、次の制限に注意してください：
>
> - TiDBのノード数は1または2にのみ設定でき、TiKVのノード数は固定されている。
> - 2 vCPUのTiDBは2 vCPUのTiKVとのみ使用できます。4 vCPUのTiDBは4 vCPUのTiKVとのみ使用できます。
> - TiFlashは使用できません。

### TiDBのノード数

高可用性のために、TiDBクラウドクラスターごとに少なくとも2つのTiDBノードを構成することを推奨します。

一般的に、TiDBのパフォーマンスはTiDBノードの数と比例して増加します。ただし、TiDBノードの数が8を超えると、性能の増加幅はほぼ線形比例となります。さらに8ノードごとに、性能の偏差係数は約5％です。

例：

- TiDBノードが9台ある場合、性能の偏差係数は約5％であるため、TiDBのパフォーマンスは「9 *（1 - 5％）= 8.55」のTiDBノードの性能になります。
- TiDBノードが16台ある場合、性能の偏差係数は約10％であるため、TiDBのパフォーマンスは「16 *（1 - 10％）= 14.4」のTiDBノードの性能になります。

指定されたTiDBノードの遅延時間では、異なる読み書き比率に応じてTiDBのパフォーマンスが異なります。

異なるワークロードにおける8 vCPU、16 GiB TiDBノードのパフォーマンスは以下の通りです：

| ワークロード | QPS（P95 ≈ 100ms） | QPS（P99 ≈ 300ms） | QPS（P99 ≈ 100ms） |
|-------------|-------------------|-------------------|-------------------|
| 読み取り    | 18,900            | 9,450             | 6,300             |
| ミックス    | 15,500            | 7,750             | 5,200             |
| 書き込み    | 18,000            | 9,000             | 6,000             |

TiDBノードの数が8を下回る場合、性能の偏差係数はほぼ0％であり、16 vCPU、32 GiB TiDBノードのTiDBのパフォーマンスは基本的に8 vCPU、16 GiB TiDBノードのそれの約2倍です。TiDBノードの数が8を超える場合は、より少ないノードが必要となるため、性能の偏差係数が小さい16 vCPU、32 GiB TiDBノードを選択することを推奨します。

クラスターサイズを計画する際は、ワークロードタイプ、全体的な期待パフォーマンス（QPS）、およびワークロードタイプに対応する単一のTiDBノードのパフォーマンスを使用して、次の公式を使用してTiDBノードの数を推定することができます：

`ノード数 = ceil（全体的な期待パフォーマンス ÷ ノードごとのパフォーマンス *（1-パフォーマンス偏差係数））`

この式では、まず `ノード数 = ceil（全体的な期待パフォーマンス ÷ ノードごとのパフォーマンス）` を計算して、おおまかなノード数を求め、その後対応するパフォーマンス偏差係数を使用してノード数の最終結果を得ます。

例えば、ミックスのワークロード下での全体的な期待パフォーマンスが110,000 QPS、 P95の遅延時間が約100 msで、8 vCPU、16 GiB TiDBノードを使用したい場合、以前のテーブルから8 vCPU、16 GiB TiDBノードの推定TiDBパフォーマンス（15,500 QPS）を取得し、次のようにしておおまかなTiDBノードの数を計算できます：

`ノード数 = ceil（110,000 ÷ 15,500）= 8`

8ノードのパフォーマンス偏差係数が約5％であるため、推定されたTiDBのパフォーマンスは次のようになります： `8 * 15,500 *（1-5％）= 117,800`、これは110,000 QPSの期待パフォーマンスを満たすことができます。

したがって、8 TiDBノード（8 vCPU、16 GiB）がお勧めです。

## TiKVのサイズ

TiKVはデータの格納を担当しています。水平スケーラブルです。

TiKVのノード数、vCPU、RAM、およびストレージを構成することができます。

異なるクラスタースケールの性能テスト結果については、[TiDBクラウド性能リファレンス](/tidb-cloud/tidb-cloud-performance-reference.md)を参照してください。

### TiKVのvCPUとRAM

サポートされているvCPUとRAMのサイズは次の通りです：

- 2 vCPU、8 GiB（ベータ版）
- 4 vCPU、16 GiB
- 8 vCPU、32 GiB
- 8 vCPU、64 GiB
- 16 vCPU、64 GiB

> **注：**
>
> TiKVのvCPUとRAMサイズが「2 vCPU、8 GiB（ベータ版）」または「4 vCPU、16 GiB」に設定されている場合は、次の制限に注意してください：
>
> - TiDBのノード数は1または2にのみ設定でき、TiKVのノード数は固定されている。
> - 2 vCPUのTiKVは2 vCPUのTiDBとのみ使用できます。4 vCPUのTiKVは4 vCPUのTiDBとのみ使用できます。
> - TiFlashは使用できません。

### TiKVのノード数

TiKVのノード数は**少なくとも1セット（3つの異なるAZの3つのノード）**である必要があります。

TiDBクラウドは、耐久性と高可用性を実現するために、選択したリージョンのすべての可用性ゾーン（少なくとも3つ）にTiKVノードを均等に展開します。典型的な3レプリカのセットアップでは、データはすべての可用性ゾーンに均等に分散され、各TiKVノードのディスクに永続的に格納されます。

> **注：**
>
> TiDBクラスターのスケーリング時には、3つの可用性ゾーンのノードが同時に増減します。TiDBクラスターをスケーリングインまたはアウトする方法については、[TiDBクラスターをスケーリングする](/tidb-cloud/scale-tidb-cluster.md)を参照してください。

TiKVは主にデータの格納に使用されますが、TiKVノードのパフォーマンスも異なるワークロードによって異なります。そのため、TiKVノードの数を計画する際には、[**データボリューム**に応じてTiKVノードの数を推定](#データボリュームに応じたTiKVノード数の推定)し、[期待されるパフォーマンスに応じてTiKVノードの数を推定](#期待されるパフォーマンスに応じたTiKVノード数の推定)し、そのうち大きい方を推奨されるノード数として採用する必要があります。

#### データボリュームに応じたTiKVノード数の推定

データのボリュームに応じたTiKVノード数の推定数は次の通り計算できます：

`ノード数 = ceil（データのサイズ × TiKVの圧縮率 × レプリカ数 ÷ TiKVのストレージ利用率 ÷ 1つのTiKVのキャパシティ ÷ 3）* 3`

一般的に、TiKVのストレージ利用率は80％以下に保つことを推奨します。TiDBクラウドのレプリカ数はデフォルトで3です。8 vCPU、64 GiB TiKVノードの最大ストレージ容量は4096 GiBです。

過去のデータに基づくと、TiKVの平均圧縮率は約40％です。

例えば、MySQLのダンプファイルのサイズが20 TBでTiKVの圧縮率が40％であるとします。その場合、データボリュームに応じたTiKVノードの推奨数は次のように計算できます：

`ノード数 = ceil（20 TB × 40％ × 3 ÷ 0.8 ÷ 4096 GiB ÷ 3）* 3 = 9`

#### 期待されるパフォーマンスに応じたTiKVノード数の推定

TiDBのパフォーマンスと同様に、TiKVのパフォーマンスもTiKVノードの数と比例して増加します。ただし、TiKVノードの数が8を超えると、性能の増加幅はほぼ線形比例となります。さらに8ノードごとに、性能の偏差係数は約5％です。

例：

- TiKVノードが9台ある場合、性能の偏差係数は約5％であるため、TiKVのパフォーマンスは「9 *（1 - 5％）= 8.55」のTiKVノードの性能になります。
- TiKVノードが18個の場合、性能の偏差係数は約10%であり、したがってTiKVの性能は単一のTiKVノードの性能の約16.2倍となります（18 * (1 - 10%) = 16.2）。

指定されたTiKVノードの遅延時間に応じて、異なる読み書き比率によってTiKVの性能が変化します。

異なるワークロードにおける8 vCPU、32 GiBのTiKVノードの性能は次のとおりです：

| ワークロード | QPS（P95 ≈ 100ms） | QPS（P99 ≈ 300ms） | QPS（P99 ≈ 100ms） |
|----------|-------------------|-------------------|-------------------|
| Read     | 28,000            | 14,000            | 7,000             |
| Mixed    | 17,800            | 8,900             | 4,450             |
| Write    | 14,500            | 7,250             | 3,625             |

もしTiKVノードの数が8を下回る場合、性能の偏差係数はほぼ0%であり、従って16 vCPU、64 GiBのTiKVノードの性能は8 vCPU、32 GiBのTiKVノードの約2倍となります。TiKVノードの数が8を超える場合は、より少ないノード数が必要となる16 vCPU、64 GiBのTiKVノードを選択することが推奨されます。これにより性能の偏差係数が小さくなります。

クラスタサイズを計画する際には、以下の式を使用して、ワークロードタイプ、全体の期待される性能（QPS）、およびワークロードタイプに対応する単一のTiKVノードの性能に応じて、TiKVノードの数を見積ることができます。

`ノード数 = ceil(全体の期待される性能 ÷ ノードごとの性能 * (1 - 性能の偏差係数))`

この式では、まず`ノード数 = ceil(全体の期待される性能 ÷ ノードごとの性能)`を計算しておおまかなノード数を決定し、その後、対応する性能の偏差係数を使用して最終的なノード数の結果を得る必要があります。

例えば、ミックスワークロードの下で全体の期待される性能が110,000 QPSであり、P95の遅延時間が約100msであり、8 vCPU、32 GiBのTiKVノードを使用したい場合、先の表から8 vCPU、32 GiBのTiKVノードの推定される性能（17,800）を取得し、次のようにしてTiKVノードのおおまかな数を計算できます：

`ノード数 = ceil(110,000 / 17,800 ) = 7`

7は8を下回るため、7つのノードの性能の偏差係数は0です。推定されるTiKVの性能は`7 * 17,800 * (1 - 0) = 124,600`となり、これは110,000 QPSの期待される性能を満たすことができます。

したがって、あなたの期待される性能に応じて7つのTiKVノード（8 vCPU、32 GiB）がお勧めされます。

次に、データボリュームに応じて計算されたTiKVノードの数と、期待される性能に応じて計算された数を比較し、大きい方をTiKVノードの推奨数として採用することができます。

### TiKVノードのストレージ

異なるTiKV vCPUのサポートされているノードストレージは次のとおりです：

| TiKV vCPU | 最小ノードストレージ | 最大ノードストレージ | デフォルトノードストレージ |
|:---------:|:--------------------:|:--------------------:|:-----------------------:|
| 2 vCPU    | 200 GiB             |     500 GiB          | 200 GiB               |
| 4 vCPU    | 200 GiB             |     2048 GiB         | 500 GiB               |
| 8 vCPU    | 200 GiB             |     4096 GiB         | 500 GiB               |
| 16 vCPU   | 200 GiB             |     6144 GiB         | 500 GiB               |

> **注意:**
>
> クラスタ作成後にTiKVノードのストレージを減らすことはできません。

## TiFlashのサイズ

TiFlashはTiKVからデータをリアルタイムで同期し、箱からエンタープライズまでリアルタイムの分析ワークロードをサポートします。水平方向にスケーラブルです。

TiFlashのノード数、vCPUとRAM、ストレージを構成することができます。

### TiFlashのvCPUとRAM

サポートされているvCPUとRAMのサイズは以下のとおりです：

- 8 vCPU、64 GiB
- 16 vCPU、128 GiB

TiDBまたはTiKVのvCPUとRAMのサイズが**2 vCPU、8 GiB（Beta）**または**4 vCPU、16 GiB**に設定されている場合は、TiFlashを使用することができません。

### TiFlashのノード数

TiDB CloudはTiFlashノードをリージョン内の異なる可用性ゾーンに均等に展開します。本番環境において高い可用性のために、TiDB Cloudクラスタごとに少なくとも2つのTiFlashノードを構成し、データの少なくとも2つのレプリカを作成することが推奨されます。

TiFlashノードの最小数は、特定のテーブルのTiFlashレプリカの数に依存します：

TiFlashノードの最小数: `min((テーブルAの圧縮サイズ * テーブルAのレプリカ + テーブルBの圧縮サイズ * テーブルBのレプリカ) / 各TiFlashキャパシティのサイズ, max(テーブルAのレプリカ, テーブルBのレプリカ))`

例えば、AWS上の各TiFlashノードのノードストレージを1024 GiBとして設定し、テーブルA用に2つのレプリカ（圧縮サイズは800 GiB）およびテーブルB用に1つのレプリカ（圧縮サイズは100 GiB）を設定した場合、必要なTiFlashノード数は次のようになります：

TiFlashノードの最小数: `min((800 GiB * 2 + 100 GiB * 1) / 1024 GiB, max(2, 1)) ≈ 2`

### TiFlashのノードストレージ

異なるTiFlash vCPUのサポートされているノードストレージは次のとおりです：

| TiFlash vCPU | 最小ノードストレージ | 最大ノードストレージ | デフォルトノードストレージ |
|:---------:|:--------------------:|:--------------------:|:-----------------------:|
| 8 vCPU    | 200 GiB             | 2048 GiB            | 500 GiB               |
| 16 vCPU   | 200 GiB             | 2048 GiB            | 500 GiB               |

> **注意:**
>
> クラスタ作成後にTiFlashノードのストレージを減らすことはできません。