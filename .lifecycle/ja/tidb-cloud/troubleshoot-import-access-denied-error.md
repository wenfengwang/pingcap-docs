---
title: Amazon S3からのデータインポート中に発生する「アクセスが拒否されました」エラーのトラブルシューティング
summary: Amazon S3からTiDB Cloudにデータをインポートする際にアクセスが拒否されたエラーのトラブルシューティング方法について学びます。

# Amazon S3からのデータインポート中に発生する「アクセスが拒否されました」エラーのトラブルシューティング

このドキュメントでは、Amazon S3からTiDB Cloudにデータをインポートする際に発生するアクセスが拒否されたエラーのトラブルシューティング方法について説明します。

TiDB Cloudコンソールの**データインポート**ページで**次へ**をクリックし、インポートプロセスを確認した後、TiDB Cloudは指定したバケットURI内のデータにアクセスできるかどうかを検証し始めます。 `AccessDenied`というキーワードを含むエラーメッセージが表示された場合、アクセスが拒否されたエラーが発生しています。

アクセスが拒否されたエラーのトラブルシューティングには、AWS Management Consoleで次のチェックを実行します。

## 指定されたロールを仮定できません

このセクションでは、TiDB Cloudが指定されたバケットにアクセスするために提供されたロールを仮定できない場合の問題のトラブルシューティング方法について説明します。

### 信頼できるエンティティを確認する

1. AWS Management Consoleで、**IAM** > **アクセス管理** > **ロール**に移動します。
2. ロールのリストから、ターゲットのTiDBクラスターのために作成したロールを見つけてクリックします。ロールの概要ページが表示されます。
3. ロールの概要ページで、**信頼関係**タブをクリックすると、信頼されるエンティティが表示されます。

以下は信頼できるエンティティのサンプルです。

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::380838443567:root"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
                "StringEquals": {
                    "sts:ExternalId": "696e6672612d617069a79c22fa5740944bf8bb32e4a0c4e3fe"
                }
            }
        }
    ]
}
```

サンプルの信頼できるエンティティでは、次のようになります。

- `380838443567` はTiDB CloudアカウントIDです。このフィールドがTiDB CloudアカウントIDと一致していることを確認してください。
- `696e6672612d617069a79c22fa5740944bf8bb32e4a0c4e3fe` はTiDB Cloudの外部IDです。信頼できるエンティティのこのフィールドがTiDB Cloudの外部IDと一致していることを確認してください。

### IAMロールが存在するかどうかを確認する

IAMロールが存在しない場合は、[Amazon S3アクセスの構成](/tidb-cloud/config-s3-and-gcs-access.md#configure-amazon-s3-access)の手順に従ってロールを作成してください。

### 外部IDが正しく設定されているかどうかを確認する

提供されたロールを仮定できません `{role_arn}`。ロールの信頼関係設定を確認してください。たとえば、信頼できるエンティティが`TiDB CloudアカウントID`に設定されているかどうか、および`信頼条件`に`TiDB Cloudの外部ID`が正しく設定されているかどうかを確認してください。[信頼できるエンティティを確認する](#信頼できるエンティティを確認する)を参照してください。

## アクセスが拒否されました

このセクションでは、アクセスの問題のトラブルシューティング方法について説明します。

### IAMユーザーのポリシーを確認する

IAMユーザーのAWSアクセスキーを使用してAmazon S3バケットにアクセスしようとすると、次のエラーが発生することがあります。

- "アクセスキーID '{access_key_id}'およびシークレットアクセスキー'{secret_access_key}'を使用してソース'{bucket_uri}'に対するアクセスが拒否されました"

これはTiDB Cloudが不十分な権限のためにAmazon S3バケットにアクセスできなかったことを示しています。Amazon S3バケットにアクセスするためには次の権限が必要です。

- `s3:GetObject`
- `s3:ListBucket`
- `s3:GetBucketLocation`

IAMユーザーのポリシーを確認するには、次の手順を実行してください。

1. AWS Management Consoleで、**IAM** > **アクセス管理** > **ユーザー**に移動します。
2. ユーザーのリストから、TiDB Cloudにデータをインポートするために使用したユーザーを見つけてクリックします。ユーザーの概要ページが表示されます。
3. ユーザーの概要ページの**権限ポリシー**エリアには、ポリシーのリストが表示されます。各ポリシーに対して次の手順を実行します。
    1. ポリシーをクリックしてポリシーの概要ページに移動します。
    2. ポリシーの概要ページで**JSON**タブをクリックして権限ポリシーを確認します。ポリシーの`Resource`フィールドが正しく構成されていることを確認してください。

以下はサンプルのポリシーです。

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject"
            ],
            "Resource": "arn:aws:s3:::tidb-cloud-source-data/mydata/*"
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetBucketLocation"
            ],
            "Resource": "arn:aws:s3:::tidb-cloud-source-data"
        },
}
```

ユーザーに権限を付与し、権限をテストする方法についての詳細は、[ユーザーポリシーでバケットへのアクセスを制御する](https://docs.aws.amazon.com/AmazonS3/latest/userguide/walkthrough1.html)を参照してください。

### IAMロールのポリシーを確認する

1. AWS Management Consoleで、**IAM** > **アクセス管理** > **ロール**に移動します。
2. ロールのリストから、ターゲットのTiDBクラスターのために作成したロールを見つけてクリックします。ロールの概要ページが表示されます。
3. ロールの概要ページの**権限ポリシー**エリアには、ポリシーのリストが表示されます。各ポリシーに対して次の手順を実行します。
    1. ポリシーをクリックしてポリシーの概要ページに移動します。
    2. ポリシーの概要ページで**JSON**タブをクリックして権限ポリシーを確認します。ポリシーの`Resource`フィールドが正しく構成されていることを確認してください。

以下はサンプルのポリシーです。

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:GetObjectVersion"
            ],
            "Resource": "arn:aws:s3:::tidb-cloud-source-data/mydata/*"
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetBucketLocation"
            ],
            "Resource": "arn:aws:s3:::tidb-cloud-source-data"
        },
        {
            "Sid": "AllowKMSkey",
            "Effect": "Allow",
            "Action": [
                "kms:Decrypt"
            ],
            "Resource": "arn:aws:kms:ap-northeast-1:105880447796:key/c3046e91-fdfc-4f3a-acff-00597dd3801f"
        }
    ]
}
```

このサンプルポリシーでは、次の点に注意してください。

- `"arn:aws:s3:::tidb-cloud-source-data/mydata/*"`において、`"arn:aws:s3:::tidb-cloud-source-data"`はサンプルのS3バケットARNであり、`/mydata/*`はデータストレージのためにカスタマイズできるディレクトリです。ディレクトリは、`/*`で終わる必要があります。たとえば、`"<Your S3バケットARN>/<ソースデータのディレクトリ>/*"`です。`/*`が追加されていない場合、`AccessDenied`エラーが発生します。

- カスタママネージドキーの暗号化を使用してAWS Key Management Service key（SSE-KMS）を有効にしている場合、ポリシーに次の構成が含まれていることを確認してください。`"arn:aws:kms:ap-northeast-1:105880447796:key/c3046e91-fdfc-4f3a-acff-00597dd3801f"`はバケットのサンプルKMSキーです。

    ```
        {
            "Sid": "AllowKMSkey",
            "Effect": "Allow",
            "Action": [
                "kms:Decrypt"
            ],
            "Resource": "arn:aws:kms:ap-northeast-1:105880447796:key/c3046e91-fdfc-4f3a-acff-00597dd3801f"
        }
    ```

    バケットのオブジェクトが他の暗号化されたバケットからコピーされている場合、KMSキー値に両方のバケットのキーを含める必要があります。たとえば、`"Resource": ["arn:aws:kms:ap-northeast-1:105880447796:key/c3046e91-fdfc-4f3a-acff-00597dd3801f","arn:aws:kms:ap-northeast-1:495580073302:key/0d7926a7-6ecc-4bf7-a9c1-a38f0faec0cd"]`です。

ポリシーが前述の例のように正しく構成されていない場合は、ポリシーの`Resource`フィールドを修正してデータを再度インポートしてください。

> 複数回の権限ポリシーの更新を行っても、データのインポート中に「AccessDenied」エラーが発生する場合、アクティブなセッションを取り消してみることができます。**IAM** > **アクセス管理** > **ロール** へ移動し、対象のロールをクリックしてロールの概要ページに入ります。概要ページで、**アクティブなセッションを取り消す**を見つけ、ボタンをクリックしてアクティブなセッションを取り消します。その後、データのインポートを再試行してください。

> なお、これにより他のアプリケーションに影響を及ぼす可能性があります。

### バケットポリシーを確認する

1. AWS Management Consoleで、Amazon S3コンソールを開き、**バケット**ページに移動します。バケットの一覧が表示されます。
2. 一覧から対象のバケットを見つけ、クリックします。バケット情報ページが表示されます。
3. **アクセス許可**タブをクリックし、スクロールして**バケットポリシー**領域に移動します。デフォルトでは、この領域にはポリシー値がありません。この領域に拒否ポリシーが表示されている場合、データのインポート中に「AccessDenied」エラーが発生する可能性があります。

    拒否ポリシーが表示されている場合は、そのポリシーが現在のデータインポートに関連しているかどうかを確認します。関連している場合は、そのポリシーを削除し、データのインポートを再試行してください。

### オブジェクト所有権を確認する

1. AWS Management Consoleで、Amazon S3コンソールを開き、**バケット**ページに移動します。バケットの一覧が表示されます。
2. 一覧から対象のバケットを見つけ、クリックします。バケット情報ページが表示されます。
3. バケット情報ページで、**アクセス許可**タブをクリックし、スクロールして**オブジェクト所有権**領域に移動します。"Object Ownership"の構成が"Bucket owner enforced"であることを確認してください。

    構成が"Bucket owner enforced"でない場合、このバケット内のすべてのオブジェクトに対するあなたのアカウントの権限が不十分であるため、「AccessDenied」エラーが発生します。

エラーを処理するためには、オブジェクト所有権領域の右上隅にある**編集**をクリックし、所有権を"Bucket owner enforced"に変更してください。なお、これによりこのバケットを使用している他のアプリケーションに影響を及ぼす可能性があります。

### バケットの暗号化タイプを確認する

S3バケットを暗号化する方法は複数あります。バケット内のオブジェクトにアクセスしようとする場合、作成したロールにはデータの復号化のための暗号化キーにアクセスする権限が必要です。それ以外の場合、「AccessDenied」エラーが発生します。

バケットの暗号化タイプを確認するには、以下の手順を実行してください:

1. AWS Management Consoleで、Amazon S3コンソールを開き、**バケット**ページに移動します。バケットの一覧が表示されます。
2. 一覧から対象のバケットを見つけ、クリックします。バケット情報ページが表示されます。
3. バケット情報ページで、**プロパティ**タブをクリックし、**デフォルトの暗号化**領域までスクロールし、この領域の構成を確認してください。

サーバーサイトの暗号化には2種類あります: Amazon S3管理キー（SSE-S3）およびAWS Key Management Service（SSE-KMS）。SSE-S3の場合、さらなるチェックは不要です。SSE-KMSの場合、次の点を確認する必要があります:

- エリア内のAWS KMSキーARNが青色の下線付きで表示されている場合、AWS KMSキーはAWS管理キー（aws/s3）です。
- エリア内のAWS KMSキーARNがリンクつきで青色で表示されている場合は、キーのARNをクリックしてキー情報ページを開きます。特定の暗号化タイプを確認するために左側のナビゲーションバーを確認してください。AWS管理キー（aws/s3）またはカスタマー管理キーである可能性があります。

<details>
<summary>SSE-KMSのAWS管理キー（aws/s3）の場合</summary>

この状況では、「AccessDenied」エラーが発生する場合、その理由はキーが読み取り専用であり、クロスアカウントの許可付与が許可されていない可能性があります。「AWS KMSキーを選択」または「AWS KMSキーARNを入力」に変更するか、サーバーサイドの暗号化タイプを「AWS S3管理キー（SSE-S3）」に変更して、「AccessDenied」エラーを解消します。この方法に加えて、カスタム管理キーまたはSSE-S3暗号化方式を使用するために新しいバケットを作成することもできます。
</details>

<details>
<summary>SSE-KMSのカスタマー管理キーの場合</summary>

この状況で「AccessDenied」エラーを解消するには、キーARNをクリックするか、KMSでキーを手動で検索してください。**Key users** ページが表示されます。領域の右上隅にある**追加**をクリックして、TiDB Cloudにデータをインポートするために使用したロールを追加します。その後、データを再度インポートしてください。

</details>

> **注意:**
>
> バケット内のオブジェクトが既存の暗号化されたバケットからコピーされた場合、AWS KMSキーARNに元のバケットのキーを含める必要があります。これは、あなたのバケット内のオブジェクトがソースオブジェクト暗号化と同じ暗号化方式を使用しているためです。詳細については、AWSドキュメントの[Using default encryption with replication](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-encryption.html)を参照してください。

### AWSの記事を確認する

上記のすべてのチェックを実行しても、まだ「AccessDenied」エラーが発生する場合は、[Amazon S3からの403 Access Deniedエラーのトラブルシューティング](https://aws.amazon.com/premiumsupport/knowledge-center/s3-troubleshoot-403/)を参照してください。