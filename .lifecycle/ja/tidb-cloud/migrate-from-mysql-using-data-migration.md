---
title: MySQL互換データベースをTiDB Cloudにデータ移行する
summary: Amazon Aurora MySQL、Amazon Relational Database Service（RDS）、Google Cloud SQL for MySQL、またはローカルMySQLインスタンスにホストされているMySQL互換データベースから、TiDB Cloudにデータを移行する方法について学びます。
aliases: ['/tidbcloud/migrate-data-into-tidb','/tidbcloud/migrate-incremental-data-from-mysql']
---

# MySQL互換データベースをTiDB Cloudにデータ移行する

このドキュメントでは、TiDB Cloudコンソールのデータ移行機能を使用して、クラウドプロバイダ（Amazon Aurora MySQL、Amazon Relational Database Service（RDS）、またはGoogle Cloud SQL for MySQL）または自己ホスト型のソースデータベースからTiDB Cloudにデータを移行する方法について説明します。

この機能を使用すると、ソースデータベースの既存データおよび継続的な変更を、1度の操作で（同じリージョン内またはクロスリージョンで）TiDB Cloudに直接移行できます。

増分データのみを移行したい場合は、[MySQL互換データベースからTiDB Cloudにデータ移行する](/tidb-cloud/migrate-incremental-data-from-mysql-using-data-migration.md)を参照してください。

## 制限事項

- データ移行機能は**TiDB専用**クラスタのみで利用可能です。

- データ移行機能は、2022年11月9日以降に作成された以下のリージョン内のプロジェクトでのみ利用可能です。指定の日付より前に**プロジェクト**が作成された場合、またはクラスタが他のリージョンにある場合、この機能はクラスタで利用できず、TiDB Cloudコンソールのクラスタ概要ページに**データ移行**タブは表示されません。

    - AWSオレゴン（us-west-2）
    - AWS北バージニア（us-east-1）
    - AWSシンガポール（ap-southeast-1）
    - AWS東京（ap-northeast-1）
    - AWSフランクフルト（eu-central-1）
    - AWSソウル（ap-northeast-2）
    - Google Cloudオレゴン（us-west1）
    - Google Cloudシンガポール（asia-southeast1）
    - Google Cloud東京（asia-northeast1）

- Amazon Aurora MySQLのライターインスタンスは既存データおよび増分データ移行の両方をサポートしています。Amazon Aurora MySQLのリーダーインスタンスは既存データ移行のみをサポートし、増分データ移行をサポートしていません。

- 1つの組織につき最大200件の移行ジョブを作成できます。これ以上の移行ジョブを作成するには、[サポートチケットを提出](/tidb-cloud/tidb-cloud-support.md)する必要があります。

- システムデータベースはフィルタリングされ、この機能を使用してすべてのデータベースを選択してもTiDB Cloudに移行されません。つまり、`mysql`、`information_schema`、`information_schema`、および`sys`はこの機能を使用しても移行されません。

- 既存データ移行中に、移行されるテーブルがターゲットデータベースに重複するキーを持っている場合、重複するキーは置き換えられます。

- 増分データ移行中に、移行されるテーブルがターゲットデータベースに重複するキーを持っている場合、エラーが報告され、移行は中断されます。この状況では、上流のデータが正確であることを確認する必要があります。もし正確であれば、移行ジョブの「リスタート」ボタンをクリックし、移行ジョブは下流の競合するレコードを上流のレコードで置き換えます。

- TiDB Cloudでクラスタを削除すると、そのクラスタ内のすべての移行ジョブが自動的に削除され、復元できません。

- 増分レプリケーション（クラスタに継続的な変更を移行する）中に、移行ジョブが突然のエラーから回復する場合、60秒間セーフモードがオープンされることがあります。セーフモード中、`INSERT`文は`REPLACE`として移行され、`UPDATE`文は`DELETE`と`REPLACE`として移行され、その後これらのトランザクションは下流のクラスタに移行され、突然のエラー中にすべてのデータがスムーズに下流のクラスタに移行されるようにします。このシナリオでは、プライマリキーまたはヌルではないユニークインデックスのない上流テーブルの場合、一部のデータが下流クラスタで重複することがあります。これは、データが下流に繰り返し挿入されているためです。

- データ移行を使用する際には、データセットのサイズを1 TiB未満に保つことをお勧めします。データセットのサイズが1 TiBを超えると、限られた仕様により既存データ移行には時間がかかります。

- 以下のシナリオでは、移行ジョブが24時間を超える場合、データ移行が連続したバイナリログを取得できるように、ソースデータベースのバイナリログをクリーンアップしないでください：

    - 既存データ移行中
    - 既存データ移行が完了し、初めて増分データ移行を開始する場合、遅延が0msでない場合

## 必要条件

移行を実行する前に、データソースを確認し、上流および下流データベースの特権を準備し、ネットワーク接続を設定する必要があります。

### データソースとバージョンがサポートされていることを確認

データ移行は、以下のデータソースとバージョンをサポートしています。

- MySQL 5.6、5.7、および 8.0のローカルインスタンスまたはパブリッククラウドプロバイダ上でのインスタンス。ただし、MySQL 8.0はTiDB Cloudでまだ実験段階であり、互換性の問題が発生する可能性があります。
- Amazon Aurora（MySQL 5.6および5.7）
- Amazon RDS（MySQL 5.7）
- Google Cloud SQL for MySQL 5.6および5.7

### 上流データベースに必要な特権を付与

上流データベースに使用するユーザーは、以下の特権をすべて取得している必要があります。

| 特権 | スコープ |
|:----|:----|
| `SELECT` | テーブル |
| `LOCK` | テーブル |
| `REPLICATION SLAVE` | グローバル |
| `REPLICATION CLIENT` | グローバル |

たとえば、次の`GRANT`ステートメントを使用して対応する特権を付与できます。

```sql
GRANT SELECT,LOCK TABLES,REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO 'your_user'@'your_IP_address_of_host'
```

### 下流のTiDB Cloudクラスタに必要な特権を付与

下流のTiDB Cloudクラスタに使用するユーザーは、以下の特権を取得している必要があります。

| 特権 | スコープ |
|:----|:----|
| `CREATE` | データベース、テーブル |
| `SELECT` | テーブル |
| `INSERT` | テーブル |
| `UPDATE` | テーブル |
| `DELETE` | テーブル |
| `ALTER`  | テーブル |
| `DROP`   | データベース、テーブル |
| `INDEX`  | テーブル |
| `TRUNCATE`  | テーブル |

たとえば、次の`GRANT`ステートメントを実行して対応する特権を付与できます。

```sql
GRANT CREATE,SELECT,INSERT,UPDATE,DELETE,ALTER,TRUNCATE,DROP,INDEX ON *.* TO 'your_user'@'your_IP_address_of_host'
```

移行ジョブを迅速にテストするためには、TiDB Cloudクラスタの`root`アカウントを使用できます。

### ネットワーク接続の設定

移行ジョブを作成する前に、接続方法に応じてネットワーク接続を設定する必要があります。[TiDB専用クラスタに接続](/tidb-cloud/connect-to-tidb-cluster.md)を参照してください。

- ネットワーク接続に公開IPを使用する場合（標準接続）、上流データベースが公開ネットワークを介して接続できることを確認してください。

- AWS PrivateLinkを使用する場合、[AWSを介したプライベートエンドポイントでTiDB専用クラスタに接続](/tidb-cloud/set-up-private-endpoint-connections.md)に従って設定してください。

- Google Cloud Private Service Connectを使用する場合、[Google Cloudを介したプライベートエンドポイントでTiDB専用クラスタに接続](/tidb-cloud/set-up-private-endpoint-connections-on-google-cloud.md)に従って設定してください。

- AWS VPC PeeringまたはGoogle Cloud VPC Network Peeringを使用する場合は、次の手順に従ってネットワークを構成してください。

<details>
<summary> AWS VPC Peeringの設定</summary>

MySQLサービスがAWS VPCにある場合は、以下の手順を実行してください：

1. MySQLサービスのVPC間接続を設定してください。`[VPCピアリング接続の設定](/tidb-cloud/set-up-vpc-peering-connections.md)`に従ってください。

2. MySQLサービスに関連付けられているセキュリティグループのインバウンドルールを変更してください。

    インバウンドルールに、[TiDB Cloudクラスタが配置されているリージョンのCIDR](/tidb-cloud/set-up-vpc-peering-connections.md#prerequisite-set-a-project-cidr)を追加する必要があります。これにより、TiDBクラスタからMySQLインスタンスへのトラフィックが流れるようになります。

3. MySQL URLにDNSホスト名が含まれている場合、TiDB CloudがMySQLサービスのホスト名を解決できるようにする必要があります。

    1. [VPCピアリング接続のDNS解決を有効にする](https://docs.aws.amazon.com/vpc/latest/peering/modify-peering-connections.html#vpc-peering-dns)に従ってください。
    2. **Accepter DNS resolution**オプションを有効にしてください。

</details>

<details>
<summary> Google Cloud VPC Network Peeringの設定 </summary>

MySQLサービスがGoogle Cloud VPCにある場合は、以下の手順を実行してください：

1. 自己ホスト型のMySQLの場合は、この手順はスキップし、次の手順に進んでください。Google Cloud SQLがMySQLサービスである場合、関連するGoogle Cloud SQLインスタンスのVPCでMySQLエンドポイントを公開する必要があります。これには、Googleが開発した[Cloud SQL Auth proxy](https://cloud.google.com/sql/docs/mysql/sql-proxy)を使用する必要があります。

## VPCピアリング接続の設定

TiDBクラスタとMySQLサービスのVPC間に[VPCピアリング接続](/tidb-cloud/set-up-vpc-peering-connections.md)を設定します。

3. MySQLが配置されているVPCのイングレスファイアウォールルールを変更します。

    [TiDB Cloudクラスタが配置されているリージョンのCIDR](/tidb-cloud/set-up-vpc-peering-connections.md#prerequisite-set-a-project-cidr)をイングレスファイアウォールルールに追加する必要があります。これにより、TiDBクラスタからMySQLエンドポイントへのトラフィックが可能になります。

<details>

### バイナリログの有効化

増分データ移行を実行するには、上流データベースのバイナリログが有効になっており、バイナリログが24時間以上保持されていることを確認してください。

## ステップ1: **データ移行**ページに移動

1. [TiDB Cloudコンソール](https://tidbcloud.com/)にログインし、プロジェクトの[**クラスタ**](https://tidbcloud.com/console/clusters)ページに移動します。

    > **ヒント:**
    >
    > 複数のプロジェクトを持っている場合、「<MDSvgIcon name="icon-left-projects" />」をクリックして、左下隅に表示されるプロジェクトを切り替えることができます。

2. 対象クラスタの名前をクリックして、その概要ページに移動し、左のナビゲーションペインで**データ移行**をクリックします。

3. **データ移行**ページで、右上隅にある**データ移行ジョブを作成**をクリックします。**データ移行ジョブを作成**ページが表示されます。

## ステップ2: ソースおよびターゲット接続の構成

**データ移行ジョブを作成**ページで、ソースおよびターゲット接続を構成します。

1. 文字で始まり、60文字未満である必要があるジョブ名を入力してください。文字(A-Z, a-z)、数字(0-9)、アンダースコア(_)、ハイフン(-)は許容されます。

2. ソース接続プロファイルを入力してください。

   - **データソース**：データソースの種類。
   - **リージョン**：クラウドデータベースの場合に必要とされるデータソースのリージョン。
   - **接続方法**：データソースの接続方法。現在、接続方法としてパブリックIP、VPCピアリング、またはプライベートリンクを選択できます。
   - **ホスト名またはIPアドレス**（パブリックIPおよびVPCピアリング用）：データソースのホスト名またはIPアドレス。
   - **サービス名**（プライベートリンク用）：エンドポイントサービス名。
   - **ポート**：データソースのポート。
   - **ユーザー名**：データソースのユーザー名。
   - **パスワード**：ユーザー名のパスワード。
   - **SSL/TLS**：SSL/TLSを有効にする場合は、次のいずれかを含むデータソースの証明書をアップロードする必要があります。
        - CA証明書のみ
        - クライアント証明書およびクライアントキー
        - CA証明書、クライアント証明書、およびクライアントキー

3. ターゲット接続プロファイルを入力してください。

   - **ユーザー名**：TiDB Cloud内のターゲットクラスタのユーザー名を入力してください。
   - **パスワード**：TiDB Cloudのユーザー名のパスワードを入力してください。

4. 入力した情報を検証するために**接続を検証**および**次へ**をクリックしてください。

5. 表示されるメッセージに応じて処置してください：

    - パブリックIPまたはVPCピアリングを使用する場合は、データ移行サービスのIPアドレスをソースデータベースとファイアウォール（存在する場合）のIPアクセスリストに追加する必要があります。
    - AWSプライベートリンクを使用する場合は、エンドポイントリクエストを承認するよう促されます。[AWS VPCコンソール](https://us-west-2.console.aws.amazon.com/vpc/home)に移動し、エンドポイントサービスをクリックして、エンドポイントリクエストを承認してください。

## ステップ3: 移行ジョブタイプを選択

**移行するオブジェクトを選択**ステップでは、既存のデータ移行、増分データ移行、またはその両方を選択できます。

### 既存データおよび増分データを移行

データを一度だけTiDB Cloudに移行する場合、**既存データ移行**と**増分データ移行**の両方を選択してください。これにより、ソースとターゲットのデータの一貫性が確保されます。

### 既存データのみを移行

ソースデータベースの既存データだけをTiDB Cloudに移行するには、**既存データ移行**を選択してください。

### 増分データのみを移行

ソースデータベースの増分データだけをTiDB Cloudに移行するには、**増分データ移行**を選択してください。この場合、移行ジョブはソースデータベースの既存データではなく、移行ジョブで明示的に指定されたソースデータベースの変更のみを移行します。

増分データ移行の詳しい手順については、[MySQL互換データベースからTiDB Cloudに増分データのみをデータ移行する](/tidb-cloud/migrate-incremental-data-from-mysql-using-data-migration.md)を参照してください。

## ステップ4: 移行するオブジェクトを選択

1. **移行するオブジェクトを選択**ページで、移行するオブジェクトを選択してください。すべてのオブジェクトを選択するには、**すべて**をクリックするか、**カスタマイズ**をクリックして、オブジェクト名の横にあるチェックボックスをクリックしてオブジェクトを選択します。

    - **すべて**をクリックすると、移行ジョブは完全な移行後にソースデータベースインスタンス全体からTiDB Cloudに既存データを移行し、完全な移行後も継続的な変更を移行します。ただし、前のステップで**既存データ移行**および**増分データ移行**のチェックボックスを選択した場合にのみ発生します。

        <img src="https://download.pingcap.com/images/docs/tidb-cloud/migration-job-select-all.png" width="60%" />

    - **カスタマイズ**をクリックして特定のデータベースを選択すると、移行ジョブは選択したデータベースの既存データを移行し、その後も継続的な変更をTiDB Cloudに移行します。ただし、前のステップで**既存データ移行**および**増分データ移行**のチェックボックスを選択した場合にのみ発生します。

        <img src="https://download.pingcap.com/images/docs/tidb-cloud/migration-job-select-db.png" width="60%" />

    - **カスタマイズ**をクリックして特定のデータセット名の下にあるテーブルを選択すると、移行ジョブは選択したテーブルの既存データを移行し、その後も継続的な変更を選択したテーブルに移行します。ただし、後に同じデータベースに作成されたテーブルは移行されません。

        <img src="https://download.pingcap.com/images/docs/tidb-cloud/migration-job-select-tables.png" width="60%" />

2. **次**をクリックしてください。

## ステップ5: 事前チェック

**事前チェック**ページで、事前チェックの結果を表示することができます。事前チェックに失敗した場合は、**失敗**または**警告**の詳細に従い、**もう一度チェック**をクリックして再度チェックしてください。

一部のチェック項目で警告のみがある場合は、リスクを評価し、警告を無視するかどうかを検討してください。すべての警告が無視されると、移行ジョブは自動的に次のステップに進みます。

エラーとその解決策についての詳細については、[事前チェックのエラーと解決策](/tidb-cloud/tidb-cloud-dm-precheck-and-troubleshooting.md#precheck-errors-and-solutions)を参照してください。

事前チェック項目の詳細については、[移行タスクの事前チェック](https://docs.pingcap.com/tidb/stable/dm-precheck)を参照してください。

すべてのチェック項目が**合格**を示している場合、**次**をクリックしてください。

## ステップ6: 仕様を選択して移行を開始

**仕様を選択して移行を開始**ページで、パフォーマンス要件に応じた適切な移行仕様を選択してください。仕様についての詳細については、[データ移行の仕様](/tidb-cloud/tidb-cloud-billing-dm.md#specifications-for-data-migration)を参照してください。

仕様を選択したら、移行を開始するために**ジョブを作成して開始**をクリックしてください。

## ステップ7: 移行の進捗状況を表示

移行ジョブが作成されたら、**移行ジョブの詳細**ページで移行の進捗状況を表示できます。移行の進捗は**ステージとステータス**領域に表示されます。

ジョブが実行中の場合は、移行ジョブを一時停止または削除することができます。

ジョブが失敗した場合は、問題を解決した後にジョブを再開することができます。

ジョブのステータスにかかわらず、ジョブを削除することができます。

移行中に問題が発生した場合は、[移行のエラーと解決策](/tidb-cloud/tidb-cloud-dm-precheck-and-troubleshooting.md#migration-errors-and-solutions)を参照してください。

## 移行ジョブ仕様のスケーリング

TiDB Cloudは、さまざまなシナリオでのパフォーマンスとコスト要件に対応するために、移行ジョブ仕様を拡張または縮小する機能をサポートしています。
異なる移行仕様には異なるパフォーマンスがあります。パフォーマンス要件はさまざまな段階で変化する可能性があります。例えば、既存データの移行中はパフォーマンスをできるだけ速くしたいので、8 RCUなどの大規模な仕様の移行ジョブを選択します。一方、既存データの移行が完了した後は、増分移行ではそのような高いパフォーマンスが必要ないため、コストを節約するために、例えば8 RCUから2 RUCに仕様を縮小することができます。

移行ジョブの仕様をスケーリングする際には、以下の点に注意してください。

- 移行ジョブの仕様をスケーリングするには、約5〜10分かかります。
- スケーリングに失敗した場合、ジョブの仕様はスケーリング前と同じままになります。

### 制限

- ジョブが **実行中** または **一時停止** の状態の場合にのみ移行ジョブの仕様をスケーリングできます。
- TiDB Cloudでは、既存データのエクスポート段階中に移行ジョブの仕様をスケーリングすることはサポートされていません。
- 移行ジョブの仕様をスケーリングすると、ジョブが再起動されます。ジョブのソーステーブルに主キーがない場合、重複データが挿入される可能性があります。
- スケーリング中に、ソースデータベースのバイナリログを削除したり、上流データベースの `expire_logs_days` を一時的に増やしたりしないでください。それ以外の場合、ジョブが連続したバイナリログ位置を取得できないため、ジョブが失敗する可能性があります。

### スケーリング手順

1. [TiDB Cloudコンソール](https://tidbcloud.com/)にログインし、プロジェクトの[**クラスタ**](https://tidbcloud.com/console/clusters)ページに移動します。

2. 対象のクラスタの名前をクリックしてその概要ページに移動し、左側のナビゲーションペインで**データ移行**をクリックします。

3. **データ移行**ページで、スケーリングを行いたい移行ジョブを見つけます。**操作**列で、**...** > **拡張/縮小**をクリックします。

4. **拡張/縮小**ウィンドウで、使用したい新しい仕様を選択し、**送信**をクリックします。ウィンドウの下部で、仕様の新しい価格を表示することができます。