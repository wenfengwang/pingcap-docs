---
title: パフォーマンスの分析とチューニングの概要
summary: TiDB CloudにおけるSQLパフォーマンスの分析とチューニング方法について学びます。
---

# パフォーマンスの分析とチューニングの概要

このドキュメントでは、TiDB CloudにおけるSQLパフォーマンスの分析とチューニングを行うための手順について説明します。

## ユーザー応答時間

ユーザー応答時間とは、アプリケーションがユーザーのリクエストの結果を返すまでにかかる時間を示します。下記のシーケンシャルなタイミングダイアグラムからわかるように、典型的なユーザーリクエストの時間には以下の要素が含まれます。

- ユーザーとアプリケーション間のネットワーク遅延
- アプリケーションの処理時間
- アプリケーションとデータベース間のやり取り中のネットワーク遅延
- データベースのサービス時間

ユーザー応答時間は、ネットワークの遅延や帯域幅、同時ユーザーの数とリクエストの種類、サーバーのCPUとI/Oのリソース使用など、リクエストチェーン上のさまざまなサブシステムの影響を受けます。全体のシステムを効果的に最適化するためには、まずユーザー応答時間のボトルネックを特定する必要があります。

指定された時間範囲（`ΔT`）内の合計ユーザー応答時間は、以下の式を使用して求めることができます。

`ΔT`の合計ユーザー応答時間 = 平均TPS（秒間トランザクション数）x 平均ユーザー応答時間 x `ΔT`。

![user_response_time](/media/performance/user_response_time_en.png)

## ユーザー応答時間とシステムのスループットの関係

ユーザー応答時間は、サービス時間、キュー待ち時間、および同時待ち時間からなるユーザーリクエストの完了にかかる時間です。

```
ユーザー応答時間 = サービス時間 + キュー待ち時間 + 一貫性待ち時間
```

- サービス時間: リクエストの処理中にシステムが特定のリソースを消費する時間です。たとえば、データベースがSQLリクエストを完了するために消費するCPU時間です。
- キュー待ち時間: リクエストの処理中にシステムが特定のリソースのサービスを待つために待機する時間です。
- 一貫性待ち時間: リクエストの処理中にシステムが他の同時タスクと通信して協調する時間です。これにより、リクエスト処理中に共有リソースにアクセスできるようになります。

システムのスループットは、システムが1秒間に完了できるリクエストの数を示します。ユーザー応答時間とスループットは通常、互いに逆の関係にあります。スループットが増加すると、システムのリソース利用と要求されたサービスのキュー待ち時間が相応に増加します。リソース利用がある特定の曲線点を超えると、キュー待ち時間は急激に増加します。

たとえば、OLTP負荷を実行しているデータベースシステムのCPU利用率が65%を超えると、CPUスケジューリングの待ち時間が著しく増加します。これは、システムの同時リクエストが完全に独立していないことを意味し、つまり、これらのリクエストは共有リソースを協力して競合することができます。たとえば、異なるユーザーからのリクエストは、同じデータに対して相互排他的なロック操作を実行する場合があります。リソース利用が増加すると、キュー待ちとスケジューリングの待ち時間も増加し、共有リソースが時間内に解放されなくなり、他のタスクの共有リソースに対する待ち時間が延長されることになります。

## ユーザー応答時間のボトルネックのトラブルシューティング

TiDB Cloudコンソールには、ユーザー応答時間のトラブルシューティングを支援するいくつかのページがあります。

- **概要**: このタブでは、TiDBのメトリクス（総QPS、遅延、接続数、リクエストQPS、リクエストの所要時間、ストレージサイズ、CPU、IO Read、IO Writeなど）を表示できます。
- **SQL診断**:

    - **SQLステートメント**を使用すると、システムのテーブルをクエリせずにSQLの実行を直接観察でき、パフォーマンスの問題を簡単に特定することができます。クエリの実行計画をさらに表示してトラブルシューティングや分析を行うこともできます。SQLパフォーマンスのチューニングの詳細については、[SQLチューニングの概要](/tidb-cloud/tidb-cloud-sql-tuning-overview.md)を参照してください。
    - **Key Visualizer**は、TiDBのデータアクセスパターンとデータホットスポットを観察するのに役立ちます。

追加のメトリクスが必要な場合は、[PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡してください。

遅延やパフォーマンスの問題が発生した場合は、次のセクションで説明する手順を参照して分析およびトラブルシューティングを行ってください。

### TiDBクラスター外のボトルネック

**概要**タブで遅延（P80）を確認します。この値がユーザー応答時間のP80値よりもはるかに低い場合、主なボトルネックはTiDBクラスター外にある可能性があります。この場合、次の手順を使用してボトルネックのトラブルシューティングを行うことができます。

1. [概要タブ](/tidb-cloud/monitor-tidb-cluster.md)の左側に表示されるTiDBのバージョンを確認してください。バージョンがv6.0.0またはそれ以前の場合は、[PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡して、Preparedプランキャッシュ、Raftエンジン、TiKV AsyncIO機能が有効にできるかどうかを確認してください。これらの機能を有効にすることで、アプリケーション側のチューニングとともにスループットのパフォーマンスが大幅に向上し、遅延とリソース使用量が大幅に低減されます。
2. 必要な場合は、スループットを向上させるために、TiDBトークンの制限を増やすことができます。
3. Preparedプランキャッシュ機能が有効になっており、ユーザーサイドでJDBCを使用している場合は、次の設定を使用することをおすすめします。

    ```
    useServerPrepStmts=true&cachePrepStmts=true&prepStmtCacheSize=1000&prepStmtCacheSqlLimit=20480&useConfigs=maxPerformance
    ```

   JDBCを使用せず、現在のTiDBクラスターのプリペアドプランキャッシュ機能を最大限に活用したい場合は、プリペアドステートメントオブジェクトをクライアント側でキャッシュする必要があります。StmtPrepareとStmtCloseの呼び出しをリセットする必要はありません。クエリごとに呼び出されるコマンドの数を3から1に減らします。これには、パフォーマンス要件とクライアント側の変更量に応じて、いくらかの開発作業が必要です。ヘルプが必要な場合は[PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に相談してください。

### TiDBクラスター内のボトルネック

パフォーマンスのボトルネックがTiDBクラスター内にあると判断した場合は、次の手順を実行することをおすすめします。

- 遅いSQLクエリを最適化する。
- ホットスポットの問題を解決する。
- クラスターをスケールアウトして容量を拡大する。

#### 遅いSQLクエリの最適化

SQLパフォーマンスのチューニングの詳細については、[SQLチューニングの概要](/tidb-cloud/tidb-cloud-sql-tuning-overview.md)を参照してください。

#### ホットスポットの問題の解決

[Key Visualizerタブ](/tidb-cloud/tune-performance.md#key-visualizer)でホットスポットの問題を表示できます。以下のスクリーンショットはサンプルのヒートマップを示しています。地図の横軸は時間、縦軸はテーブルとインデックスです。色が明るくなるほどトラフィックが多いことを示しています。ツールバーで読み取りトラフィックまたは書き込みトラフィックの表示を切り替えることができます。

![ホットスポットの問題](/media/tidb-cloud/tidb-cloud-troubleshoot-hotspot.png)

以下のスクリーンショットは、書き込みのホットスポットの例を示しています。書き込みフローグラフに明るい対角線（上向きまたは下向きの対角線）が現れ、書き込みトラフィックが対角線の終わりにしか表示されないことがわかります。テーブルのRegionの数が増えるにつれてステップ状のパターンになります。これはテーブルに書き込みのホットスポットがあることを示しています。書き込みのホットスポットが発生した場合は、自己増加するプライマリキーを使用しているか、プライマリキーを使用していないか、または時刻に依存する挿入文やインデックスを使用しているかを確認する必要があります。

![書き込みのホットスポット](/media/tidb-cloud/tidb-cloud-troubleshoot-write-hotspot.png)

一般的に、読み込みのホットスポットは、明るい水平線としてヒートマップに表示されます。多数のクエリを含む小さなテーブルである場合があります。

![読み込みのホットスポット](/media/tidb-cloud/tidb-cloud-troubleshoot-read-hotspot-new.png)

ハイライトされたブロックの上にカーソルを重ねると、トラフィックの高いテーブルまたはインデックスが表示されます。

![ホットスポットのインデックス](/media/tidb-cloud/tidb-cloud-troubleshoot-hotspot-index.png)

#### スケールアウト

クラスターの[概要](/tidb-cloud/monitor-tidb-cluster.md)ページで、ストレージスペース、CPU利用率、TiKVのIOレートのメトリクスをチェックします。いずれかのメトリクスが長時間上限に達している場合、現在のクラスターサイズではビジネス要件を満たすことができない可能性があります。[PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡してクラスターのスケールアウトが必要かどうかを確認することをおすすめします。

#### その他の問題

前述の方法でパフォーマンスの問題が解決しない場合は、[PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡してください。トラブルシューティングプロセスを迅速に進めるために、次の情報を提供することをおすすめします。

- クラスターID
- 問題の間隔と比較可能な通常の間隔
- 問題の現象と期待される動作
- 読み込みまたは書き込みの割合や主要な動作など、ビジネスのワークロードの特性

## 概要

一般的に、以下の最適化方法を使用してパフォーマンスの問題を分析し解決することができます。

| アクション | 影響 |
|:--|:--|
| Preparedプランキャッシュ + JDBC | スループットのパフォーマンスが大幅に向上し、遅延が大幅に低減され、平均TiDB CPU使用率も大幅に低減されます。 |
| TiKVでAsyncIOとRaftエンジンを有効にする | スループットのパフォーマンスがいくらか改善されます。[PingCAPサポートチーム](/tidb-cloud/tidb-cloud-support.md)に連絡して有効にする必要があります。 |
| クラスタ化インデックス | スループットのパフォーマンスが大幅に向上します。 |
| TiDBノードをスケールアウトする | スループットのパフォーマンスが大幅に向上します。 |
| クライアント側の最適化。 1つのJVMを3つに分割する | スループットパフォーマンスが大幅に改善され、さらなる分割によってスループット容量がさらに向上する可能性があります。 |
| アプリケーションとデータベース間のネットワーク遅延を制限する | ハイネットワーク遅延はスループットの低下とレイテンシーの増加につながる可能性があります。 |

将来的にTiDB Cloudでは、より多くの観測可能なメトリクスと自己診断サービスを導入します。これにより、パフォーマンスメトリクスの包括的な理解と操作アドバイスが提供され、ユーザーエクスペリエンスが向上します。