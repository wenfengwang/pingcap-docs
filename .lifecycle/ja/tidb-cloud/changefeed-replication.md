---
title: TiDB Cloud レプリケーション
summary: プライマリ TiDB クラスタからセカンダリ TiDB クラスタにデータをストリームするレプリカを作成する方法を学びます。
---

# TiDB Cloud レプリケーション

TiDB Cloud レプリケーションは、TiDB Cloud のプライマリ TiDB クラスタに対して、継続的にレプリケーションされる読み取り可能なセカンダリ TiDB クラスタを作成する機能です。この読み取り可能なセカンダリクラスタ（地域間レプリケーション、セカンダリレプリケーション、またはジオレプリケーションとも呼ばれます）は、プライマリ TiDB クラスタと同じ地域にある場合がありますが、一般的には異なる地域に配置されます。

TiDB Cloud レプリケーションを使用すると、地域の災害や大規模な障害が発生した場合にデータベースの迅速な障害復旧を行うことができ、ビジネスの継続性を実現することができます。セカンダリクラスタが設定された後、異なる地域にあるセカンダリクラスタに地理的なフェイルオーバーを手動で開始することができます。

> **警告:**
>
> 現在、**TiDB Cloud レプリケーション**機能はベータ版であり、次の制限があります:
>
> * 1つのプライマリクラスタには、1つのレプリケーションのみを持つことができます。
> * セカンダリクラスタを別のクラスタへの**TiDB Cloud レプリケーション**のソースとして使用することはできません。
> * **TiDB Cloud レプリケーション**は、[Apache Kafka へのシンク](/tidb-cloud/changefeed-sink-to-apache-kafka.md)および[MySQL へのシンク](/tidb-cloud/changefeed-sink-to-mysql.md)と矛盾します。**TiDB Cloud レプリケーション**が有効になっている場合、プライマリクラスタおよびセカンダリクラスタのいずれも、**Apache Kafka へのシンク**または**MySQL へのシンク**のチェンジフィードを使用することはできません。
> * TiDB Cloud は TiCDC を使用してレプリケーションを確立するため、[TiCDC の制限事項](https://docs.pingcap.com/tidb/stable/ticdc-overview#restrictions)と同じ制限事項があります。
> * **TiDB Cloud レプリケーション**は、要求に基づいてのみ使用可能です。この機能の使用を要求するには、[TiDB Cloud コンソール](https://tidbcloud.com)の右下にある **?** をクリックし、**サポートのリクエスト** をクリックします。その後、**説明** フィールドに "TiDB Cloud レプリケーションの申請" を記入して、**送信** をクリックします。

アプリケーションのレプリケーションをサポートするには、プライマリ地域とセカンダリ地域の両方にアプリケーションを展開し、各アプリケーションが同じ地域の TiDB クラスタに接続されることを確認する必要があります。セカンダリ地域のアプリケーションは待機状態にあります。プライマリ地域が障害の発生した場合、セカンダリ地域の TiDB クラスタをアクティブにするための "Detach" 操作を開始し、すべてのデータトラフィックをセカンダリ地域のアプリケーションに転送することができます。

次の図は、TiDB Cloud レプリケーションを使用してジオ冗長なクラウドアプリケーションを展開する典型的なデプロイメントを示しています:

<!-- https://www.figma.com/file/DaevXzW4aq35QodwZEkcTS/DBaaS-Architecture-Chart-(high-level)-(Copy)?node-id=0%3A1 -->
![TiDB Cloud レプリケーション](/media/tidb-cloud/changefeed-replication-deployment.png)

セカンダリ TiDB クラスタの作成は、ビジネス継続性ソリューションの一部にすぎません。壊滅的な障害が発生した後、アプリケーション（またはサービス）をエンドツーエンドで復旧するには、アプリケーションのすべてのコンポーネントと依存するサービスが復元可能であることを確認する必要があります。

- アプリケーションの各コンポーネントが同じ障害に対して強固であり、アプリケーションのリカバリ目標時間（RTO）内に利用可能であるかどうかを確認してください。アプリケーションの典型的なコンポーネントには、カスタム JavaScript を含むブラウザのクライアントソフトウェア、Web フロントエンド、ストレージ、および DNS があります。
- すべての依存サービスを特定し、これらのサービスの保証と機能を確認し、これらのサービスのフェイルオーバー時にアプリケーションが動作可能であることを確認してください。

## TiDB Cloud レプリケーションの用語と機能

### 自動非同期レプリケーション

プライマリ TiDB クラスタごとに、セカンダリクラスタは1つだけ作成できます。TiDB Cloud はプライマリ TiDB クラスタのフルバックアップを作成し、そのバックアップを新しく作成したセカンダリクラスタに復元することで、セカンダリクラスタにすべての既存データが含まれることを確認します。セカンダリクラスタが作成されると、プライマリクラスタのすべてのデータ変更は非同期にセカンダリクラスタにレプリケートされます。

### 読み取り可能なセカンダリクラスタ

セカンダリクラスタは読み取り専用モードです。リアルタイム性の低い読み取り専用のワークロードがある場合、これをセカンダリクラスタに分散することができます。

同じ地域の読み取り密度の高いシナリオを満たすためには、**TiDB Cloud レプリケーション**を使用して、プライマリクラスタと同じ地域に読み取り可能なセカンダリクラスタを作成できます。ただし、同じ地域のセカンダリクラスタは大規模な障害や壊滅的な障害のフェイルオーバーターゲットとして使用しないでください。

### Planned Detach

**Planned Detach** は、通常は計画されたメンテナンスなどの理由で手動でトリガできます。**Planned Detach** は、セカンダリクラスタにデータの損失なく（RPO=0）、主要クラスタと完全に同期するまで待機します。RTO は、プライマリクラスタとセカンダリクラスタのレプリケーションラグに依存します。ほとんどの場合、RTO は数分程度です。

**Planned Detach** では、セカンダリクラスタをプライマリクラスタから切り離して個別のクラスタにします。**Planned Detach** がトリガされると、次の手順が実行されます。

1. プライマリクラスタを読み取り専用に設定し、プライマリクラスタに新しいトランザクションがコミットされないようにします。
2. セカンダリクラスタがプライマリクラスタと完全に同期するまで待機します。
3. プライマリクラスタからセカンダリクラスタへのレプリケーションを停止します。
4. 元のセカンダリクラスタを書き込み可能に設定します。これにより、セカンダリクラスタがビジネスを提供できる状態になります。

**Planned Detach**が完了した後、元のプライマリクラスタは読み取り専用に設定されます。元のプライマリクラスタに書き込む必要がある場合は、次のいずれかの操作を行ってクラスタを明示的に書き込み可能にします。

- クラスタ詳細ページに移動し、**設定**をクリックし、**書き込み可能にする**ドロップダウンボタンをクリックします。
- 元のプライマリクラスタの SQL ポートに接続し、次のステートメントを実行します:

    {{< copyable "sql" >}}

    ```sql
    set global tidb_super_read_only=OFF;
    ```

### Force Detach

予期しない障害からの復旧には、**Force Detach** を使用します。プライマリクラスタが存在する地域で壊滅的な障害が発生した場合、**Force Detach** を使用してセカンダリクラスタをできるだけ迅速にビジネスにサービスできる状態にすることで、ビジネスの継続性を確保します。この操作により、セカンダリクラスタは直ちに個別のクラスタとして機能し、未レプリケートのデータを待機することはありません。RPO はプライマリクラスタとセカンダリクラスタのレプリケーションラグに依存し、RTO は **Force Detach** が手動でトリガされるまでの時間に依存します。

**Force Detach** がトリガされると、次の手順が実行されます。

1. プライマリクラスタからセカンダリクラスタへのデータレプリケーションが即座に停止します。
2. 元のセカンダリクラスタを書き込み可能に設定し、それによってビジネスのワークロードを開始できる状態にします。
3. 元のプライマリクラスタがまだアクセス可能な場合、または元のプライマリクラスタが回復した場合、TiDB Cloud は元のプライマリクラスタを読み取り専用に設定し、新しいトランザクションがコミットされないようにします。

元のプライマリクラスタが障害から回復した後、2つのクラスタ間で実行されたが未同期のトランザクションのデータを比較して確認し、ビジネスの状況に基づいてこれらの非同期のトランザクションを元のセカンダリクラスタに手動でレプリケートするかどうかを決定する機会があります。

セカンダリクラスタとのデータレプリケーションのトポロジは、セカンダリクラスタを切り離した後は存在しなくなります。元のプライマリクラスタは読み取り専用モードに設定され、元のセカンダリクラスタは書き込み可能になります。元のプライマリクラスタで DML または DDL を計画している場合、次のいずれかの操作を行って読み取り専用モードを手動で無効にする必要があります:

- クラスタ詳細ページに移動し、**設定**をクリックし、**書き込み可能にする**ドロップダウンボタンをクリックします。
- 元のプライマリクラスタの SQL ポートに接続し、次のステートメントを実行します:

    {{< copyable "sql" >}}

    ```sql
    set global tidb_super_read_only=OFF;
    ```

## TiDB Cloud レプリケーションの設定

TiDB Cloud レプリケーションを設定するには、次の手順に従ってください:

1. [TiDB Cloud コンソール](https://tidbcloud.com) に移動し、TiDB クラスタのクラスタ概要ページに移動し、左側のナビゲーションペインで **Changefeed** をクリックします。
2. **TiDB クラスタのレプリカを作成する** をクリックします。
3. データベースのユーザー名とパスワードを入力します。
4. セカンダリクラスタの地域を選択します。
5. **作成** をクリックします。しばらくすると、sink が動作を開始し、sink のステータスが "**Producing**" に変わります。

**Planned Detach** または **Force Detach** をトリガするには、次の手順に従ってください:

1. [TiDB Cloud コンソール](https://tidbcloud.com) に移動し、TiDB クラスタのクラスタ概要ページに移動し、左側のナビゲーションペインで **Changefeed** をクリックします。
2. **TiDB クラスタのレプリカを作成する** をクリックします。
3. **Planned Detach** または **Force Detach** をクリックします。

## プライマリクラスタのスケール

プライマリクラスタをスケールアウトまたはスケールインする場合でも、セカンダリクラスタを切断することなく操作を行うことができます。プライマリクラスタがスケーリングされると、セカンダリクラスタも自動的に同じスケーリングに従います。

## プライマリクラスタとセカンダリクラスタの遅延をモニタリング

RPO に関連する遅延をモニタリングするには、次の手順を実行します:
```
1. In the [TiDB Cloud console](https://tidbcloud.com), navigate to the cluster overview page of your TiDB cluster, and then click **Changefeed** in the left navigation pane.
2. Click **Create a replica of your TiDB Cluster**.
3. You can see the lag of the primary-secondary cluster.
```