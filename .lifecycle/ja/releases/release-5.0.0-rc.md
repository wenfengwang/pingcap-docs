---
title: TiDB 5.0 RC 公開ノート
---

# TiDB 5.0 RC 公開ノート

公開日: 2021年1月12日

TiDB バージョン: 5.0.0-rc

TiDB v5.0.0-rc は TiDB v5.0 の前身バージョンです。v5.0 では、PingCAP は企業が TiDB を基にしたアプリケーションを迅速に構築することを支援し、データベースのパフォーマンス、パフォーマンスの揺らぎ、セキュリティ、高可用性、障害対策、SQL パフォーマンスのトラブルシューティングなどの懸念から解放します。

v5.0 での主な新機能や改善点は次のとおりです:

+ クラスター化インデックス。この機能を有効にすると、データベースのパフォーマンスが向上します。例えば、TPC-C の tpmC テストでは、クラスター化インデックスを有効にした場合、TiDB のパフォーマンスが39%向上します。
+ 非同期コミット。この機能を有効にすると、書き込み遅延が低減されます。例えば、Sysbench oltp-insert テストでは、非同期コミットを有効にした場合、TiDB の書き込み遅延が37.3%削減されます。
+ パフォーマンスの揺らぎの低減。オプティマイザの安定性の向上により、I/O、ネットワーク、CPU、メモリリソースの使用を制限することで実現されます。例えば、72時間のパフォーマンステストでは、Sysbench TPS 揺らぎの標準偏差が11.09% から 3.36% に低減されます。
+ レイフト合意アルゴリズム。このアルゴリズムにより、リージョンのメンバーシップの変更時にもシステムの可用性を確保します。
+ 最適化された `EXPLAIN` 機能と非表示インデックス。これにより、DBA (データベース管理者) は SQL 文のデバッグをより効率的に行うことができます。
+ 企業データの信頼性を保証します。TiDB から AWS S3 ストレージおよび Google Cloud GCS にデータをバックアップしたり、これらのクラウドストレージプラットフォームからデータを復元したりできます。
+ AWS S3 ストレージまたは TiDB/MySQL からのデータのインポートおよびエクスポートのパフォーマンス向上。例えば、TPC-C テストでは、1 TiB のデータのインポートパフォーマンスが 254 GiB/h から 366 GiB/h に40%向上します。

## SQL

### クラスター化インデックスのサポート (実験段階)

クラスター化インデックス機能を有効にすると、TiDB のパフォーマンスが大幅に向上します (例: TPC-C tpmC テストでは、クラスター化インデックスを有効にした場合、TiDB のパフォーマンスが39%向上します)。次の場合において、クラスター化インデックスは以下のように処理を効率化します:

+ データの挿入時、クラスター化インデックスがネットワークからのインデックスデータの書き込みを削減します。
+ 同等条件を持つクエリが主キーのみを含む場合、クラスター化インデックスはネットワークからのインデックスデータの読み取りを削減します。
+ 範囲条件を持つクエリが主キーのみを含む場合、クラスター化インデックスはネットワークからの複数回のインデックスデータの読み取りを削減します。
+ 主キープレフィックスを含む同等条件または範囲条件を持つクエリがある場合、クラスター化インデックスはネットワークからの複数回のインデックスデータの読み取りを削減します。

クラスター化インデックスは、テーブル内のデータの物理的な格納順序を定義します。テーブル内のデータは、クラスター化インデックスの定義に従ってのみソートされます。各テーブルにはクラスター化インデックスが1つだけ存在します。

ユーザーは `tidb_enable_clustered_index` 変数を変更してクラスター化インデックス機能を有効にできます。有効にした場合、この機能は新規に作成されたテーブルにのみ適用され、複数の列を持つ主キーまたは単一列で整数型でない場合に適用されます。主キーが単一列で整数型の場合、またはテーブルに主キーがない場合は、クラスター化インデックスの影響を受けずに従来通りデータがソートされます。

例: テーブル (`tbl_name`) にクラスター化インデックスがあるかどうかを確認するには、`select tidb_pk_type from information_schema.tables where table_name = '{tbl_name}'` を実行します。

+ [ユーザードキュメント](/system-variables.md#tidb_enable_clustered_index-new-in-v50)
+ 関連するイシュー: [#4841](https://github.com/pingcap/tidb/issues/4841)

### 不可視インデックスのサポート

パフォーマンスの調整や最適なインデックスの選択を行う際、ユーザーは SQL 文を使用してインデックスを「表示」または「非表示」に設定することができます。この設定により、`DROP INDEX` や `ADD INDEX` のようなリソース消費の多い操作を回避できます。

インデックスの可視性を変更するには、`ALTER INDEX` 文を使用します。変更後、インデックスの可視性に応じてオプティマイザーがこのインデックスをインデックスリストに追加するかどうかを決定します。

+ [ユーザードキュメント](/sql-statements/sql-statement-alter-index.md)
+ 関連するイシュー: [#9246](https://github.com/pingcap/tidb/issues/9246)

### `EXCEPT` および `INTERSECT` 演算子のサポート

`INTERSECT` 演算子は、2つ以上のクエリの結果セットの共通部分を返します。ある程度では、これは `InnerJoin` 演算子の代替となります。

`EXCEPT` 演算子は、2つのクエリの結果セットを結合し、最初のクエリの結果に含まれているが 2番目のクエリの結果には含まれていない要素を返します。

+ [ユーザードキュメント](/functions-and-operators/set-operators.md)
+ 関連するイシュー: [#18031](https://github.com/pingcap/tidb/issues/18031)

## トランザクション

### 悲観的トランザクションの実行成功率の向上

悲観的トランザクションモードでは、トランザクションに関連するテーブルに同時実行されるDDL操作や `SCHEMA VERSION` 変更がある場合、システムは自動的にトランザクションの `SCHEMA VERSION` を最新のものに更新し、DDL操作によるトランザクション中断を防ぎ、トランザクションの確定を保証します。トランザクションが中断された場合、クライアントは `Information schema is changed` エラーメッセージを受け取ります。

+ 関連するイシュー: [#18005](https://github.com/pingcap/tidb/issues/18005)

## 文字セットと照合順序

文字セットの大文字・小文字を区別しない比較ソートをサポートします。

+ [ユーザードキュメント](/character-set-and-collation.md#new-framework-for-collations)
+ 関連するイシュー: [#17596](https://github.com/pingcap/tidb/issues/17596)

## セキュリティ

### エラーメッセージとログファイルの非表示化のサポート

TiDB は、ID情報やクレジットカード番号などの機密情報の漏洩を避けるために、エラーメッセージとログファイルの非表示化をサポートします。

ユーザーは、異なるコンポーネントのために非表示化機能を有効にできます:

+ TiDB サイドでは、tidb-server で SQL 文を使用して `tidb_redact_log=1` 変数を設定します。
+ TiKV サイドでは、tikv-server で `security.redact-info-log = true` 設定を行います。
+ PD サイドでは、pd-server で `security.redact-info-log = true` 設定を行います。[#2852](https://github.com/tikv/pd/issues/2852) [#3011](https://github.com/tikv/pd/pull/3011)
+ TiFlash サイドでは、tiflash-server で `security.redact_info_log = true` 設定を行い、tiflash-learner で `security.redact-info-log = true` を設定します。

[ユーザードキュメント](/log-redaction.md)

関連するイシュー: [#18566](https://github.com/pingcap/tidb/issues/18566)

## パフォーマンスの改善

### 非同期コミットのサポート (実験段階)

非同期コミット機能を有効にすると、トランザクションの待機時間が大幅に削減されることがあります。例えば、この機能を有効にすると、Sysbench oltp-insert テストでのトランザクションの待機時間は37.3%低下します。

非同期コミット機能がない場合、書き込まれるステートメントは、二段階トランザクション確定が終了するまでクライアントに返されませんでした。非同期コミット機能により、二段階コミットの最初の段階が終了した後に結果をクライアントに返します。次に、二段階目はバックグラウンドで非同期に実行されるため、トランザクション確定の待機時間が削減されます。

ただし、非同期コミットが有効な場合、トランザクションの外部整合性は、`tidb_guarantee_external_consistency = ON` が設定されている場合に **のみ** 保証されます。非同期コミットが有効な場合、パフォーマンスが低下する可能性があります。

ユーザーは、グローバル変数 `tidb_enable_async_commit = ON` を設定することで、この機能を有効にできます。

+ [ユーザードキュメント](/system-variables.md#tidb_enable_async_commit-new-in-v50)
+ 関連するイシュー: [#8316](https://github.com/tikv/tikv/issues/8316)

### インデックス選択におけるオプティマイザの安定性の向上 (実験段階)

オプティマイザが常に比較的適切なインデックスを選択する能力は、クエリの待機時間が安定するかどうかに大きく影響します。同じSQL文に対して、欠落または不正確な統計情報により、オプティマイザが常に異なるインデックスを複数の候補インデックスから選択しないようにするために、統計モジュールを改良し再構築しました。相対的に適切なインデックスを選択するために、以下の主な改善点を実装しました:

+ 複数列のNDV、複数列の順序依存、および複数列の関数依存などの情報を統計モジュールに追加。
+ 統計モジュールを再構築。
	+ `CMSKetch` から `TopN` の値を削除。
	+ `TopN` の検索ロジックを再構築。
	+ ヒストグラムから `TopN` 情報を削除し、バケットNDVの簡単なメンテナンスのためのヒストグラムのインデックスを作成。

関連するイシュー: [#18065](https://github.com/pingcap/tidb/issues/18065)

### 誤ったスケジューリングや不完全なI/Oフロー制御によるパフォーマンス揺らぎの最適化
TiDBのスケジューリングプロセスはI/O、ネットワーク、CPU、およびメモリなどのリソースを占有します。TiDBがスケジュールされたタスクを制御しないと、QPSや遅延がリソース剥奪によるパフォーマンスの揺れを引き起こす可能性があります。これらの最適化を行った後、72時間のテストにおいて、Sysbench TPSの標準偏差が11.09％から3.36％に低減しました。

+ ノード容量の変動による余分なスケジューリングの問題を減らし、PDの`store-limit`設定値が大きすぎることによる余分なスケジューリングを減らしました。これは、`region-score-formula-version = v2`構成項目を有効にし、新しいスケジューリング計算式を導入することで達成されました。 [#3269](https://github.com/tikv/pd/pull/3269)
+ `enable-cross-table-merge = true`を変更することでクロスリージョン統合機能を有効にし、空のリージョン数を減らしました。 [#3129](https://github.com/tikv/pd/pull/3129)
+ TiKVのバックグラウンドでのデータ圧縮は大量のI/Oリソースを占有します。システムは自動的にデータ圧縮率を調整し、バックグラウンドタスクとフォアグラウンドの読み書きのI/Oリソースの競合をバランスします。`rate-limiter-auto-tuned`構成項目を介してこの機能を有効にした結果、遅延の揺れが大幅に減少しました。 [#18011](https://github.com/pingcap/tidb/issues/18011)
+ TiKVがガベージコレクション（GC）やデータ圧縮を実行する際、パーティションがCPUおよびI/Oリソースを占有します。これら2つのタスクの実行中に重複するデータが存在します。I/O使用量を減らすために、GCコンパクションフィルタ機能はこれら2つのタスクを1つに統合し、同じタスクで実行します。この機能はまだ実験的なもので、`gc.enable-compaction-filter = true`で有効化できます。 [#18009](https://github.com/pingcap/tidb/issues/18009)
+ TiFlashがデータの圧縮やソートを行う際、大量のI/Oリソースを占有します。システムはI/Oリソースの使用を制限することで、リソースの競合を緩和します。この機能はまだ実験的なもので、`bg_task_io_rate_limit`で有効にできます。

関連する問題：[#18005](https://github.com/pingcap/tidb/issues/18005)

### Real-time BI / データウェアハウスシナリオにおけるTiFlashの安定性向上

+ DeltaIndexのメモリ使用量を制限し、大容量データシナリオでのメモリの過度な使用によるメモリ不足（OOM）を回避します。
+ バックグラウンドデータソーティングタスクで使用されるI/Oライトトラフィックを制限し、フォアグラウンドタスクへの影響を軽減します。
+ 高並行度でコプロセッサタスクを処理する際の過度なメモリ使用によるシステムのOOMを避けるために、新しいスレッドプールを追加してコプロセッサタスクを順次にキューに入れます。

### その他のパフォーマンスの最適化

+ `delete from table where id <?`ステートメントの実行パフォーマンスを改善しました。そのP99のパフォーマンスが4倍向上しました。[#18028](https://github.com/pingcap/tidb/issues/18028)
+ TiFlashは複数のローカルディスクでのデータ同時読み書きをサポートし、パフォーマンスを向上させます。

## 高可用性と災害復旧

### リージョンメンバーシップの変更中のシステムの可用性向上（実験的）

リージョンメンバーシップの変更プロセスでは、「メンバーの追加」と「メンバーの削除」は2つのステップで行われます。メンバーシップ変更が完了した後に障害が発生すると、リージョンが利用できなくなり、フォアグラウンドアプリケーションでエラーが返されます。導入されたRaft Joint Consensusアルゴリズムはリージョンメンバーシップの変更中のシステムの可用性を向上させます。メンバーシップ変更中の「メンバーの追加」と「メンバーの削除」の操作を1つの操作に統合し、すべてのメンバーに送信します。変更プロセス中、リージョンは中間状態にあります。変更されたメンバーが失敗しても、システムは利用可能です。ユーザーは`pd-ctl config set enable-joint-consensus true`を実行して、この機能を有効にできます。[#7587](https://github.com/tikv/tikv/issues/7587) [#2860](https://github.com/tikv/pd/issues/2860)

+ [ユーザードキュメント](/pd-configuration-file.md#enable-joint-consensus-new-in-v50)
+ 関連する問題：[#18079](https://github.com/pingcap/tidb/issues/18079)

### システムのOOMリスクを削減するためのメモリ管理モジュールの最適化

+ キャッシュ統計のメモリ消費を削減しました。
+ Dumplingツールを使用してデータをエクスポートする際のメモリ消費を削減しました。
+ データの暗号化された中間結果をディスクに保存することでメモリ消費を削減しました。

## バックアップとリストア

+ Backup & Restoreツール（BR）は、データをAWS S3およびGoogle Cloud GCSにバックアップすることをサポートします（[ユーザードキュメント](/br/backup-and-restore-storages.md)）。
+ Backup & Restoreツール（BR）は、AWS S3およびGoogle Cloud GCSからTiDBにデータをリストアすることをサポートします（[ユーザードキュメント](/br/backup-and-restore-storages.md)）。
+ 関連する問題：[#89](https://github.com/pingcap/br/issues/89)

## データのインポートとエクスポート

+ TiDB Lightningは、AWS S3ストレージからAuroraスナップショットデータをTiDBにインポートすることをサポートします（関連する問題：[#266](https://github.com/pingcap/tidb-lightning/issues/266)）。
+ DBaaS T1.standardに1 TiBのデータをインポートするTPC-Cテストでは、パフォーマンスが254 GiB/hから366 GiB/hに40％向上しました。
+ Dumplingは、TiDB/MySQLからAWS S3ストレージにデータをエクスポートすることをサポートします（実験的）（関連する問題：[#8](https://github.com/pingcap/dumpling/issues/8)、[ユーザードキュメント](/dumpling-overview.md#export-data-to-amazon-s3-cloud-storage)）

## 診断

### より多くの収集された情報を備えた最適化された`EXPLAIN`機能により、ユーザーはパフォーマンスの問題をトラブルシュートするのに役立ちます

ユーザーがSQLパフォーマンスの問題をトラブルシュートする際には、パフォーマンスの問題の原因を特定するための詳細な診断情報が必要です。以前のTiDBバージョンでは、`EXPLAIN`ステートメントによって収集される情報が十分に詳細ではありませんでした。DBAは、ログ情報、モニタリング情報、または推測でのみトラブルシュートを行っていましたが、これは非効率的であるかもしれません。TiDB v5.0では、ユーザーがパフォーマンスの問題をより効率的にトラブルシュートできるよう、以下の改善が行われています。

+ `EXPLAIN ANALYZE`がすべてのDMLステートメントを解析し、各オペレータの実際のパフォーマンスプランと実行情報を表示できるようになりました。[#18056](https://github.com/pingcap/tidb/issues/18056)
+ ユーザーは`EXPLAIN FOR CONNECTION`を使用して実行中のSQLステートメントのステータス情報を解析できます。この情報には、各オペレータの実行時間および処理された行数が含まれます。[#18233](https://github.com/pingcap/tidb/issues/18233)
+ `EXPLAIN ANALYZE`の出力には、オペレータが送信するRPCリクエストの数、ロックの競合の解決にかかる時間、ネットワーク遅延、RocksDBで削除されたデータのスキャン量、RocksDBキャッシュのヒット率など、より多くの情報が含まれるようになりました。[#18663](https://github.com/pingcap/tidb/issues/18663)
+ SQLステートメントの詳細な実行情報がスローログに記録されるようになりました。この情報には、各オペレータによって消費された時間、処理された行数、送信されたRPCリクエストの数などが含まれます。[#15009](https://github.com/pingcap/tidb/issues/15009)

[ユーザードキュメント](/sql-statements/sql-statement-explain.md)

## デプロイとメンテナンス

+ 以前は、TiDB Ansibleの構成情報がTiUPにインポートされると、TiUPはユーザーの構成を`ansible-imported-configs`ディレクトリに配置していました。後に`tiup cluster edit-config`を使用して構成を編集する必要があると、インポートされた構成がエディタインターフェースに表示されず、ユーザーにとって混乱の原因となることがありました。TiDB v5.0では、TiDB Ansible構成がインポートされると、TiUPは構成情報を`ansible-imported-configs`だけでなくエディタインターフェースにも配置するようになりました。この改善により、ユーザーはクラスタ構成を編集する際にインポートされた構成を確認できます。
+ 複数のミラーを1つにマージし、ローカルミラーで成分を公開し、ローカルミラーにコンポーネント所有者を追加することをサポートする、強化された`mirror`コマンドが追加されました。[#814](https://github.com/pingcap/tiup/issues/814)
    + 大規模な企業、特に金融業界では、本番環境の変更には慎重が必要です。各バージョンでCDを使用することが要求されると面倒なことがあります。TiDB v5.0では、TiUPの`merge`コマンドが複数のインストールパッケージを1つにマージすることをサポートし、インストールを簡素化します。
    + v4.0では、ユーザーは自作ミラーを公開するためにtiup-serverを起動する必要がありました。v5.0では、ユーザーは`tiup mirror set`を使用して現在のミラーをローカルミラーに設定するだけで簡単に自作ミラーを公開できるようになりました。