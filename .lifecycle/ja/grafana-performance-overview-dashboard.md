# パフォーマンス概要の主なメトリクス

もしTiUPを使ってTiDBクラスタをデプロイしている場合、モニタリングシステム（Prometheus&Grafana）は同時にデプロイされます。詳細は、[TiDBモニタリングフレームワーク概要](/tidb-monitoring-framework.md)を参照してください。

Grafanaのダッシュボードは、PD、TiDB、TiKV、Node_exporter、概要、およびパフォーマンス概要を含むシリーズのサブダッシュボードに分かれています。多くのメトリクスがあり、診断に役立ちます。

パフォーマンス概要ダッシュボードは、TiDB、PD、TiKVのメトリクスを組み合わせ、それぞれを次のセクションで表示します：

- 概要：データベース時間とSQL実行時間の要約。概要内の異なる色を確認することにより、データベースのワークロードプロファイルとパフォーマンスのボトルネックを素早く特定することができます。

- ロードプロファイル：データベースQPS、接続情報、アプリケーションがTiDBとやり取りするMySQLコマンドのタイプ、データベース内のTSOとKVリクエストOPS、TiKVおよびTiDBのリソース使用状況など、主要なメトリクスとリソース使用状況が含まれます。

- 上から下への待ち時間の分解：クエリ待ち時間対接続アイドル時間の比率、クエリ待ち時間の分解、実行中のTSO/KVリクエストの待ち時間、TiKV内での書き込み待ち時間の分解。

パフォーマンス概要ダッシュボードを使用すると、パフォーマンスを効率的に分析し、ユーザー応答時間のボトルネックがデータベース内にあるかどうかを確認できます。もしボトルネックがデータベース内にある場合、データベース時間の概要、ワークロードプロファイル、およびSQL待ち時間の分解によって、データベース内のボトルネックを特定できます。詳細については、[パフォーマンスの分析とチューニング](/performance-tuning-methods.md)を参照してください。

以下のセクションでは、パフォーマンス概要ダッシュボードのメトリクスについて説明します。

## パフォーマンス概要

### SQLタイプ別データベース時間

- データベース時間：1秒あたりの合計データベース時間
- sql_type：各種SQLステートメントの実行にかかるデータベース時間

### SQLフェーズ別データベース時間

- データベース時間：1秒あたりの合計データベース時間
- get token/parse/compile/execute：4つのSQL処理フェーズで消費されるデータベース時間

一般的に、SQL実行フェーズは緑色で、その他のフェーズは赤色です。緑色以外の領域が大きい場合、実行フェーズ以外のフェーズで多くのデータベース時間が消費されており、さらなる分析が必要です。

### SQL実行時間の概要

- execute time：1秒あたりのSQL実行時のデータベース時間
- tso_wait：SQL実行中の並列TSO待ち時間
- kv request type：SQL実行中の各KVリクエストタイプごとの待ち時間。全KVリクエスト待ち時間はSQL実行時間を超過する場合があります。なぜならKVリクエストは並列して行われるからです。
- tiflash_mpp：SQL実行中の1秒あたりのTiFlashリクエスト処理時間

緑のメトリクスは一般的なKV書き込みリクエスト（例：prewrite、commit）を示し、青のメトリクスは一般的な読み取りリクエストを示します。紫のメトリクスはTiFlash MPPリクエストを示し、その他の色のメトリクスは注意が必要な予期せぬ状況を示します。例えば、悲観的ロックKVリクエストは赤色で、TSO待ちが濃い茶色で表示されます。

青色または緑色以外の領域が大きい場合、SQL実行中にボトルネックが発生していることを示します。

- 深刻なロック競合が発生する場合、赤色の領域が大きくなります。
- TSO待ちで過剰な時間が消費されている場合、濃い茶色の領域が大きくなります。

### QPS

すべてのTiDBインスタンスで実行される秒間のSQLステートメント数。`SELECT`、`INSERT`、`UPDATE`などのタイプ別に集計されます。

### タイプ別CPS

タイプ別に処理されるすべてのTiDBインスタンスでのコマンドの秒間数。

### 実行計画キャッシュOPSを使用するクエリ

- avg-hit：すべてのTiDBインスタンスで秒間の実行計画キャッシュを使用するクエリの数
- avg-miss：すべてのTiDBインスタンスで秒間の実行計画キャッシュを使用しないクエリの数

`avg-hit + avg-miss`は全クエリの1秒あたりの実行数を表す`StmtExecute`に等しいです。

### KV/TSOリクエストOPS

- kv request total：すべてのTiDBインスタンスで1秒あたりのKVリクエストの総数
- kv request by type：`Get`、`Prewrite`、`Commit`などのタイプ別に、すべてのTiDBインスタンスで1秒あたりのKVリクエスト数
- tso - cmd：すべてのTiDBインスタンスで1秒あたりの`TSOcmd`リクエスト数
- tso - request：すべてのTiDBインスタンスで1秒あたりの`TSO request`リクエスト数

一般的に、`tso - cmd`を`tso - request`で割ると、1秒あたりのリクエストの平均バッチサイズが得られます。

### ソース別KVリクエスト時間

- kv request total time：すべてのTiDBインスタンスでの1秒あたりのKVおよびTiFlashリクエストの合計時間
- 各KVリクエストと対応するリクエストソースは積み上げ棒グラフになっており、`external`は通常の業務リクエストを示し、`internal`は内部アクティビティリクエスト（DDLや自動解析リクエストなど）を示します。

### TiDB CPU

- avg：すべてのTiDBインスタンスでの平均CPU利用率
- delta：すべてのTiDBインスタンスでの最大CPU利用率から最小CPU利用率を引いた差
- max：すべてのTiDBインスタンスでの最大CPU利用率

### TiKV CPU/IO MBps

- CPU-Avg：すべてのTiKVインスタンスでの平均CPU利用率
- CPU-Delta：すべてのTiKVインスタンスでの最大CPU利用率から最小CPU利用率を引いた差
- CPU-MAX：すべてのTiKVインスタンスでの最大CPU利用率
- IO-Avg：すべてのTiKVインスタンスでのIOの平均MBps
- IO-Delt：すべてのTiKVインスタンスでの最大IO数から最小IO数を引いた差
- IO-MAX：すべてのTiKVインスタンスでの最大IO数

### 実行時間

- Duration：実行時間

    - クライアントからTiDBへのリクエストを受け取って、TiDBがリクエストを実行し、クライアントに結果を返すまでの時間。一般的に、クライアントのリクエストはSQLステートメントの形で送信されますが、この時間には`COM_PING`、`COM_SLEEP`、`COM_STMT_FETCH`、`COM_SEND_LONG_DATA`などのコマンドの実行時間も含まれます。
    - TiDBはマルチクエリをサポートしており、クライアントは`select 1; select 1; select 1;`のように1回の送信で複数のSQLステートメントを送ることができます。この場合、このクエリの総実行時間には、すべてのSQLステートメントの実行時間も含まれます。

- avg：すべてのリクエストの実行時間の平均値
- 99：すべてのリクエストのP99実行時間
- タイプ別のavg：タイプ別に集計されたすべてのTiDBインスタンスのリクエストの実行時間の平均値：`SELECT`、`INSERT`、`UPDATE`など

### 接続アイドル時間

接続アイドル時間は、接続がアイドル状態にある時間を示します。

- avg-in-txn：トランザクション内での接続の平均アイドル時間
- avg-not-in-txn：トランザクション外での接続の平均アイドル時間
- 99-in-txn：トランザクション内での接続のP99アイドル時間

### 接続数

- total：すべてのTiDBインスタンスへの接続数
- active connections：すべてのTiDBインスタンスへのアクティブ接続数
- tidb-{node-number}-peer：各TiDBインスタンスへの接続数
- disconnection/s：TiDBクラスタ内の切断数
- 99-not-in-txn：トランザクション外での接続のP99アイドル時間

### パース時間、コンパイル時間、および実行時間

- パース時間：SQLステートメントのパースにかかる時間
- コンパイル時間：パースされたSQL ASTを実行計画にコンパイルするのにかかる時間
- 実行時間：SQLステートメントの実行計画の実行にかかる時間

これらの3つのメトリクスはすべてのTiDBインスタンスでの平均実行時間とP99実行時間を含みます。

### 平均TiDB KVリクエスト実行時間

タイプ別に集計されたすべてのTiDBインスタンスでのKVリクエスト実行の平均時間。`Get`、`Prewrite`、`Commit`などが含まれます。

### 平均TiKV GRPC実行時間

タイプ別に集計されたすべてのTiKVインスタンスでのgRPCリクエスト実行の平均時間。`kv_get`、`kv_prewrite`、`kv_commit`などが含まれます。

### PD TSO待ち/RPC実行時間

- wait - avg：全TiDBインスタンスでPDからTSOを返すのを待つ平均時間
- rpc - avg：PDにTSOリクエストを送信してからTSOを受信するまでの平均時間
- wait - 99：全TiDBインスタンスでPDからTSOを返すのを待つP99時間
- rpc - 99：PDにTSOリクエストを送信してからTSOを受信するまでのP99時間

### ストレージ非同期書き込み時間、ストア時間、適用時間

- ストレージ非同期書き込み時間：非同期書き込みにかかる時間
- ストア時間：非同期書き込み中のストアループにかかる時間
- 適用時間：非同期書き込み中の適用ループにかかる時間

これらの3つのメトリクスはすべてのTiKVインスタンスでの平均時間とP99時間を含みます。

平均ストレージ非同期書き込み時間 = 平均ストア時間 + 平均適用時間

### ログの追加時間、ログのコミット時間、およびログ適用時間

- ログの追加時間：Raftがログを追加するのにかかる時間
- ログのコミット時間：Raftがログをコミットするのにかかる時間
- ログの適用時間：Raftがログを適用するのにかかる時間

これらの3つのメトリクスはすべてのTiKVインスタンスでの平均時間とP99時間を含みます。

### パフォーマンス概要パネルのインタフェース

![パフォーマンス概要](/media/performance/grafana_performance_overview.png)

## TiFlash
- CPU: TiFlash インスタンスごとのCPU利用率。
- Memory: TiFlash インスタンスごとのメモリ使用量。
- IO 利用率: TiFlash インスタンスごとのIO利用率。
- MPP クエリ件数: TiFlash インスタンスごとの1秒あたりの TiFlash MPP クエリ数。
- Request QPS: すべての TiFlash インスタンスで受信された coprocessor リクエストの数。

    - `batch`: バッチリクエストの数。
    - `batch_cop`: バッチリクエスト内の coprocessor リクエストの数。
    - `cop`: coprocessor インターフェースを介して直接送信された coprocessor リクエストの数。
    - `cop_dag`: すべての coprocessor リクエスト内の dag リクエストの数。
    - `super_batch`: スーパーバッチ機能を有効にするリクエストの数。
- Executor QPS: すべての TiFlash インスタンスで受信されたリクエスト内の各種類の dag エグゼキュータの数。 `table_scan` はテーブルスキャンエグゼキュータです。 `selection` は選択エグゼキュータです。 `aggregation` は集計エグゼキュータです。 `top_n` は `TopN` エグゼキュータです。 `limit` は limit エグゼキュータです。
- Request Duration Overview: すべての TiFlash インスタンスでの各種リクエストタイプごとの1秒あたりの総処理時間の積み上げチャートを提供します。
- Request Duration: すべての TiFlash インスタンスでの各 MPP および coprocessor リクエストタイプの総処理時間。これは、コプロセッサ要求の受信から要求の応答が完了するまでの時間であり、平均レイテンシと p99 レイテンシが含まれます。
- Request Handle Duration: すべての TiFlash インスタンスでの各 MPP および coprocessor リクエストタイプの実際の処理時間。これは、コプロセッサリクエストの実行開始から実行の完了までの時間であり、平均レイテンシと p99 レイテンシが含まれます。
- Raft Wait Index Duration: `wait_index` が TiFlash インスタンス全体で使用する時間、つまり `read_index` リクエストが受信されてから Region インデックスが `read_index` 以上になるまで待機するために使用する時間です。
- Raft Batch Read Index Duration: TiFlash インスタンス全体で `read_index` が使用する時間。ほとんどの時間は、Region リーダーおよびリトライとの相互作用に使用されます。
- インスタンス別の書き込みスループット: インスタンス別の書き込みスループット。これには、Raft 書き込みコマンドおよび Raft スナップショットを適用するスループットが含まれます。
- 書き込みフロー: すべての TiFlash インスタンスによるディスク書き込みのトラフィック。
- 読み取りフロー: すべての TiFlash インスタンスによるディスク読み取りのトラフィック。

## CDC

- CPU 使用率: TiCDC ノードごとの CPU 使用率。
- メモリ使用率: TiCDC ノードごとのメモリ使用率。
- Goroutine 件数: TiCDC ノードごとのゴルーチンの数。
- Changefeed チェックポイントラグ: データレプリケーションの進行ラグ（単位は秒）、上流と下流の間での進行ラグです。
- Changefeed resolved ts ラグ: データレプリケーションの進行ラグ（単位は秒）、上流と TiCDC ノードの間での進行ラグです。
- Changefeed ステータス:

    - 0: 正常
    - 1: エラー
    - 2: 失敗
    - 3: 停止
    - 4: 完了
    - -1: 不明
- Puller 出力イベント数/秒: TiCDC ノードの Puller モジュールが Sorter モジュールに1秒あたり送信する行数。
- Sorter 出力イベント数/秒: TiCDC ノードの Sorter モジュールが Mounter モジュールに1秒あたり送信する行数。
- Mounter 出力イベント数/秒: TiCDC ノードの Mounter モジュールが Sink モジュールに1秒あたり送信する行数。
- Table sink 出力イベント数/秒: TiCDC ノードの Table Sorter モジュールが Sink モジュールに1秒あたり送信する行数。
- SinkV2 - Sink フラッシュ行数/秒: TiCDC ノードの Sink モジュールが下流に1秒あたり送信する行数。
- トランザクション Sink 完全フラッシュ期間: TiCDC ノードの MySQL Sink による下流トランザクションの書き込みの平均レイテンシと p999 レイテンシ。
- MQ ワーカーのメッセージ送信期間パーセンタイル: 下流が Kafka の場合、MQ ワーカーによるメッセージ送信のレイテンシ。
- Kafka 送信バイト数: MQ ワークロードでの下流トランザクションの書き込みトラフィック。