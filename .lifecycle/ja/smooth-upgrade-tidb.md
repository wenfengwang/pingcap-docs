---
title：TiDBスムースアップグレード
summary: このドキュメントでは、TiDBのスムースアップグレード機能を紹介します。これにより、TiDBクラスターを手動でDDL操作をキャンセルすることなくアップグレードできます。

# TiDBスムースアップグレード

このドキュメントでは、TiDBのスムースアップグレード機能を紹介します。これにより、TiDBクラスターを手動でDDL操作をキャンセルすることなくアップグレードできます。

v7.1.0以降、TiDBを後のバージョンにアップグレードする際、TiDBスムースアップグレードがサポートされます。この機能により、アップグレードプロセス中の制限が解除され、よりユーザーフレンドリーなアップグレード体験が提供されます。ただし、アップグレードプロセス中にユーザーによって起動されたDDL操作がないことを確認する必要があります。

## サポートされているバージョン

機能をスイッチで制御する必要があるかどうかに応じて、スムースアップグレードを利用する方法には2つの方法があります。

- 機能はデフォルトで有効になっており、スイッチで制御する必要がありません。現在、この方法をサポートしているバージョンはv7.1.0、v7.1.1、v7.2.0、v7.3.0です。具体的なサポートされているバージョンは次のとおりです：
    - v7.1.0からv7.1.1、v7.2.0、またはv7.3.0へのアップグレード
    - v7.1.1からv7.2.0またはv7.3.0へのアップグレード
    - v7.2.0からv7.3.0へのアップグレード

- 機能はデフォルトで無効であり、`/upgrade/start`リクエストを送信して有効にすることができます。詳細については、[TiDB HTTP API](https://github.com/pingcap/tidb/blob/master/docs/tidb_http_api.md)を参照してください。サポートされているバージョンは次のとおりです：
    - v7.1.2およびそれ以降のv7.1.x（すなわち、x >= 2のv7.1.x）からv7.4.0およびそれ以降のバージョンへのアップグレード
    - v7.4.0から後のバージョンへのアップグレード

以下の表を参照して、特定のバージョンでサポートされているアップグレード方法を確認してください：

| 元のバージョン | アップグレードされたバージョン | アップグレード方法 | メモ |
|------|--------|-------------|-------------|
| < v7.1.0  | 任意のバージョン                 | スムースアップグレードはサポートされていません。 | |
| v7.1.0    | v7.1.1、v7.2.0、またはv7.3.0   | スムースアップグレードが自動でサポートされています。追加操作は不要です。 | 実験的な機能です。問題[#44760](https://github.com/pingcap/tidb/pull/44760)に遭遇する可能性があります。 |
| v7.1.1    | v7.2.0またはv7.3.0         | スムースアップグレードが自動でサポートされています。追加操作は不要です。 | 実験的な機能です。 |
| v7.2.0    | v7.3.0                   | スムースアップグレードが自動でサポートされています。追加操作は不要です。 | 実験的な機能です。 |
| [v7.1.2, v7.2.0)                     | [v7.1.2, v7.2.0) | `/upgrade/start` HTTPリクエストを送信してスムースアップグレードを有効にします。 [TiUPの使用](#use-tiup-to-upgrade)と[その他のアップグレード方法](#other-upgrade-methods)の2つの方法があります | スムースアップグレードが有効になっていない場合は、アップグレード中にDDL操作が行われていないことを確認してください。 |
| [v7.1.2, v7.2.0)または>= v7.4.0             | >= v7.4.0 | `/upgrade/start` HTTPリクエストを送信してスムースアップグレードを有効にします。 [TiUPの使用](#use-tiup-to-upgrade)と[その他のアップグレード方法](#other-upgrade-methods)の2つの方法があります  | スムースアップグレードが有効になっていない場合は、アップグレード中にDDL操作が行われていないことを確認してください。 |
| v7.1.0、v7.1.1、v7.2.0、およびv7.3.0     | >= v7.4.0 | スムースアップグレードはサポートされていません。 | |

## 機能紹介

スムースアップグレード機能導入前に、アップグレードプロセス中のDDL操作には以下の制限があります：

- アップグレードプロセス中のDDL操作を実行すると、TiDBで未定義の動作が発生する可能性があります。
- アップグレードプロセス中にTiDBをアップグレードすると、TiDBで未定義の動作が発生する可能性があります。

これらの制限は、アップグレードプロセス中にユーザーによって起動されたDDL操作がないことを確認する必要があることを要約したものです。スムースアップグレード機能導入後、TiDBはアップグレードプロセス中にこの制限の影響を受けなくなります。

詳細については、[TiUPを使用してTiDBをアップグレード](/upgrade-tidb-using-tiup.md#upgrade-tidb-using-tiup)の**注意**セクションを参照してください。

### アップグレード手順

#### TiUPを使用してアップグレード

v1.14.0以降、TiUPはこの機能を自動でサポートします。つまり、`tiup cluster upgrade`コマンドを使用してTiDBクラスターを直接アップグレードできます。ただし、現在は`tiup cluster patch`コマンドはサポートされていません。

#### TiDB Operatorを使用してアップグレード

現在、この機能はサポートされていません。可能な限り早くサポートされる予定です。

#### その他のアップグレード方法

以下の手順を実行して、TiDBを手動でアップグレードするか、スクリプトを使用してアップグレードできます。

1. TiDBクラスター内の任意のTiDBノードにHTTPアップグレード開始リクエストを送信します：`curl -X POST http://{TiDBIP}:10080/upgrade/start`。
   * TiDBクラスターが**アップグレード中**の状態に入ります。
   * 実行するDDL操作が一時停止されます。

2. TiDBバイナリを置換し、ローリングアップグレードを実行します。このプロセスは通常のアップグレードプロセスと同じです。
    * アップグレードプロセス中にシステムDDL操作が実行されます。

3. クラスター内のすべてのTiDBノードが正常にアップグレードされた後、TiDBノードのいずれかにHTTPアップグレード完了リクエストを送信します：`curl -X POST http://{TiDBIP}:10080/upgrade/finish`。
    * ユーザーの一時停止されたDDL操作が再開されます。

## 制限事項

スムースアップグレード機能を使用する際の以下の制限事項に注意してください。

### ユーザー操作の制限事項

* アップグレード前、クラスターにキャンセルされているDDLジョブ（つまり、進行中のDDLジョブがユーザーによってキャンセルされている状態）がある場合、キャンセル中のジョブを一時停止できないため、TiDBはジョブの再試行を行います。再試行が失敗した場合、エラーが報告され、アップグレードが中止されます。

* TiUPを使用してTiDBをアップグレードするシナリオでは、TiUPアップグレードにはタイムアウト期間があります。アップグレード前にキューに待機しているDDLジョブが多数（300以上）ある場合、アップグレードに失敗する可能性があります。

* アップグレード中に、次に示す操作は許可されません：

    * システムテーブル（`mysql.*`、`information_schema.*`、`performance_schema.*`、および`metrics_schema.*`）でDDL操作を実行します。
    * DDLジョブを手動でキャンセルします：`ADMIN CANCEL DDL JOBS job_id [, job_id] ...;`。
    * データのインポート。

### ツールの制限事項

* アップグレード中には、次に示すツールの使用がサポートされていません：

    * BR：BRは一時停止されたDDLジョブをTiDBに複製する可能性があります。一時停止されたDDLジョブは自動的に再開されないため、後でDDLジョブが詰まる可能性があります。

    * DMおよびTiCDC：DMまたはTiCDCを使用してアップグレードプロセス中にSQLステートメントをTiDBにインポートし、そのSQLステートメントの1つにDDL操作が含まれている場合、インポート操作がブロックされ、未定義のエラーが発生する可能性があります。

### プラグインの制限事項

TiDBにインストールされているプラグインにはDDL操作が含まれる場合があります。ただし、アップグレード中にプラグインのDDL操作が非システムテーブルで実行されている場合、アップグレードに失敗する可能性があります。