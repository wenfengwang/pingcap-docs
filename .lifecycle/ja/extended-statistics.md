---
title: 拡張統計の紹介
summary: オプティマイザをガイドするための拡張統計の使用方法を学びます。
---

# 拡張統計の紹介

TiDBでは、次の2種類の統計情報を収集できます。

- 基本統計情報: ヒストグラムやCount-Min Sketchなどの統計情報です。詳細は[統計情報の紹介](/statistics.md)を参照してください。
- 拡張統計情報: テーブルとカラムでフィルターされた統計情報です。

> **ヒント:**
>
> このドキュメントを読む前に、まず[統計情報の紹介](/statistics.md)をお読みいただくことを推奨します。

`ANALYZE`ステートメントが手動または自動で実行されると、TiDBはデフォルトで基本統計情報のみを収集し、拡張統計情報は収集しません。これは、拡張統計情報は特定のシナリオでのオプティマイザの見積もりにのみ使用され、その収集には追加のオーバーヘッドが必要であるためです。

拡張統計情報はデフォルトで無効になっています。拡張統計情報を収集するには、まず拡張統計情報を有効にしてから、各個々の拡張統計オブジェクトを登録する必要があります。

登録後、`ANALYZE`ステートメントが次に実行されると、TiDBは基本統計情報と登録された拡張統計情報の両方を収集します。

## 制限事項

次のシナリオでは、拡張統計情報は収集されません。

- インデックスのみの統計情報収集
- `ANALYZE INCREMENTAL`コマンドを使用した統計情報収集
- システム変数`tidb_enable_fast_analyze`の値が`true`に設定されている場合の統計情報収集

## 一般的な操作

### 拡張統計情報を有効にする

拡張統計情報を有効にするには、システム変数`tidb_enable_extended_stats`を`ON`に設定します。

```sql
SET GLOBAL tidb_enable_extended_stats = ON;
```

この変数のデフォルト値は`OFF`です。このシステム変数の設定は、すべての拡張統計オブジェクトに適用されます。

### 拡張統計情報を登録する

拡張統計情報の登録は一度きりの作業ではなく、各拡張統計オブジェクトに対して登録を繰り返す必要があります。

拡張統計情報を登録するには、`ALTER TABLE ADD STATS_EXTENDED` SQLステートメントを使用します。構文は以下の通りです。

```sql
ALTER TABLE テーブル名 ADD STATS_EXTENDED IF NOT EXISTS 統計情報名 統計情報タイプ(カラム名, カラム名...);
```

構文では、テーブル名、統計情報名、統計情報タイプ、および収集する拡張統計情報のカラム名を指定できます。

- `table_name`は拡張統計情報を収集するテーブルの名前を指定します。
- `stats_name`は統計オブジェクトの名前を指定し、各テーブルで一意である必要があります。
- `stats_type`は統計情報のタイプを指定します。現在は相関タイプのみがサポートされています。
- `column_name`は複数のカラムを持つカラムグループを指定します。現在は2つのカラム名のみ指定できます。

<details>
<summary>動作原理</summary>

アクセスパフォーマンスを向上させるために、各TiDBノードは拡張統計情報のシステムテーブル`mysql.stats_extended`にキャッシュを維持します。拡張統計情報を登録すると、次に`ANALYZE`ステートメントが実行されると、TiDBは`mysql.stats_extended`テーブルに対応するオブジェクトがあれば、拡張統計情報を収集します。

`mysql.stats_extended`テーブルの各行には`version`列があります。行が更新されると、`version`の値が増加します。このようにしてTiDBはテーブルを完全に再読み込むのではなく、段階的にメモリにロードします。

TiDBは定期的に`mysql.stats_extended`をロードして、キャッシュがテーブル内のデータと同じ状態に保たれるようにします。

> **警告:**
>
> `mysql.stats_extended`システムテーブルに直接操作を行うことは**推奨されません**。さもないと、異なるTiDBノードで不整合のキャッシュが発生します。
>
> テーブルで誤って操作を行った場合は、各TiDBノードで次のステートメントを実行できます。この操作により、現在のキャッシュがクリアされ、`mysql.stats_extended`テーブルが完全に再読み込まれます。
>
> ```sql
> ADMIN RELOAD STATS_EXTENDED;
> ```

</details>

### 拡張統計情報を削除する

拡張統計オブジェクトを削除するには、次のステートメントを使用します。

```sql
ALTER TABLE テーブル名 DROP STATS_EXTENDED 統計情報名;
```

<details>
<summary>動作原理</summary>

ステートメントを実行すると、TiDBは`mysql.stats_extended`の`status`列の対応するオブジェクトの値を`2`にマークし、オブジェクトを直接削除するのではなく、バックグラウンドのガベージコレクションが最終的にオブジェクトを削除します。

> **警告:**
>
> `mysql.stats_extended`システムテーブルに直接操作を行うことは**推奨されません**。さもないと、異なるTiDBノードで不整合のキャッシュが発生します。
>
> テーブルで誤って操作を行った場合は、各TiDBノードで次のステートメントを使用できます。この操作により、現在のキャッシュがクリアされ、`mysql.stats_extended`テーブルが完全に再読み込まれます。
>
> ```sql
> ADMIN RELOAD STATS_EXTENDED;
> ```

</details>

### 拡張統計情報のエクスポートとインポート

拡張統計情報のエクスポートまたはインポートの方法は、基本統計情報のエクスポートまたはインポートと同じです。詳細は[統計情報の紹介 - 統計情報のエクスポートとインポート](/statistics.md#import-and-export-statistics)を参照してください。

## 相関型拡張統計情報の使用例

TiDBでは現在、相関型拡張統計情報のみをサポートしています。このタイプは範囲クエリ内の行数を見積もったり、インデックス選択を改善するために使用されます。次の例は、相関型拡張統計情報が範囲クエリ内の行数の見積もりにどのように使用されるかを示しています。

### 手順1. テーブルを定義する

テーブル`t`を以下のように定義します。

```sql
CREATE TABLE t(col1 INT, col2 INT, KEY(col1), KEY(col2));
```

テーブル`t`の`col1`および`col2`が両方とも行の順序で単調増加制約に準拠していると仮定します。つまり、`col1`と`col2`の値は厳密に順序付けられ、相関係数は`1`となります。

### 手順2. 拡張統計情報なしで例のクエリを実行する

拡張統計情報を使用せずに次のクエリを実行します。

```sql
SELECT * FROM t WHERE col1 > 1 ORDER BY col2 LIMIT 1;
```

前述のクエリの実行にあたり、TiDBオプティマイザーにはテーブル`t`へのアクセス方法として次のオプションがあります。

- `col1`のインデックスを使用してテーブル`t`にアクセスし、その後`col2`で結果をソートして`Top-1`を計算します。
- `col1 > 1`を満たす最初の行を`col2`でスキャンしたときにTiDBがテーブルをスキャンする際にフィルタリングされる行がどれだけあるかによってアクセス方法のコストが主に決まります。

拡張統計情報がない場合、TiDBオプティマイザーは`col1`と`col2`が独立していると仮定するため、**著しい見積もりの誤差**が発生します。

### 手順3. 拡張統計情報を有効にする

`tidb_enable_extended_stats`を`ON`に設定し、`col1`と`col2`のための拡張統計情報オブジェクトを登録します。

```sql
ALTER TABLE t ADD STATS_EXTENDED s1 correlation(col1, col2);
```

登録後に`ANALYZE`を実行すると、TiDBはテーブル`t`の`col`および`col2`の[ピアソンの相関係数](https://en.wikipedia.org/wiki/Pearson_correlation_coefficient)を計算し、オブジェクトを`mysql.stats_extended`テーブルに書き込みます。

### 手順4. 拡張統計情報がどのように違いを生むかを確認する

相関型拡張統計情報を持つ場合、オプティマイザーはより正確にスキャンする行数を見積もることができます。

この時点では、[手順2. 拡張統計情報なしで例のクエリを実行する](#step-2-execute-an-example-query-without-extended-statistics)のクエリに関して、`col1`と`col2`は厳密に順序付けられています。テーブル`t`へのアクセスを`col2`のインデックスを使用して`col1 > 1`を満たす最初の行を見つけるようにした場合、TiDBオプティマイザーは以下のクエリに同等の行数の見積もりを行います。

```sql
SELECT * FROM t WHERE col1 <= 1 OR col1 IS NULL;
```

前述のクエリの結果に1を加えたものが、最終的な行数の見積もりとなります。これにより独立した仮定を使用する必要がなくなり、**著しい見積もりの誤差が回避されます**。

相関係数（この例では`1`）がシステム変数`tidb_opt_correlation_threshold`の値より小さい場合、オプティマイザーは独立した仮定を使用しますが、見積もりをヒューリスティック的に増やします。`tidb_opt_correlation_exp_factor`の値が大きいほど、見積もりの結果も大きくなります。相関係数の絶対値が大きいほど、見積もりの結果も大きくなります。

```