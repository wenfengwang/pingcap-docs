---
title: デッドロック
summary: `DEADLOCKS` INFORMATION_SCHEMA テーブルの情報を学ぶ。

# DEADLOCKS

`DEADLOCKS` テーブルは、現在の TiDB ノードで最近発生した複数のデッドロックエラーの情報を表示します。

```sql
USE INFORMATION_SCHEMA;
DESC deadlocks;
```

出力は以下の通りです:

```sql
+-------------------------+---------------------+------+------+---------+-------+
| Field                   | Type                | Null | Key  | Default | Extra |
+-------------------------+---------------------+------+------+---------+-------+
| DEADLOCK_ID             | bigint(21)          | NO   |      | NULL    |       |
| OCCUR_TIME              | timestamp(6)        | YES  |      | NULL    |       |
| RETRYABLE               | tinyint(1)          | NO   |      | NULL    |       |
| TRY_LOCK_TRX_ID         | bigint(21) unsigned | NO   |      | NULL    |       |
| CURRENT_SQL_DIGEST      | varchar(64)         | YES  |      | NULL    |       |
| CURRENT_SQL_DIGEST_TEXT | text                | YES  |      | NULL    |       |
| KEY                     | text                | YES  |      | NULL    |       |
| KEY_INFO                | text                | YES  |      | NULL    |       |
| TRX_HOLDING_LOCK        | bigint(21) unsigned | NO   |      | NULL    |       |
+-------------------------+---------------------+------+------+---------+-------+
```

`DEADLOCKS` テーブルは、同じデッドロックイベントを示すために複数行を使用し、各行はデッドロックイベントに関与するトランザクションの情報を表示します。TiDB ノードが複数のデッドロックエラーを記録すると、`DEADLOCK_ID` 列を使用して各エラーを区別します。同じ `DEADLOCK_ID` は、同じデッドロックイベントを示します。`DEADLOCK_ID` は**グローバルな一意性を保証せず、永続化されません**。単に同じ結果セット内で同じデッドロックイベントを示します。

`DEADLOCKS` テーブルの各列の意味は次の通りです:

* `DEADLOCK_ID`: デッドロックイベントの ID。テーブル内に複数のデッドロックエラーが存在する場合、この列を使用して異なるデッドロックエラーに属する行を区別できます。
* `OCCUR_TIME`: デッドロックエラーが発生した時刻。
* `RETRYABLE`: デッドロックエラーが再試行可能かどうか。再試行可能なデッドロックエラーの説明については、[再試行可能なデッドロックエラー](#retryable-deadlock-errors) セクションを参照してください。
* `TRY_LOCK_TRX_ID`: ロックを取得しようとするトランザクションの ID。この ID はトランザクションの `start_ts` でもあります。
* `CURRENT_SQL_DIGEST`: ロックを取得しようとするトランザクションで現在実行中の SQL ステートメントのダイジェスト。
* `CURRENT_SQL_DIGEST_TEXT`: ロックを取得しようとするトランザクションで現在実行中の SQL ステートメントの正規化された形式。
* `KEY`: トランザクションがロックを取得しようとしているブロックされたキー。このフィールドの値は16進数文字列の形式で表示されます。
* `KEY_INFO`: `KEY` の詳細情報。[`KEY_INFO`](#key_info) セクションを参照してください。
* `TRX_HOLDING_LOCK`: キーのロックを保持しておりブロックを引き起こしているトランザクションの ID。この ID はトランザクションの `start_ts` でもあります。

<CustomContent platform="tidb">

`DEADLOCKS` テーブルで記録できるデッドロックイベントの最大数を調整するには、TiDB 構成ファイルの [`pessimistic-txn.deadlock-history-capacity`](/tidb-configuration-file.md#deadlock-history-capacity) 設定を調整します。デフォルトでは、テーブルに最近の 10 件のデッドロックイベント情報が記録されます。

</CustomContent>

<CustomContent platform="tidb-cloud">

`DEADLOCKS` テーブルには最近の 10 件のデッドロックイベント情報が記録されます。

</CustomContent>

> **警告:**
>
> * [PROCESS](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_process) 権限を持つユーザーのみがこのテーブルをクエリできます。
> * `CURRENT_SQL_DIGEST` 列の情報（SQL ダイジェスト）は、正規化された SQL ステートメントから計算されたハッシュ値です。`CURRENT_SQL_DIGEST_TEXT` 列の情報は内部的にはステートメントサマリーテーブルから問い合わせられますが、内部で対応するステートメントが見つからない可能性があります。SQL ダイジェストとステートメントサマリーテーブルの詳細については、[ステートメントサマリーテーブル](/statement-summary-tables.md) を参照してください。

## `KEY_INFO`

`KEY_INFO` 列は `KEY` 列の詳細情報を JSON 形式で表示します。各フィールドの説明は次の通りです:

* `"db_id"`: キーが所属するスキーマの ID。
* `"db_name"`: キーが所属するスキーマの名前。
* `"table_id"`: キーが所属するテーブルの ID。
* `"table_name"`: キーが所属するテーブルの名前。
* `"partition_id"`: キーの位置するパーティションの ID。
* `"partition_name"`: キーの位置するパーティションの名前。
* `"handle_type"`: 行キー（すなわちデータ行を保存するキー）のハンドルタイプ。可能な値は次の通りです:
    * `"int"`: ハンドルタイプは int であり、つまりハンドルは行 ID です。
    * `"common"`: ハンドルタイプは int64 ではありません。これは、クラスタ化インデックスが有効な場合に非 int 主キーで表示されます。
    * `"unknown"`: ハンドルタイプは現在サポートされていません。
* `"handle_value"`: ハンドル値。
* `"index_id"`: インデックスキーが所属するインデックスの ID。
* `"index_name"`: インデックスキーが所属するインデックスの名前。
* `"index_values"`: インデックスキーのインデックス値。

上記のフィールドで、特定のフィールドの情報が適用されない場合や現在利用できない場合、そのフィールドはクエリ結果から省略されます。たとえば、行キー情報には `index_id`、`index_name`、`index_values` が含まれません。インデックスキーには `handle_type`、`handle_value` が含まれません。パーティションされていないテーブルには `partition_id`、`partition_name` が表示されません。削除されたテーブルのキー情報は `table_name`、`db_id`、`db_name`、`index_name` のようなスキーマ情報を取得できず、テーブルがパーティション化されているかどうかを区別できません。

> **注:**
>
> パーティションを有効にしたテーブルからキーが取得され、クエリ中の理由により（例: キーが所属するテーブルが削除されたため）スキーマ情報を問い合わせることができない場合、`table_id` フィールドにキーが所属するパーティションの ID が表示される可能性があります。これは、TiDB が複数の独立したテーブルのキーと同じように異なるパーティションのキーをエンコードするために、スキーマ情報が欠落している場合にこのような ID が表示されるためです。したがって、スキーマ情報が欠落している場合、TiDB はキーが非分割テーブルに属しているか、テーブルの 1 つのパーティションに属しているかを確認できません。

## 再試行可能なデッドロックエラー

<CustomContent platform="tidb-cloud">

> **注:**
>
> このセクションは TiDB Cloud には適用されません。

</CustomContent>

<CustomContent platform="tidb">

> **注:**
>
> `DEADLOCKS` テーブルはデフォルトで再試行可能なデッドロックエラーの情報を収集しません。テーブルに再試行可能なデッドロックエラー情報を収集する必要がある場合は、TiDB 構成ファイルの [`pessimistic-txn.deadlock-history-collect-retryable`](/tidb-configuration-file.md#deadlock-history-collect-retryable) の値を調整できます。

</CustomContent>

トランザクション A がトランザクション B がすでに保持しているロックによってブロックされ、トランザクション B が直接または間接的に現在のトランザクション A が保持しているロックによってブロックされている場合、デッドロックエラーが発生します。このデッドロックには、次の 2 つのケースがあります:

+ ケース 1: トランザクション B がトランザクション A が開始した後に実行されたステートメントによって（直接または間接的に）生成されたロックによってブロックされる可能性があります。
+ ケース 2: トランザクション B は、トランザクション A で現在実行中のステートメントによってもブロックされる可能性があります。

ケース 1 では、TiDB はトランザクション A のクライアントにデッドロックエラーを報告し、トランザクションを中止します。

ケース 2 では、TiDB はトランザクション内で現在実行中のステートメントを自動的に再試行します。たとえば、トランザクション A が次のステートメントを実行するとします:

```sql
UPDATE t SET v = v + 1 WHERE id = 1 OR id = 2;
```

トランザクション B は次の 2 つのステートメントを順に実行します。

```sql
UPDATE t SET v = 4 WHERE id = 2;
UPDATE t SET v = 2 WHERE id = 1;
```

その後、トランザクション A は `id = 1` および `id = 2` の 2 つの行をロックし、2 つのトランザクションが次の順序で実行されるとします:

1. トランザクション A は `id = 1` の行をロックします。
2. トランザクション B は最初のステートメントを実行し `id = 2` の行をロックします。
3. トランザクション B は 2 番目のステートメントを実行し、トランザクション A によってブロックされる `id = 1` の行をロックしようとします。
4. トランザクション A はトランザクション B によってブロックされ、デッドロックが形成されます。
この場合、トランザクションAの宣言は他のトランザクションをブロックするためのものであり、現在実行中の宣言でもあります。現在宣言の悲観的ロックを解決することができます（トランザクションBが実行を続けることができるように）、そして現在の宣言を再試行することができます。 TiDBでは、これが該当するかどうかを判断するために内部的にキーハッシュを使用します。

再試行可能なデッドロックが発生した場合、内部の自動再試行はトランザクションエラーを引き起こさず、クライアントには透過的です。ただし、この状況が頻繁に発生すると、パフォーマンスに影響を与える可能性があります。これが発生した場合、TiDBログで、「single statement deadlock, retry statement」が表示されます。

## 例1

テーブル定義と初期データが次のようになっていると仮定します。

```sql
CREATE TABLE t (id int primary key, v int);
INSERT INTO t VALUES (1, 10), (2, 20);
```

次の順序で2つのトランザクションが実行されます:

| トランザクション1                        | トランザクション2                        | 説明             |
|--------------------------------------|--------------------------------------|-----------------
| `UPDATE t SET v = 11 WHERE id = 1;`  |                                      |                     
|                                      | `UPDATE t SET v = 21 WHERE id = 2;`  |                     
| `UPDATE t SET v = 12 WHERE id = 2;`  |                                      | トランザクション1がブロックされます。    
|                                      | `UPDATE t SET v = 22 WHERE id = 1;`  | トランザクション2はデッドロックエラーを報告します。   |

その後、トランザクション2はデッドロックエラーを報告します。この時、`DEADLOCKS`テーブルをクエリします:

```sql
SELECT * FROM INFORMATION_SCHEMA.DEADLOCKS;
```

期待される出力は次のようになります:

```sql
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
| DEADLOCK_ID | OCCUR_TIME                 | RETRYABLE | TRY_LOCK_TRX_ID    | CURRENT_SQL_DIGEST                                               | CURRENT_SQL_DIGEST_TEXT                 | KEY                                    | KEY_INFO                                                                                           | TRX_HOLDING_LOCK   |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
|           1 | 2021-08-05 11:09:03.230341 |         0 | 426812829645406216 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000002 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"2"} | 426812829645406217 |
|           1 | 2021-08-05 11:09:03.230341 |         0 | 426812829645406217 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000001 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"1"} | 426812829645406216 |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
```

`DEADLOCKS`テーブルには2つのデータ行が生成されます。両方の行の`DEADLOCK_ID`フィールドが`1`であるため、両方の行の情報は同じデッドロックエラーに属することを意味します。最初の行は、`"7480000000000000355F728000000000000002"`のキーで、ID `"426812829645406216"`のトランザクションはID `"426812829645406217"`のトランザクションによってブロックされていることを示しています。2番目の行は、`"7480000000000000355F728000000000000001"`のキーで、ID`426812829645406217`のトランザクションが`426812829645406216` のトランザクションによってブロックされていることを示しているため、相互ブロックが構成されてデッドロックが形成されています。

## 例2

`DEADLOCKS`テーブルをクエリし、以下の結果が得られたと仮定します:

```sql
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
| DEADLOCK_ID | OCCUR_TIME                 | RETRYABLE | TRY_LOCK_TRX_ID    | CURRENT_SQL_DIGEST                                               | CURRENT_SQL_DIGEST_TEXT                 | KEY                                    | KEY_INFO                                                                                           | TRX_HOLDING_LOCK   |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
|           1 | 2021-08-05 11:09:03.230341 |         0 | 426812829645406216 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000002 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"2"} | 426812829645406217 |
|           1 | 2021-08-05 11:09:03.230341 |         0 | 426812829645406217 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000001 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"1"} | 426812829645406216 |
|           2 | 2021-08-05 11:09:21.252154 |         0 | 426812832017809412 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000002 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"2"} | 426812832017809413 |
|           2 | 2021-08-05 11:09:21.252154 |         0 | 426812832017809413 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000003 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"3"} | 426812832017809414 |
|           2 | 2021-08-05 11:09:21.252154 |         0 | 426812832017809414 | 22230766411edb40f27a68dadefc63c6c6970d5827f1e5e22fc97be2c4d8350d | update `t` set `v` = ? where `id` = ? ; | 7480000000000000355F728000000000000001 | {"db_id":1,"db_name":"test","table_id":53,"table_name":"t","handle_type":"int","handle_value":"1"} | 426812832017809412 |
+-------------+----------------------------+-----------+--------------------+------------------------------------------------------------------+-----------------------------------------+----------------------------------------+----------------------------------------------------------------------------------------------------+--------------------+
```

前のクエリ結果の`DEADLOCK_ID`列は、最初の2行が一緒にデッドロックエラーの情報を表し、互いを待つ2つのトランザクションがデッドロックを形成していることを示しています。次の3行は、互いに待っている3つのトランザクションがサイクルになってデッドロックを形成している別のデッドロックエラーの情報を表します。

## CLUSTER_DEADLOCKS

 `CLUSTER_DEADLOCKS` テーブルは、クラスタ全体の各TiDBノードで最近発生したデッドロックエラーの情報を返し、それは各ノードの`DEADLOCKS`テーブルの結合情報です。 `CLUSTER_DEADLOCKS` は、異なるTiDBノードを区別するために、追加の `INSTANCE` 列も含み、ノードのIPアドレスとポートを表示します。

`DEADLOCK_ID`はグローバルな一意性を保証しないため、`CLUSTER_DEADLOCKS` テーブルのクエリ結果では、結果セット内の異なるデッドロックエラーの情報を区別するために、`INSTANCE` と `DEADLOCK_ID` を一緒に使用する必要があります。

```sql
```sql
USE INFORMATION_SCHEMA;
DESC CLUSTER_DEADLOCKS;
```

The output is as follows:

```sql
+-------------------------+---------------------+------+------+---------+-------+
| Field                   | Type                | Null | Key  | Default | Extra |
+-------------------------+---------------------+------+------+---------+-------+
| INSTANCE                | varchar(64)         | YES  |      | NULL    |       |
| DEADLOCK_ID             | bigint(21)          | NO   |      | NULL    |       |
| OCCUR_TIME              | timestamp(6)        | YES  |      | NULL    |       |
| RETRYABLE               | tinyint(1)          | NO   |      | NULL    |       |
| TRY_LOCK_TRX_ID         | bigint(21) unsigned | NO   |      | NULL    |       |
| CURRENT_SQL_DIGEST      | varchar(64)         | YES  |      | NULL    |       |
| CURRENT_SQL_DIGEST_TEXT | text                | YES  |      | NULL    |       |
| KEY                     | text                | YES  |      | NULL    |       |
| KEY_INFO                | text                | YES  |      | NULL    |       |
| TRX_HOLDING_LOCK        | bigint(21) unsigned | NO   |      | NULL    |       |
+-------------------------+---------------------+------+------+---------+-------+
```