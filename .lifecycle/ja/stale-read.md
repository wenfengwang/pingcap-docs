---
title: Stale Readの使用シナリオ
summary: Stale Readおよびその使用シナリオについて学ぶ
---

# Stale Readの使用シナリオ

このドキュメントでは、Stale Readの使用シナリオについて説明します。Stale Readは、TiDBによってTiDBに格納されたデータの過去のバージョンを読み取るためのメカニズムです。このメカニズムを使用することで、特定の時点や指定された時間範囲内の対応する過去のデータを読み取ることができ、それによって、ストレージノード間のデータ複製によってもたらされる遅延を軽減することができます。

Stale Readを使用する場合、TiDBはデータの読み取りのためにランダムにレプリカを選択します。つまり、すべてのレプリカがデータの読み取りに利用可能です。アプリケーションが非リアルタイムのデータの読み取りを許容できない場合は、Stale Readを使用しないでください。そうでない場合、レプリカから読み取られるデータはTiDBに書き込まれた最新のデータでないかもしれません。

## シナリオの例

<CustomContent platform="tidb">

+ シナリオ1: トランザクションが読み取り操作のみを行い、データの古さをある程度許容できる場合は、Stale Readを使用して過去のデータを取得できます。Stale Readを使用すると、TiDBはいかなるレプリカにもクエリリクエストを送信することで、リアルタイムのパフォーマンスを一部犠牲にしてクエリ実行のスループットを向上させます。特に、小さいテーブルがクエリされる場合には、強力な一貫性の読み取りが使用される場合、リーダーが特定のストレージノードに集中することで、クエリの圧力もそのノードに集中する可能性があります。したがって、そのノードがクエリ全体のボトルネックになる可能性があります。しかし、Stale Readを使用すると、全体的なクエリスループットを向上させ、クエリのパフォーマンスを著しく向上させることができます。

+ シナリオ2: 地理的に分散した展開のいくつかのシナリオでは、強力な一貫性を持つフォロワーの読み取りが使われる場合、フォロワーから読み取られるデータがリーダーに格納されているデータと一貫するようにするために、TiDBは異なるデータセンターから`Readindex`を要求して検証します。これにより、クエリプロセス全体のアクセス遅延が増加します。Stale Readを使用すると、TiDBはリアルタイムのパフォーマンスを犠牲にして、現在のデータセンターのレプリカにアクセスし、クエリ全体のアクセス遅延を減らすことができます。詳細については、[三つのデータセンター展開におけるローカルリード](/best-practices/three-dc-local-read.md)を参照してください。

</CustomContent>

<CustomContent platform="tidb-cloud">

トランザクションが読み取り操作のみを行い、データの古さをある程度許容できる場合は、Stale Readを使用して過去のデータを取得できます。Stale Readを使用すると、TiDBはいかなるレプリカにもクエリリクエストを送信することで、リアルタイムのパフォーマンスを一部犠牲にしてクエリ実行のスループットを向上させます。特に、小さいテーブルがクエリされる場合には、強力な一貫性の読み取りが使用される場合、リーダーが特定のストレージノードに集中することで、クエリの圧力もそのノードに集中する可能性があります。したがって、そのノードがクエリ全体のボトルネックになる可能性があります。しかし、Stale Readを使用すると、全体的なクエリスループットを向上させ、クエリのパフォーマンスを著しく向上させることができます。

</CustomContent>

## 使用法

TiDBは、次のようにステートメントレベル、セッションレベル、グローバルレベルでStale Readを実行する方法を提供しています。

- ステートメントレベル
    - 正確な時点を指定する（**推奨**）: TiDBに、孤立性レベルを侵害せずに特定の時点からのデータをグローバルに一貫して読み取らせる必要がある場合は、その時点の対応するタイムスタンプをクエリステートメントで指定できます。詳細については、[`AS OF TIMESTAMP`句](/as-of-timestamp.md#syntax)を参照してください。
    - 時間範囲を指定する: 孤立性レベルを侵害せずに指定された時間範囲内で可能な限り新しいデータを読み取らせる必要がある場合は、クエリステートメントで時間範囲を指定できます。指定された時間範囲内で、TiDBは対応するデータを読み取るための適切なタイムスタンプを選択します。「適切」なタイムスタンプとは、このタイムスタンプより前に開始され、アクセスされたレプリカにコミットされていないトランザクションがない場合、つまり、TiDBがアクセスされたレプリカで読み取り操作を行い、その読み取り操作がブロックされない状態になっているということです。詳細については、[`AS OF TIMESTAMP`句](/as-of-timestamp.md#syntax)および[`TIDB_BOUNDED_STALENESS`関数](/as-of-timestamp.md#syntax)の導入を参照してください。
- セッションレベル
    - 時間範囲を指定する: セッション内で、孤立性レベルを侵害せずに、後続のクエリで可能な限り新しいデータを読み取らせる必要がある場合は、`tidb_read_staleness`システム変数を設定することで、時間範囲を指定できます。詳細については、[`tidb_read_staleness`](/tidb-read-staleness.md)を参照してください。

また、TiDBは、セッションまたはグローバルレベルで[`tidb_external_ts`](/system-variables.md#tidb_external_ts-new-in-v640)システム変数を設定することで、正確な時点を指定する方法を提供しています。詳細については、[`tidb_external_ts`を使用したStale Readの実行](/tidb-external-ts.md)を参照してください。

### Stale Readの遅延を減らす

Stale Read機能は、定期的にTiDBクラスタのResolved TSのタイムスタンプを進めることで、トランザクションの一貫性を満たすデータを読み取ることを保証します。Stale Readが使用するタイムスタンプ（たとえば、`AS OF TIMESTAMP '2016-10-08 16:45:26'`）がResolved TSよりも大きい場合、Stale Readは最初にResolved TSを進めるようTiDBにトリガーし、データの読み取りを待機させます。これにより遅延が発生します。

Stale Readの遅延を減らすためには、TiKVの次の構成項目を変更して、Resolved TSのタイムスタンプをより頻繁に進めるようにすることができます。

```toml
[resolved-ts]
advance-ts-interval = "20s" # デフォルト値は "20s" です。これを "1s" のような小さい値に設定して、Resolved TSのタイムスタンプをより頻繁に進めることができます。
```

> **注意:**
>
> 上記のTiKV構成項目を減少させると、TiKVのCPU使用率とノード間のトラフィックが増加します。

<CustomContent platform="tidb">

Resolved TSとsafe-tsの内部に関する詳細および診断手法については、[TiKVにおけるStale Readとsafe-tsの理解](/troubleshoot-stale-read.md)を参照してください。

</CustomContent>

## 制約

Stale Readのクエリがあるテーブルに対してTiFlashにプッシュダウンされる場合、そのテーブルに対してクエリステートメントで指定された読み取りタイムスタンプの後に実行された新しいDDL操作がある場合、クエリはエラーを返します。これは、TiFlashが最新のスキーマを持つテーブルからデータを読み取るのをサポートしているためです。

次の表を例にとってみましょう：

```sql
create table t1(id int);
alter table t1 set tiflash replica 1;
```

1分後に次のDDL操作を実行します：

```sql
alter table t1 add column c1 int not null;
```

その後、1分前の時点でStale Readを使用してデータをクエリします。

```sql
set @@session.tidb_enforce_mpp=1;
select * from t1 as of timestamp NOW() - INTERVAL 1 minute;
```

TiFlashは次のようにエラーを報告します：

```
ERROR 1105 (HY000): other error for mpp stream: From MPP<query:<query_ts:1673950975508472943, local_query_id:18, server_id:111947, start_ts:438816196526080000>,task_id:1>: Code: 0, e.displayText() = DB::TiFlashException: Table 323 schema version 104 newer than query schema version 100, e.what() = DB::TiFlashException,
```

このエラーを回避するには、Stale Readで指定された読み取りタイムスタンプをDDL操作の後の時間に変更することができます。