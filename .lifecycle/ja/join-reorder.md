---
title: ジョインの並べ替えへの概要
summary: ジョインの並べ替えアルゴリズムを使用して、TiDBで複数のテーブルをジョインします。
aliases: ['/docs/dev/join-reorder/','/docs/dev/reference/performance/join-reorder/']
---

# ジョインの並べ替えへの概要

実際のアプリケーションシナリオでは、複数のテーブルをジョインすることが一般的です。ジョインの実行効率は、各テーブルがジョインする順序と関連しています。

例えば：

{{< copyable "sql" >}}

```sql
SELECT * FROM t1, t2, t3 WHERE t1.a=t2.a AND t3.a=t2.a;
```

このクエリでは、テーブルは以下の2つの順序でジョインできます。

- t1がt2とジョインし、その後t3がジョイン
- t2がt3とジョインし、その後t1がジョイン

t1とt3は異なるデータ容量と分配を持っているため、これら2つの実行順序は異なるパフォーマンスを示す可能性があります。

そのため、オプティマイザはジョイン順序を決定するアルゴリズムが必要です。現在、TiDBで以下の2つのジョインの並び替えアルゴリズムが使用されています。

- グリーディー法: ジョインに参加するすべてのノードの中から、TiDBは行数が最も少ないテーブルを選択し、それぞれの他のテーブルとのジョイン結果を推定し、最小のジョイン結果を持つペアを選択します。その後、TiDBは同様のプロセスを続けて、次のラウンドのために他のノードを選択してジョインを行い、全てのノードがジョインを完了するまで続けます。
- 動的計画法アルゴリズム: ジョインに参加するすべてのノードの中から、TiDBは可能なすべてのジョインの順序を列挙し、最適なジョイン順序を選択します。

## 例: ジョインの並べ替えのグリーディー法

前述の3つのテーブル（t1、t2、t3）を例にすると、最初にTiDBはジョイン操作に参加するすべてのノードを取得し、行数の昇順でノードを並べます。

![join-reorder-1](/media/join-reorder-1.png)

その後、行数が最も少ないテーブルが選択され、残りの2つのテーブルとそれぞれジョインされます。出力結果セットのサイズを比較して、TiDBはより小さい結果セットを持つペアを選択します。

![join-reorder-2](/media/join-reorder-2.png)

その後TiDBは次の選択に移ります。もし4つのテーブルをジョインしようとした場合、TiDBは出力結果セットのサイズを比較し続け、より小さな結果セットを持つペアを選択します。

このケースでは、3つのテーブルだけがジョインされるため、TiDBは最終的なジョイン結果を得ます。

![join-reorder-3](/media/join-reorder-3.png)

## 例: ジョインの並べ替えの動的計画法アルゴリズム

前述の3つのテーブル（t1、t2、t3）を再び例にすると、動的計画法アルゴリズムはすべての可能性を列挙できます。そのため、グリーディー法は`最も少ない行数を持つt1`テーブルから始まらなければならないのに対し、動的計画法アルゴリズムは以下のようなジョイン順序を列挙できます。

![join-reorder-4](/media/join-reorder-4.png)

この選択がグリーディー法よりも優れている場合、動的計画法アルゴリズムはより良いジョイン順序を選択できます。

すべての可能性が列挙されるため、動的計画法アルゴリズムはより多くの時間を要し、統計により影響を受けやすくなります。

## ジョインの並べ替えアルゴリズムの選択

TiDBのジョイン並べ替えアルゴリズムの選択は、[`tidb_opt_join_reorder_threshold`](/system-variables.md#tidb_opt_join_reorder_threshold)変数によって制御されます。ジョイン並べ替えに参加するノード数がこの閾値を超える場合、TiDBはグリーディー法を使用します。そうでない場合、TiDBは動的計画法アルゴリズムを使用します。

## ジョインの並べ替えアルゴリズムの制限

現在のジョインの並べ替えアルゴリズムには以下の制限があります。

- 結果セットの計算方法の制限により、アルゴリズムは最適なジョイン順序を選択できません。
- ジョインの並べ替えアルゴリズムのOuter Joinへの対応は、[`tidb_enable_outer_join_reorder`](/system-variables.md#tidb_enable_outer_join_reorder-new-in-v610)システム変数によって制御されます。
- 現在、動的計画法アルゴリズムはOuter Joinのジョイン並べ替えを行うことができません。

現在、ジョインの順序を強制するために、TiDBでは`STRAIGHT_JOIN`構文がサポートされています。詳細については、[構文要素の説明](/sql-statements/sql-statement-select.md#description-of-the-syntax-elements)を参照してください。