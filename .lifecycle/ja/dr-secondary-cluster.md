---
title: プライマリおよびセカンダリクラスタに基づいたDRソリューション
summary: TiCDCに基づいたプライマリセカンダリ災害復旧の実装方法について学ぶ

# プライマリおよびセカンダリクラスタに基づいたDRソリューション

プライマリおよびセカンダリデータベースに基づく災害復旧（DR）は一般的なソリューションです。このソリューションでは、DRシステムにはプライマリクラスタとセカンダリクラスタがあります。プライマリクラスタはユーザリクエストを処理し、セカンダリクラスタはプライマリクラスタからデータをバックアップします。プライマリクラスタに障害が発生した場合、セカンダリクラスタがサービスを引き継ぎ、バックアップデータを使用してサービスを提供し続けます。これにより、障害による中断がなく、ビジネスシステムが通常通り動作することが保証されます。

プライマリセカンダリDRソリューションには、以下の利点があります。

- 高い可用性: プライマリセカンダリアーキテクチャによりシステムの可用性が向上し、障害からの迅速な回復が保証されます。
- 迅速なスイッチオーバー: プライマリクラスタに障害が発生した場合、システムは迅速にセカンダリクラスタに切り替わり、サービスを継続することができます。
- データの整合性: セカンダリクラスタは基本的にリアルタイムでプライマリクラスタからデータをバックアップします。このようにして、システムが障害によりセカンダリクラスタに切り替わる際、データはほぼ最新の状態になります。

このドキュメントには以下の内容が含まれています:

- プライマリクラスタとセカンダリクラスタのセットアップ
- プライマリクラスタからセカンダリクラスタへのデータレプリケーション
- クラスタのモニタリング
- DRスイッチオーバーの実行

また、このドキュメントではセカンダリクラスタでのビジネスデータのクエリ方法や、プライマリクラスタとセカンダリクラスタ間の双方向レプリケーションの方法についても説明しています。

## TiCDCに基づいたプライマリおよびセカンダリクラスタのセットアップ

### アーキテクチャ

![TiCDCセカンダリクラスタアーキテクチャ](/media/dr/dr-ticdc-secondary-cluster.png)

前述のアーキテクチャには、2つのTiDBクラスタが含まれています: プライマリクラスタおよびセカンダリクラスタ。

- プライマリクラスタ: リージョン1で実行され、3つのレプリカがあるアクティブクラスタです。このクラスタは読み書きリクエストを処理します。
- セカンダリクラスタ: リージョン2で実行され、TiCDCを介してプライマリクラスタからデータをレプリケーションします。

このDRアーキテクチャはシンプルで使いやすく、リージョナル障害に耐える能力を持ちます。DRシステムは、プライマリクラスタの書き込みパフォーマンスが低下せず、セカンダリクラスタがレイテンシに敏感でない一部の読み取り専用ビジネスを処理できることを保証します。このソリューションの復旧ポイント目標（RPO）は秒単位であり、復旧時間目標（RTO）は数分またはそれ以下になります。これは多くのデータベースベンダーが重要な本番システムに推奨するソリューションです。

> **注意:**
>
> - ["TiKVのリージョン"](./glossary.md#regionpeerraft-group) はデータの範囲を指し、"リージョン" という用語は物理的な場所を指します。これら2つの用語は交換して使用できません。
> - セカンダリクラスタへのデータレプリケーションに複数のchangefeedを実行したり既にセカンダリクラスタが存在する状態で他のセカンダリクラスタを実行しないでください。そうしないと、セカンダリクラスタのデータトランザクションの整合性が保証されません。

### プライマリクラスタとセカンダリクラスタのセットアップ

本書では、TiDBプライマリおよびセカンダリクラスタを異なるリージョン（リージョン1およびリージョン2）に展開します。また、セカンダリクラスタと一緒にTiCDCも展開します。なぜならばプライマリクラスタとセカンダリクラスタの間には一定のネットワーク遅延があるため、TiCDCをセカンダリクラスタと一緒に展開することで、ネットワーク遅延の影響を回避し、最適なレプリケーションパフォーマンスを実現できます。このドキュメントで提供されている例の展開トポロジは次のとおりです (コンポーネントノード1台につき1台のサーバが展開されます):

|リージョン | ホスト | クラスタ | コンポーネント |
| --- | --- | --- | --- |
| リージョン1 | 10.0.1.9 | プライマリ | Monitor, Grafana, または AlterManager |
| リージョン2 | 10.0.1.11 | セカンダリ | Monitor, Grafana, または AlterManager |
| リージョン1 | 10.0.1.1/10.0.1.2/10.0.1.3 | プライマリ | PD |
| リージョン2 | 10.1.1.1/10.1.1.2/10.1.1.3 | セカンダリ | PD |
| リージョン2 | 10.1.1.9/10.1.1.10 | プライマリ | TiCDC |
| リージョン1 | 10.0.1.4/10.0.1.5 | プライマリ | TiDB |
| リージョン2 | 10.1.1.4/10.1.1.5 | セカンダリ | TiDB |
| リージョン1 | 10.0.1.6/10.0.1.7/10.0.1.8 | プライマリ | TiKV |
| リージョン2 | 10.1.1.6/10.1.1.7/10.1.1.8 | セカンダリ | TiKV |

サーバーの構成については、以下のドキュメントを参照してください:

- [TiDBのソフトウェアおよびハードウェア推奨事項](./hardware-and-software-requirements.md)
- [TiCDCのソフトウェアおよびハードウェア推奨事項](./ticdc/deploy-ticdc.md#software-and-hardware-recommendations)

TiDBプライマリクラスタおよびセカンダリクラスタの展開方法の詳細については、[TiDBクラスタの展開](./production-deployment-using-tiup.md)を参照してください。

TiCDCを展開する際は、セカンダリクラスタとTiCDCを一緒に展開および管理する必要があり、それらの間のネットワークが接続されていることに注意してください。

- 既存のプライマリクラスタにTiCDCを展開するには、[TiCDCの展開](./ticdc/deploy-ticdc.md#add-or-scale-out-ticdc-to-an-existing-tidb-cluster-using-tiup)を参照してください。
- 新しいプライマリクラスタとTiCDCを展開するには、次の展開テンプレートを使用し、必要に応じて構成パラメータを変更してください:

    ```yaml
    global:
    user: "tidb"
    ssh_port: 22
    deploy_dir: "/tidb-deploy"
    data_dir: "/tidb-data"
    server_configs: {}
    pd_servers:
    - host: 10.0.1.1
    - host: 10.0.1.2
    - host: 10.0.1.3
    tidb_servers:
    - host: 10.0.1.4
    - host: 10.0.1.5
    tikv_servers:
    - host: 10.0.1.6
    - host: 10.0.1.7
    - host: 10.0.1.8
    monitoring_servers:
    - host: 10.0.1.9
    grafana_servers:
    - host: 10.0.1.9
    alertmanager_servers:
    - host: 10.0.1.9
    cdc_servers:
    - host: 10.1.1.9
        gc-ttl: 86400
        data_dir: "/cdc-data"
        ticdc_cluster_id: "DR_TiCDC"
    - host: 10.1.1.10
        gc-ttl: 86400
        data_dir: "/cdc-data"
        ticdc_cluster_id: "DR_TiCDC"
    ```

### プライマリクラスタからセカンダリクラスタへのデータレプリケーション

TiDBプライマリおよびセカンダリクラスタを設定した後、まずプライマリクラスタからデータをセカンダリクラスタに移行し、次にリアルタイムの変更データをプライマリクラスタからセカンダリクラスタにレプリケーションするレプリケーションタスクを作成します。

#### 外部ストレージの選択

データの移行およびリアルタイムの変更データをレプリケーションする際には外部ストレージが使用されます。Amazon S3が推奨される選択肢です。TiDBクラスタが自己構築のデータセンターに展開されている場合は、次の方法が推奨されます:

* [MinIO](https://docs.min.io/docs/minio-quickstart-guide.html) をバックアップストレージシステムとして構築し、S3プロトコルを使用してデータをMinIOにバックアップします。
* Network File System（NFS、たとえばNAS）ディスクをbrコマンドラインツール、TiKV、およびTiCDCインスタンスにマウントし、対応するNFSディレクトリにバックアップデータを書き込むためにPOSIXファイルシステムインタフェースを使用します。

以下の例では、MinIOをストレージシステムとして使用し、参考例として示しています。MinIOをリージョン1またはリージョン2にデプロイするための別個のサーバーを準備する必要があることに注意してください。

```shell
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
# MinIOへアクセスするためのアクセスキーとアクセスシークレットIDの設定
export HOST_IP='10.0.1.10' # IPアドレスをMinIOのIPに置き換えます
export MINIO_ROOT_USER='minio'
export MINIO_ROOT_PASSWORD='miniostorage'
# redoとbackupディレクトリを作成します。`backup`と`redo`はバケット名です。
mkdir -p data/redo
mkdir -p data/backup
# ポート6060でMinIOを起動します
nohup ./minio server ./data --address :6060 &
```

上記のコマンドは、1台のノードでMinIOサーバーを起動し、Amazon S3サービスをシミュレートします。コマンドのパラメータは以下のように構成されています:

* `endpoint`: `http://10.0.1.10:6060/`
* `access-key`: `minio`
* `secret-access-key`: `miniostorage`
* `bucket`: `redo`/`backup`

リンクは以下のとおりです:

```
s3://backup?access-key=minio&secret-access-key=miniostorage&endpoint=http://10.0.1.10:6060&force-path-style=true
```

#### データの移行
[バックアップとリストア機能](/br/backup-and-restore-overview.md)を使用して、プライマリ クラスタからセカンダリ クラスタにデータを移行します。

1. GCを無効にします。増分移行中に新たに書き込まれたデータが削除されないようにするには、バックアップ前に上流クラスタでGCを無効にする必要があります。この方法で、履歴データが削除されません。

    次のステートメントを実行して、GCを無効にします。

    ```sql
    SET GLOBAL tidb_gc_enable=FALSE;
    ```

    変更が有効になっているかどうかを確認するには、`tidb_gc_enable`の値をクエリします。

    ```sql
    SELECT @@global.tidb_gc_enable;
    ```

    値が`0`の場合、それはGCが無効であることを意味します。

    ```
    +-------------------------+
    | @@global.tidb_gc_enable |
    +-------------------------+
    |                       0 |
    +-------------------------+
    1行が返されました (0.00秒)
    ```

    > **注意:**
    >
    > 本番クラスタでは、GCを無効にしてバックアップを実行するとクラスタのパフォーマンスに影響を与える場合があります。パフォーマンスの低下を避けるために、オフピーク時にデータをバックアップし、`RATE_LIMIT`を適切な値に設定することをお勧めします。

2. データをバックアップします。上流クラスタで`BACKUP`ステートメントを実行して、データをバックアップします。

    ```sql
    BACKUP DATABASE * TO '`s3://backup?access-key=minio&secret-access-key=miniostorage&endpoint=http://10.0.1.10:6060&force-path-style=true`';
    ```

    ```
    +----------------------+----------+--------------------+---------------------+---------------------+
    | Destination          | Size     | BackupTS           | Queue Time          | Execution Time      |
    +----------------------+----------+--------------------+---------------------+---------------------+
    | s3://backup          | 10315858 | 431434047157698561 | 2022-02-25 19:57:59 | 2022-02-25 19:57:59 |
    +----------------------+----------+--------------------+---------------------+---------------------+
    1行が返されました (2.11秒)
    ```

    `BACKUP`ステートメントを実行した後に、TiDBはバックアップデータのメタデータを返します。`BackupTS`に注意してください。これは、**増分移行の開始** として使用されます。

3. データをリストアします。セカンダリ クラスタで`RESTORE`ステートメントを実行して、データをリストアします。

    ```sql
    RESTORE DATABASE * FROM '`s3://backup?access-key=minio&secret-access-key=miniostorage&endpoint=http://10.0.1.10:6060&force-path-style=true`';
    ```

    ```
    +----------------------+----------+----------+---------------------+---------------------+
    | Destination          | Size     | BackupTS | Queue Time          | Execution Time      |
    +----------------------+----------+----------+---------------------+---------------------+
    | s3://backup          | 10315858 | 0        | 2022-02-25 20:03:59 | 2022-02-25 20:03:59 |
    +----------------------+----------+----------+---------------------+---------------------+
    1行が返されました (41.85秒)
    ```

#### 増分データをレプリケート

前述のセクションで説明したように、データを移行した後、プライマリ クラスタからセカンダリ クラスタに対して、**BackupTS**から始めて増分データをレプリケートできます。

1. チェンジフィードを作成します。

    `changefeed.toml`というチェンジフィード構成ファイルを作成します。

    ```toml
    [consistent]
    # eventual consistency: redo logs are used to ensure eventual consistency in disaster scenarios.
    level = "eventual"
    # The size of a single redo log, in MiB. The default value is 64, and the recommended value is less than 128.
    max-log-size = 64
    # The interval for refreshing or uploading redo logs to Amazon S3, in milliseconds. The default value is 1000, and the recommended value range is 500-2000.
    flush-interval = 2000
    # The path where redo logs are saved.
    storage = "s3://redo?access-key=minio&secret-access-key=miniostorage&endpoint=http://10.0.1.10:6060&force-path-style=true"
    ```

    プライマリ クラスタで、次のコマンドを実行して、プライマリ クラスタからセカンダリ クラスタに対するチェンジフィードを作成します。

    ```shell
    tiup cdc cli changefeed create --server=http://10.1.1.9:8300 \
    --sink-uri="mysql://{username}:{password}@10.1.1.4:4000" \
    --changefeed-id="dr-primary-to-secondary" --start-ts="431434047157698561"
    ```

    チェンジフィードの構成に関する詳細情報は、[TiCDCチェンジフィード構成](/ticdc/ticdc-changefeed-config.md)を参照してください。

2. チェンジフィードタスクが正常に実行されているかどうかを確認するには、`changefeed query`コマンドを実行します。クエリ結果には、タスク情報とタスクのステータスが含まれます。`--simple`または`-s`引数を指定して、基本的なレプリケーションステートとチェックポイント情報のみを表示できます。この引数を指定しない場合、出力には詳細なタスク構成、レプリケーションステート、およびレプリケーションテーブル情報も含まれます。

    ```shell
    tiup cdc cli changefeed query -s --server=http://10.1.1.9:8300 --changefeed-id="dr-primary-to-secondary"
    ```

    ```shell
    {
    "state": "normal",
    "tso": 431434047157998561,  # チェンジフィードがレプリケーションされた TSO
    "checkpoint": "2020-08-27 10:12:19.579", # TSOに対応する物理時間
    "error": null
    }
    ```

3. GCを有効にします。

    TiCDCは、プライマリ クラスタからセカンダリ クラスタにチェンジフィードを作成した後、レプリケートされる前に履歴データがガベージコレクトされないようにします。したがって、プライマリ クラスタからセカンダリ クラスタにチェンジフィードを作成した後、次のステートメントを実行して、GCを再度有効にすることができます。

    次のステートメントを実行して、GCを有効にします。

    ```sql
    SET GLOBAL tidb_gc_enable=TRUE;
    ```

    変更が有効になっているかどうかを確認するには、`tidb_gc_enable`の値をクエリします。

    ```sql
    SELECT @@global.tidb_gc_enable;
    ```

    値が`1`の場合、それはGCが有効であることを意味します。

    ```
    +-------------------------+
    | @@global.tidb_gc_enable |
    +-------------------------+
    |                       1 |
    +-------------------------+
    1行が返されました (0.00秒)
    ```

### プライマリ クラスタとセカンダリ クラスタを監視

現在、TiDBにはDRダッシュボードが用意されていません。TiDBのプライマリ クラスタおよびセカンダリ クラスタの状態を確認するには、次のダッシュボードを使用してください。また、DRスイッチオーバーを実行するかどうかを決定できます。

- [TiDBキーメトリクス](/grafana-overview-dashboard.md)
- [チェンジフィードメトリクス](/ticdc/monitor-ticdc.md#changefeed)

### DRスイッチオーバーを実行

このセクションでは、計画されたDRスイッチオーバー、災害に基づくDRスイッチオーバー、およびセカンダリ クラスタの再構築手順について説明します。

#### 計画されたプライマリとセカンダリのスイッチオーバー

重要なビジネスシステムの信頼性をテストするために、定期的にDRドリルを実施することが重要です。DRドリルのための推奨手順は次のとおりです。シミュレートされたビジネスライティングやデータベースへのアクセスにプロキシサービスを使用しないため、アプリケーションシナリオとは異なる場合があります。必要に応じて構成を変更してください。

1. プライマリ クラスタでビジネスのライティングを停止します。
2. ライティングがなくなった後、TiDBクラスタの最新のTSO（`Position`）をクエリします。

    ```sql
    mysql> show master status;
    +-------------+--------------------+--------------+------------------+-------------------+
    | File        | Position           | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
    +-------------+--------------------+--------------+------------------+-------------------+
    | tidb-binlog | 438223974697009153 |              |                  |                   |
    +-------------+--------------------+--------------+------------------+-------------------+
    1行が返されました (0.33秒)
    ```

3. `dr-primary-to-secondary`のチェンジフィードが条件 `TSO >= Position` を満たすまでポーリングします。

    ```shell
    tiup cdc cli changefeed query -s --server=http://10.1.1.9:8300 --changefeed-id="dr-primary-to-secondary"

    {
        "state": "normal",
        "tso": 438224029039198209,  # チェンジフィードがレプリケーションされた TSO
        "checkpoint": "2022-12-22 14:53:25.307", # TSOに対忋する物理時間
        "error": null
    }
    ```

4. `dr-primary-to-secondary`のチェンジフィードを停止します。チェンジフィードを削除して一時停止できます。

    ```shell
    tiup cdc cli changefeed remove --server=http://10.1.1.9:8300 --changefeed-id="dr-primary-to-secondary"
    ```
5. `start-ts`パラメータを指定せずに`dr-secondary-to-primary`という変更フィードを作成します。 変更フィードは現在の時刻からデータをレプリケートし始めます。
6. ビジネスアプリケーションのデータベースアクセス構成を変更します。 ビジネスアプリケーションを再起動して、セカンダリクラスタにアクセスできるようにします。
7. ビジネスアプリケーションが正常に実行されているかどうかを確認します。

前述の手順を繰り返して、以前のプライマリクラスタおよびセカンダリクラスタの構成を復元できます。

#### 災害時のプライマリクラスタとセカンダリクラスタの切り替え

災害が発生した場合、たとえばプライマリクラスタが存在する地域で停電が発生した場合、プライマリクラスタとセカンダリクラスタ間のレプリケーションが突然中断される可能性があります。その結果、セカンダリクラスタ内のデータがプライマリクラスタと一貫していなくなる可能性があります。

1. セカンダリクラスタをトランザクション一貫性の状態に復元します。 具体的には、リージョン2の任意のTiCDCノードで次のコマンドを実行して、リドゥログをセカンダリクラスタに適用します。

    ```shell
    tiup cdc redo apply --storage "s3://redo?access-key=minio&secret-access-key=miniostorage&endpoint=http://10.0.1.10:6060&force-path-style=true" --tmp-dir /tmp/redo --sink-uri "mysql://{username}:{password}@10.1.1.4:4000"
    ```

    このコマンドのパラメータの説明は次のとおりです。

    - `--storage`: Amazon S3にリドゥログが保存されているパス
    - `--tmp-dir`: Amazon S3からリドゥログをダウンロードするためのキャッシュディレクトリ
    - `--sink-uri`: セカンダリクラスタのアドレス

2. ビジネスアプリケーションのデータベースアクセス構成を変更します。 ビジネスアプリケーションを再起動して、セカンダリクラスタにアクセスできるようにします。
3. ビジネスアプリケーションが正常に実行されているかどうかを確認します。

#### プライマリおよびセカンダリクラスタの再構築

プライマリクラスタが遭遇した災害が解決された場合、またはプライマリクラスタが一時的に復旧できない場合、TiDBクラスタはセカンダリクラスタのみがプライマリクラスタとして稼働しているため、脆弱になります。 システムの信頼性を維持するために、DRクラスタを再構築する必要があります。

TiDBのプライマリおよびセカンダリクラスタを再構築するには、新しいクラスタを展開して新しいDRシステムを形成できます。 詳細については、次のドキュメントを参照してください。

- [プライマリおよびセカンダリクラスタのセットアップ](#ticdcに基づくプライマリおよびセカンダリクラスタのセットアップ)
- [プライマリクラスタからセカンダリクラスタへのデータのレプリケーション](#プライマリクラスタからセカンダリクラスタへのデータのレプリケーション)
- 上記の手順が完了したら、新しいプライマリクラスタにするために、[プライマリおよびセカンダリクラスタの切り替え](#計画されたプライマリおよびセカンダリクラスタの切り替え)を参照してください。

> **注意:**
>
> プライマリおよびセカンダリクラスタ間のデータの不一致が解決できる場合、修復されたクラスタを新しいクラスタを展開する代わりにDRシステムを再構築することができます。

### セカンダリクラスタでのビジネスデータのクエリ

プライマリ-セカンダリDRシナリオでは、セカンダリクラスタはいくつかのレイテンシに敏感でないクエリを実行するための読み取り専用クラスタとして使用されることが一般的です。 TiDBは、プライマリ-セカンダリDRソリューションによってこの機能も提供しています。

変更フィードを作成する際に、構成ファイルでSyncpoint機能を有効にします。 その後、変更フィードは定期的に（`sync-point-interval`で）一貫したスナップショットポイントを設定します。このポイントは、セカンダリクラスタにレプリケートされたものであり、セカンダリクラスタ上で`SET GLOBAL tidb_external_ts = @@tidb_current_ts`を実行することで設定します。

セカンダリクラスタからデータをクエリするために、ビジネスアプリケーションで`SET GLOBAL|SESSION tidb_enable_external_ts_read = ON;`を構成します。 その後、プライマリクラスタとトランザクション的に整合するデータを取得できます。

```toml
# v6.4.0以降、SYSTEM_VARIABLES_ADMINまたはSUPER権限を持つ変更フィードのみTiCDC Syncpoint機能を使用できます。
enable-sync-point = true

# Syncpointがプライマリとセカンダリのスナップショットを整合させる間隔を指定します。また、セカンダリクラスタからプライマリクラスタで2分前に生成されたトランザクションデータなど、完全なトランザクションを読み取ることのできる最大遅延を示します。
# フォーマットはh m sです。 たとえば、"1h30m30s"。 デフォルト値は"10m"で、最小値は"30s"です。
sync-point-interval = "10m"

# Syncpointによってセカンダリのテーブルに保持されるデータの保持期間を指定します。 この期間を超過すると、データはクリーンアップされます。
# フォーマットはh m sです。 たとえば、"24h30m30s"。 デフォルト値は"24h"です。
sync-point-retention = "1h"

[consistent]
# eventual consistency: redo logs are used to ensure eventual consistency in disaster scenarios.
level = "eventual"
# 単一のリドゥログのサイズ（MiB）。 デフォルト値は64で、推奨値は128よりも小さいです。
max-log-size = 64
# Amazon S3にリドゥログを更新またはアップロードする間隔（ミリ秒単位）。
# デフォルト値は1000で、推奨値の範囲は500〜2000です。
flush-interval = 2000
# リドゥログが保存されているパスです。
storage = "s3://redo?access-key=minio&secret-access-key=miniostorage&endpoint=http://10.0.1.10:6060&force-path-style=true"
```

> **注意:**
>
> プライマリ-セカンダリDRアーキテクチャでは、セカンダリクラスタは1つの変更フィードからのみデータをレプリケートできます。 それ以外の場合、セカンダリクラスタのデータトランザクションの整合性は保証できません。

### プライマリとセカンダリクラスタ間の双方向レプリケーションを実行する

このDRシナリオでは、2つのリージョンのTiDBクラスタはお互いの災害復旧クラスタとして機能できます：ビジネストラフィックはリージョン構成に基づいて対応するTiDBクラスタに書き込まれ、両方のTiDBクラスタはお互いのデータをバックアップします。

バイナリレプリケーション機能により、2つのリージョンのTiDBクラスタは互いのデータをレプリケーションできます。 このDRソリューションはデータのセキュリティと信頼性を保証し、データベースの書き込みパフォーマンスも確保します。 計画されたDR切り替えでは、新しい変更フィードを開始する前に実行中の変更フィードを停止する必要がないため、操作とメンテナンスが簡素化されます。

双方向DRクラスタを構築するには、[TiCDC双方向レプリケーション](/ticdc/ticdc-bidirectional-replication.md)を参照してください。

## トラブルシューティング

前述の手順で問題が発生した場合は、まず[TiDB FAQs](/faq/faq-overview.md)で問題の解決策を見つけることができます。 問題が解決されない場合は、[バグを報告](/support.md)することができます。