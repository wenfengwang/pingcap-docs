---
title: TiDB ダッシュボードメトリクス関連グラフ
summary: TiDB ダッシュボードメトリクス関連グラフを学ぶ
---

# TiDB ダッシュボードメトリクス関連グラフ

TiDB ダッシュボードメトリクス関連グラフは v4.0.7 で導入された機能です。この機能は、TiDB クラスター内の各内部プロセスの監視データの関連グラフを示します。目的は、各プロセスの所要時間とその関係を迅速に把握することです。

## グラフにアクセス

TiDB ダッシュボードにログインした後、左側のナビゲーションメニューで **Cluster Diagnostics** をクリックし、メトリクス関連グラフを生成するページが表示されます。

![メトリクス関連グラフホームページ](/media/dashboard/dashboard-metrics-relation-home-v650.png)

**範囲開始時間** と **範囲期間** を設定した後、 **メトリクス関連を生成** をクリックすると、メトリクス関連グラフページに移動します。

## グラフの理解

以下の画像はメトリクス関連グラフの例です。このグラフは、2020-07-29 16:36:00以降の TiDB クラスター内の5分間にわたる各監視メトリクスの所要時間の割合を示しています。グラフには各監視メトリクスの関連も示されています。

![メトリクス関連グラフ例](/media/dashboard/dashboard-metrics-relation-example.png)

たとえば、 `tidb_execute` 監視メトリクスのノードの意味は次のとおりです：

+ `tidb_execute` 監視メトリクスの合計所要時間は19306.46秒であり、これは総クエリ所要時間の89.4%を占めています。
+ `tidb_execute` ノードの所要時間自体は9070.18秒であり、これは総クエリ所要時間の42%を占めています。
+ ボックス領域にマウスを重ねると、 `tidb_execute` メトリクスの合計所要時間、平均所要時間、平均P99（99パーセンタイル）所要時間など、メトリクスの詳細情報が表示されます。

![tidb_execute ノードの例](/media/dashboard/dashboard-metrics-relation-node-example.png)

### ノード情報

各ボックス領域は監視メトリクスを表し、以下の情報を提供します：

* 監視メトリクスの名前
* 監視メトリクスの合計所要時間
* メトリクスの合計所要時間の総クエリ所要時間に対する割合

*メトリクスノードの合計所要時間* = *メトリクスノード自体の所要時間* + *その子ノードの所要時間*。したがって、一部のノードのメトリクス グラフは、ノード自体の所要時間が総所要時間に占める割合を表示します。たとえば、 `tidb_execute` のグラフはこのような表現です。

![tidb_execute ノードの例1](/media/dashboard/dashboard-metrics-relation-node-example1.png)

* `tidb_execute` は、SQL クエリの実行における TiDB 実行エンジンの実行所要時間を表す監視メトリクスの名前です。
* `19306.46秒` は `tidb_execute` メトリクスの総所要時間が19306.46秒であることを意味し、 `89.40%` はこれが全 SQL クエリの総所要時間の89.40%を占めることを示しています（ユーザー SQL クエリおよび TiDB の内部 SQL クエリを含む）。総クエリ所要時間は `tidb_query` の総所要時間です。
* `9070.18秒` は、 `tidb_execute` ノード自体の総所要時間が9070.18秒であり、残りはその子ノードの所要時間です。 `42.00%` は9070.18秒がすべてのクエリの総クエリ所要時間の42.00%を占めることを示しています。

ボックス領域にマウスを重ねると、 `tidb_execute` メトリクスノードの詳細情報を表示できます。

![tidb_execute ノードの例2](/media/dashboard/dashboard-metrics-relation-node-example2.png)

上記の画像に表示されるテキスト情報は、メトリクスノードの説明を表し、総所要時間、総時間、平均所要時間、および平均所要時間のP99、P90、およびP80を含みます。

### ノード間の親子関係

`tidb_execute` メトリクスノードを例にとって、このセクションではメトリクスの子ノードについて説明します。

![tidb_execute ノード関連の例1](/media/dashboard/dashboard-metrics-relation-relation-example1.png)

上記のグラフから、 `tidb_execute` の2つの子ノードが表示されます：

* `pd_start_tso_wait`：トランザクションの `start_tso` を待機する総所要時間で、300.66秒です。
* `tidb_txn_cmd`：関連するトランザクションのコマンドを実行する TiDB の総所要時間で、9935.62秒です。

さらに、 `tidb_execute` は点線で示される矢印で `tidb_cop` のボックス領域を指し示しており、次のように示しています：

`tidb_execute` は `tidb_cop` メトリックの所要時間を含みますが、 `cop` リクエストは同時に実行される場合があります。たとえば、2つのテーブルで `join` クエリを実行する際の `execute` の所要時間が60秒であり、結合された2つのテーブルで同時にテーブルスキャンリクエストが実行されます。 `cop` リクエストの所要時間がそれぞれ40秒と30秒の場合、 `cop` リクエストの合計所要時間は70秒です。ただし、 `execute` の所要時間は60秒です。したがって、親ノードの所要時間が子ノードの所要時間を完全に含まない場合、点線の矢印が子ノードを指すために使用されます。

> **注記:**
>
> ノードがその子ノードを指す点線の矢印を持つ場合、このノード自体の所要時間は正確ではありません。たとえば、 `tidb_execute` ノードでは、ノード自体の所要時間は9070.18秒であり（`9070.18 = 19306.46 - 300.66 - 9935.62`）、これに `tidb_cop` の所要時間の一部が含まれていません。しかし、実際にはこれは真ではありません。 `tidb_execute` そのものの所要時間である9070.18秒は、 `tidb_cop` の所要時間の一部を含んでおり、この部分の所要時間を特定することはできません。

### `tidb_kv_request` とその親ノード

![tidb_execute ノード関連の例2](/media/dashboard/dashboard-metrics-relation-relation-example2.png)

`tidb_kv_request` の親ノードである `tidb_cop` および `tidb_txn_cmd.get` は、その両方が `tidb_kv_request` を指し示す点線の矢印を持ち、次のように示しています：

* `tidb_cop` の所要時間には `tidb_kv_request` の一部の所要時間が含まれます。
* `tidb_txn_cmd.get` の所要時間にも、 `tidb_kv_request` の一部の所要時間が含まれます。

しかし、 `tidb_kv_request` の所要時間のどれだけが `tidb_cop` に含まれているかは分かりにくいです。

* `tidb_kv_request.Get`： `Get` タイプのキーバリューリクエストを送信する TiDB の所要時間。
* `tidb_kv_request.Cop`： `Cop` タイプのキーバリューリクエストを送信する TiDB の所要時間。

`tidb_kv_request` は、その子ノードに `tidb_kv_request.Get` と `tidb_kv_request.Cop` ノードを含みませんが、それらのノードで構成されています。子ノードの名前の接頭辞は親ノードの名前に `.xxx` が付き、これは子ノードが親ノードのサブクラスであることを意味します。この例を理解するためには、次のように理解できます：

TiDB がキーバリューリクエストを送信する合計所要時間は14745.07秒であり、`Get` および `Cop` タイプのキーバリューリクエストはそれぞれ9798.02秒および4946.46秒を消費しています。