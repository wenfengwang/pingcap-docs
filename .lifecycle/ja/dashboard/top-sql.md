---
title: TiDB ダッシュボードのトップSQLページ
summary: 高いCPUオーバーヘッドを持つSQLステートメントを見つける方法を学ぶ。

# TiDB ダッシュボード トップSQLページ

トップSQLを使用すると、データベース内の各SQLステートメントのCPUオーバーヘッドをリアルタイムで監視し、視覚的に探索できます。これにより、データベースのパフォーマンスの問題を最適化および解決するのに役立ちます。トップSQLは、すべてのTiDBおよびTiKVインスタンスから秒単位で集計されたSQLステートメントによるCPU負荷データを継続的に収集および保存します。収集されたデータは最大30日間保存できます。また、トップSQLでは視覚的なチャートとテーブルが提供され、一定期間においてTiDBまたはTiKVインスタンスの高いCPU負荷を引き起こしているSQLステートメントを素早く特定できます。

トップSQLは以下の機能を提供します:

* チャートとテーブルを使用して、最も高いCPUオーバーヘッドを持つ5つの種類のSQLステートメントを視覚化します。
* クエリ数、平均待ち時間、クエリプランなどの詳細な実行情報を表示します。
* 実行されたすべてのSQLステートメントを収集し、実行中のものを含みます。
* 特定のTiDBおよびTiKVインスタンスのデータを表示できます。

## 推奨シナリオ

トップSQLはパフォーマンスの問題を分析するために適しています。以下はいくつかの典型的なトップSQLのシナリオです:

* Grafanaのチャートを使用してクラスタ内の個々のTiKVインスタンスのCPU使用率が非常に高いことがわかりました。分散リソースを最適化し、より良い活用するために、どのSQLステートメントがCPUホットスポットを引き起こしているかを知りたいです。
* クラスタ全体のCPU使用率が非常に高く、クエリが遅いことがわかりました。現在最もCPUリソースを消費しているSQLステートメントを素早く特定したいです。
* クラスタのCPU使用率が急激に変化し、その主要な原因を知りたいです。
* クラスタ内で最もリソースを消費するSQLステートメントを分析し、ハードウェアコストを削減したいです。

トップSQLは、データの不正や異常なクラッシュなどの非パフォーマンスの問題を特定するためには使用できません。

トップSQL機能はまだ初期段階にあり、継続的に拡張されています。現時点では、以下のようなシナリオは **サポートされていません**:

* トップ5以外のSQLステートメントのオーバーヘッドを分析すること（例: 複数のビジネスワークロードが混在している場合）。
* ユーザーやデータベースなど、異なる次元ごとにトップNのSQLステートメントのオーバーヘッドを分析すること。
* 高いCPU負荷など、高いCPU負荷以外の原因によるデータベースのパフォーマンスの問題を分析すること。

## ページへのアクセス

以下のいずれかの方法でトップSQLページにアクセスできます:

* TiDBダッシュボードにログインした後、左側のナビゲーションメニューで **トップSQL** をクリックします。

  ![トップSQL](/media/dashboard/top-sql-access.png)

* ブラウザで <http://127.0.0.1:2379/dashboard/#/topsql> を訪問します。`127.0.0.1:2379` を実際のPDインスタンスのアドレスとポートに置き換えてください。

## トップSQLの有効化

> **注意:**
>
> トップSQLを使用するためには、クラスタは最新バージョンのTiUP（v1.9.0以降）またはTiDBオペレータ（v1.3.0以降）で展開またはアップグレードする必要があります。クラスタを以前のバージョンのTiUPやTiDBオペレータを使用してアップグレードした場合は、[FAQ](/dashboard/dashboard-faq.md#a-required-component-ngmonitoring-is-not-started-error-is-shown)の手順を参照してください。

トップSQLはデフォルトでは有効になっていません。有効にするとクラスタのパフォーマンスにわずかな影響があります（平均で3%以内）。トップSQLを有効にする手順は以下です:

1. [トップSQL ページ](#access-the-page)にアクセスします。
2. **Settings** エリアの右側にある **Open Settings** をクリックします。**Enable Feature** をオンに切り替えます。
3. **Save** をクリックします。

機能を有効にした後、データの読み込みを待ちます。その後、CPU負荷の詳細を確認できます。

UIに加えて、以下のTiDBシステム変数 [`tidb_enable_top_sql`](/system-variables.md#tidb_enable_top_sql-new-in-v540) を設定して、トップSQL機能を有効にすることもできます:

{{< copyable "sql" >}}

```sql
SET GLOBAL tidb_enable_top_sql = 1;
```

## トップSQLの使用

以下はトップSQLを使用する一般的な手順です。

1. [トップSQL ページ](#access-the-page)にアクセスします。

2. 観測したい特定のTiDBまたはTiKVインスタンスを選択します。

   ![Select Instance](/media/dashboard/top-sql-usage-select-instance.png)

   観測したいTiDBまたはTiKVインスタンスが分からない場合は、任意のインスタンスを選択できます。また、クラスタのCPU負荷が非常に不均衡な場合は、まずGrafanaのチャートを使用して観測したい特定のインスタンスを特定できます。

3. トップSQLによって提示されたチャートとテーブルを観測します。

   ![Chart and Table](/media/dashboard/top-sql-usage-chart.png)

   棒グラフのサイズは、その瞬間にSQLステートメントによって消費されるCPUリソースの大きさを表しています。異なる色が異なる種類のSQLステートメントを区別しています。ほとんどの場合、対応する時間範囲の中でCPUリソースのオーバーヘッドが高いSQLステートメントに焦点を合わせる必要があります。

4. テーブル内のSQLステートメントをクリックして、さらに詳細情報を表示します。そのステートメントの異なるプランの実行メトリクス（平均クエリ数、平均スキャンインデックス数など）を確認できます。

   ![Details](/media/dashboard/top-sql-details.png)

5. これらの初期的な手掛かりを元に、高いCPU消費または大規模なデータスキャンのルート原因を見つけるために、[SQLステートメント](/dashboard/dashboard-statement-list.md)や[遅いクエリ](/dashboard/dashboard-slow-query.md)ページをさらに探索できます。

その他に、トップSQLを以下のように設定できます:

* タイムピッカーで時間範囲を調整したり、チャートで時間範囲を選択して問題をより正確かつ詳細に見ることができます。短い時間範囲では、精度が1秒まで向上します。

  ![Change time range](/media/dashboard/top-sql-usage-change-timerange.png)

* チャートが古い場合は、 **Refresh** ボタンをクリックするか、 **Refresh** ドロップダウンリストからオートリフレッシュオプションを選択できます。

  ![Refresh](/media/dashboard/top-sql-usage-refresh.png)

## トップSQLの無効化

以下の手順に従ってこの機能を無効にできます:

1. [トップSQL ページ](#access-the-page)にアクセスします。
2. 上部右隅の歯車アイコンをクリックして設定画面を開き、**Enable Feature** をオフに切り替えます。
3. **Save** をクリックします。
4. ポップアップダイアログボックスで **Disable** をクリックします。

UIに加えて、以下のTiDBシステム変数 [`tidb_enable_top_sql`](/system-variables.md#tidb_enable_top_sql-new-in-v540) を設定して、トップSQL機能を無効にすることもできます:

{{< copyable "sql" >}}

```sql
SET GLOBAL tidb_enable_top_sql = 0;
```

## よくある質問

**1.トップSQLを有効化できず、UIに「required component NgMonitoring is not started」と表示されます。**

[TiDBダッシュボード FAQ](/dashboard/dashboard-faq.md#a-required-component-ngmonitoring-is-not-started-error-is-shown)を参照してください。

**2. トップSQLを有効化した後、パフォーマンスに影響はありますか？**

この機能はクラスタのパフォーマンスにわずかな影響を与えます。ベンチマークによると、通常、この機能を有効にした場合、平均パフォーマンスへの影響は3%未満です。

**3. この機能のステータスはどうですか？**

現在、これは一般利用可能（GA）の機能であり、本番環境で使用できます。

**4. "他のステートメント"とは何ですか？**

"他のステートメント"はトップ5のステートメント以外のすべてのCPUオーバーヘッドを数えます。この情報を使用して、トップ5のステートメントによるCPUオーバーヘッドと全体のCPUオーバーヘッドを比較することができます。

**5. Top SQLによって表示されるCPUオーバーヘッドとプロセスの実際のCPU使用率との関係は何ですか？**

これらは強く相関していますが、完全に同じではありません。例えば、複数のレプリカを書き込むコストは、Top SQLに表示されるTiKVのCPUオーバーヘッドには含まれません。一般的に、CPU使用率が高いSQLステートメントは、Top SQLに表示されるCPUオーバーヘッドも高くなります。

**6. Top SQLチャートのY軸の意味は何ですか？**

CPUリソースの消費量を表します。SQLステートメントが消費するリソースが多いほど、値が高くなります。ほとんどの場合、特定の値の意味や単位について気にする必要はありません。

**7.Top SQLは実行中の（未完了の）SQLステートメントを収集しますか？**

はい。トップSQLチャートに表示される各瞬間の棒は、その時点で実行中のすべてのSQLステートメントのCPUオーバーヘッドを示しています。
